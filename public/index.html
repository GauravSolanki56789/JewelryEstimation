<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jewellery Estimation Software - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
    /* Smooth transitions */
    * {
        transition: background-color 0.2s ease;
    }
    
    /* Table hover effects */
    tbody tr:hover {
        background-color: #f9fafb !important;
    }
    
    /* Modal backdrop blur */
    #modalOverlay {
        backdrop-filter: blur(2px);
    }
    
    /* Print styles for ledger */
    @media print {
        .no-print {
            display: none !important;
        }
        
        body {
            background: white !important;
        }
    }
</style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-amber-600 to-orange-600 text-white p-6">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">üíé Jewellery Estimation Software</h1>
                        <p class="text-amber-100" id="quotationNo">Quotation No: Q0001</p>
                    </div>
                    <div class="flex gap-3 flex-wrap">
                        <button onclick="showTab('billing')" id="btnBilling"
                            class="px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition">üìã
                            Billing</button>
                        <button onclick="showTab('products')" id="btnProducts"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üì¶
                            Products</button>
                        <button onclick="showTab('customers')" id="btnCustomers"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üë•
                            Customers</button>
                        <button onclick="showTab('rol')" id="btnROL"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìä ROL</button>
                        <button onclick="showTab('salesbill')" id="btnSalesBill"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üí∞Sales Bill</button>
                        <button onclick="showTab('quotations')" id="btnQuotations"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìú
                            Quotations</button>
                        <button onclick="showTab('billhistory')" id="btnBillHistory" 
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìãBillHistory</button>
                        <button onclick="showTab('ledger')" id="btnLedger"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìí Ledger</button>
                    </div>
                </div>
            </div>
        </div>
        

<!-- Billing Tab - REPLACE ENTIRE billingTab div -->
<div id="billingTab" class="space-y-4">
    <!-- Customer Details Card - Compact -->
    <div class="bg-white p-4 rounded-xl shadow-lg">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Customer</label>
                <select id="customerSelect" onchange="loadCustomerDetails()"
                    class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Mobile</label>
                <input type="text" id="customerMobile" readonly class="w-full px-3 py-2 text-sm bg-gray-100 border rounded-lg">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Rate Slab</label>
                <select id="rateSlab" onchange="updateRateSlabInfo()"
                    class="w-full px-3 py-2 text-sm border-2 border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 font-semibold">
                    <option value="R">R</option>
                    <option value="R1">R1</option>
                    <option value="R2">R2</option>
                    <option value="R3">R3</option>
                    <option value="R4">R4</option>
                </select>
            </div>
            <div class="flex items-end gap-2">
                <button onclick="showNewCustomerModal()"
                    class="flex-1 px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 font-medium">‚ûï New</button>
                <button onclick="showCashEntryModal()" 
                    class="px-3 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 font-medium">üíµ</button>
                <button onclick="showBankEntryModal()" 
                    class="px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 font-medium">üè¶</button>
            </div>
        </div>
        
        <!-- Customer Details Compact Display -->
        <div id="customerDetailsDisplay" class="mt-3 hidden">
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-3 rounded-lg border-l-4 border-amber-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800" id="custName"></p>
                        <p class="text-xs text-gray-600" id="custAddress"></p>
                    </div>
                    <div class="bg-amber-600 text-white px-3 py-1 rounded-lg text-center">
                        <p class="text-xs">Rate Slab</p>
                        <p class="text-lg font-bold" id="rateSlabDisplay">R</p>
                        <p class="text-xs" id="rateSlabDesc">Standard</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid: Scanner & Rates | Product Table -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- LEFT COLUMN: Scanner, Rates, Manual Entry -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Barcode Scanner -->
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üì∑</span>
                    <h3 class="font-bold text-lg">Scanner</h3>
                </div>
                <input id="barcodeInput" type="text" placeholder="Scan barcode..."
                    class="w-full px-4 py-3 border-2 border-white/30 rounded-lg focus:ring-2 focus:ring-white text-lg text-gray-900 font-semibold" autofocus>
                <p class="text-xs text-blue-100 mt-2">üîç Press Enter</p>
            </div>

            <!-- Current Rates -->
            <div class="bg-white p-4 rounded-xl shadow-lg border-2 border-amber-200">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 text-sm">Current Rates</h3>
                    <button onclick="showRatesModal()" class="px-2 py-1 bg-amber-600 text-white text-xs rounded hover:bg-amber-700">Update</button>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-yellow-50 rounded">
                        <span class="text-xs font-medium">Gold</span>
                        <span class="text-sm font-bold text-yellow-600" id="goldRate">‚Çπ7500/gm</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-xs font-medium">Silver</span>
                        <span class="text-sm font-bold text-gray-600" id="silverRate">‚Çπ156/gm</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-purple-50 rounded">
                        <span class="text-xs font-medium">Platinum</span>
                        <span class="text-sm font-bold text-gray-800" id="platinumRate">‚Çπ3500/gm</span>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Form -->
            <div class="bg-white p-3 rounded-xl shadow-lg border">
                <h3 class="font-bold text-gray-800 text-sm mb-2">Manual Entry</h3>
                <div class="space-y-2">
                    <input type="text" id="itemSku" placeholder="SKU" class="w-full px-2 py-1.5 text-xs border rounded">
                    <input type="text" id="itemStyleCode" placeholder="Style Code" class="w-full px-2 py-1.5 text-xs border rounded">
                    <input type="text" id="itemName" placeholder="Item Name" class="w-full px-2 py-1.5 text-xs border rounded">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="itemSize" placeholder="Size" class="px-2 py-1.5 text-xs border rounded">
                        <input type="number" step="0.01" id="itemWeight" placeholder="Weight" class="px-2 py-1.5 text-xs border rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.1" id="itemPurity" placeholder="Purity %" value="100" class="px-2 py-1.5 text-xs border rounded">
                        <input type="number" step="0.01" id="itemRate" placeholder="Rate/gm" class="px-2 py-1.5 text-xs border rounded">
                    </div>
                    <input type="number" step="0.01" id="itemMcRate" placeholder="MC Rate/gm" class="w-full px-2 py-1.5 text-xs border rounded">
                    <input type="hidden" id="itemMetalType">
                    <div class="bg-amber-50 border-2 border-amber-300 rounded p-2 text-center">
                        <p class="text-xs text-gray-600">Amount</p>
                        <div class="text-lg font-bold text-amber-700" id="itemAmount">‚Çπ0.00</div>
                    </div>
                    <button onclick="addItem()" class="w-full px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 font-bold">‚ûï Add</button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Product Table (Excel-like) -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-lg border-2 border-blue-200">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-t-xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">üì¶ Scanned Products</h3>
                        <span class="bg-white text-blue-600 px-3 py-1 rounded-full font-bold" id="itemCount">0 Items</span>
                    </div>
                </div>
                
                <!-- Table Container - Scrollable -->
                <div class="overflow-auto" style="max-height: calc(100vh - 320px);">
                    <!-- Empty State -->
                    <div id="emptyProductsState" class="text-center py-16">
                        <div class="text-6xl mb-4">üîç</div>
                        <h4 class="text-xl font-bold text-gray-700 mb-2">No Products Scanned</h4>
                        <p class="text-gray-500">Scan a barcode to begin</p>
                    </div>
                    
                    <!-- Products Table - Excel Style -->
                    <table id="productsTable" class="w-full hidden text-sm">
                        <thead class="bg-gray-200 sticky top-0">
                            <tr class="border-b-2 border-gray-400">
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">#</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Barcode</th>
                                <th class="px-3 py-2 text-left font-bold text-gray-700 border-r">Item Name</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">SKU</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Style</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Metal</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Size</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r bg-blue-50">Weight (g)</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Purity%</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-yellow-50">Rate/g</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-orange-50">MC/g</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-green-50">Amount</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700">Action</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Summary Footer -->
                <div class="border-t-2 border-gray-300 bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-b-xl">
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <p class="text-xs text-gray-600 mb-1">Items</p>
                            <p class="text-xl font-bold text-gray-800" id="totalItems">0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">SUBTOTAL</p>
                            <p class="text-xl font-bold text-gray-800" id="summaryTotal">‚Çπ0.00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">GST (3%)</p>
                            <p class="text-xl font-bold text-blue-600" id="summaryGst">‚Çπ0.00</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg px-3 py-2">
                            <p class="text-xs mb-1">NET TOTAL</p>
                            <p class="text-2xl font-bold" id="summaryNetTotal">‚Çπ0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-2 gap-4">
        <button onclick="generateQuote()" class="px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:shadow-xl font-bold text-lg transition-all">üìÑ Generate Quote</button>
        <button onclick="clearAll()" class="px-6 py-4 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-xl hover:shadow-xl font-bold text-lg transition-all">üóëÔ∏è Clear All</button>
    </div>
</div>

<!-- Products Tab -->   
<div id="productsTab" class="space-y-6 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
            <h2 class="text-2xl font-bold text-gray-800">üì¶ Product Management</h2>
            <div class="flex gap-2 flex-wrap">
                <button onclick="downloadStockReport()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìä Stock
                    Report</button>
                <button onclick="downloadAllProducts()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                    Download All</button>
                <button onclick="downloadSampleExcel()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìã
                    Sample</button>
                <button onclick="showBulkUploadModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">üì§ Bulk
                    Upload</button>
                <button onclick="showAddProductModal()"
                    class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-bold text-sm">‚ûï Add
                    Product</button>
            </div>
        </div>

        <!-- Barcode Scanner for Product Management -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-xl border-2 border-purple-200 mb-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-xl">üì∑</span>
                <h3 class="font-semibold text-gray-800">Quick Add by Barcode</h3>
            </div>
            <input id="productBarcodeInput" type="text" placeholder="Scan barcode to quickly add new product..."
                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            <p class="text-xs text-gray-600 mt-1">Scan a new barcode to auto-fill product form</p>
        </div>

        <!-- Search Bar -->
        <div class="mb-4">
            <input type="text" id="productSearch"
                placeholder="üîç Search by Barcode, SKU, Style Code, or Product Name..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-base"
                oninput="filterProducts()">
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Barcode</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">SKU</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Style Code</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Name</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Size</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Avg Wt</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Metal</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Purity%</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">MC Rate</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Customers Tab -->
        <div id="customersTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üë• Customer Management</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadAllCustomers()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì• Download All</button>
                        <button onclick="downloadSampleCustomerExcel()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìã Sample</button>
                        <button onclick="showBulkUploadCustomerModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">üì§ Bulk Upload</button>
                        <button onclick="showNewCustomerModal()" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-bold text-sm">‚ûï Add Customer</button>
                    </div>
                </div>
                <div id="customersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- ROL Tab -->
        <div id="rolTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üìä Reorder Level (ROL) Management</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadROLReport()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                            Download ROL Report</button>
                        <button onclick="downloadROLSample()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìã
                            Download Sample</button>
                        <button onclick="showROLUploadModal()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">üì§ Upload
                            ROL Data</button>
                    </div>
                </div>
        
                <!-- Filter Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border-2 border-blue-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Style Code</label>
                            <select id="rolStyleCodeFilter" onchange="updateROLDisplay()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Style Codes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter View</label>
                            <select id="rolViewFilter" onchange="updateROLDisplay()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">Show All Items</option>
                                <option value="reorder">Show Only Reorder Required</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="updateROLDisplay()"
                                class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">üîÑ
                                Refresh</button>
                        </div>
                    </div>
                </div>
        
                <!-- ROL Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Items</p>
                        <p class="text-3xl font-bold" id="rolTotalItems">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Reorder Required</p>
                        <p class="text-3xl font-bold" id="rolReorderCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Stock OK</p>
                        <p class="text-3xl font-bold" id="rolStockOK">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Required</p>
                        <p class="text-3xl font-bold" id="rolTotalRequired">0</p>
                    </div>
                </div>
        
                <!-- ROL Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Barcode</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Style Code</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Product Name</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">ROL Set</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Available</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Required</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rolTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Quotations History Tab -->
        <div id="quotationsTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üìú Quotation History</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadAllQuotations()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                            Export All</button>
                        <button onclick="clearOldQuotations()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">üóëÔ∏è
                            Clear Old</button>
                    </div>
                </div>
        
                <!-- Search and Filter -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border-2 border-blue-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="quotationSearch" onkeyup="filterQuotations()"
                                placeholder="üîç Search by Quote No, Customer..."
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Customer</label>
                            <select id="quotationCustomerFilter" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Customers</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Date</label>
                            <select id="quotationDateFilter" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                </div>
        
                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Quotations</p>
                        <p class="text-3xl font-bold" id="quotationTotalCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Value</p>
                        <p class="text-2xl font-bold" id="quotationTotalValue">‚Çπ0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">This Month</p>
                        <p class="text-3xl font-bold" id="quotationMonthCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Today</p>
                        <p class="text-3xl font-bold" id="quotationTodayCount">0</p>
                    </div>
                </div>
        
                <!-- Quotations Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Quote No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Items</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">GST</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Net Total</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="quotationsTableBody"></tbody>
                    </table>
                </div>
        
                <!-- Empty State -->
                <div id="quotationsEmptyState" class="text-center py-12 hidden">
                    <div class="text-6xl mb-4">üìã</div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">No Quotations Yet</h3>
                    <p class="text-gray-500">Generate your first quotation from the Billing tab</p>
                </div>
            </div>
        </div>

        <!-- Sales Bill Tab -->
        <div id="salesbillTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">üí∞ Sales Bill</h2>
        
                <!-- Step 1: Select Quotation -->
                <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <h3 class="font-semibold text-blue-900 mb-3">Step 1: Select Quotation to Convert</h3>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">Select Quotation</label>
                            <select id="selectQuotationForBill" class="w-full border rounded px-3 py-2"
                                onchange="loadQuotationForBill()">
                                <option value="">-- Select a Quotation --</option>
                            </select>
                        </div>
                        <button onclick="refreshQuotationsList()"
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            üîÑ Refresh List
                        </button>
                    </div>
                </div>
        
                <!-- Quotation Details Display (Hidden by default) -->
                <div id="selectedQuotationDetails" class="hidden mb-6 p-4 bg-gray-50 border rounded">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <span class="text-sm text-gray-600">Quotation No:</span>
                            <div class="font-semibold text-lg" id="selectedQuotNo"></div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">Customer:</span>
                            <div class="font-semibold" id="selectedQuotCustomer"></div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">Total Amount:</span>
                            <div class="font-semibold text-green-600" id="selectedQuotAmount"></div>
                        </div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Items:</span>
                        <div class="font-medium" id="selectedQuotItems"></div>
                    </div>
                </div>
        
                <!-- Current Rates Display -->
                <div id="billRatesSection" class="hidden mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
                    <h3 class="font-semibold mb-2">üìä Current Rates</h3>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>Gold: <span id="billGoldRate" class="font-semibold"></span></div>
                        <div>Silver: <span id="billSilverRate" class="font-semibold"></span></div>
                        <div>Platinum: <span id="billPlatinumRate" class="font-semibold"></span></div>
                    </div>
                </div>
        
                <!-- Step 2: Rate Slab Selection -->
                <div id="billRateSlabSection" class="hidden mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded">
                    <h3 class="font-semibold text-green-900 mb-3">Step 2: Select Rate Slab (Optional Discount)</h3>
                    <div class="flex gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium mb-2">Rate Slab</label>
                            <select id="billRateSlab" class="border rounded px-3 py-2" onchange="updateBillRateSlabInfo()">
                                <option value="R">R - Standard Rate</option>
                                <option value="R1">R1 - MC Discount ‚Çπ2/gm</option>
                                <option value="R2">R2 - MC Discount ‚Çπ5/gm</option>
                                <option value="R3">R3 - MC Discount ‚Çπ10/gm</option>
                                <option value="R4">R4 - MC Discount ‚Çπ15/gm</option>
                            </select>
                        </div>
                        <div class="flex-1 text-sm">
                            <div>Selected: <span id="billRateSlabDisplay" class="font-semibold">R</span></div>
                            <div class="text-gray-600" id="billRateSlabDesc">Standard Rate</div>
                        </div>
                    </div>
                </div>
        
                <!-- Items Table -->
                <div id="billItemsTableContainer" class="hidden mb-6">
                    <h3 class="font-semibold mb-3">üì¶ Bill Items</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="border px-4 py-2">#</th>
                                    <th class="border px-4 py-2">Item Name</th>
                                    <th class="border px-4 py-2">Weight (gm)</th>
                                    <th class="border px-4 py-2">Rate</th>
                                    <th class="border px-4 py-2">MC Rate</th>
                                    <th class="border px-4 py-2">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="billItemsTableBody"></tbody>
                        </table>
                    </div>
                </div>
        
                <!-- Bill Summary -->
                <div id="billSummarySection" class="hidden mb-6 p-4 bg-gray-100 rounded">
                    <h3 class="font-semibold mb-3">üí∞ Bill Summary</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="billSummaryTotal" class="font-semibold">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>GST (3%):</span>
                            <span id="billSummaryGst">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-green-600 border-t pt-2">
                            <span>Net Total:</span>
                            <span id="billSummaryNetTotal">‚Çπ0.00</span>
                        </div>
                    </div>
                </div>
        
                <!-- Action Buttons -->
                <div id="billActionsSection" class="hidden flex gap-4">
                    <button onclick="generateSalesBill()"
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                        üìÑ Generate Bill
                    </button>
                    <button onclick="clearBillSelection()"
                        class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">
                        üîÑ Clear & Start New
                    </button>
                </div>
            </div>
        </div>

        <!-- Bill History Tab -->
        <div id="billHistoryTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üí∞ Sales Bill History</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadAllBills()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                            Export All</button>
                        <button onclick="clearOldBills()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">üóëÔ∏è
                            Clear Old</button>
                    </div>
                </div>
        
                <!-- Search and Filter -->
                <div class="bg-gradient-to-r from-green-50 to-teal-50 p-4 rounded-xl border-2 border-green-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="billSearch" onkeyup="filterBills()"
                                placeholder="üîç Search by Bill No, Customer..."
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Customer</label>
                            <select id="billCustomerFilter" onchange="filterBills()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="all">All Customers</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Date</label>
                            <select id="billDateFilter" onchange="filterBills()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                </div>
        
                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Bills</p>
                        <p class="text-3xl font-bold" id="billTotalCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Revenue</p>
                        <p class="text-2xl font-bold" id="billTotalValue">‚Çπ0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">This Month</p>
                        <p class="text-3xl font-bold" id="billMonthCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Today</p>
                        <p class="text-3xl font-bold" id="billTodayCount">0</p>
                    </div>
                </div>
        
                <!-- Bills Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Bill No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Items</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">GST</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Net Total</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billsTableBody"></tbody>
                    </table>
                </div>
        
                <!-- Empty State -->
                <div id="billsEmptyState" class="text-center py-12 hidden">
                    <div class="text-6xl mb-4">üí∞</div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">No Bills Yet</h3>
                    <p class="text-gray-500">Generate your first sales bill from the Sales Bill tab</p>
                </div>
            </div>
        </div>

        <!-- Accounts Ledger Tab -->
<div id="ledgerTab" class="space-y-6 hidden">
    <!-- Dashboard Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Cash Balance</p>
            <p class="text-3xl font-bold" id="ledgerCashBalance">‚Çπ0</p>
            <p class="text-xs mt-1">üíµ Available Cash</p>
        </div>
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Bank Balance</p>
            <p class="text-3xl font-bold" id="ledgerBankBalance">‚Çπ0</p>
            <p class="text-xs mt-1">üè¶ Total in Banks</p>
        </div>
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Receivables</p>
            <p class="text-3xl font-bold" id="ledgerReceivables">‚Çπ0</p>
            <p class="text-xs mt-1">üì• To Collect</p>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Payables</p>
            <p class="text-3xl font-bold" id="ledgerPayables">‚Çπ0</p>
            <p class="text-xs mt-1">üì§ To Pay</p>
        </div>
    </div>

    <!-- Metal Stock Overview -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Metal Inventory (Weight)</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                <p class="text-sm text-gray-600">Gold Stock</p>
                <p class="text-2xl font-bold text-yellow-600" id="ledgerGoldStock">0g</p>
                <p class="text-xs text-gray-500 mt-1" id="ledgerGoldValue">Value: ‚Çπ0</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                <p class="text-sm text-gray-600">Silver Stock</p>
                <p class="text-2xl font-bold text-gray-600" id="ledgerSilverStock">0g</p>
                <p class="text-xs text-gray-500 mt-1" id="ledgerSilverValue">Value: ‚Çπ0</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                <p class="text-sm text-gray-600">Platinum Stock</p>
                <p class="text-2xl font-bold text-purple-600" id="ledgerPlatinumStock">0g</p>
                <p class="text-xs text-gray-500 mt-1" id="ledgerPlatinumValue">Value: ‚Çπ0</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
<div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
    <button onclick="showCashEntryModal()"
        class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
        üíµ Cash Entry
    </button>
    <button onclick="showBankEntryModal()"
        class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
        üè¶ Bank Entry
    </button>
    <button onclick="showLedgerCustomerAccounts()"
        class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
        üë• Customer Accounts
    </button>
    <button onclick="showLedgerTransactions()"
        class="px-4 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium">
        üìã All Transactions
    </button>
    <button onclick="showLedgerExpenses()"
        class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
        üí∏ Expenses
    </button>
    <button onclick="showLedgerPurchases()"
        class="px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">
        üõí Metal Purchases
    </button>
</div>

    <!-- Subtabs Container -->
    <div id="ledgerSubtabs">
        <!-- Will be populated by subtab functions -->
    </div>
</div>

    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
        onclick="event.target === this && closeModals()"></div>
    
    <!-- Rates Modal -->
    <div id="ratesModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">Update Metal Rates</h3>
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4">
                <p class="text-sm text-yellow-800">‚ö†Ô∏è Updating rates will automatically recalculate all items in current
                    bill</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Gold Rate (per gram)</label>
                    <input type="number" id="rateGold" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Silver Rate (per gram)</label>
                    <input type="number" id="rateSilver" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Platinum Rate (per gram)</label>
                    <input type="number" id="ratePlatinum" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveRates()"
                        class="flex-1 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-medium">Save
                        Rates</button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div id="addProductModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-2xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4" id="productModalTitle">Add New Product</h3>
            <input type="hidden" id="editProductIndex" value="">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Barcode *</label>
                    <input type="text" id="newBarcode" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">SKU</label>
                    <input type="text" id="newSku" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Style Code</label>
                    <input type="text" id="newStyleCode" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Metal Type *</label>
                    <select id="newMetalType" class="w-full px-3 py-2 border rounded-lg">
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                        <option value="platinum">Platinum</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-sm font-medium mb-1">Product Name *</label>
                    <input type="text" id="newShortName" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Size</label>
                    <input type="text" id="newSize" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Average Weight (gm)</label>
                    <input type="number" step="0.01" id="newAvgWt" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Purity (%) *</label>
                    <input type="number" step="0.1" id="newPurity" value="100" class="w-full px-3 py-2 border rounded-lg"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">MC Rate (per gram) *</label>
                    <input type="number" step="0.01" id="newMcRate" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div class="col-span-2 flex gap-3">
                    <button onclick="saveProduct()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">üíæ Save
                        Product</button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Upload Products Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üì§ Bulk Upload Products from Excel</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                <p class="text-sm text-blue-700 font-mono">Barcode | SKU | StyleCode | ProductName | Size | AvgWeight |
                    Purity | MCRate | MetalType</p>
                <p class="text-sm text-blue-700 mt-2"><strong>MetalType:</strong> Must be "gold", "silver", or "platinum"
                </p>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden"
                    onchange="handleExcelUpload(event)">
                <button onclick="document.getElementById('excelFileInput').click()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg">
                    üìÅ Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">Click "Sample" button first to download template</p>
            </div>
            <div id="uploadPreview" class="hidden">
                <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 rows):</h4>
                <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left">Barcode</th>
                                <th class="px-2 py-2 text-left">Name</th>
                                <th class="px-2 py-2 text-left">Metal</th>
                                <th class="px-2 py-2 text-left">Purity</th>
                                <th class="px-2 py-2 text-left">MC Rate</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody"></tbody>
                    </table>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmBulkUpload()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Upload <span id="uploadCount"></span> Products
                    </button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4" id="customerModalTitle">Add New Customer</h3>
            <input type="hidden" id="editCustomerIndex" value="">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Customer Name *</label>
                    <input type="text" id="newCustName" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address Line 1</label>
                    <input type="text" id="newCustAddress1" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address Line 2</label>
                    <input type="text" id="newCustAddress2" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">City & Pincode</label>
                    <input type="text" id="newCustCity" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Mobile Number *</label>
                    <input type="tel" id="newCustMobile" class="w-full px-3 py-2 border rounded-lg" maxlength="10" required>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveCustomer()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">üíæ Save
                        Customer</button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Upload Customers Modal -->
    <div id="bulkUploadCustomerModal"
        class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üì§ Bulk Upload Customers from Excel</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                <p class="text-sm text-blue-700 font-mono">Name | Address1 | Address2 | City | Mobile</p>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                <input type="file" id="excelCustomerFileInput" accept=".xlsx,.xls" class="hidden"
                    onchange="handleCustomerExcelUpload(event)">
                <button onclick="document.getElementById('excelCustomerFileInput').click()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg">
                    üìÅ Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">Click "Sample" button first to download template</p>
            </div>
            <div id="uploadCustomerPreview" class="hidden">
                <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 rows):</h4>
                <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left">Name</th>
                                <th class="px-2 py-2 text-left">Address</th>
                                <th class="px-2 py-2 text-left">City</th>
                                <th class="px-2 py-2 text-left">Mobile</th>
                            </tr>
                        </thead>
                        <tbody id="previewCustomerTableBody"></tbody>
                    </table>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmBulkUploadCustomer()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Upload <span id="uploadCustomerCount"></span> Customers
                    </button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>

<!-- Quotation Format Selection Modal -->
<div id="quotationFormatModal"
    class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üìÑ Generate Quotation</h3>
        
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
            <p class="text-sm text-blue-800 font-medium mb-2">üí° Payment Options:</p>
            <p class="text-xs text-blue-700">Select whether payment was received for this quotation</p>
        </div>
        
        <div class="space-y-3">
            <div class="border-2 border-gray-200 rounded-lg p-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" name="paymentOption" value="cash" id="paymentCash" class="w-5 h-5">
                    <div>
                        <div class="font-bold text-gray-800">üíµ Cash Received</div>
                        <div class="text-sm text-gray-600">Payment received immediately</div>
                    </div>
                </label>
            </div>
            
            <div class="border-2 border-gray-200 rounded-lg p-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" name="paymentOption" value="credit" id="paymentCredit" checked class="w-5 h-5">
                    <div>
                        <div class="font-bold text-gray-800">üìã Credit Sale</div>
                        <div class="text-sm text-gray-600">Payment pending (will bill later)</div>
                    </div>
                </label>
            </div>
            
            <button onclick="generateQuotePDFWithPayment()"
                class="w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Generate Quotation
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Stock Report Format Selection Modal -->
<div id="stockReportModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üìä Stock Report Options</h3>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
            <select id="stockReportType"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="detailed">Detailed Report (All Fields)</option>
                <option value="summary">Summary Report (Key Info Only)</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Metal Type</label>
            <select id="stockMetalFilter"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="all">All Metals</option>
                <option value="gold">Gold Only</option>
                <option value="silver">Silver Only</option>
                <option value="platinum">Platinum Only</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Style Code</label>
            <select id="stockStyleCodeFilter"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="all">All Style Codes</option>
            </select>
        </div>

        <h4 class="text-sm font-semibold text-gray-700 mb-2">Choose Format:</h4>
        <div class="space-y-3">
            <button onclick="downloadStockReportPDF()"
                class="w-full px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Download as PDF
            </button>
            <button onclick="downloadStockReportExcel()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìó</span> Download as Excel
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
                </div>
            </div>
        </div>

    <!-- ROL Upload Modal -->
    <div id="rolUploadModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üì§ Upload ROL Data from Excel</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                <p class="text-sm text-blue-700 font-mono">Barcode | StyleCode | ProductName | ROL</p>
                <p class="text-sm text-blue-700 mt-2"><strong>Note:</strong> Barcode must match existing products</p>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                <input type="file" id="rolExcelFileInput" accept=".xlsx,.xls" class="hidden"
                    onchange="handleROLExcelUpload(event)">
                <button onclick="document.getElementById('rolExcelFileInput').click()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg">
                    üìÅ Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">Click "Download Sample" first to see the format</p>
            </div>
            <div id="rolUploadPreview" class="hidden">
                <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 rows):</h4>
                <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left">Barcode</th>
                                <th class="px-2 py-2 text-left">Style Code</th>
                                <th class="px-2 py-2 text-left">Product Name</th>
                                <th class="px-2 py-2 text-center">ROL</th>
                            </tr>
                        </thead>
                        <tbody id="rolPreviewTableBody"></tbody>
                    </table>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmROLUpload()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Upload <span id="rolUploadCount"></span> ROL Items
                    </button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Quotation Details Modal -->
    <div id="viewQuotationModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="viewQuotationTitle">Quotation Details</h3>
                <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
    
            <!-- Customer Info -->
            <div class="bg-amber-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-bold" id="viewQuotCustomer"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date</p>
                        <p class="font-bold" id="viewQuotDate"></p>
                    </div>
                </div>
            </div>
    
            <!-- Items Table -->
            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-left">#</th>
                            <th class="px-2 py-2 text-left">Item</th>
                            <th class="px-2 py-2 text-right">Weight</th>
                            <th class="px-2 py-2 text-right">Rate</th>
                            <th class="px-2 py-2 text-right">MC</th>
                            <th class="px-2 py-2 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="viewQuotItemsBody"></tbody>
                </table>
            </div>
    
            <!-- Totals -->
            <div class="bg-gradient-to-br from-amber-100 to-orange-100 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Total:</span>
                    <span class="font-bold" id="viewQuotTotal"></span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">GST (3%):</span>
                    <span class="font-bold" id="viewQuotGST"></span>
                </div>
                <div class="flex justify-between text-lg border-t-2 border-amber-400 pt-2">
                    <span class="font-bold">Net Total:</span>
                    <span class="font-bold text-amber-700" id="viewQuotNetTotal"></span>
                </div>
            </div>
    
            <!-- Actions -->
            <!-- Actions -->
<div class="flex gap-3 mt-4">
    <button onclick="reprintQuotationPDF()"
        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
        üìï Download PDF
    </button>
    <button onclick="closeModals()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
        Close
    </button>
</div>
        </div>
    </div>

<!-- Bill Format Selection Modal -->
<div id="billFormatModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üí∞ Generate Sales Bill</h3>
        <p class="text-gray-600 mb-4">Bill will be saved and PDF will be downloaded.</p>
        <div class="space-y-3">
            <button onclick="generateSalesBillPDF()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Generate PDF Bill
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>
 
    <!-- View Bill Details Modal -->
    <div id="viewBillModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Bill Details - <span id="viewBillNo"></span></h3>
                <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
    
            <!-- Customer Info -->
            <div class="bg-green-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-bold" id="viewBillCustomerName"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date</p>
                        <p class="font-bold" id="viewBillDate"></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Address</p>
                        <p class="text-sm" id="viewBillCustomerAddress"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Mobile</p>
                        <p class="text-sm" id="viewBillCustomerMobile"></p>
                    </div>
                </div>
                <div class="mt-2">
                    <p class="text-sm text-gray-600">Rate Slab: <span class="font-semibold" id="viewBillRateSlab"></span>
                    </p>
                </div>
            </div>
    
            <!-- Items Table -->
            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-left">#</th>
                            <th class="px-2 py-2 text-left">SKU</th>
                            <th class="px-2 py-2 text-left">Style Code</th>
                            <th class="px-2 py-2 text-left">Item</th>
                            <th class="px-2 py-2 text-center">Size</th>
                            <th class="px-2 py-2 text-right">Weight</th>
                            <th class="px-2 py-2 text-center">Purity</th>
                            <th class="px-2 py-2 text-right">Rate</th>
                            <th class="px-2 py-2 text-right">MC</th>
                            <th class="px-2 py-2 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="viewBillItemsTableBody"></tbody>
                </table>
            </div>
    
            <!-- Totals -->
            <div class="bg-gradient-to-br from-green-100 to-teal-100 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Total:</span>
                    <span class="font-bold" id="viewBillTotal"></span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">GST (3%):</span>
                    <span class="font-bold" id="viewBillGST"></span>
                </div>
                <div class="flex justify-between text-lg border-t-2 border-green-400 pt-2">
                    <span class="font-bold">Net Total:</span>
                    <span class="font-bold text-green-700" id="viewBillNetTotal"></span>
                </div>
            </div>
    
            <!-- Actions -->
            <div class="flex gap-3 mt-4">
                <button onclick="reprintBill(document.getElementById('viewBillModal').getAttribute('data-bill-index'))"
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                    üñ®Ô∏è Reprint
                </button>
                <button onclick="closeModals()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Convert Quotation to Bill Modal -->
    <div id="convertQuotModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üîÑ Convert to Sales Bill</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <p class="text-sm text-blue-800">This will create a new sales bill from this quotation.</p>
            </div>
            <div class="space-y-3">
                <button onclick="confirmConvertToBill()"
                    class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg">
                    ‚úÖ Convert to Bill
                </button>
                <button onclick="closeModals()"
                    class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Reprint Format Modal -->
<div id="reprintFormatModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üñ®Ô∏è Reprint Bill</h3>
        <p class="text-gray-600 mb-4">Bill will be downloaded as PDF</p>
        <input type="hidden" id="reprintBillIndex" value="">
        <div class="space-y-3">
            <button onclick="reprintBillPDF()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Download PDF
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Cash Entry Modal -->
<div id="cashEntryModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üíµ Cash Entry</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Entry Type *</label>
                <select id="cashEntryType" onchange="updateCashEntryFields()" class="w-full px-3 py-2 border rounded-lg">
                    <option value="cash_in">Cash In (Received)</option>
                    <option value="cash_out">Cash Out (Paid)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                <input type="number" step="0.01" id="cashEntryAmount" 
                    placeholder="0.00"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Category *</label>
                <select id="cashEntryCategory" class="w-full px-3 py-2 border rounded-lg">
                    <option value="Sales">Sales</option>
                    <option value="Purchase">Purchase</option>
                    <option value="Customer Payment">Customer Payment</option>
                    <option value="Supplier Payment">Supplier Payment</option>
                    <option value="Owner Investment">Owner Investment</option>
                    <option value="Loan">Loan</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Description *</label>
                <textarea id="cashEntryDescription" rows="2" 
                    placeholder="Enter details about this cash transaction"
                    class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Reference/Receipt No</label>
                <input type="text" id="cashEntryReference" 
                    placeholder="Optional"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Date</label>
                <input type="date" id="cashEntryDate" 
                    value="${new Date().toISOString().split('T')[0]}"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div class="flex gap-3">
                <button onclick="saveCashEntry()" 
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    üíæ Save Entry
                </button>
                <button onclick="closeCashEntryModal()" 
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

    <script>
        let items = [];
        let rates = JSON.parse(localStorage.getItem('rates') || '{"gold":7500,"silver":156,"platinum":3500}');
        let customers = JSON.parse(localStorage.getItem('customers') || '[]');
        let products = JSON.parse(localStorage.getItem('products') || '[]');
        let currentCustomer = null;
        let quotationCounter = parseInt(localStorage.getItem('quotationCounter') || '1');
        let bulkUploadData = [];
        let bulkUploadCustomerData = [];
        let currentRateSlab = 'R'; 
        const rateSlabDiscounts = {  
                'R': 0,
                'R1': 2,
                'R2': 5,
                'R3': 10,
                'R4': 15
            };
        let rolData = JSON.parse(localStorage.getItem('rolData') || '[]');
        let bulkUploadROLData = [];

        // ========== ACCOUNTS LEDGER DATA STRUCTURES ==========

            // Core ledger storage
            let ledgerTransactions = JSON.parse(localStorage.getItem('ledgerTransactions') || '[]');
            let cashBook = JSON.parse(localStorage.getItem('cashBook') || '[]');
            let bankAccounts = JSON.parse(localStorage.getItem('bankAccounts') || '[]');
            let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            let metalPurchases = JSON.parse(localStorage.getItem('metalPurchases') || '[]');
            let suppliers = JSON.parse(localStorage.getItem('suppliers') || '[]');

            // Account balances
            let accountBalances = JSON.parse(localStorage.getItem('accountBalances') || JSON.stringify({
                cash: 0,
                bank: 0,
                receivables: 0,
                payables: 0,
                goldStock: 0,
                silverStock: 0,
                platinumStock: 0
            }));

            // Expense categories
            const expenseCategories = [
                'Rent',
                'Salaries',
                'Electricity',
                'Marketing',
                'Transportation',
                'Office Supplies',
                'Maintenance',
                'Insurance',
                'Professional Fees',
                'Miscellaneous'
            ];

            // Transaction types
            const transactionTypes = {
                SALE: 'sale',
                PURCHASE: 'purchase',
                EXPENSE: 'expense',
                CASH_IN: 'cash_in',
                CASH_OUT: 'cash_out',
                BANK_DEPOSIT: 'bank_deposit',
                BANK_WITHDRAWAL: 'bank_withdrawal',
                PAYMENT_RECEIVED: 'payment_received',
                PAYMENT_MADE: 'payment_made'
            };

            // Function to generate unique transaction ID
            function generateTransactionId() {
                return 'TXN' + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            }

            // Function to record ledger transaction
            function recordLedgerTransaction(type, data) {
    const transaction = {
        id: generateTransactionId(),
        type: type,
        date: data.date || new Date().toISOString(),
        amount: data.amount || 0,
        description: data.description || '',
        category: data.category || '',
        paymentMethod: data.paymentMethod || 'Cash',
        reference: data.reference || '',
        customerName: data.customerName || '',
        customerMobile: data.customerMobile || '',
        billNo: data.billNo || '',
        supplier: data.supplier || '',
        metalType: data.metalType || '',
        weight: data.weight || 0
    };

    ledgerTransactions.unshift(transaction);
    localStorage.setItem('ledgerTransactions', JSON.stringify(ledgerTransactions));

    // Don't auto-update balances here - let calling functions handle it
    return transaction;
}

            // Function to update account balances
            function updateAccountBalances(type, data) {
                switch (type) {
                    case transactionTypes.SALE:
                        accountBalances.cash += data.amount;
                        accountBalances.receivables += data.amount;
                        break;
                    case transactionTypes.PURCHASE:
                        accountBalances.cash -= data.amount;
                        accountBalances.payables += data.amount;
                        break;
                    case transactionTypes.EXPENSE:
                        accountBalances.cash -= data.amount;
                        break;
                    case transactionTypes.CASH_IN:
                        accountBalances.cash += data.amount;
                        break;
                    case transactionTypes.CASH_OUT:
                        accountBalances.cash -= data.amount;
                        break;
                    case transactionTypes.BANK_DEPOSIT:
                        accountBalances.cash -= data.amount;
                        accountBalances.bank += data.amount;
                        break;
                    case transactionTypes.BANK_WITHDRAWAL:
                        accountBalances.bank -= data.amount;
                        accountBalances.cash += data.amount;
                        break;
                    case transactionTypes.PAYMENT_RECEIVED:
                        accountBalances.cash += data.amount;
                        accountBalances.receivables -= data.amount;
                        break;
                    case transactionTypes.PAYMENT_MADE:
                        accountBalances.cash -= data.amount;
                        accountBalances.payables -= data.amount;
                        break;
                }

                localStorage.setItem('accountBalances', JSON.stringify(accountBalances));
            }

        // Product inventory tracking
let soldProducts = JSON.parse(localStorage.getItem('soldProducts') || '[]');

// Function to mark product as sold
function markProductAsSold(barcode, billNo) {
    soldProducts.push({
        barcode: barcode,
        billNo: billNo,
        soldDate: new Date().toISOString()
    });
    localStorage.setItem('soldProducts', JSON.stringify(soldProducts));
}

// Function to check if product is sold
function isProductSold(barcode) {
    return soldProducts.find(sp => sp.barcode === barcode);
}

// Function to remove sold product from inventory
function removeProductFromInventory(barcode) {
    const productIndex = products.findIndex(p => p.barcode === barcode);
    if (productIndex >= 0) {
        products.splice(productIndex, 1);
        localStorage.setItem('products', JSON.stringify(products));
    }
}

        let savedQuotations = JSON.parse(localStorage.getItem('savedQuotations') || '[]');
        let currentViewingQuotation = null;
        // New variables added for sales bill
        let billItems = [];
        let currentBillCustomer = null;
        let billCounter = parseInt(localStorage.getItem('billCounter') || '1');
        let currentBillRateSlab = 'R';
        let savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
        let currentViewingBill = null;
        let quotationToConvert = null;

        // ========== SALES BILL - CONVERT QUOTATION TO BILL ==========

            let selectedQuotationForBill = null;
            

            function refreshQuotationsList() {
                const select = document.getElementById('selectQuotationForBill');
                select.innerHTML = '<option value="">-- Select a Quotation --</option>';

                if (savedQuotations.length === 0) {
                    alert('No quotations available. Please create a quotation first.');
                    return;
                }

                savedQuotations.forEach((quot, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = `${quot.quotationNo} - ${quot.customer.name} - ‚Çπ${quot.netTotal.toFixed(2)}`;
                    select.appendChild(option);
                });
            }

function loadQuotationForBill() {
    const idx = document.getElementById('selectQuotationForBill').value;

    if (idx === '') {
        // Hide all sections
        document.getElementById('selectedQuotationDetails').classList.add('hidden');
        document.getElementById('billRatesSection').classList.add('hidden');
        document.getElementById('billRateSlabSection').classList.add('hidden');
        document.getElementById('billItemsTableContainer').classList.add('hidden');
        document.getElementById('billSummarySection').classList.add('hidden');
        document.getElementById('billActionsSection').classList.add('hidden');
        selectedQuotationForBill = null;
        billItems = [];
        return;
    }

    selectedQuotationForBill = savedQuotations[idx];
    
    // Check if already billed
    if (selectedQuotationForBill.isBilled) {
        const billDate = new Date(selectedQuotationForBill.billDate).toLocaleDateString('en-GB');
        alert(`‚ö†Ô∏è This quotation (${selectedQuotationForBill.quotationNo}) has already been billed!\n\nBill No: ${selectedQuotationForBill.billNo || 'Unknown'}\nBill Date: ${billDate}\n\nPlease select a different quotation.`);
        document.getElementById('selectQuotationForBill').value = '';
        
        // Clear all sections
        document.getElementById('selectedQuotationDetails').classList.add('hidden');
        document.getElementById('billRatesSection').classList.add('hidden');
        document.getElementById('billRateSlabSection').classList.add('hidden');
        document.getElementById('billItemsTableContainer').classList.add('hidden');
        document.getElementById('billSummarySection').classList.add('hidden');
        document.getElementById('billActionsSection').classList.add('hidden');
        selectedQuotationForBill = null;
        billItems = [];
        return;
    }

    // Display quotation details
    document.getElementById('selectedQuotNo').textContent = selectedQuotationForBill.quotationNo;
    document.getElementById('selectedQuotCustomer').textContent = selectedQuotationForBill.customer.name;
    document.getElementById('selectedQuotAmount').textContent = `‚Çπ${selectedQuotationForBill.netTotal.toFixed(2)}`;
    document.getElementById('selectedQuotItems').textContent =
        selectedQuotationForBill.items.map(item => `${item.name} (${item.weight.toFixed(2)}g)`).join(', ');

    document.getElementById('selectedQuotationDetails').classList.remove('hidden');

    // Show current rates
    updateBillRatesDisplay();
    document.getElementById('billRatesSection').classList.remove('hidden');

    // Show rate slab section
    document.getElementById('billRateSlab').value = selectedQuotationForBill.rateSlab || 'R';
    currentBillRateSlab = selectedQuotationForBill.rateSlab || 'R';
    updateBillRateSlabInfo();
    document.getElementById('billRateSlabSection').classList.remove('hidden');

    // Load items from quotation with current rates
billItems = selectedQuotationForBill.items.map(item => {
    const currentRate = rates[item.metalType] || rates.silver;
    const originalMCRate = item.originalMcRate || item.mcRate;
    const adjustedMCRate = getBillAdjustedMCRate(originalMCRate);
    const amount = (currentRate + adjustedMCRate) * item.weight;
    
    return {
        ...item,
        rate: currentRate,
        mcRate: adjustedMCRate,
        originalMcRate: originalMCRate,
        amount: amount,
        barcode: item.barcode || null
    };
});

    // Recalculate with current rates and rate slab
    recalculateBillItems();

    // Show items table and summary
    document.getElementById('billItemsTableContainer').classList.remove('hidden');
    document.getElementById('billSummarySection').classList.remove('hidden');
    document.getElementById('billActionsSection').classList.remove('hidden');
}

            function updateBillRatesDisplay() {
                document.getElementById('billGoldRate').textContent = `‚Çπ${rates.gold}/gm`;
                document.getElementById('billSilverRate').textContent = `‚Çπ${rates.silver}/gm`;
                document.getElementById('billPlatinumRate').textContent = `‚Çπ${rates.platinum}/gm`;
            }

            function updateBillRateSlabInfo() {
                currentBillRateSlab = document.getElementById('billRateSlab').value;

                document.getElementById('billRateSlabDisplay').textContent = currentBillRateSlab;

                const descriptions = {
                    'R': 'Standard Rate',
                    'R1': 'MC Discount ‚Çπ2/gm',
                    'R2': 'MC Discount ‚Çπ5/gm',
                    'R3': 'MC Discount ‚Çπ10/gm',
                    'R4': 'MC Discount ‚Çπ15/gm'
                };

                document.getElementById('billRateSlabDesc').textContent = descriptions[currentBillRateSlab];

                if (billItems.length > 0) {
                    recalculateBillItems();
                }
            }

            function getBillAdjustedMCRate(originalMCRate) {
                const discount = rateSlabDiscounts[currentBillRateSlab];
                return Math.max(0, originalMCRate - discount);
            }

            function recalculateBillItems() {
                billItems.forEach(item => {
                    // Update with current metal rate
                    const currentRate = rates[item.metalType] || rates.silver;
                    item.rate = currentRate;

                    // Apply rate slab discount to MC
                    const originalMCRate = item.originalMcRate || item.mcRate;
                    const adjustedMCRate = getBillAdjustedMCRate(originalMCRate);

                    // Recalculate amount
                    item.amount = (item.rate + adjustedMCRate) * item.weight;
                    item.mcRate = adjustedMCRate;
                    item.originalMcRate = originalMCRate;
                });

                updateBillItemsTable();
                updateBillSummary();
            }

            function updateBillItemsTable() {
                const tbody = document.getElementById('billItemsTableBody');
                tbody.innerHTML = '';

                billItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
            <td class="px-4 py-3">${index + 1}</td>
            <td class="px-4 py-3 font-medium">${item.name}</td>
            <td class="px-4 py-3 text-right">${item.weight.toFixed(2)}</td>
            <td class="px-4 py-3 text-right">‚Çπ${item.rate}</td>
            <td class="px-4 py-3 text-right">‚Çπ${item.mcRate.toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-semibold">‚Çπ${item.amount.toFixed(2)}</td>
        `;
                    tbody.appendChild(row);
                });
            }

            function updateBillSummary() {
                const total = billItems.reduce((sum, item) => sum + item.amount, 0);
                const gst = total * 0.03;
                const netTotal = total + gst;

                document.getElementById('billSummaryTotal').textContent = `‚Çπ${total.toFixed(2)}`;
                document.getElementById('billSummaryGst').textContent = `‚Çπ${gst.toFixed(2)}`;
                document.getElementById('billSummaryNetTotal').textContent = `‚Çπ${netTotal.toFixed(2)}`;
            }

            function clearBillSelection() {
                if (confirm('Clear current selection and start new bill?')) {
                    document.getElementById('selectQuotationForBill').value = '';
                    loadQuotationForBill();
                }
            }

            function generateSalesBill() {
                    if (billItems.length === 0) {
                        alert('‚ö†Ô∏è Please load a quotation first');
                        return;
                    }
                    if (!selectedQuotationForBill) {
                        alert('‚ö†Ô∏è No quotation selected');
                        return;
                    }
                    // Show format selection modal
                    document.getElementById('modalOverlay').classList.remove('hidden');
                    document.getElementById('modalOverlay').classList.add('flex');
                    document.getElementById('billFormatModal').classList.remove('hidden');
                }

function generateSalesBillPDF() {
    if (billItems.length === 0) {
        alert('‚ö†Ô∏è No items to bill');
        return;
    }
    if (!selectedQuotationForBill) {
        alert('‚ö†Ô∏è No quotation selected');
        return;
    }

    const total = billItems.reduce((sum, item) => sum + item.amount, 0);
    const gst = total * 0.03;
    const cgst = gst / 2;
    const sgst = gst / 2;
    const netTotal = total + gst;
    const billNo = `SCB${String(billCounter).padStart(4, '0')}`;
    const date = new Date();

    // SAVE BILL TO HISTORY
    const billRecord = {
    id: Date.now(),
    billNo: billNo,
    quotationNo: selectedQuotationForBill.quotationNo,
    date: date.toISOString(),
    customer: selectedQuotationForBill.customer,
    items: JSON.parse(JSON.stringify(billItems)),
    total: total,
    gst: gst,
    netTotal: netTotal,
    rateSlab: currentBillRateSlab,
    paymentStatus: selectedQuotationForBill.paymentReceived ? 'paid' : 'unpaid',
    paidAmount: selectedQuotationForBill.paymentReceived ? netTotal : 0,
    linkedQuotation: selectedQuotationForBill.id
};

    savedBills.unshift(billRecord);
    localStorage.setItem('savedBills', JSON.stringify(savedBills));

    // Mark products as sold and update barcodes
billItems.forEach(item => {
    if (item.barcode) {
        // Mark as sold
        if (!soldProducts.find(sp => sp.barcode === item.barcode)) {
            markProductAsSold(item.barcode, billNo);
        }
        // Remove from inventory
        removeProductFromInventory(item.barcode);
    }
});

// √¢¬≠ AUTOMATIC LEDGER ENTRY FOR SALE
const ledgerEntry = recordLedgerTransaction(transactionTypes.SALE, {
    billNo: billNo,
    customerName: selectedQuotationForBill.customer.name,
    customerMobile: selectedQuotationForBill.customer.mobile,
    amount: netTotal,
    items: billItems.length,
    description: `Sales Bill ${billNo} - ${selectedQuotationForBill.customer.name}`,
    category: 'Sales Revenue',
    paymentMethod: selectedQuotationForBill.paymentReceived ? 'Cash' : 'Credit',
    reference: billNo,
    date: date.toISOString()
});

// Update cash/receivables based on quotation payment status
if (selectedQuotationForBill.paymentReceived) {
    // Payment was already received during quotation
    accountBalances.cash += netTotal;
} else {
    // Credit sale - increase receivables
    accountBalances.receivables += netTotal;
}

// Update metal stock levels (DEDUCT sold items)
billItems.forEach(item => {
    const weightInGrams = item.weight;
    if (item.metalType === 'gold') {
        accountBalances.goldStock = Math.max(0, accountBalances.goldStock - weightInGrams);
    } else if (item.metalType === 'silver') {
        accountBalances.silverStock = Math.max(0, accountBalances.silverStock - weightInGrams);
    } else if (item.metalType === 'platinum') {
        accountBalances.platinumStock = Math.max(0, accountBalances.platinumStock - weightInGrams);
    }
});

localStorage.setItem('accountBalances', JSON.stringify(accountBalances));

    // Update ledger dashboard if visible
if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
    updateLedgerDashboard();
    showLedgerCustomerAccounts(); // Refresh customer accounts
}

    // Update products table if visible
    if (!document.getElementById('productsTab').classList.contains('hidden')) {
        updateProductsTable();
    }

    // MARK QUOTATION AS BILLED
    const quotIndex = savedQuotations.findIndex(q => q.id === selectedQuotationForBill.id);
    if (quotIndex >= 0) {
        savedQuotations[quotIndex].isBilled = true;
        savedQuotations[quotIndex].billNo = billNo;
        savedQuotations[quotIndex].billDate = date.toISOString();
        localStorage.setItem('savedQuotations', JSON.stringify(savedQuotations));
    }

    // ========== PDF GENERATION (MATCHING SAMPLE) ==========
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
    const customer = selectedQuotationForBill.customer;
    const totalWeight = billItems.reduce((sum, item) => sum + item.weight, 0);
    const totalPCS = billItems.length;

    // ========== HEADER ==========
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('JP JEWELLERY', 105, 15, { align: 'center' });

    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.text('2ND FLOOR, OLD NO.34, NEW NO.21, BOTHRA EMPORIUM', 105, 20, { align: 'center' });
    doc.text('VEERAPPAN STREET, SOWCARPET', 105, 24, { align: 'center' });
    doc.text('CHENNAI 600079 | 044-43593474', 105, 28, { align: 'center' });

    doc.setFont(undefined, 'bold');
    doc.text('TAX INVOICE', 105, 35, { align: 'center' });
    doc.text('33AADFJ4897R1ZJ', 105, 39, { align: 'center' });

    // ========== BILL INFO ==========
    doc.setFontSize(8);
    doc.text('INVOICE No.:', 15, 48);
    doc.setFont(undefined, 'normal');
    doc.text(billNo, 45, 48);

    doc.setFont(undefined, 'bold');
    doc.text('BILL DATE:', 150, 48);
    doc.setFont(undefined, 'normal');
    doc.text(formattedDate, 175, 48);

    // ========== CUSTOMER INFO ==========
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    doc.text(customer.name.toUpperCase(), 15, 60);

    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    let yCustomer = 64;
    if (customer.address1) {
        doc.text(customer.address1, 15, yCustomer);
        yCustomer += 4;
    }
    if (customer.address2) {
        doc.text(customer.address2, 15, yCustomer);
        yCustomer += 4;
    }
    if (customer.city) {
        doc.text(customer.city, 15, yCustomer);
        yCustomer += 4;
    }
    doc.text(`MOB: ${customer.mobile}`, 15, yCustomer);

    // ========== ITEMS TABLE ==========
    const tableStartY = Math.max(yCustomer + 8, 85);

    const tableData = billItems.map((item, idx) => {
        return [
            idx + 1,
            item.name,
            '711311', // HSN Code
            totalPCS,
            item.weight.toFixed(3),
            item.purity.toFixed(1),
            item.rate.toFixed(2),
            item.amount.toFixed(2)
        ];
    });

    doc.autoTable({
        startY: tableStartY,
        head: [['Sl', 'ITEM', 'HSN', 'PCS', 'Weight In Gms', 'Purity', 'Rate', 'TOTAL']],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [220, 220, 220],
            textColor: 0,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: 2
        },
        bodyStyles: {
            fontSize: 7,
            cellPadding: 1.5
        },
        columnStyles: {
            0: { cellWidth: 10, halign: 'center' },
            1: { cellWidth: 60, halign: 'left' },
            2: { cellWidth: 20, halign: 'center' },
            3: { cellWidth: 15, halign: 'center' },
            4: { cellWidth: 25, halign: 'right' },
            5: { cellWidth: 20, halign: 'center' },
            6: { cellWidth: 20, halign: 'right' },
            7: { cellWidth: 25, halign: 'right' }
        },
        margin: { left: 15, right: 15 }
    });

    // ========== TOTALS SECTION ==========
    const finalY = doc.lastAutoTable.finalY + 10;

    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text(`Total PCS: ${totalPCS}`, 15, finalY);
    doc.text(`${totalWeight.toFixed(3)}`, 50, finalY);

    const rightX = 150;
    doc.text('GST Value:', rightX, finalY);
    doc.setFont(undefined, 'normal');
    doc.text(total.toFixed(2), 195, finalY, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('CGST@1.50%:', rightX, finalY + 5);
    doc.setFont(undefined, 'normal');
    doc.text(cgst.toFixed(2), 195, finalY + 5, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('SGST@1.50%:', rightX, finalY + 10);
    doc.setFont(undefined, 'normal');
    doc.text(sgst.toFixed(2), 195, finalY + 10, { align: 'right' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Total Amount:', rightX, finalY + 17);
    doc.text(netTotal.toFixed(2), 195, finalY + 17, { align: 'right' });

    // ========== FOOTER ==========
    const footerY = finalY + 25;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    doc.text('BANK NAME: HDFC BANK', 15, footerY);
    doc.text('AC NAME: JPJEWELLERY', 15, footerY + 4);
    doc.text('AC NO: 50200016402896', 15, footerY + 8);
    doc.text('IFSC CODE: HDFC0000214', 15, footerY + 12);

    doc.setFont(undefined, 'bold');
    doc.text('For JP JEWELLERY', 150, footerY + 10);

    doc.save(`Bill_${billNo}_${formattedDate.replace(/\//g, '-')}.pdf`);

    closeModals();
    alert(`‚úÖ Sales Bill Generated!\n\nBill No: ${billNo}\nQuotation: ${selectedQuotationForBill.quotationNo}\nCustomer: ${customer.name}\n\n${billItems.length} products removed from inventory.\n\nTransaction recorded in Accounts Ledger.`);

    clearBillSelection();
    billCounter++;
    localStorage.setItem('billCounter', billCounter);
}

    function incrementBillCounter() {
        billCounter++;
        localStorage.setItem('billCounter', billCounter);
    }

                        // ========== BILL HISTORY MANAGEMENT ==========
    function loadBillHistory() {
        // Populate customer filter
        const customerFilter = document.getElementById('billCustomerFilter');
        customerFilter.innerHTML = '<option value="all">All Customers</option>';

        const uniqueCustomers = [...new Set(savedBills.map(b => b.customer.name))];
        uniqueCustomers.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            customerFilter.appendChild(option);
        });

        // Update statistics
        updateBillStatistics();

        // Display bills
        displayBills(savedBills);
    }

                            function viewBill(index) {
                                    const bill = savedBills[index];

                                    // Populate bill details modal
                                    document.getElementById('viewBillNo').textContent = bill.billNo;

                                    const date = new Date(bill.date);
                                    document.getElementById('viewBillDate').textContent = date.toLocaleDateString('en-GB');

                                    document.getElementById('viewBillCustomerName').textContent = bill.customer.name;
                                    document.getElementById('viewBillCustomerAddress').textContent =
                                        `${bill.customer.address1}, ${bill.customer.address2}, ${bill.customer.city}`;
                                    document.getElementById('viewBillCustomerMobile').textContent = bill.customer.mobile;
                                    document.getElementById('viewBillRateSlab').textContent = bill.rateSlab || 'R';

                                    // Populate items table
                                    const tbody = document.getElementById('viewBillItemsTableBody');
                                    tbody.innerHTML = '';

                                    bill.items.forEach((item, idx) => {
                                        const row = document.createElement('tr');
                                        row.className = 'border-b';
                                        row.innerHTML = `
            <td class="px-4 py-2">${idx + 1}</td>
            <td class="px-4 py-2">${item.sku || '-'}</td>
            <td class="px-4 py-2">${item.styleCode || '-'}</td>
            <td class="px-4 py-2 font-medium">${item.name}</td>
            <td class="px-4 py-2 text-center">${item.size || '-'}</td>
            <td class="px-4 py-2 text-right">${item.weight.toFixed(2)}</td>
            <td class="px-4 py-2 text-center">${item.purity.toFixed(0)}%</td>
            <td class="px-4 py-2 text-right">‚Çπ${item.rate}</td>
            <td class="px-4 py-2 text-right">‚Çπ${item.mcRate.toFixed(2)}</td>
            <td class="px-4 py-2 text-right font-semibold">‚Çπ${item.amount.toFixed(2)}</td>
        `;
                                        tbody.appendChild(row);
                                    });

                                    // Summary
                                    document.getElementById('viewBillTotal').textContent = `‚Çπ${bill.total.toFixed(2)}`;
                                    document.getElementById('viewBillGst').textContent = `‚Çπ${bill.gst.toFixed(2)}`;
                                    document.getElementById('viewBillNetTotal').textContent = `‚Çπ${bill.netTotal.toFixed(2)}`;

                                    // Store current bill index for reprint
                                    document.getElementById('viewBillModal').setAttribute('data-bill-index', index);

                                    // Show modal
                                    document.getElementById('modalOverlay').classList.remove('hidden');
                                    document.getElementById('modalOverlay').classList.add('flex');
                                    document.getElementById('viewBillModal').classList.remove('hidden');
                                }

                                function reprintBill(index) {
                                        const bill = savedBills[index];

                                        // Show reprint format modal
                                        document.getElementById('reprintBillIndex').value = index;
                                        document.getElementById('modalOverlay').classList.remove('hidden');
                                        document.getElementById('modalOverlay').classList.add('flex');
                                        document.getElementById('reprintFormatModal').classList.remove('hidden');
                                    }

                                    function reprintBillPDF() {
                                        const index = parseInt(document.getElementById('reprintBillIndex').value);
                                        const bill = savedBills[index];

                                        // PDF Generation
                                        const { jsPDF } = window.jspdf;
                                        const doc = new jsPDF('p', 'mm', 'a4');

                                        const totalWeight = bill.items.reduce((sum, item) => sum + item.weight, 0);
                                        const totalMC = bill.items.reduce((sum, item) => sum + (item.weight * item.mcRate), 0);
                                        const totalPCS = bill.items.length;
                                        const date = new Date(bill.date).toLocaleDateString('en-GB');

                                        // Customer info
                                        doc.setFontSize(9);
                                        doc.setFont(undefined, 'normal');
                                        doc.text('To:', 15, 15);
                                        doc.setFont(undefined, 'bold');
                                        doc.setFontSize(10);
                                        doc.text(bill.customer.name.toUpperCase(), 15, 20);

                                        doc.setFontSize(8);
                                        doc.setFont(undefined, 'normal');
                                        let yPos = 24;
                                        if (bill.customer.address1) {
                                            doc.text(bill.customer.address1, 15, yPos);
                                            yPos += 4;
                                        }
                                        if (bill.customer.address2) {
                                            doc.text(bill.customer.address2, 15, yPos);
                                            yPos += 4;
                                        }
                                        if (bill.customer.city) {
                                            doc.text(bill.customer.city, 15, yPos);
                                            yPos += 4;
                                        }
                                        doc.text(`Mob: ${bill.customer.mobile}`, 15, yPos);

                                        // Bill info
                                        doc.setFontSize(8);
                                        doc.setFont(undefined, 'bold');
                                        doc.text('BILL No:', 160, 15);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(bill.billNo, 180, 15);
                                        doc.setFont(undefined, 'bold');
                                        doc.text('Date:', 160, 20);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(date, 180, 20);

                                        // Add REPRINT watermark
                                        doc.setFontSize(10);
                                        doc.setFont(undefined, 'bold');
                                        doc.setTextColor(255, 0, 0);
                                        doc.text('REPRINT', 160, 25);
                                        doc.setTextColor(0, 0, 0);

                                        // Items table
                                        const tableStartY = yPos + 8;
                                        const tableData = bill.items.map((item, idx) => {
    // CORRECT CALCULATION: (Rate + MC) √ó Weight
    const itemTotal = (item.rate + item.mcRate) * item.weight;
    
    return [
        idx + 1,
        item.sku || '-',
        item.styleCode || '-',
        item.name,
        item.size || '-',
        item.weight.toFixed(2),
        item.weight.toFixed(2),
        item.purity.toFixed(0),
        item.weight.toFixed(2),
        '1',
        item.mcRate.toFixed(2),
        item.rate.toFixed(0),
        itemTotal.toFixed(2)
    ];
});

                                        doc.autoTable({
                                            startY: tableStartY,
                                            head: [[
                                                '#', 'SKU', 'STYLE CODE', 'Short Name', 'SIZE',
                                                'NET.WT', 'AVG.WT', '% Pure', 'G.WT', 'PCS',
                                                'MC/gm', 'RATE', 'Amount'
                                            ]],
                                            body: tableData,
                                            theme: 'grid',
                                            headStyles: {
                                                fillColor: [34, 197, 94],
                                                textColor: 255,
                                                fontSize: 7,
                                                fontStyle: 'bold',
                                                halign: 'center',
                                                valign: 'middle',
                                                cellPadding: 1.5
                                            },
                                            bodyStyles: {
                                                fontSize: 7,
                                                cellPadding: 1,
                                                valign: 'middle'
                                            },
                                            columnStyles: {
                                                0: { cellWidth: 8, halign: 'center' },
                                                1: { cellWidth: 20, halign: 'left', fontSize: 6.5 },
                                                2: { cellWidth: 16, halign: 'center', fontSize: 6.5 },
                                                3: { cellWidth: 38, halign: 'left' },
                                                4: { cellWidth: 12, halign: 'center' },
                                                5: { cellWidth: 13, halign: 'right' },
                                                6: { cellWidth: 13, halign: 'right' },
                                                7: { cellWidth: 11, halign: 'center' },
                                                8: { cellWidth: 11, halign: 'right' },
                                                9: { cellWidth: 9, halign: 'center' },
                                                10: { cellWidth: 12, halign: 'right' },
                                                11: { cellWidth: 12, halign: 'right' },
                                                12: { cellWidth: 16, halign: 'right' }
                                            },
                                            margin: { left: 15, right: 14 }
                                        });

                                        // Grand total section
                                        const finalY = doc.lastAutoTable.finalY + 8;
                                        doc.setDrawColor(0);
                                        doc.setLineWidth(0.5);
                                        doc.rect(15, finalY, 180, 25);
                                        doc.line(105, finalY, 105, finalY + 25);

                                        // Left side
                                        doc.setFontSize(8);
                                        doc.setFont(undefined, 'bold');
                                        doc.text('COUNT:', 18, finalY + 6);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(totalPCS.toString(), 45, finalY + 6);
                                        doc.setFont(undefined, 'bold');
                                        doc.text('Total Weight:', 18, finalY + 12);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(`${totalWeight.toFixed(2)} gm`, 45, finalY + 12);
                                        doc.setFont(undefined, 'bold');
                                        doc.text('MC:', 18, finalY + 18);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(totalMC.toFixed(2), 45, finalY + 18);

                                        // Right side
                                        doc.setFontSize(9);
                                        doc.setFont(undefined, 'bold');
                                        doc.text('GRAND TOTAL', 110, finalY + 5);
                                        doc.setFontSize(8);
                                        doc.text('TOTAL:', 110, finalY + 11);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(bill.total.toFixed(2), 190, finalY + 11, { align: 'right' });
                                        doc.setFont(undefined, 'bold');
                                        doc.text('GST:', 110, finalY + 16);
                                        doc.setFont(undefined, 'normal');
                                        doc.text(bill.gst.toFixed(2), 190, finalY + 16, { align: 'right' });
                                        doc.setFont(undefined, 'bold');
                                        doc.text('NET TOTAL:', 110, finalY + 21);
                                        doc.text(bill.netTotal.toFixed(2), 190, finalY + 21, { align: 'right' });

                                        doc.save(`Bill_${bill.billNo}_REPRINT_${date.replace(/\//g, '-')}.pdf`);

                                        closeModals();
                                        alert('Bill reprinted successfully (PDF)!');
                                    }

        // INITIAL DATA LOAD

        if (products.length === 0) {
            products = [
                { id: 1, barcode: '1001', sku: 'RING-22K-001', styleCode: '4001', shortName: 'Gold Ring 22K', size: '18', avgWt: 4.5, purity: 91.6, mcRate: 250, metalType: 'gold' },
                { id: 2, barcode: '1002', sku: 'CHAIN-22K-002', styleCode: '4002', shortName: 'Gold Chain 22K', size: '20', avgWt: 15.3, purity: 91.6, mcRate: 200, metalType: 'gold' },
                { id: 3, barcode: '1003', sku: 'IDOL-SF-001', styleCode: '4265', shortName: 'Silver Idol', size: '270', avgWt: 17.47, purity: 100, mcRate: 173.69, metalType: 'silver' }
            ];
            localStorage.setItem('products', JSON.stringify(products));
        }

        document.addEventListener('DOMContentLoaded', function () {
                updateRatesDisplay();
                updateCustomerDropdown();
                updateProductsTable();
                updateRateSlabInfo(); 
                updateBillCustomerDropdown();
                updateCashEntryFields();

                // Billing barcode scanner
                document.getElementById('barcodeInput').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        handleBarcodeScan(this.value.trim());
                        this.value = '';
                    }
                });
                document.getElementById('billBarcodeInput').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    handleBillBarcodeScan(this.value.trim());
                    this.value = '';
                }
            });

                // Product Management barcode scanner
                const productBarcodeInput = document.getElementById('productBarcodeInput');
                if (productBarcodeInput) {
                    productBarcodeInput.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            handleProductBarcodeScan(this.value.trim());
                            this.value = '';
                        }
                    });
                }

                ['itemWeight', 'itemRate', 'itemMcRate', 'itemPurity'].forEach(id => {
                    document.getElementById(id).addEventListener('input', updateItemAmount);
                });

                // ADDED BILL ITEM LISTENERS
            ['billItemWeight', 'billItemRate', 'billItemMcRate', 'billItemPurity'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateBillItemAmount);
            });    

            // Initialize Sales Bill Tab
            refreshQuotationsList();
            updateBillCustomerDropdown();

                // Initial focus on barcode scanner
                document.getElementById('barcodeInput').focus();
                // Initialize ledger dashboard
                updateLedgerDashboard();

                // Initialize Ledger Dashboard on load
updateLedgerDashboard();
showLedgerCustomerAccounts(); // Set default view
            });

            function updateBillCustomerDropdown() {
                    const select = document.getElementById('billCustomerSelect');
                    if (!select) return;

                    select.innerHTML = '<option value="">-- Select Customer --</option>';
                    customers.forEach((customer, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                }

        function showTab(tab) {
                // Hide all tabs
                document.getElementById('billingTab').classList.add('hidden');
                document.getElementById('productsTab').classList.add('hidden');
                document.getElementById('customersTab').classList.add('hidden');
                document.getElementById('rolTab').classList.add('hidden');
                document.getElementById('quotationsTab').classList.add('hidden');
                document.getElementById('salesbillTab').classList.add('hidden'); // ADD
                document.getElementById('billHistoryTab').classList.add('hidden'); // ADD
                document.getElementById('ledgerTab').classList.add('hidden'); // ADD THIS

                // Reset all buttons
                document.getElementById('btnBilling').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnProducts').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnCustomers').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnROL').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnQuotations').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnSalesBill').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition'; // ADD
                document.getElementById('btnBillHistory').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                    document.getElementById('btnLedger').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition'; // ADD THIS

                if (tab === 'billing') {
                    document.getElementById('billingTab').classList.remove('hidden');
                    document.getElementById('btnBilling').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                } else if (tab === 'products') {
                    document.getElementById('productsTab').classList.remove('hidden');
                    document.getElementById('btnProducts').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateProductsTable();
                } else if (tab === 'customers') {
                    document.getElementById('customersTab').classList.remove('hidden');
                    document.getElementById('btnCustomers').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadCustomersDisplay();
                } else if (tab === 'rol') {
                    document.getElementById('rolTab').classList.remove('hidden');
                    document.getElementById('btnROL').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    initializeROL();
                    updateROLDisplay();
                } else if (tab === 'quotations') {
                    document.getElementById('quotationsTab').classList.remove('hidden');
                    document.getElementById('btnQuotations').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadQuotationsHistory();
                } else if (tab === 'salesbill') { // ADD THIS BLOCK
                    document.getElementById('salesbillTab').classList.remove('hidden');
                    document.getElementById('btnSalesBill').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateBillRatesDisplay();
                    setTimeout(() => {
                        document.getElementById('billBarcodeInput').focus();
                    }, 100);
                } else if (tab === 'billhistory') {
                    document.getElementById('billHistoryTab').classList.remove('hidden');
                    document.getElementById('btnBillHistory').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadBillHistory();
                } else if (tab === 'ledger') {
                    document.getElementById('ledgerTab').classList.remove('hidden');
                    document.getElementById('btnLedger').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateLedgerDashboard();
                    showLedgerCustomerAccounts(); // Show customer accounts by default
                }
            }

        function updateRatesDisplay() {
            document.getElementById('goldRate').textContent = `‚Çπ${rates.gold}/gm`;
            document.getElementById('silverRate').textContent = `‚Çπ${rates.silver}/gm`;
            document.getElementById('platinumRate').textContent = `‚Çπ${rates.platinum}/gm`;
        }

        function showRatesModal() {
            document.getElementById('rateGold').value = rates.gold;
            document.getElementById('rateSilver').value = rates.silver;
            document.getElementById('ratePlatinum').value = rates.platinum;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('ratesModal').classList.remove('hidden');
        }

        function saveRates() {
            rates.gold = parseFloat(document.getElementById('rateGold').value) || 0;
            rates.silver = parseFloat(document.getElementById('rateSilver').value) || 0;
            rates.platinum = parseFloat(document.getElementById('ratePlatinum').value) || 0;
            localStorage.setItem('rates', JSON.stringify(rates));
            updateRatesDisplay();
            let updatedCount = 0;
            items.forEach(item => {
                if (item.metalType) {
                    const newRate = rates[item.metalType];
                    if (newRate) {
                        item.rate = newRate;
                        item.amount = (item.rate + adjustedMCRate) * item.weight;
                        updatedCount++;
                    }
                }
            });
            if (updatedCount > 0) {
                updateItemsTable();
                updateSummary();
            }
            closeModals();
            alert(`Rates updated!${updatedCount > 0 ? ` ${updatedCount} items recalculated.` : ''}`);
        }

        function updateCustomerDropdown() {
            const select = document.getElementById('customerSelect');
            select.innerHTML = '<option value="">-- Select Customer --</option>';
            customers.forEach((customer, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }

        function loadCustomerDetails() {
                const idx = document.getElementById('customerSelect').value;
                if (idx === '') {
                    document.getElementById('customerDetailsDisplay').classList.add('hidden');
                    document.getElementById('customerMobile').value = '';
                    currentCustomer = null;
                    return;
                }
                currentCustomer = customers[idx];
                document.getElementById('custName').textContent = currentCustomer.name;
                document.getElementById('custAddress').textContent = `${currentCustomer.address1}, ${currentCustomer.address2}, ${currentCustomer.city}`;
                document.getElementById('customerMobile').value = currentCustomer.mobile;
                document.getElementById('customerDetailsDisplay').classList.remove('hidden');

                // Update rate slab display
                updateRateSlabInfo();

                // Recalculate all items with new rate slab
                if (items.length > 0) {
                    recalculateAllItems();
                }
            }
            
            function updateRateSlabInfo() {
                    currentRateSlab = document.getElementById('rateSlab').value;
                    const discount = rateSlabDiscounts[currentRateSlab];

                    document.getElementById('rateSlabDisplay').textContent = currentRateSlab;

                    const descriptions = {
                        'R': 'Standard Rate',
                        'R1': 'MC Discount ‚Çπ2/gm',
                        'R2': 'MC Discount ‚Çπ5/gm',
                        'R3': 'MC Discount ‚Çπ10/gm',
                        'R4': 'MC Discount ‚Çπ15/gm'
                    };

                    document.getElementById('rateSlabDesc').textContent = descriptions[currentRateSlab];

                    // Recalculate all items if any exist
                    if (items.length > 0) {
                        recalculateAllItems();
                    }

                    // Update current item amount if form is filled
                    updateItemAmount();
                }

                function getAdjustedMCRate(originalMCRate) {
                    const discount = rateSlabDiscounts[currentRateSlab];
                    const adjustedRate = Math.max(0, originalMCRate - discount);
                    return adjustedRate;
                }

                function recalculateAllItems() {
                    items.forEach(item => {
                        // Get original MC rate (stored separately)
                        const originalMCRate = item.originalMcRate || item.mcRate;
                        const adjustedMCRate = getAdjustedMCRate(originalMCRate);

                        item.amount = (item.rate + adjustedMCRate) * item.weight;
                        item.mcRate = adjustedMCRate;
                        item.originalMcRate = originalMCRate; // Store original for future recalculations
                    });
                     updateItemsTable();
                    updateSummary();
                }

        function showNewCustomerModal() {
            document.getElementById('customerModalTitle').textContent = 'Add New Customer';
            document.getElementById('editCustomerIndex').value = '';
            document.getElementById('newCustName').value = '';
            document.getElementById('newCustAddress1').value = '';
            document.getElementById('newCustAddress2').value = '';
            document.getElementById('newCustCity').value = '';
            document.getElementById('newCustMobile').value = '';
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        function editCustomer(idx) {
            const customer = customers[idx];
            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('editCustomerIndex').value = idx;
            document.getElementById('newCustName').value = customer.name;
            document.getElementById('newCustAddress1').value = customer.address1 || '';
            document.getElementById('newCustAddress2').value = customer.address2 || '';
            document.getElementById('newCustCity').value = customer.city || '';
            document.getElementById('newCustMobile').value = customer.mobile;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        function saveCustomer() {
            const customer = {
                name: document.getElementById('newCustName').value.trim(),
                address1: document.getElementById('newCustAddress1').value.trim(),
                address2: document.getElementById('newCustAddress2').value.trim(),
                city: document.getElementById('newCustCity').value.trim(),
                mobile: document.getElementById('newCustMobile').value.trim()
            };
            if (!customer.name || !customer.mobile) {
                alert('Please fill Name and Mobile Number');
                return;
            }
            const editIndex = document.getElementById('editCustomerIndex').value;
            if (editIndex !== '') {
                customers[editIndex] = customer;
                alert('Customer updated!');
            } else {
                customers.push(customer);
                alert('Customer added!');
            }
            localStorage.setItem('customers', JSON.stringify(customers));
            updateCustomerDropdown();
            loadCustomersDisplay();
            closeModals();
        }

        function deleteCustomer(idx) {
            if (!confirm('Delete this customer?')) return;
            customers.splice(idx, 1);
            localStorage.setItem('customers', JSON.stringify(customers));
            updateCustomerDropdown();
            loadCustomersDisplay();
            alert('Customer deleted!');
        }

        function loadCustomersDisplay() {
            const container = document.getElementById('customersList');
            container.innerHTML = '';
            if (customers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-8">No customers yet.</p>';
                return;
            }
            customers.forEach((customer, idx) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg border hover:shadow-lg transition';
                card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-gray-800">${customer.name}</h3>
                            <div class="flex gap-2">
                                <button onclick="editCustomer(${idx})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">‚úèÔ∏è</button>
                                <button onclick="deleteCustomer(${idx})" class="text-red-600 hover:text-red-800 text-sm font-medium">üóëÔ∏è</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">${customer.address1}</p>
                        <p class="text-sm text-gray-600">${customer.address2}</p>
                        <p class="text-sm text-gray-600">${customer.city}</p>
                        <p class="text-sm text-blue-600 font-medium mt-2">üì± ${customer.mobile}</p>
                    `;
                container.appendChild(card);
            });
        }

    function updateProductsTable() {
        const searchTerm = document.getElementById('productSearch') ? document.getElementById('productSearch').value.toLowerCase().trim() : '';
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = '';

        let displayProducts = products;

        // Apply search filter if search term exists
        if (searchTerm) {
            displayProducts = products.filter(product => {
                return (
                    (product.barcode && product.barcode.toLowerCase().includes(searchTerm)) ||
                    (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.styleCode && product.styleCode.toLowerCase().includes(searchTerm)) ||
                    (product.shortName && product.shortName.toLowerCase().includes(searchTerm)) ||
                    (product.metalType && product.metalType.toLowerCase().includes(searchTerm))
                );
            });
        }

        if (displayProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">No products found.</td></tr>';
            return;
        }

        displayProducts.forEach((product) => {
            const originalIdx = products.findIndex(p => p.id === product.id);
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';
            row.innerHTML = `
            <td class="px-4 py-3 font-mono text-sm">${product.barcode}</td>
            <td class="px-4 py-3 text-sm">${product.sku || '-'}</td>
            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${product.styleCode || '-'}</td>
            <td class="px-4 py-3 font-medium">${product.shortName}</td>
            <td class="px-4 py-3 text-sm">${product.size || '-'}</td>
            <td class="px-4 py-3 text-sm">${(product.avgWt || 0).toFixed(2)}g</td>
            <td class="px-4 py-3 capitalize text-sm">${product.metalType}</td>
            <td class="px-4 py-3 text-sm">${product.purity}%</td>
            <td class="px-4 py-3 text-sm">‚Çπ${product.mcRate}</td>
            <td class="px-4 py-3 text-center">
                <button onclick="editProduct(${originalIdx})" class="text-blue-600 hover:text-blue-800 font-medium mr-2">‚úèÔ∏è</button>
                <button onclick="deleteProduct(${originalIdx})" class="text-red-600 hover:text-red-800 font-medium">üóëÔ∏è</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase().trim();

            if (!searchTerm) {
                updateProductsTable();
                return;
            }

            const tbody = document.getElementById('productsTableBody');
            tbody.innerHTML = '';

            const filteredProducts = products.filter(product => {
                const searchableFields = [
                    product.barcode || '',
                    product.sku || '',
                    product.styleCode || '',
                    product.shortName || '',
                    product.metalType || '',
                    product.size || ''
                ].map(field => field.toString().toLowerCase());

                return searchableFields.some(field => field.includes(searchTerm));
            });

            if (filteredProducts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">No products found matching your search.</td></tr>';
                return;
            }

            filteredProducts.forEach((product) => {
                const originalIdx = products.findIndex(p => p.id === product.id);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
            <td class="px-4 py-3 font-mono text-sm">${product.barcode}</td>
            <td class="px-4 py-3 text-sm">${product.sku || '-'}</td>
            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${product.styleCode || '-'}</td>
            <td class="px-4 py-3 font-medium">${product.shortName}</td>
            <td class="px-4 py-3 text-sm">${product.size || '-'}</td>
            <td class="px-4 py-3 text-sm">${(product.avgWt || 0).toFixed(2)}g</td>
            <td class="px-4 py-3 capitalize text-sm">${product.metalType}</td>
            <td class="px-4 py-3 text-sm">${product.purity}%</td>
            <td class="px-4 py-3 text-sm">‚Çπ${product.mcRate}</td>
            <td class="px-4 py-3 text-center">
                <button onclick="editProduct(${originalIdx})" class="text-blue-600 hover:text-blue-800 font-medium mr-2">‚úèÔ∏è</button>
                <button onclick="deleteProduct(${originalIdx})" class="text-red-600 hover:text-red-800 font-medium">üóëÔ∏è</button>
            </td>
        `;
                tbody.appendChild(row);
            });
        }

    function downloadStockReport() {
            if (products.length === 0) {
                alert('No products in inventory to generate report!');
                return;
            }

            // Populate style code filter
            const styleCodeFilter = document.getElementById('stockStyleCodeFilter');
            styleCodeFilter.innerHTML = '<option value="all">All Style Codes</option>';

            const uniqueStyleCodes = [...new Set(products.map(p => p.styleCode).filter(s => s && s.trim() !== ''))];
            uniqueStyleCodes.sort().forEach(styleCode => {
                const option = document.createElement('option');
                option.value = styleCode;
                option.textContent = styleCode;
                styleCodeFilter.appendChild(option);
            });

            // Show format selection modal
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('stockReportModal').classList.remove('hidden');
        }

        function getFilteredProducts() {
                const metalFilter = document.getElementById('stockMetalFilter').value;
                const styleCodeFilter = document.getElementById('stockStyleCodeFilter').value;

                let filtered = products;

                // Apply metal filter
                if (metalFilter !== 'all') {
                    filtered = filtered.filter(p => p.metalType === metalFilter);
                }

                // Apply style code filter
                if (styleCodeFilter !== 'all') {
                    filtered = filtered.filter(p => p.styleCode === styleCodeFilter);
                }

                return filtered;
            }

        function downloadStockReportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape'); // Landscape for better table fit

                const reportType = document.getElementById('stockReportType').value;
                const metalFilter = document.getElementById('stockMetalFilter').value;
                const filteredProducts = getFilteredProducts();

                if (filteredProducts.length === 0) {
                    alert('No products found for selected filter!');
                    return;
                }

                const date = new Date().toLocaleDateString('en-GB');

                // Header
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('STOCK INVENTORY REPORT', 148, 15, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${date}`, 148, 22, { align: 'center' });
            doc.text(`Total Items: ${filteredProducts.length}`, 148, 28, { align: 'center' });

            let yPosFilter = 34;
            if (metalFilter !== 'all') {
                doc.text(`Metal Filter: ${metalFilter.toUpperCase()}`, 148, yPosFilter, { align: 'center' });
                yPosFilter += 5;
            }

            const styleCodeFilter = document.getElementById('stockStyleCodeFilter').value;
            if (styleCodeFilter !== 'all') {
                doc.text(`Style Code: ${styleCodeFilter}`, 148, yPosFilter, { align: 'center' });
                yPosFilter += 5;
            }

                // Calculate totals
                const totalsByMetal = {};
                filteredProducts.forEach(p => {
                    if (!totalsByMetal[p.metalType]) {
                        totalsByMetal[p.metalType] = { count: 0, weight: 0 };
                    }
                    totalsByMetal[p.metalType].count++;
                    totalsByMetal[p.metalType].weight += (p.avgWt || 0);
                });

                let tableData, tableHeaders;

                if (reportType === 'detailed') {
                    tableHeaders = [['#', 'Barcode', 'SKU', 'Style Code', 'Product Name', 'Size', 'Avg Wt (gm)', 'Purity %', 'MC Rate', 'Metal Type']];
                    tableData = filteredProducts.map((p, idx) => [
                        idx + 1,
                        p.barcode,
                        p.sku || '-',
                        p.styleCode || '-',
                        p.shortName,
                        p.size || '-',
                        (p.avgWt || 0).toFixed(2),
                        p.purity.toFixed(1),
                        p.mcRate.toFixed(2),
                        p.metalType.toUpperCase()
                    ]);
                } else {
                    tableHeaders = [['#', 'Barcode', 'Product Name', 'Metal Type', 'Purity %', 'Avg Wt (gm)', 'MC Rate']];
                    tableData = filteredProducts.map((p, idx) => [
                        idx + 1,
                        p.barcode,
                        p.shortName,
                        p.metalType.toUpperCase(),
                        p.purity.toFixed(1),
                        (p.avgWt || 0).toFixed(2),
                        p.mcRate.toFixed(2)
                    ]);
                }

            const tableStartY = (metalFilter !== 'all' || styleCodeFilter !== 'all') ? 42 : 35;
            doc.autoTable({
                startY: tableStartY,
                    head: tableHeaders,
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [139, 92, 246],
                        textColor: 255,
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { fontSize: 8 },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });

                // Summary at bottom
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('SUMMARY BY METAL TYPE:', 20, finalY);

                let summaryY = finalY + 7;
                doc.setFontSize(9);
                Object.keys(totalsByMetal).forEach(metal => {
                    doc.setFont(undefined, 'bold');
                    doc.text(`${metal.toUpperCase()}:`, 25, summaryY);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${totalsByMetal[metal].count} items, Total Weight: ${totalsByMetal[metal].weight.toFixed(2)} gm`, 60, summaryY);
                    summaryY += 5;
                });

                doc.save(`Stock_Report_${reportType}_${date.replace(/\//g, '-')}.pdf`);
                closeModals();
                alert('Stock Report PDF downloaded successfully!');
            }

            function downloadStockReportExcel() {
                    const reportType = document.getElementById('stockReportType').value;
                    const metalFilter = document.getElementById('stockMetalFilter').value;
                    const filteredProducts = getFilteredProducts();

                    if (filteredProducts.length === 0) {
                        alert('No products found for selected filter!');
                        return;
                    }

                    const date = new Date().toLocaleDateString('en-GB');
                    const wb = XLSX.utils.book_new();

                    // Calculate totals
                    const totalsByMetal = {};
                    filteredProducts.forEach(p => {
                        if (!totalsByMetal[p.metalType]) {
                            totalsByMetal[p.metalType] = { count: 0, weight: 0 };
                        }
                        totalsByMetal[p.metalType].count++;
                        totalsByMetal[p.metalType].weight += (p.avgWt || 0);
                    });

                    // Header section
                    const styleCodeFilter = document.getElementById('stockStyleCodeFilter').value;

                const headerData = [
                    ['STOCK INVENTORY REPORT'],
                    [''],
                    ['Generated Date:', date],
                    ['Total Items:', filteredProducts.length],
                    ['Metal Filter:', metalFilter === 'all' ? 'All Metals' : metalFilter.toUpperCase()],
                    ['Style Code Filter:', styleCodeFilter === 'all' ? 'All Style Codes' : styleCodeFilter],
                    ['Report Type:', reportType === 'detailed' ? 'Detailed Report' : 'Summary Report'],
                    ['']
                ];

                    let productData;

                    if (reportType === 'detailed') {
                        productData = filteredProducts.map((p, idx) => ({
                            '#': idx + 1,
                            'Barcode': p.barcode,
                            'SKU': p.sku || '-',
                            'Style Code': p.styleCode || '-',
                            'Product Name': p.shortName,
                            'Size': p.size || '-',
                            'Avg Weight (gm)': (p.avgWt || 0).toFixed(2),
                            'Purity %': p.purity.toFixed(1),
                            'MC Rate': p.mcRate.toFixed(2),
                            'Metal Type': p.metalType.toUpperCase()
                        }));
                    } else {
                        productData = filteredProducts.map((p, idx) => ({
                            '#': idx + 1,
                            'Barcode': p.barcode,
                            'Product Name': p.shortName,
                            'Metal Type': p.metalType.toUpperCase(),
                            'Purity %': p.purity.toFixed(1),
                            'Avg Weight (gm)': (p.avgWt || 0).toFixed(2),
                            'MC Rate': p.mcRate.toFixed(2)
                        }));
                    }

                    // Convert products to array of arrays
                    const productHeaders = Object.keys(productData[0]);
                    const productRows = productData.map(obj => productHeaders.map(key => obj[key]));

                    // Summary section
                    const summaryData = [
                        [''],
                        ['SUMMARY BY METAL TYPE'],
                        ['Metal Type', 'Count', 'Total Weight (gm)']
                    ];

                    Object.keys(totalsByMetal).forEach(metal => {
                        summaryData.push([
                            metal.toUpperCase(),
                            totalsByMetal[metal].count,
                            totalsByMetal[metal].weight.toFixed(2)
                        ]);
                    });

                    // Combine all data
                    const allData = [
                        ...headerData,
                        productHeaders,
                        ...productRows,
                        ...summaryData
                    ];

                    // Create worksheet
                    const ws = XLSX.utils.aoa_to_sheet(allData);

                    // Set column widths
                    if (reportType === 'detailed') {
                        ws['!cols'] = [
                            { wch: 5 }, { wch: 15 }, { wch: 18 }, { wch: 15 }, { wch: 35 },
                            { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 12 }
                        ];
                    } else {
                        ws['!cols'] = [
                            { wch: 5 }, { wch: 15 }, { wch: 35 }, { wch: 12 },
                            { wch: 10 }, { wch: 15 }, { wch: 10 }
                        ];
                    }

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Stock Report');

                    // Save file
                    XLSX.writeFile(wb, `Stock_Report_${reportType}_${date.replace(/\//g, '-')}.xlsx`);

                    closeModals();
                    alert('Stock Report Excel downloaded successfully!');
                }

        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductIndex').value = '';
            document.getElementById('newBarcode').value = '';
            document.getElementById('newSku').value = '';
            document.getElementById('newStyleCode').value = '';
            document.getElementById('newShortName').value = '';
            document.getElementById('newSize').value = '';
            document.getElementById('newAvgWt').value = '';
            document.getElementById('newPurity').value = '100';
            document.getElementById('newMcRate').value = '';
            document.getElementById('newMetalType').value = 'gold';
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function editProduct(idx) {
            const product = products[idx];
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('editProductIndex').value = idx;
            document.getElementById('newBarcode').value = product.barcode;
            document.getElementById('newSku').value = product.sku || '';
            document.getElementById('newStyleCode').value = product.styleCode || '';
            document.getElementById('newShortName').value = product.shortName;
            document.getElementById('newSize').value = product.size || '';
            document.getElementById('newAvgWt').value = product.avgWt || '';
            document.getElementById('newPurity').value = product.purity;
            document.getElementById('newMcRate').value = product.mcRate;
            document.getElementById('newMetalType').value = product.metalType;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function saveProduct() {
            const product = {
                barcode: document.getElementById('newBarcode').value.trim(),
                sku: document.getElementById('newSku').value.trim(),
                styleCode: document.getElementById('newStyleCode').value.trim(),
                shortName: document.getElementById('newShortName').value.trim(),
                size: document.getElementById('newSize').value.trim(),
                avgWt: parseFloat(document.getElementById('newAvgWt').value) || 0,
                purity: parseFloat(document.getElementById('newPurity').value) || 100,
                mcRate: parseFloat(document.getElementById('newMcRate').value) || 0,
                metalType: document.getElementById('newMetalType').value
            };
            if (!product.barcode || !product.shortName) {
                alert('Please fill Barcode and Product Name');
                return;
            }
            const editIndex = document.getElementById('editProductIndex').value;
            if (editIndex !== '') {
                product.id = products[editIndex].id;
                products[editIndex] = product;
                alert('Product updated!');
            } else {
                product.id = Date.now();
                products.push(product);
                alert('Product added!');
            }
            localStorage.setItem('products', JSON.stringify(products));
            updateProductsTable();
            closeModals();
        }

        function deleteProduct(idx) {
            if (!confirm('Delete this product?')) return;
            products.splice(idx, 1);
            localStorage.setItem('products', JSON.stringify(products));
            updateProductsTable();
            alert('Product deleted!');
        }

        function downloadAllProducts() {
            if (products.length === 0) {
                alert('No products to download!');
                return;
            }
            const data = products.map(p => ({
                Barcode: p.barcode,
                SKU: p.sku || '',
                StyleCode: p.styleCode || '',
                ProductName: p.shortName,
                Size: p.size || '',
                AvgWeight: p.avgWt || 0,
                Purity: p.purity,
                MCRate: p.mcRate,
                MetalType: p.metalType
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            XLSX.writeFile(wb, 'All_Products_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('Products downloaded!');
        }

        function downloadSampleExcel() {
            const sampleData = [
                { Barcode: '2001', SKU: 'RING-22K-100', StyleCode: '5001', ProductName: 'Gold Ring 22K Design 1', Size: '16', AvgWeight: 3.5, Purity: 91.6, MCRate: 250, MetalType: 'gold' },
                { Barcode: '2002', SKU: 'BANGLE-22K-200', StyleCode: '5002', ProductName: 'Gold Bangle 22K', Size: '2.6', AvgWeight: 25.5, Purity: 91.6, MCRate: 200, MetalType: 'gold' },
                { Barcode: '2003', SKU: 'CHAIN-18K-300', StyleCode: '5003', ProductName: 'Gold Chain 18K', Size: '18', AvgWeight: 12.3, Purity: 75, MCRate: 180, MetalType: 'gold' },
                { Barcode: '2004', SKU: 'IDOL-SF-400', StyleCode: '5004', ProductName: 'Silver Ganesh Idol', Size: '4inch', AvgWeight: 45.2, Purity: 100, MCRate: 150, MetalType: 'silver' }
            ];
            const ws = XLSX.utils.json_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sample Products');
            XLSX.writeFile(wb, 'Sample_Products_Format.xlsx');
            alert('Sample downloaded!');
        }

        function showBulkUploadModal() {
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('excelFileInput').value = '';
            bulkUploadData = [];
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('bulkUploadModal').classList.remove('hidden');
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    if (jsonData.length === 0) {
                        alert('Excel file is empty!');
                        return;
                    }
                    bulkUploadData = jsonData.map((row, idx) => ({
                        id: Date.now() + idx,
                        barcode: String(row.Barcode || row.barcode || '').trim(),
                        sku: String(row.SKU || row.sku || '').trim(),
                        styleCode: String(row.StyleCode || row.styleCode || '').trim(),
                        shortName: String(row.ProductName || row.productName || row.shortName || '').trim(),
                        size: String(row.Size || row.size || '').trim(),
                        avgWt: parseFloat(row.AvgWeight || row.avgWeight || row.avgWt || 0),
                        purity: parseFloat(row.Purity || row.purity || 100),
                        mcRate: parseFloat(row.MCRate || row.mcRate || 0),
                        metalType: String(row.MetalType || row.metalType || 'gold').toLowerCase().trim()
                    }));
                    const tbody = document.getElementById('previewTableBody');
                    tbody.innerHTML = '';
                    bulkUploadData.slice(0, 5).forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                                <td class="px-2 py-2">${item.barcode}</td>
                                <td class="px-2 py-2">${item.shortName}</td>
                                <td class="px-2 py-2 capitalize">${item.metalType}</td>
                                <td class="px-2 py-2">${item.purity}%</td>
                                <td class="px-2 py-2">‚Çπ${item.mcRate}</td>
                            `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('uploadCount').textContent = bulkUploadData.length;
                    document.getElementById('uploadPreview').classList.remove('hidden');
                } catch (error) {
                    alert('Error reading Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmBulkUpload() {
            if (bulkUploadData.length === 0) return;
            const invalidItems = bulkUploadData.filter(item => !item.barcode || !item.shortName);
            if (invalidItems.length > 0) {
                alert(`Error: ${invalidItems.length} items missing Barcode or Name.`);
                return;
            }
            products.push(...bulkUploadData);
            localStorage.setItem('products', JSON.stringify(products));
            updateProductsTable();
            closeModals();
            alert(`Successfully uploaded ${bulkUploadData.length} products!`);
        }

        function downloadAllCustomers() {
            if (customers.length === 0) {
                alert('No customers to download!');
                return;
            }
            const data = customers.map(c => ({
                Name: c.name,
                Address1: c.address1 || '',
                Address2: c.address2 || '',
                City: c.city || '',
                Mobile: c.mobile
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Customers');
            XLSX.writeFile(wb, 'All_Customers_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('Customers downloaded!');
        }

        function downloadSampleCustomerExcel() {
            const sampleData = [
                { Name: 'Rajesh Kumar', Address1: '123 Main Street', Address2: 'T Nagar', City: 'Chennai-600017', Mobile: '9876543210' },
                { Name: 'Priya Sharma', Address1: '456 MG Road', Address2: 'Anna Nagar', City: 'Chennai-600040', Mobile: '9123456789' },
                { Name: 'Vijay Reddy', Address1: '789 Gandhi Street', Address2: 'Adyar', City: 'Chennai-600020', Mobile: '9988776655' }
            ];
            const ws = XLSX.utils.json_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sample Customers');
            XLSX.writeFile(wb, 'Sample_Customers_Format.xlsx');
            alert('Sample downloaded!');
        }

        function showBulkUploadCustomerModal() {
            document.getElementById('uploadCustomerPreview').classList.add('hidden');
            document.getElementById('excelCustomerFileInput').value = '';
            bulkUploadCustomerData = [];
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('bulkUploadCustomerModal').classList.remove('hidden');
        }

        function handleCustomerExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    if (jsonData.length === 0) {
                        alert('Excel file is empty!');
                        return;
                    }
                    bulkUploadCustomerData = jsonData.map(row => ({
                        name: String(row.Name || row.name || '').trim(),
                        address1: String(row.Address1 || row.address1 || '').trim(),
                        address2: String(row.Address2 || row.address2 || '').trim(),
                        city: String(row.City || row.city || '').trim(),
                        mobile: String(row.Mobile || row.mobile || '').trim()
                    }));
                    const tbody = document.getElementById('previewCustomerTableBody');
                    tbody.innerHTML = '';
                    bulkUploadCustomerData.slice(0, 5).forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                                <td class="px-2 py-2">${item.name}</td>
                                <td class="px-2 py-2">${item.address1}, ${item.address2}</td>
                                <td class="px-2 py-2">${item.city}</td>
                                <td class="px-2 py-2">${item.mobile}</td>
                            `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('uploadCustomerCount').textContent = bulkUploadCustomerData.length;
                    document.getElementById('uploadCustomerPreview').classList.remove('hidden');
                } catch (error) {
                    alert('Error reading Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmBulkUploadCustomer() {
            if (bulkUploadCustomerData.length === 0) return;
            const invalidItems = bulkUploadCustomerData.filter(item => !item.name || !item.mobile);
            if (invalidItems.length > 0) {
                alert(`Error: ${invalidItems.length} customers missing Name or Mobile.`);
                return;
            }
            customers.push(...bulkUploadCustomerData);
            localStorage.setItem('customers', JSON.stringify(customers));
            updateCustomerDropdown();
            loadCustomersDisplay();
            closeModals();
            alert(`Successfully uploaded ${bulkUploadCustomerData.length} customers!`);
        }

    function handleBarcodeScan(barcode) {
    if (!barcode) return;

    // Check if product is already sold
    const soldInfo = isProductSold(barcode);
    if (soldInfo) {
        alert(`‚ö†Ô∏è PRODUCT ALREADY SOLD!\n\nBarcode: ${barcode}\nBill No: ${soldInfo.billNo}\nSold Date: ${new Date(soldInfo.soldDate).toLocaleDateString('en-GB')}\n\nThis product cannot be added to quotation.`);
        
        const barcodeInput = document.getElementById('barcodeInput');
        barcodeInput.style.backgroundColor = '#f8d7da';
        barcodeInput.style.borderColor = '#dc3545';
        setTimeout(() => {
            barcodeInput.style.backgroundColor = '';
            barcodeInput.style.borderColor = '';
        }, 1000);
        return;
    }

    const product = products.find(p => p.barcode === barcode);
    if (product) {
        // Check if EXACT SAME BARCODE already exists in current bill
        const existingItemIndex = items.findIndex(item => item.barcode === barcode);

        if (existingItemIndex >= 0) {
            alert(`‚ö†Ô∏è This exact item (Barcode: ${barcode}) is already added!\n${product.shortName}\nSKU: ${product.sku || 'N/A'}\n\nIf you need multiple pieces, edit the quantity manually.`);

            const existingRow = document.getElementById('itemsTableBody').children[existingItemIndex];
            existingRow.style.backgroundColor = '#fff3cd';
            setTimeout(() => {
                existingRow.style.backgroundColor = '';
            }, 1000);

            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').focus();
            return;
        }

        // Auto-populate form
        document.getElementById('itemSku').value = product.sku || '';
        document.getElementById('itemStyleCode').value = product.styleCode || '';
        document.getElementById('itemName').value = product.shortName;
        document.getElementById('itemSize').value = product.size || '';
        document.getElementById('itemWeight').value = product.avgWt || '';
        document.getElementById('itemPurity').value = product.purity;
        document.getElementById('itemMetalType').value = product.metalType;

        const metalRate = rates[product.metalType] || rates.silver;
        document.getElementById('itemRate').value = metalRate;

        const originalMCRate = product.mcRate;
        const adjustedMCRate = getAdjustedMCRate(originalMCRate);
        document.getElementById('itemMcRate').value = adjustedMCRate;
        document.getElementById('itemMcRate').setAttribute('data-original-mc', originalMCRate);

        updateItemAmount();

        // AUTO-ADD ITEM IMMEDIATELY
        const item = {
            barcode: barcode,
            sku: product.sku || '',
            styleCode: product.styleCode || '',
            name: product.shortName,
            size: product.size || '',
            weight: product.avgWt || 0,
            purity: product.purity,
            rate: metalRate,
            mcRate: adjustedMCRate,
            originalMcRate: originalMCRate,
            metalType: product.metalType,
            id: Date.now()
        };

        item.amount = (item.rate + item.mcRate) * item.weight;

        items.push(item);
        updateItemsTable();
        updateSummary();
        clearItemForm();

        const barcodeInput = document.getElementById('barcodeInput');
        barcodeInput.style.backgroundColor = '#d4edda';
        barcodeInput.style.borderColor = '#28a745';
        setTimeout(() => {
            barcodeInput.style.backgroundColor = '';
            barcodeInput.style.borderColor = '';
        }, 300);
    } else {
        alert('Product not found! Please add this product first.');
        const barcodeInput = document.getElementById('barcodeInput');
        barcodeInput.style.backgroundColor = '#f8d7da';
        barcodeInput.style.borderColor = '#dc3545';
        setTimeout(() => {
            barcodeInput.style.backgroundColor = '';
            barcodeInput.style.borderColor = '';
        }, 500);
    }
}

            function handleProductBarcodeScan(barcode) {
                    if (!barcode) return;

                    // Check if product already exists
                    const existingProduct = products.find(p => p.barcode === barcode);
                    if (existingProduct) {
                        alert(`Product already exists!\nBarcode: ${barcode}\nName: ${existingProduct.shortName}`);
                        // Optionally edit the existing product
                        if (confirm('Do you want to edit this product?')) {
                            const idx = products.findIndex(p => p.id === existingProduct.id);
                            editProduct(idx);
                        }
                        return;
                    }

                    // New barcode - open add product modal with barcode pre-filled
                    showAddProductModal();
                    document.getElementById('newBarcode').value = barcode;
                    document.getElementById('newBarcode').style.backgroundColor = '#d4edda';

                    // Success feedback
                    const scanner = document.getElementById('productBarcodeInput');
                    scanner.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        scanner.style.backgroundColor = '';
                        document.getElementById('newBarcode').style.backgroundColor = '';
                    }, 500);

                    // Focus on SKU field
                    setTimeout(() => {
                        document.getElementById('newSku').focus();
                    }, 100);
                }

        function updateItemAmount() {
           const weight = parseFloat(document.getElementById('itemWeight').value) || 0;
           const rate = parseFloat(document.getElementById('itemRate').value) || 0;
           const mcRate = parseFloat(document.getElementById('itemMcRate').value) || 0;
    
          // CORRECT FORMULA: (Rate + MC) √ó Weight
          const total = (rate + mcRate) * weight;
          document.getElementById('itemAmount').textContent = `‚Çπ${total.toFixed(2)}`;
        }

        function addItem() {
                const item = {
                    sku: document.getElementById('itemSku').value,
                    styleCode: document.getElementById('itemStyleCode').value,
                    name: document.getElementById('itemName').value,
                    size: document.getElementById('itemSize').value,
                    weight: parseFloat(document.getElementById('itemWeight').value) || 0,
                    purity: parseFloat(document.getElementById('itemPurity').value) || 100,
                    rate: parseFloat(document.getElementById('itemRate').value) || 0,
                    mcRate: parseFloat(document.getElementById('itemMcRate').value) || 0,
                    originalMcRate: parseFloat(document.getElementById('itemMcRate').getAttribute('data-original-mc')) || parseFloat(document.getElementById('itemMcRate').value) || 0,
                    metalType: document.getElementById('itemMetalType').value
                };

                if (!item.name || !item.weight) {
                    alert('Please fill item name and weight');
                    return;
                }

                // Calculate amount correctly
                item.amount = (item.rate + item.mcRate) * item.weight;
                item.id = Date.now();

                items.push(item);
                updateItemsTable();
                updateSummary();
                clearItemForm();
            }

// ========== TABLE-BASED PRODUCT DISPLAY (Excel-like) ==========

function updateItemsTable() {
    const table = document.getElementById('productsTable');
    const tbody = document.getElementById('productTableBody');
    const emptyState = document.getElementById('emptyProductsState');
    const itemCountSpan = document.getElementById('itemCount');
    const totalItemsSpan = document.getElementById('totalItems');
    
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (items.length === 0) {
        table.classList.add('hidden');
        emptyState.classList.remove('hidden');
        itemCountSpan.textContent = '0 Items';
        if (totalItemsSpan) totalItemsSpan.textContent = '0';
        return;
    }
    
    table.classList.remove('hidden');
    emptyState.classList.add('hidden');
    itemCountSpan.textContent = `${items.length} Item${items.length > 1 ? 's' : ''}`;
    if (totalItemsSpan) totalItemsSpan.textContent = items.length;
    
    items.forEach((item, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-blue-50 transition-colors';
        
        const metalColors = {
            'gold': 'bg-yellow-100 text-yellow-800',
            'silver': 'bg-gray-200 text-gray-800',
            'platinum': 'bg-purple-100 text-purple-800'
        };
        
        const metalColor = metalColors[item.metalType] || 'bg-blue-100 text-blue-800';
        
        row.innerHTML = `
            <td class="px-2 py-3 text-center font-bold text-gray-700 border-r bg-gray-50">${index + 1}</td>
            <td class="px-2 py-3 text-center font-mono text-xs border-r">${item.barcode || '-'}</td>
            <td class="px-3 py-3 text-left font-semibold text-gray-800 border-r">
                ${item.name}
            </td>
            <td class="px-2 py-3 text-center text-xs border-r">${item.sku || '-'}</td>
            <td class="px-2 py-3 text-center text-xs border-r">${item.styleCode || '-'}</td>
            <td class="px-2 py-3 text-center border-r">
                <span class="px-2 py-1 rounded text-xs font-bold ${metalColor}">
                    ${item.metalType.toUpperCase()}
                </span>
            </td>
            <td class="px-2 py-3 text-center text-xs border-r">${item.size || '-'}</td>
            <td class="px-2 py-3 border-r bg-blue-50">
                <input type="number" step="0.01" value="${item.weight}" 
                    onchange="editItemWeight(${item.id}, this.value)"
                    class="w-20 px-2 py-1 text-center font-bold text-gray-800 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 bg-white">
            </td>
            <td class="px-2 py-3 text-center font-semibold border-r">${item.purity}%</td>
            <td class="px-2 py-3 text-right font-semibold border-r bg-yellow-50">‚Çπ${item.rate}</td>
            <td class="px-2 py-3 border-r bg-orange-50">
                <input type="number" step="0.01" value="${item.mcRate.toFixed(2)}" 
                    onchange="editItemMCRate(${item.id}, this.value)"
                    class="w-20 px-2 py-1 text-center font-bold text-gray-800 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 bg-white">
            </td>
            <td class="px-2 py-3 text-right font-bold text-green-700 border-r bg-green-50">‚Çπ${item.amount.toFixed(2)}</td>
            <td class="px-2 py-3 text-center">
                <button onclick="removeItem(${item.id})" 
                    class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-all hover:scale-110"
                    title="Delete">
                    ‚úï
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

    function editItemWeight(itemId, newWeight) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            item.weight = parseFloat(newWeight) || 0;

            // Recalculate amount
            item.amount = (item.rate + item.mcRate) * item.weight;

            updateItemsTable();
            updateSummary();
        }

        function editItemMCRate(itemId, newMCRate) {
                const item = items.find(i => i.id === itemId);
                if (!item) return;

                item.mcRate = parseFloat(newMCRate) || 0;
                item.originalMcRate = item.mcRate; // Update original as well

                // Recalculate amount
                item.amount = (item.rate + item.mcRate) * item.weight;

                updateItemsTable();
                updateSummary();
            }

                function removeItem(id) {
                    items = items.filter(item => item.id !== id);
                    updateItemsTable();
                    updateSummary();
                }

                function clearItemForm() {
                    document.getElementById('itemSku').value = '';
                    document.getElementById('itemStyleCode').value = '';
                    document.getElementById('itemName').value = '';
                    document.getElementById('itemSize').value = '';
                    document.getElementById('itemWeight').value = '';
                    document.getElementById('itemPurity').value = '100';
                    document.getElementById('itemRate').value = '';
                    document.getElementById('itemMcRate').value = '';
                    document.getElementById('itemMetalType').value = '';
                    document.getElementById('itemAmount').textContent = '‚Çπ0.00';
                     // Return focus to barcode scanner
                    setTimeout(() => {
                        document.getElementById('barcodeInput').focus();
                    }, 100);
                }

                function updateSummary() {
                    const total = items.reduce((sum, item) => sum + item.amount, 0);
                    const gst = total * 0.03;
                    const netTotal = total + gst;
                    document.getElementById('summaryTotal').textContent = `‚Çπ${total.toFixed(2)}`;
                    document.getElementById('summaryGst').textContent = `‚Çπ${gst.toFixed(2)}`;
                    document.getElementById('summaryNetTotal').textContent = `‚Çπ${netTotal.toFixed(2)}`;
                }
            
                function generateQuote() {
    if (items.length === 0) {
        alert('Please add items first');
        return;
    }
    if (!currentCustomer) {
        alert('Please select a customer first');
        return;
    }
    // Show format selection modal with payment option
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('modalOverlay').classList.add('flex');
    document.getElementById('quotationFormatModal').classList.remove('hidden');
}

    function generateQuotePDF() {
        // Calculate totals ONCE
        const total = items.reduce((sum, item) => sum + item.amount, 0);
        const gst = total * 0.03;
        const netTotal = total + gst;
        const quotationNo = `Q${String(quotationCounter).padStart(4, '0')}`;

        // SAVE QUOTATION TO HISTORY
        const quotationRecord = {
            id: Date.now(),
            quotationNo: quotationNo,
            date: new Date().toISOString(),
            customer: {
                name: currentCustomer.name,
                address1: currentCustomer.address1,
                address2: currentCustomer.address2,
                city: currentCustomer.city,
                mobile: currentCustomer.mobile
            },
            items: JSON.parse(JSON.stringify(items)),
            total: total,
            gst: gst,
            netTotal: netTotal,
            rateSlab: currentRateSlab,
            isBilled: false 
        };

        savedQuotations.unshift(quotationRecord);
        localStorage.setItem('savedQuotations', JSON.stringify(savedQuotations));

        // PDF Generation
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');

        const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
        const totalMC = items.reduce((sum, item) => sum + (item.weight * item.mcRate), 0);
        const totalPCS = items.length;
        const date = new Date().toLocaleDateString('en-GB');

        // Customer info
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text('To:', 15, 15);

        doc.setFont(undefined, 'bold');
        doc.setFontSize(10);
        doc.text(currentCustomer.name.toUpperCase(), 15, 20);

        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        let yPos = 24;
        if (currentCustomer.address1) {
            doc.text(currentCustomer.address1, 15, yPos);
            yPos += 4;
        }
        if (currentCustomer.address2) {
            doc.text(currentCustomer.address2, 15, yPos);
            yPos += 4;
        }
        if (currentCustomer.city) {
            doc.text(currentCustomer.city, 15, yPos);
            yPos += 4;
        }
        doc.text(`Mob: ${currentCustomer.mobile}`, 15, yPos);

        // Quotation info
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.text('EST. No:', 160, 15);
        doc.setFont(undefined, 'normal');
        doc.text(quotationNo, 180, 15);

        doc.setFont(undefined, 'bold');
        doc.text('Date:', 160, 20);
        doc.setFont(undefined, 'normal');
        doc.text(date, 180, 20);

        // Items table - CORRECTED CALCULATION
        const tableStartY = yPos + 8;

        const tableData = items.map((item, idx) => {
    // CORRECT CALCULATION: (Rate + MC) √ó Weight
    const itemTotal = (item.rate + item.mcRate) * item.weight;

    return [
        idx + 1,
        item.sku || '-',
        item.styleCode || '-',
        item.name,
        item.size || '-',
        item.weight.toFixed(2),
        item.weight.toFixed(2),
        item.purity.toFixed(1),
        item.weight.toFixed(2),
        '1',
        item.mcRate.toFixed(2),
        item.rate.toFixed(2),
        itemTotal.toFixed(2)
    ];
});

        doc.autoTable({
            startY: tableStartY,
            head: [[
                '#',
                'SKU',
                'STYLE CODE',
                'Short Name',
                'SIZE',
                'NET.WT',
                'AVG.WT',
                '% Pure',
                'G.WT',
                'PCS',
                'MC/gm',
                'RATE',
                'Amount'
            ]],
            body: tableData,
            theme: 'grid',
            headStyles: {
                fillColor: [211, 211, 211],
                textColor: 0,
                fontSize: 7,
                fontStyle: 'bold',
                halign: 'center',
                valign: 'middle',
                cellPadding: 1.5
            },
            bodyStyles: {
                fontSize: 7,
                cellPadding: 1,
                valign: 'middle'
            },
            columnStyles: {
                0: { cellWidth: 8, halign: 'center' },
                1: { cellWidth: 20, halign: 'left', fontSize: 6.5 },
                2: { cellWidth: 16, halign: 'center', fontSize: 6.5 },
                3: { cellWidth: 38, halign: 'left' },
                4: { cellWidth: 12, halign: 'center' },
                5: { cellWidth: 13, halign: 'right' },
                6: { cellWidth: 13, halign: 'right' },
                7: { cellWidth: 11, halign: 'center' },
                8: { cellWidth: 11, halign: 'right' },
                9: { cellWidth: 9, halign: 'center' },
                10: { cellWidth: 12, halign: 'right' },
                11: { cellWidth: 12, halign: 'right' },
                12: { cellWidth: 16, halign: 'right' }
            },
            margin: { left: 15, right: 14 }
        });

        // Grand total section
        const finalY = doc.lastAutoTable.finalY + 8;

        doc.setDrawColor(0);
        doc.setLineWidth(0.5);
        doc.rect(15, finalY, 180, 25);
        doc.line(105, finalY, 105, finalY + 25);

        // Left side
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.text('COUNT:', 18, finalY + 6);
        doc.setFont(undefined, 'normal');
        doc.text(totalPCS.toString(), 45, finalY + 6);

        doc.setFont(undefined, 'bold');
        doc.text('Total Weight:', 18, finalY + 12);
        doc.setFont(undefined, 'normal');
        doc.text(`${totalWeight.toFixed(2)} gm`, 45, finalY + 12);

        doc.setFont(undefined, 'bold');
        doc.text('MC:', 18, finalY + 18);
        doc.setFont(undefined, 'normal');
        doc.text(totalMC.toFixed(2), 45, finalY + 18);

        // Right side
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('GRAND TOTAL', 110, finalY + 5);

        doc.setFontSize(8);
        doc.text('TOTAL:', 110, finalY + 11);
        doc.setFont(undefined, 'normal');
        doc.text(total.toFixed(2), 190, finalY + 11, { align: 'right' });

        doc.setFont(undefined, 'bold');
        doc.text('GST:', 110, finalY + 16);
        doc.setFont(undefined, 'normal');
        doc.text(gst.toFixed(2), 190, finalY + 16, { align: 'right' });

        doc.setFont(undefined, 'bold');
        doc.text('NET TOTAL:', 110, finalY + 21);
        doc.setFont(undefined, 'bold');
        doc.text(netTotal.toFixed(2), 190, finalY + 21, { align: 'right' });

        doc.save(`Quotation_${quotationNo}_${date.replace(/\//g, '-')}.pdf`);

        quotationCounter++;
        localStorage.setItem('quotationCounter', quotationCounter);
        document.getElementById('quotationNo').textContent = `Quotation No: Q${String(quotationCounter).padStart(4, '0')}`;

        closeModals();
        alert('PDF Quotation generated!');

        // Clear billing form after successful quotation
        clearAll();
    }

    function generateQuotePDFWithPayment() {
    const paymentOption = document.querySelector('input[name="paymentOption"]:checked').value;
    const isCashReceived = paymentOption === 'cash';
    
    // Calculate totals
    const total = items.reduce((sum, item) => sum + item.amount, 0);
    const gst = total * 0.03;
    const netTotal = total + gst;
    const quotationNo = `Q${String(quotationCounter).padStart(4, '0')}`;

    // SAVE QUOTATION TO HISTORY
    const quotationRecord = {
        id: Date.now(),
        quotationNo: quotationNo,
        date: new Date().toISOString(),
        customer: {
            name: currentCustomer.name,
            address1: currentCustomer.address1,
            address2: currentCustomer.address2,
            city: currentCustomer.city,
            mobile: currentCustomer.mobile
        },
        items: items.map(item => ({
    ...item,
    barcode: item.barcode || null
})),
        total: total,
        gst: gst,
        netTotal: netTotal,
        rateSlab: currentRateSlab,
        isBilled: false,
        paymentReceived: isCashReceived,
        paymentDate: isCashReceived ? new Date().toISOString() : null
    };

    savedQuotations.unshift(quotationRecord);
    localStorage.setItem('savedQuotations', JSON.stringify(savedQuotations));

    // ‚≠ê IF CASH RECEIVED - RECORD IN LEDGER IMMEDIATELY
    if (isCashReceived) {
        recordLedgerTransaction(transactionTypes.CASH_IN, {
            quotationNo: quotationNo,
            customerName: currentCustomer.name,
            customerMobile: currentCustomer.mobile,
            amount: netTotal,
            description: `Cash received for Quotation ${quotationNo} - ${currentCustomer.name}`,
            category: 'Sales Revenue',
            paymentMethod: 'Cash',
            reference: quotationNo
        });
        
        // Update cash balance
        accountBalances.cash += netTotal;
        localStorage.setItem('accountBalances', JSON.stringify(accountBalances));
    }

    // Generate PDF (same as before)
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
    const totalMC = items.reduce((sum, item) => sum + (item.weight * item.mcRate), 0);
    const totalPCS = items.length;
    const date = new Date().toLocaleDateString('en-GB');

    // Customer info
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('To:', 15, 15);

    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.text(currentCustomer.name.toUpperCase(), 15, 20);

    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    let yPos = 24;
    if (currentCustomer.address1) {
        doc.text(currentCustomer.address1, 15, yPos);
        yPos += 4;
    }
    if (currentCustomer.address2) {
        doc.text(currentCustomer.address2, 15, yPos);
        yPos += 4;
    }
    if (currentCustomer.city) {
        doc.text(currentCustomer.city, 15, yPos);
        yPos += 4;
    }
    doc.text(`Mob: ${currentCustomer.mobile}`, 15, yPos);

    // Quotation info
    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text('EST. No:', 160, 15);
    doc.setFont(undefined, 'normal');
    doc.text(quotationNo, 180, 15);

    doc.setFont(undefined, 'bold');
    doc.text('Date:', 160, 20);
    doc.setFont(undefined, 'normal');
    doc.text(date, 180, 20);
    
    // Payment status indicator
    if (isCashReceived) {
        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 128, 0);
        doc.text('PAID', 160, 25);
        doc.setTextColor(0, 0, 0);
    }

    // Items table
    const tableStartY = yPos + 8;

    const tableData = items.map((item, idx) => {
        const itemTotal = (item.rate + item.mcRate) * item.weight;

        return [
            idx + 1,
            item.sku || '-',
            item.styleCode || '-',
            item.name,
            item.size || '-',
            item.weight.toFixed(2),
            item.weight.toFixed(2),
            item.purity.toFixed(1),
            item.weight.toFixed(2),
            '1',
            item.mcRate.toFixed(2),
            item.rate.toFixed(2),
            itemTotal.toFixed(2)
        ];
    });

    doc.autoTable({
        startY: tableStartY,
        head: [[
            '#',
            'SKU',
            'STYLE CODE',
            'Short Name',
            'SIZE',
            'NET.WT',
            'AVG.WT',
            '% Pure',
            'G.WT',
            'PCS',
            'MC/gm',
            'RATE',
            'Amount'
        ]],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [211, 211, 211],
            textColor: 0,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle',
            cellPadding: 1.5
        },
        bodyStyles: {
            fontSize: 7,
            cellPadding: 1,
            valign: 'middle'
        },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            1: { cellWidth: 20, halign: 'left', fontSize: 6.5 },
            2: { cellWidth: 16, halign: 'center', fontSize: 6.5 },
            3: { cellWidth: 38, halign: 'left' },
            4: { cellWidth: 12, halign: 'center' },
            5: { cellWidth: 13, halign: 'right' },
            6: { cellWidth: 13, halign: 'right' },
            7: { cellWidth: 11, halign: 'center' },
            8: { cellWidth: 11, halign: 'right' },
            9: { cellWidth: 9, halign: 'center' },
            10: { cellWidth: 12, halign: 'right' },
            11: { cellWidth: 12, halign: 'right' },
            12: { cellWidth: 16, halign: 'right' }
        },
        margin: { left: 15, right: 14 }
    });

    // Grand total section
    const finalY = doc.lastAutoTable.finalY + 8;

    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.rect(15, finalY, 180, 25);
    doc.line(105, finalY, 105, finalY + 25);

    // Left side
    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text('COUNT:', 18, finalY + 6);
    doc.setFont(undefined, 'normal');
    doc.text(totalPCS.toString(), 45, finalY + 6);

    doc.setFont(undefined, 'bold');
    doc.text('Total Weight:', 18, finalY + 12);
    doc.setFont(undefined, 'normal');
    doc.text(`${totalWeight.toFixed(2)} gm`, 45, finalY + 12);

    doc.setFont(undefined, 'bold');
    doc.text('MC:', 18, finalY + 18);
    doc.setFont(undefined, 'normal');
    doc.text(totalMC.toFixed(2), 45, finalY + 18);

    // Right side
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('GRAND TOTAL', 110, finalY + 5);

    doc.setFontSize(8);
    doc.text('TOTAL:', 110, finalY + 11);
    doc.setFont(undefined, 'normal');
    doc.text(total.toFixed(2), 190, finalY + 11, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('GST:', 110, finalY + 16);
    doc.setFont(undefined, 'normal');
    doc.text(gst.toFixed(2), 190, finalY + 16, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('NET TOTAL:', 110, finalY + 21);
    doc.setFont(undefined, 'bold');
    doc.text(netTotal.toFixed(2), 190, finalY + 21, { align: 'right' });

    doc.save(`Quotation_${quotationNo}_${date.replace(/\//g, '-')}.pdf`);

    quotationCounter++;
    localStorage.setItem('quotationCounter', quotationCounter);
    document.getElementById('quotationNo').textContent = `Quotation No: Q${String(quotationCounter).padStart(4, '0')}`;

    closeModals();
    
    if (isCashReceived) {
        alert(`‚úÖ Quotation Generated & Cash Recorded!\n\nQuotation: ${quotationNo}\nAmount: ‚Çπ${netTotal.toFixed(2)}\n\nüíµ Cash payment recorded in Accounts Ledger`);
    } else {
        alert(`‚úÖ Quotation Generated!\n\nQuotation: ${quotationNo}\nAmount: ‚Çπ${netTotal.toFixed(2)}\n\nüìã Payment pending - Customer can pay later`);
    }

    // Update dashboard if on ledger tab
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        updateLedgerDashboard();
    }

    clearAll();
}
    
               function clearAll() {
                    if (items.length === 0 || confirm('Clear all items from bill?')) {
                        items = [];
                        updateItemsTable();
                        updateSummary();
                        clearItemForm();
                        document.getElementById('rateSlab').value = 'R';
                        currentRateSlab = 'R';
                        updateRateSlabInfo();
                        document.getElementById('barcodeInput').focus();
                    }
                }

                function viewSoldProductsReport() {
    if (soldProducts.length === 0) {
        alert('No products have been sold yet.');
        return;
    }

    const wb = XLSX.utils.book_new();
    
    const data = soldProducts.map(sp => {
        const bill = savedBills.find(b => b.billNo === sp.billNo);
        return {
            'Barcode': sp.barcode,
            'Bill No': sp.billNo,
            'Sold Date': new Date(sp.soldDate).toLocaleDateString('en-GB'),
            'Customer': bill ? bill.customer.name : 'N/A'
        };
    });

    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Sold Products');
    XLSX.writeFile(wb, `Sold_Products_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert(`Sold Products Report downloaded!\nTotal: ${soldProducts.length} products`);
}

                function closeModals() {
    document.getElementById('modalOverlay').classList.add('hidden');
    document.getElementById('modalOverlay').classList.remove('flex');
    document.getElementById('ratesModal').classList.add('hidden');
    document.getElementById('addProductModal').classList.add('hidden');
    document.getElementById('addCustomerModal').classList.add('hidden');
    document.getElementById('bulkUploadModal').classList.add('hidden');
    document.getElementById('bulkUploadCustomerModal').classList.add('hidden');
    document.getElementById('quotationFormatModal').classList.add('hidden');
    document.getElementById('stockReportModal').classList.add('hidden');
    document.getElementById('rolUploadModal').classList.add('hidden');
    document.getElementById('viewQuotationModal').classList.add('hidden');
    document.getElementById('billFormatModal').classList.add('hidden');
    document.getElementById('viewBillModal').classList.add('hidden');
    document.getElementById('reprintFormatModal').classList.add('hidden');
    document.getElementById('cashEntryModal').classList.add('hidden');
    
    // Close dynamically created modals
    const bankModal = document.getElementById('bankEntryModal');
    if (bankModal) bankModal.remove();
    
    const paymentModal = document.getElementById('recordPaymentModal');
    if (paymentModal) paymentModal.remove();
}

                // ========== ROL MANAGEMENT FUNCTIONS ==========

                    function initializeROL() {
                            // Populate style code filter dropdown
                            const styleCodeFilter = document.getElementById('rolStyleCodeFilter');
                            if (!styleCodeFilter) return;

                            styleCodeFilter.innerHTML = '<option value="all">All Style Codes</option>';

                            const uniqueStyleCodes = [...new Set(products.map(p => p.styleCode).filter(s => s && s.trim() !== ''))];
                            uniqueStyleCodes.sort().forEach(styleCode => {
                                const option = document.createElement('option');
                                option.value = styleCode;
                                option.textContent = styleCode;
                                styleCodeFilter.appendChild(option);
                            });

                            // Initialize display
                            updateROLDisplay();
                        }

                    function updateROLDisplay() {
                        const styleCodeFilter = document.getElementById('rolStyleCodeFilter').value;
                        const viewFilter = document.getElementById('rolViewFilter').value;

                        // Get filtered products
                        let filteredProducts = products;
                        if (styleCodeFilter !== 'all') {
                            filteredProducts = products.filter(p => p.styleCode === styleCodeFilter);
                        }

                        // Merge with ROL data
                        const rolItems = filteredProducts.map(product => {
                            const rolItem = rolData.find(r => r.barcode === product.barcode);
                            const rolSet = rolItem ? rolItem.rol : 0;
                            const available = rolItem ? (rolItem.available || 0) : 0;
                            const required = Math.max(0, rolSet - available);

                            return {
                                barcode: product.barcode,
                                styleCode: product.styleCode || '-',
                                productName: product.shortName,
                                rolSet: rolSet,
                                available: available,
                                required: required,
                                needsReorder: required > 0
                            };
                        });

                        // Apply view filter
                        let displayItems = rolItems;
                        if (viewFilter === 'reorder') {
                            displayItems = rolItems.filter(item => item.needsReorder);
                        }

                        // Update statistics
                        const totalItems = rolItems.length;
                        const reorderCount = rolItems.filter(item => item.needsReorder).length;
                        const stockOK = totalItems - reorderCount;
                        const totalRequired = rolItems.reduce((sum, item) => sum + item.required, 0);

                        document.getElementById('rolTotalItems').textContent = totalItems;
                        document.getElementById('rolReorderCount').textContent = reorderCount;
                        document.getElementById('rolStockOK').textContent = stockOK;
                        document.getElementById('rolTotalRequired').textContent = totalRequired;

                        // Update table
                        const tbody = document.getElementById('rolTableBody');
                        tbody.innerHTML = '';

                        if (displayItems.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No items found.</td></tr>';
                            return;
                        }

                        displayItems.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = item.needsReorder ? 'border-b hover:bg-red-50 bg-red-50' : 'border-b hover:bg-green-50 bg-green-50';

                            const statusBadge = item.needsReorder
                                ? '<span class="px-2 py-1 bg-red-600 text-white text-xs rounded-full font-bold">REORDER</span>'
                                : '<span class="px-2 py-1 bg-green-600 text-white text-xs rounded-full font-bold">OK</span>';

                            row.innerHTML = `
            <td class="px-4 py-3 font-mono text-sm">${item.barcode}</td>
            <td class="px-4 py-3 text-sm font-semibold text-blue-600">${item.styleCode}</td>
            <td class="px-4 py-3 font-medium">${item.productName}</td>
            <td class="px-4 py-3 text-center font-bold">${item.rolSet}</td>
            <td class="px-4 py-3 text-center">${item.available}</td>
            <td class="px-4 py-3 text-center font-bold ${item.needsReorder ? 'text-red-600' : 'text-green-600'}">${item.required}</td>
            <td class="px-4 py-3 text-center">${statusBadge}</td>
        `;
                            tbody.appendChild(row);
                        });
                    }

                    function downloadROLSample() {
                        const sampleData = [
                            { Barcode: '1001', StyleCode: 'EMERALD IDOL', ProductName: 'Silver Ganesh Idol', ROL: 20 },
                            { Barcode: '1002', StyleCode: 'EMERALD IDOL', ProductName: 'Silver Lakshmi Idol', ROL: 15 },
                            { Barcode: '1003', StyleCode: 'SOLID IDOL 2D', ProductName: 'Gold Krishna Idol 2D', ROL: 10 },
                            { Barcode: '1004', StyleCode: 'SOLID IDOL 3D', ProductName: 'Silver Saraswati 3D', ROL: 25 }
                        ];

                        const ws = XLSX.utils.json_to_sheet(sampleData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'ROL Sample');
                        XLSX.writeFile(wb, 'ROL_Sample_Format.xlsx');
                        alert('ROL Sample downloaded!');
                    }

                    function showROLUploadModal() {
                        document.getElementById('rolUploadPreview').classList.add('hidden');
                        document.getElementById('rolExcelFileInput').value = '';
                        bulkUploadROLData = [];
                        document.getElementById('modalOverlay').classList.remove('hidden');
                        document.getElementById('modalOverlay').classList.add('flex');
                        document.getElementById('rolUploadModal').classList.remove('hidden');
                    }

                    function handleROLExcelUpload(event) {
                            const file = event.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = function (e) {
                                try {
                                    const data = new Uint8Array(e.target.result);
                                    const workbook = XLSX.read(data, { type: 'array' });
                                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                                    if (jsonData.length === 0) {
                                        alert('Excel file is empty!');
                                        return;
                                    }

                                    bulkUploadROLData = jsonData.map(row => ({
                                        barcode: String(row.Barcode || row.barcode || '').trim(),
                                        styleCode: String(row.StyleCode || row.styleCode || '').trim(),
                                        productName: String(row.ProductName || row.productName || '').trim(),
                                        rol: parseInt(row.ROL || row.rol || 0),
                                        available: 0 // Initialize available as 0
                                    }));

                                    // Preview
                                    const tbody = document.getElementById('rolPreviewTableBody');
                                    tbody.innerHTML = '';
                                    bulkUploadROLData.slice(0, 5).forEach(item => {
                                        const row = document.createElement('tr');
                                        row.className = 'border-b';
                                        row.innerHTML = `
                    <td class="px-2 py-2">${item.barcode}</td>
                    <td class="px-2 py-2">${item.styleCode}</td>
                    <td class="px-2 py-2">${item.productName}</td>
                    <td class="px-2 py-2 text-center font-bold">${item.rol}</td>
                `;
                                        tbody.appendChild(row);
                                    });

                                    document.getElementById('rolUploadCount').textContent = bulkUploadROLData.length;
                                    document.getElementById('rolUploadPreview').classList.remove('hidden');
                                } catch (error) {
                                    alert('Error reading Excel: ' + error.message);
                                }
                            };
                            reader.readAsArrayBuffer(file);
                        }

                        function confirmROLUpload() {
                            if (bulkUploadROLData.length === 0) return;

                            // Validate that barcodes exist in products
                            const invalidItems = bulkUploadROLData.filter(item => {
                                return !products.find(p => p.barcode === item.barcode);
                            });

                            if (invalidItems.length > 0) {
                                alert(`Error: ${invalidItems.length} items have barcodes not found in products database.\nPlease add these products first.`);
                                return;
                            }

                            // Merge with existing ROL data
                            bulkUploadROLData.forEach(newItem => {
                                const existingIndex = rolData.findIndex(r => r.barcode === newItem.barcode);
                                if (existingIndex >= 0) {
                                    rolData[existingIndex] = newItem;
                                } else {
                                    rolData.push(newItem);
                                }
                            });

                            localStorage.setItem('rolData', JSON.stringify(rolData));
                            updateROLDisplay();
                            closeModals();
                            alert(`Successfully uploaded ${bulkUploadROLData.length} ROL items!`);
                        }

                        function downloadROLReport() {
                            const styleCodeFilter = document.getElementById('rolStyleCodeFilter').value;

                            // Get filtered products
                            let filteredProducts = products;
                            if (styleCodeFilter !== 'all') {
                                filteredProducts = products.filter(p => p.styleCode === styleCodeFilter);
                            }

                            // Merge with ROL data and filter only items needing reorder
                            const rolItems = filteredProducts.map(product => {
                                const rolItem = rolData.find(r => r.barcode === product.barcode);
                                const rolSet = rolItem ? rolItem.rol : 0;
                                const available = rolItem ? (rolItem.available || 0) : 0;
                                const required = Math.max(0, rolSet - available);

                                return {
                                    barcode: product.barcode,
                                    styleCode: product.styleCode || '-',
                                    productName: product.shortName,
                                    rolSet: rolSet,
                                    available: available,
                                    required: required,
                                    needsReorder: required > 0
                                };
                            }).filter(item => item.needsReorder); // Only items that need reorder

                            if (rolItems.length === 0) {
                                alert('No items need reordering!');
                                return;
                            }

                            const date = new Date().toLocaleDateString('en-GB');
                            const wb = XLSX.utils.book_new();

                            // Create data
                            const headerData = [
                                ['REORDER LEVEL (ROL) REPORT'],
                                ['Generated:', date],
                                ['Style Code Filter:', styleCodeFilter === 'all' ? 'All Style Codes' : styleCodeFilter],
                                ['Items Requiring Reorder:', rolItems.length],
                                ['']
                            ];

                            const tableData = rolItems.map((item, idx) => ({
                                '#': idx + 1,
                                'Barcode': item.barcode,
                                'Style Code': item.styleCode,
                                'Product Name': item.productName,
                                'ROL Set': item.rolSet,
                                'Available Stock': item.available,
                                'Required Qty': item.required,
                                'Status': 'REORDER NEEDED'
                            }));

                            const tableHeaders = Object.keys(tableData[0]);
                            const tableRows = tableData.map(obj => tableHeaders.map(key => obj[key]));

                            const summaryData = [
                                [''],
                                ['SUMMARY'],
                                ['Total Items Needing Reorder:', rolItems.length],
                                ['Total Quantity Required:', rolItems.reduce((sum, item) => sum + item.required, 0)]
                            ];

                            // Combine all data
                            const allData = [
                                ...headerData,
                                tableHeaders,
                                ...tableRows,
                                ...summaryData
                            ];

                            const ws = XLSX.utils.aoa_to_sheet(allData);

                            ws['!cols'] = [
                                { wch: 5 }, { wch: 15 }, { wch: 15 }, { wch: 35 },
                                { wch: 12 }, { wch: 15 }, { wch: 15 }, { wch: 18 }
                            ];

                            XLSX.utils.book_append_sheet(wb, ws, 'ROL Report');
                            XLSX.writeFile(wb, `ROL_Report_${date.replace(/\//g, '-')}.xlsx`);
                            alert('ROL Report downloaded successfully!');
                        }

                        // ========== QUOTATION HISTORY FUNCTIONS ==========

                            function loadQuotationsHistory() {
                                // Populate customer filter
                                const customerFilter = document.getElementById('quotationCustomerFilter');
                                customerFilter.innerHTML = '<option value="all">All Customers</option>';

                                const uniqueCustomers = [...new Set(savedQuotations.map(q => q.customer.name))];
                                uniqueCustomers.forEach(name => {
                                    const option = document.createElement('option');
                                    option.value = name;
                                    option.textContent = name;
                                    customerFilter.appendChild(option);
                                });

                                // Update statistics and display
                                updateQuotationStatistics();
                                displayQuotations(savedQuotations);
                            }

                            function updateQuotationStatistics() {
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);

                                const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                                const todayQuotations = savedQuotations.filter(q => {
                                    const qDate = new Date(q.date);
                                    qDate.setHours(0, 0, 0, 0);
                                    return qDate.getTime() === today.getTime();
                                });

                                const monthQuotations = savedQuotations.filter(q => {
                                    const qDate = new Date(q.date);
                                    return qDate >= thisMonth;
                                });

                                const totalValue = savedQuotations.reduce((sum, q) => sum + q.netTotal, 0);

                                document.getElementById('quotationTotalCount').textContent = savedQuotations.length;
                                document.getElementById('quotationTotalValue').textContent = `‚Çπ${totalValue.toFixed(0)}`;
                                document.getElementById('quotationMonthCount').textContent = monthQuotations.length;
                                document.getElementById('quotationTodayCount').textContent = todayQuotations.length;
                            }

                            function displayQuotations(quotations) {
                                const tbody = document.getElementById('quotationsTableBody');
                                const emptyState = document.getElementById('quotationsEmptyState');

                                tbody.innerHTML = '';

                                if (quotations.length === 0) {
                                    emptyState.classList.remove('hidden');
                                    return;
                                }

                                emptyState.classList.add('hidden');

                                quotations.forEach(quotation => {
                                    const row = document.createElement('tr');
                                    row.className = 'border-b hover:bg-gray-50';

                                    const date = new Date(quotation.date).toLocaleDateString('en-GB');
                                    const itemCount = quotation.items.length;

                                    row.innerHTML = `
            <td class="px-4 py-3 font-mono text-sm font-bold text-blue-600">${quotation.quotationNo}</td>
            <td class="px-4 py-3 text-sm">${date}</td>
            <td class="px-4 py-3 font-medium">${quotation.customer.name}</td>
            <td class="px-4 py-3 text-center">${itemCount}</td>
            <td class="px-4 py-3 text-right">‚Çπ${quotation.total.toFixed(2)}</td>
            <td class="px-4 py-3 text-right">‚Çπ${quotation.gst.toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-bold">‚Çπ${quotation.netTotal.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">
                <button onclick="viewQuotationDetails(${quotation.id})" 
                    class="text-blue-600 hover:text-blue-800 font-medium mr-2" title="View">üëÅÔ∏è</button>
                <button onclick="deleteQuotation(${quotation.id})" 
                    class="text-red-600 hover:text-red-800 font-medium" title="Delete">üóëÔ∏è</button>
            </td>
        `;

                                    tbody.appendChild(row);
                                });
                            }

                            function filterQuotations() {
                                const searchTerm = document.getElementById('quotationSearch').value.toLowerCase();
                                const customerFilter = document.getElementById('quotationCustomerFilter').value;
                                const dateFilter = document.getElementById('quotationDateFilter').value;

                                let filtered = savedQuotations;

                                // Search filter
                                if (searchTerm) {
                                    filtered = filtered.filter(q =>
                                        q.quotationNo.toLowerCase().includes(searchTerm) ||
                                        q.customer.name.toLowerCase().includes(searchTerm) ||
                                        q.customer.mobile.includes(searchTerm)
                                    );
                                }

                                // Customer filter
                                if (customerFilter !== 'all') {
                                    filtered = filtered.filter(q => q.customer.name === customerFilter);
                                }

                                // Date filter
                                if (dateFilter !== 'all') {
                                    const today = new Date();
                                    today.setHours(0, 0, 0, 0);

                                    filtered = filtered.filter(q => {
                                        const qDate = new Date(q.date);
                                        qDate.setHours(0, 0, 0, 0);

                                        if (dateFilter === 'today') {
                                            return qDate.getTime() === today.getTime();
                                        } else if (dateFilter === 'week') {
                                            const weekAgo = new Date(today);
                                            weekAgo.setDate(weekAgo.getDate() - 7);
                                            return qDate >= weekAgo;
                                        } else if (dateFilter === 'month') {
                                            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                            return qDate >= monthStart;
                                        }
                                        return true;
                                    });
                                }

                                displayQuotations(filtered);
                            }

                            function viewQuotationDetails(id) {
                                const quotation = savedQuotations.find(q => q.id === id);
                                if (!quotation) return;

                                currentViewingQuotation = quotation;

                                document.getElementById('viewQuotationTitle').textContent = `Quotation ${quotation.quotationNo}`;
                                document.getElementById('viewQuotCustomer').textContent = quotation.customer.name;
                                document.getElementById('viewQuotDate').textContent = new Date(quotation.date).toLocaleDateString('en-GB');

                                // Items
                                const tbody = document.getElementById('viewQuotItemsBody');
                                tbody.innerHTML = '';
                                quotation.items.forEach((item, idx) => {
                                    const row = document.createElement('tr');
                                    row.className = 'border-b';
                                    row.innerHTML = `
            <td class="px-2 py-2">${idx + 1}</td>
            <td class="px-2 py-2">${item.name}</td>
            <td class="px-2 py-2 text-right">${item.weight.toFixed(2)}g</td>
            <td class="px-2 py-2 text-right">‚Çπ${item.rate}</td>
            <td class="px-2 py-2 text-right">‚Çπ${item.mcRate}</td>
            <td class="px-2 py-2 text-right font-semibold">‚Çπ${item.amount.toFixed(2)}</td>
        `;
                                    tbody.appendChild(row);
                                });

                                // Totals
                                document.getElementById('viewQuotTotal').textContent = `‚Çπ${quotation.total.toFixed(2)}`;
                                document.getElementById('viewQuotGST').textContent = `‚Çπ${quotation.gst.toFixed(2)}`;
                                document.getElementById('viewQuotNetTotal').textContent = `‚Çπ${quotation.netTotal.toFixed(2)}`;

                                // Show modal
                                document.getElementById('modalOverlay').classList.remove('hidden');
                                document.getElementById('modalOverlay').classList.add('flex');
                                document.getElementById('viewQuotationModal').classList.remove('hidden');
                            }

                            function deleteQuotation(id) {
                                if (!confirm('Are you sure you want to delete this quotation?')) return;

                                savedQuotations = savedQuotations.filter(q => q.id !== id);
                                localStorage.setItem('savedQuotations', JSON.stringify(savedQuotations));

                                loadQuotationsHistory();
                                alert('Quotation deleted successfully!');
                            }

                            function downloadAllQuotations() {
                                if (savedQuotations.length === 0) {
                                    alert('No quotations to export!');
                                    return;
                                }

                                const data = savedQuotations.map(q => ({
                                    'Quote No': q.quotationNo,
                                    'Date': new Date(q.date).toLocaleDateString('en-GB'),
                                    'Customer': q.customer.name,
                                    'Mobile': q.customer.mobile,
                                    'Items': q.items.length,
                                    'Total': q.total.toFixed(2),
                                    'GST': q.gst.toFixed(2),
                                    'Net Total': q.netTotal.toFixed(2)
                                }));

                                const ws = XLSX.utils.json_to_sheet(data);
                                const wb = XLSX.utils.book_new();
                                XLSX.utils.book_append_sheet(wb, ws, 'Quotations');
                                XLSX.writeFile(wb, `All_Quotations_${new Date().toISOString().split('T')[0]}.xlsx`);
                                alert('All quotations exported successfully!');
                            }

                            function clearOldQuotations() {
                                const months = prompt('Delete quotations older than how many months? (Enter number)');
                                if (!months || isNaN(months)) return;

                                const cutoffDate = new Date();
                                cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(months));

                                const before = savedQuotations.length;
                                savedQuotations = savedQuotations.filter(q => new Date(q.date) >= cutoffDate);
                                const after = savedQuotations.length;

                                localStorage.setItem('savedQuotations', JSON.stringify(savedQuotations));
                                loadQuotationsHistory();

                                alert(`Deleted ${before - after} old quotations`);
                            }

                            function reprintQuotationPDF() {
                                if (!currentViewingQuotation) return;

                                const q = currentViewingQuotation;
                                const { jsPDF } = window.jspdf;
                                const doc = new jsPDF('p', 'mm', 'a4');

                                const date = new Date(q.date).toLocaleDateString('en-GB');

                                // Customer info
                                doc.setFontSize(9);
                                doc.setFont(undefined, 'normal');
                                doc.text('To:', 15, 15);
                                doc.setFont(undefined, 'bold');
                                doc.setFontSize(10);
                                doc.text(q.customer.name.toUpperCase(), 15, 20);

                                doc.setFontSize(8);
                                doc.setFont(undefined, 'normal');
                                let yPos = 24;
                                if (q.customer.address1) {
                                    doc.text(q.customer.address1, 15, yPos);
                                    yPos += 4;
                                }
                                if (q.customer.address2) {
                                    doc.text(q.customer.address2, 15, yPos);
                                    yPos += 4;
                                }
                                if (q.customer.city) {
                                    doc.text(q.customer.city, 15, yPos);
                                    yPos += 4;
                                }
                                doc.text(`Mob: ${q.customer.mobile}`, 15, yPos);

                                // Quote info
                                doc.setFontSize(8);
                                doc.setFont(undefined, 'bold');
                                doc.text('EST. No:', 160, 15);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.quotationNo, 180, 15);
                                doc.setFont(undefined, 'bold');
                                doc.text('Date:', 160, 20);
                                doc.setFont(undefined, 'normal');
                                doc.text(date, 180, 20);

                                // Items table
                                const tableStartY = yPos + 8;
                                const tableData = q.items.map((item, idx) => {
    // CORRECT CALCULATION: (Rate + MC) √ó Weight
    const itemTotal = (item.rate + item.mcRate) * item.weight;
    
    return [
        idx + 1,
        item.sku || '-',
        item.styleCode || '-',
        item.name,
        item.size || '-',
        item.weight.toFixed(2),
        item.weight.toFixed(2),
        item.purity.toFixed(0),
        item.weight.toFixed(2),
        '1',
        item.mcRate.toFixed(2),
        item.rate.toFixed(0),
        itemTotal.toFixed(2)
    ];
});

                                doc.autoTable({
                                    startY: tableStartY,
                                    head: [['#', 'SKU', 'STYLE CODE', 'Short Name', 'SIZE', 'NET.WT', 'AVG.WT', '% Pure', 'G.WT', 'PCS', 'MC/gm', 'RATE', 'Amount']],
                                    body: tableData,
                                    theme: 'grid',
                                    headStyles: { fillColor: [211, 211, 211], textColor: 0, fontSize: 7, fontStyle: 'bold', halign: 'center', cellPadding: 1.5 },
                                    bodyStyles: { fontSize: 7, cellPadding: 1 },
                                    columnStyles: {
                                        0: { cellWidth: 8, halign: 'center' },
                                        1: { cellWidth: 20, halign: 'left', fontSize: 6.5 },
                                        2: { cellWidth: 16, halign: 'center', fontSize: 6.5 },
                                        3: { cellWidth: 38, halign: 'left' },
                                        4: { cellWidth: 12, halign: 'center' },
                                        5: { cellWidth: 13, halign: 'right' },
                                        6: { cellWidth: 13, halign: 'right' },
                                        7: { cellWidth: 11, halign: 'center' },
                                        8: { cellWidth: 11, halign: 'right' },
                                        9: { cellWidth: 9, halign: 'center' },
                                        10: { cellWidth: 12, halign: 'right' },
                                        11: { cellWidth: 12, halign: 'right' },
                                        12: { cellWidth: 16, halign: 'right' }
                                    },
                                    margin: { left: 15, right: 14 }
                                });

                                // Totals section
                                const finalY = doc.lastAutoTable.finalY + 8;
                                const totalWeight = q.items.reduce((sum, item) => sum + item.weight, 0);
                                const totalMC = q.items.reduce((sum, item) => sum + (item.weight * item.mcRate), 0);

                                doc.setDrawColor(0);
                                doc.setLineWidth(0.5);
                                doc.rect(15, finalY, 180, 25);
                                doc.line(105, finalY, 105, finalY + 25);

                                doc.setFontSize(8);
                                doc.setFont(undefined, 'bold');
                                doc.text('COUNT:', 18, finalY + 6);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.items.length.toString(), 45, finalY + 6);
                                doc.setFont(undefined, 'bold');
                                doc.text('Total Weight:', 18, finalY + 12);
                                doc.setFont(undefined, 'normal');
                                doc.text(`${totalWeight.toFixed(2)} gm`, 45, finalY + 12);
                                doc.setFont(undefined, 'bold');
                                doc.text('MC:', 18, finalY + 18);
                                doc.setFont(undefined, 'normal');
                                doc.text(totalMC.toFixed(2), 45, finalY + 18);

                                doc.setFontSize(9);
                                doc.setFont(undefined, 'bold');
                                doc.text('GRAND TOTAL', 110, finalY + 5);
                                doc.setFontSize(8);
                                doc.text('TOTAL:', 110, finalY + 11);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.total.toFixed(2), 190, finalY + 11, { align: 'right' });
                                doc.setFont(undefined, 'bold');
                                doc.text('GST:', 110, finalY + 16);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.gst.toFixed(2), 190, finalY + 16, { align: 'right' });
                                doc.setFont(undefined, 'bold');
                                doc.text('NET TOTAL:', 110, finalY + 21);
                                doc.text(q.netTotal.toFixed(2), 190, finalY + 21, { align: 'right' });

                                doc.save(`Quotation_${q.quotationNo}_REPRINT.pdf`);
                                alert('Quotation PDF downloaded!');
                            }

                            // ========== BILL HISTORY FUNCTIONS ==========
                            function filterBills() {
                                    const searchTerm = document.getElementById('billSearch').value.toLowerCase();
                                    const customerFilter = document.getElementById('billCustomerFilter').value;
                                    const dateFilter = document.getElementById('billDateFilter').value;

                                    let filtered = savedBills;

                                    // Search filter
                                    if (searchTerm) {
                                        filtered = filtered.filter(b =>
                                            b.billNo.toLowerCase().includes(searchTerm) ||
                                            b.customer.name.toLowerCase().includes(searchTerm) ||
                                            b.customer.mobile.includes(searchTerm)
                                        );
                                    }

                                    // Customer filter
                                    if (customerFilter !== 'all') {
                                        filtered = filtered.filter(b => b.customer.name === customerFilter);
                                    }

                                    // Date filter
                                    if (dateFilter !== 'all') {
                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);

                                        filtered = filtered.filter(b => {
                                            const bDate = new Date(b.date);
                                            bDate.setHours(0, 0, 0, 0);

                                            if (dateFilter === 'today') {
                                                return bDate.getTime() === today.getTime();
                                            } else if (dateFilter === 'week') {
                                                const weekAgo = new Date(today);
                                                weekAgo.setDate(weekAgo.getDate() - 7);
                                                return bDate >= weekAgo;
                                            } else if (dateFilter === 'month') {
                                                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                                return bDate >= monthStart;
                                            }
                                            return true;
                                        });
                                    }

                                    displayBills(filtered);
                                }

    function displayBills(bills) {
        const tbody = document.getElementById('billsTableBody');
        const emptyState = document.getElementById('billsEmptyState');

        tbody.innerHTML = '';

        if (bills.length === 0) {
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');

        bills.forEach((bill) => {
            // FIX: Find the actual index in savedBills array
            const actualIndex = savedBills.findIndex(b => b.id === bill.id);

            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';

            const date = new Date(bill.date);
            const formattedDate = date.toLocaleDateString('en-GB');
            const formattedTime = date.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit'
            });

            row.innerHTML = `
        <td class="px-4 py-3 font-semibold text-green-600">${bill.billNo}</td>
        <td class="px-4 py-3">
            <div>${formattedDate}</div>
            <div class="text-xs text-gray-500">${formattedTime}</div>
        </td>
        <td class="px-4 py-3">
            <div class="font-medium">${bill.customer.name}</div>
            <div class="text-xs text-gray-500">${bill.customer.mobile}</div>
        </td>
        <td class="px-4 py-3 text-center">
            <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">
                ${bill.items.length} items
            </span>
        </td>
        <td class="px-4 py-3 text-right">‚Çπ${bill.total.toFixed(2)}</td>
        <td class="px-4 py-3 text-right">‚Çπ${bill.gst.toFixed(2)}</td>
        <td class="px-4 py-3 text-right font-bold">‚Çπ${bill.netTotal.toFixed(2)}</td>
        <td class="px-4 py-3 text-center">
            <div class="flex gap-2 justify-center">
                <button onclick="viewBill(${actualIndex})" 
                    class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                    üëÅÔ∏è View
                </button>
                <button onclick="reprintBill(${actualIndex})" 
                    class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                    üñ®Ô∏è Reprint
                </button>
            </div>
        </td>
    `;

            tbody.appendChild(row);
        });
    }

   function updateBillStatistics() {
       const today = new Date();
       today.setHours(0, 0, 0, 0);

       const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);

       const todayBills = savedBills.filter(b => {
           const bDate = new Date(b.date);
           bDate.setHours(0, 0, 0, 0);
           return bDate.getTime() === today.getTime();
       });

       const monthBills = savedBills.filter(b => {
           const bDate = new Date(b.date);
           return bDate >= thisMonth;
       });

       const totalValue = savedBills.reduce((sum, b) => sum + b.netTotal, 0);

       document.getElementById('billTotalCount').textContent = savedBills.length;
       document.getElementById('billTotalValue').textContent = `‚Çπ${totalValue.toFixed(0)}`;
       document.getElementById('billMonthCount').textContent = monthBills.length;
       document.getElementById('billTodayCount').textContent = todayBills.length;
   }

   function downloadAllBills() {
       if (savedBills.length === 0) {
           alert('No bills to export!');
           return;
       }

       const data = savedBills.map(b => ({
           'Bill No': b.billNo,
           'Date': new Date(b.date).toLocaleDateString('en-GB'),
           'Customer': b.customer.name,
           'Mobile': b.customer.mobile,
           'Items': b.items.length,
           'Total': b.total.toFixed(2),
           'GST': b.gst.toFixed(2),
           'Net Total': b.netTotal.toFixed(2),
           'Quotation': b.quotationNo
       }));

       const ws = XLSX.utils.json_to_sheet(data);
       const wb = XLSX.utils.book_new();
       XLSX.utils.book_append_sheet(wb, ws, 'Bills');
       XLSX.writeFile(wb, `All_Bills_${new Date().toISOString().split('T')[0]}.xlsx`);
       alert('All bills exported successfully!');
   }

   function clearOldBills() {
       const months = prompt('Delete bills older than how many months? (Enter number)');
       if (!months || isNaN(months)) return;

       const cutoffDate = new Date();
       cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(months));

       const before = savedBills.length;
       savedBills = savedBills.filter(b => new Date(b.date) >= cutoffDate);
       const after = savedBills.length;

       localStorage.setItem('savedBills', JSON.stringify(savedBills));
       loadBillHistory();

       alert(`Deleted ${before - after} old bills`);
   }

    // ========== ACCOUNTS LEDGER FUNCTIONS ==========

    function loadLedgerCustomers() {
        const select = document.getElementById('ledgerCustomerSelect');
        if (!select) return;

        select.innerHTML = '<option value="">-- Select Customer --</option>';

        // Get unique customers from bills
        const uniqueCustomers = [];
        const customerMap = new Map();

        savedBills.forEach(bill => {
            if (!customerMap.has(bill.customer.mobile)) {
                customerMap.set(bill.customer.mobile, bill.customer);
                uniqueCustomers.push(bill.customer);
            }
        });

        uniqueCustomers.sort((a, b) => a.name.localeCompare(b.name));

        uniqueCustomers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.mobile;
            option.textContent = customer.name;
            select.appendChild(option);
        });
    }

    function loadLedger() {
        const customerMobile = document.getElementById('ledgerCustomerSelect').value;
        const period = document.getElementById('ledgerPeriod').value;

        if (!customerMobile) {
            document.getElementById('ledgerCustomerInfo').classList.add('hidden');
            document.getElementById('ledgerSummary').classList.add('hidden');
            document.getElementById('ledgerTransactions').classList.add('hidden');
            document.getElementById('ledgerEmptyState').classList.remove('hidden');
            return;
        }

        // Filter bills by customer
        let customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);

        // Filter by period
        const today = new Date();
        if (period === 'month') {
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            customerBills = customerBills.filter(bill => new Date(bill.date) >= monthStart);
        } else if (period === 'year') {
            const yearStart = new Date(today.getFullYear(), 0, 1);
            customerBills = customerBills.filter(bill => new Date(bill.date) >= yearStart);
        }

        if (customerBills.length === 0) {
            alert('No transactions found for this customer in the selected period');
            return;
        }

        // Get customer info from first bill
        const customer = customerBills[0].customer;

        // Display customer info
        document.getElementById('ledgerCustName').textContent = customer.name;
        document.getElementById('ledgerCustMobile').textContent = customer.mobile;
        document.getElementById('ledgerCustAddress').textContent =
            `${customer.address1}, ${customer.address2}, ${customer.city}`;
        document.getElementById('ledgerTotalTxn').textContent = customerBills.length;

        // Calculate summary
        const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
        const avgBill = totalAmount / customerBills.length;
        const lastBill = customerBills[0]; // Already sorted by date (newest first)
        const lastDate = new Date(lastBill.date).toLocaleDateString('en-GB');

        document.getElementById('ledgerTotalBills').textContent = customerBills.length;
        document.getElementById('ledgerTotalAmount').textContent = `‚Çπ${totalAmount.toFixed(2)}`;
        document.getElementById('ledgerAvgBill').textContent = `‚Çπ${avgBill.toFixed(2)}`;
        document.getElementById('ledgerLastTxn').textContent = lastDate;

        // Display transactions
        const tbody = document.getElementById('ledgerTableBody');
        tbody.innerHTML = '';

        customerBills.forEach(bill => {
            const billIndex = savedBills.findIndex(b => b.id === bill.id);
            const date = new Date(bill.date);
            const formattedDate = date.toLocaleDateString('en-GB');
            const formattedTime = date.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';

            row.innerHTML = `
            <td class="px-4 py-3">
                <div>${formattedDate}</div>
                <div class="text-xs text-gray-500">${formattedTime}</div>
            </td>
            <td class="px-4 py-3 font-semibold text-green-600">${bill.billNo}</td>
            <td class="px-4 py-3">
                <div class="font-medium">Sales Bill</div>
                <div class="text-xs text-gray-500">Ref: ${bill.quotationNo || 'N/A'}</div>
            </td>
            <td class="px-4 py-3 text-center">
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-sm">
                    ${bill.items.length}
                </span>
            </td>
            <td class="px-4 py-3 text-right">‚Çπ${bill.total.toFixed(2)}</td>
            <td class="px-4 py-3 text-right">‚Çπ${bill.gst.toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-bold text-green-600">‚Çπ${bill.netTotal.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">
                <button onclick="viewBill(${billIndex})" 
                    class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                    üëÅÔ∏è View
                </button>
            </td>
        `;

            tbody.appendChild(row);
        });

        // Show sections
        document.getElementById('ledgerCustomerInfo').classList.remove('hidden');
        document.getElementById('ledgerSummary').classList.remove('hidden');
        document.getElementById('ledgerTransactions').classList.remove('hidden');
        document.getElementById('ledgerEmptyState').classList.add('hidden');
    }

    function downloadLedgerReport() {
        const customerMobile = document.getElementById('ledgerCustomerSelect').value;
        if (!customerMobile) {
            alert('Please select a customer first');
            return;
        }

        const period = document.getElementById('ledgerPeriod').value;
        let customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);

        // Filter by period
        const today = new Date();
        if (period === 'month') {
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            customerBills = customerBills.filter(bill => new Date(bill.date) >= monthStart);
        } else if (period === 'year') {
            const yearStart = new Date(today.getFullYear(), 0, 1);
            customerBills = customerBills.filter(bill => new Date(bill.date) >= yearStart);
        }

        if (customerBills.length === 0) {
            alert('No transactions to export');
            return;
        }

        const customer = customerBills[0].customer;
        const wb = XLSX.utils.book_new();

        // Header
        const headerData = [
            [`LEDGER STATEMENT - ${customer.name.toUpperCase()}`],
            [''],
            ['Customer Name:', customer.name],
            ['Mobile:', customer.mobile],
            ['Address:', `${customer.address1}, ${customer.address2}, ${customer.city}`],
            ['Period:', period === 'month' ? 'This Month' : period === 'year' ? 'This Year' : 'All Time'],
            ['Generated:', new Date().toLocaleDateString('en-GB')],
            ['']
        ];

        // Transactions
        const txnHeader = [['Date', 'Bill No', 'Particulars', 'Items', 'Amount', 'GST', 'Net Total']];
        const txnData = customerBills.map(bill => [
            new Date(bill.date).toLocaleDateString('en-GB'),
            bill.billNo,
            `Sales Bill (Ref: ${bill.quotationNo || 'N/A'})`,
            bill.items.length,
            bill.total.toFixed(2),
            bill.gst.toFixed(2),
            bill.netTotal.toFixed(2)
        ]);

        // Summary
        const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
        const summaryData = [
            [''],
            ['SUMMARY'],
            ['Total Transactions:', customerBills.length],
            ['Total Amount:', totalAmount.toFixed(2)],
            ['Average Bill Value:', (totalAmount / customerBills.length).toFixed(2)]
        ];

        // Combine
        const allData = [
            ...headerData,
            ...txnHeader,
            ...txnData,
            ...summaryData
        ];

        const ws = XLSX.utils.aoa_to_sheet(allData);
        ws['!cols'] = [
            { wch: 12 }, { wch: 15 }, { wch: 30 }, { wch: 8 },
            { wch: 15 }, { wch: 15 }, { wch: 15 }
        ];

        XLSX.utils.book_append_sheet(wb, ws, 'Ledger');
        XLSX.writeFile(wb, `Ledger_${customer.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
        alert('Ledger exported successfully!');
    }

    function printLedgerStatement() {
        const customerMobile = document.getElementById('ledgerCustomerSelect').value;
        if (!customerMobile) {
            alert('Please select a customer first');
            return;
        }

        const period = document.getElementById('ledgerPeriod').value;
        let customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);

        // Filter by period
        const today = new Date();
        if (period === 'month') {
            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
            customerBills = customerBills.filter(bill => new Date(bill.date) >= monthStart);
        } else if (period === 'year') {
            const yearStart = new Date(today.getFullYear(), 0, 1);
            customerBills = customerBills.filter(bill => new Date(bill.date) >= yearStart);
        }

        if (customerBills.length === 0) {
            alert('No transactions to print');
            return;
        }

        const customer = customerBills[0].customer;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('ACCOUNT LEDGER STATEMENT', 105, 15, { align: 'center' });

        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Generated: ${new Date().toLocaleDateString('en-GB')}`, 105, 22, { align: 'center' });

        // Customer Info
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Customer Details:', 15, 35);

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Name: ${customer.name}`, 15, 42);
        doc.text(`Mobile: ${customer.mobile}`, 15, 48);
        doc.text(`Address: ${customer.address1}, ${customer.address2}, ${customer.city}`, 15, 54);

        // Transactions Table
        const tableData = customerBills.map(bill => [
            new Date(bill.date).toLocaleDateString('en-GB'),
            bill.billNo,
            `Sales Bill`,
            bill.items.length,
            `‚Çπ${bill.total.toFixed(2)}`,
            `‚Çπ${bill.gst.toFixed(2)}`,
            `‚Çπ${bill.netTotal.toFixed(2)}`
        ]);

        doc.autoTable({
            startY: 62,
            head: [['Date', 'Bill No', 'Type', 'Items', 'Amount', 'GST', 'Net Total']],
            body: tableData,
            theme: 'striped',
            headStyles: {
                fillColor: [139, 92, 246],
                textColor: 255,
                fontSize: 9,
                fontStyle: 'bold'
            },
            bodyStyles: { fontSize: 8 }
        });

        // Summary
        const finalY = doc.lastAutoTable.finalY + 10;
        const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);

        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('SUMMARY', 15, finalY);

        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        doc.text(`Total Transactions: ${customerBills.length}`, 15, finalY + 7);
        doc.text(`Total Amount: ‚Çπ${totalAmount.toFixed(2)}`, 15, finalY + 14);
        doc.text(`Average Bill: ‚Çπ${(totalAmount / customerBills.length).toFixed(2)}`, 15, finalY + 21);

        doc.save(`Ledger_${customer.name}_${new Date().toISOString().split('T')[0]}.pdf`);
        alert('Ledger statement printed!');
    }

    // ========== LEDGER DISPLAY FUNCTIONS ==========

        function updateLedgerDashboard() {
    // Update balances
    document.getElementById('ledgerCashBalance').textContent = `‚Çπ${accountBalances.cash.toFixed(2)}`;
    document.getElementById('ledgerBankBalance').textContent = `‚Çπ${accountBalances.bank.toFixed(2)}`;
    document.getElementById('ledgerReceivables').textContent = `‚Çπ${accountBalances.receivables.toFixed(2)}`;
    document.getElementById('ledgerPayables').textContent = `‚Çπ${accountBalances.payables.toFixed(2)}`;

    // Update metal stocks with values
    const goldValue = accountBalances.goldStock * rates.gold;
    const silverValue = accountBalances.silverStock * rates.silver;
    const platinumValue = accountBalances.platinumStock * rates.platinum;
    
    document.getElementById('ledgerGoldStock').textContent = `${accountBalances.goldStock.toFixed(2)}g`;
    document.getElementById('ledgerGoldValue').textContent = `Value: ‚Çπ${goldValue.toFixed(2)}`;
    
    document.getElementById('ledgerSilverStock').textContent = `${accountBalances.silverStock.toFixed(2)}g`;
    document.getElementById('ledgerSilverValue').textContent = `Value: ‚Çπ${silverValue.toFixed(2)}`;
    
    document.getElementById('ledgerPlatinumStock').textContent = `${accountBalances.platinumStock.toFixed(2)}g`;
    document.getElementById('ledgerPlatinumValue').textContent = `Value: ‚Çπ${platinumValue.toFixed(2)}`;
}

        function showLedgerTransactions() {
            const container = document.getElementById('ledgerSubtabs');

            container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìã All Transactions</h3>
                <div class="flex gap-2">
                    <button onclick="exportLedgerTransactions()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Export
                    </button>
                    <button onclick="showAddManualTransactionModal()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ‚ûï Add Manual Entry
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="mb-4 flex gap-3">
                <input type="text" id="ledgerTxnSearch" placeholder="üîç Search transactions..." 
                    onkeyup="filterLedgerTransactions()"
                    class="flex-1 px-4 py-2 border rounded-lg">
                <select id="ledgerTxnTypeFilter" onchange="filterLedgerTransactions()"
                    class="px-4 py-2 border rounded-lg">
                    <option value="all">All Types</option>
                    <option value="sale">Sales</option>
                    <option value="purchase">Purchases</option>
                    <option value="expense">Expenses</option>
                    <option value="cash_in">Cash In</option>
                    <option value="cash_out">Cash Out</option>
                </select>
            </div>
            
            <!-- Transactions Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Type</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Description</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Reference</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerTxnTableBody"></tbody>
                </table>
            </div>
        </div>
    `;

            displayLedgerTransactions(ledgerTransactions);
        }

        function displayLedgerTransactions(transactions) {
            const tbody = document.getElementById('ledgerTxnTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No transactions yet</td></tr>';
                return;
            }

            transactions.forEach(txn => {
                const date = new Date(txn.date);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const typeColors = {
                    'sale': 'bg-green-100 text-green-800',
                    'purchase': 'bg-purple-100 text-purple-800',
                    'expense': 'bg-red-100 text-red-800',
                    'cash_in': 'bg-blue-100 text-blue-800',
                    'cash_out': 'bg-orange-100 text-orange-800'
                };

                row.innerHTML = `
            <td class="px-4 py-3 text-sm">${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 rounded text-xs font-semibold ${typeColors[txn.type] || 'bg-gray-100 text-gray-800'}">
                    ${txn.type.toUpperCase().replace('_', ' ')}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">${txn.description || '-'}</td>
            <td class="px-4 py-3 text-right font-bold ${txn.amount >= 0 ? 'text-green-600' : 'text-red-600'}">
                ‚Çπ${Math.abs(txn.amount).toFixed(2)}
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${txn.reference || '-'}</td>
        `;

                tbody.appendChild(row);
            });
        }

        function filterLedgerTransactions() {
    const searchTerm = document.getElementById('ledgerTxnSearch')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('ledgerTxnTypeFilter')?.value || 'all';

    let filtered = ledgerTransactions;

    if (typeFilter !== 'all') {
        filtered = filtered.filter(txn => txn.type === typeFilter);
    }

    if (searchTerm) {
        filtered = filtered.filter(txn =>
            (txn.description && txn.description.toLowerCase().includes(searchTerm)) ||
            (txn.reference && txn.reference.toLowerCase().includes(searchTerm)) ||
            (txn.customerName && txn.customerName.toLowerCase().includes(searchTerm)) ||
            (txn.category && txn.category.toLowerCase().includes(searchTerm))
        );
    }

    displayLedgerTransactions(filtered);
}

        function exportLedgerTransactions() {
            if (ledgerTransactions.length === 0) {
                alert('No transactions to export!');
                return;
            }

        // ========== EXPENSE MANAGEMENT ==========

            function showLedgerExpenses() {
    const container = document.getElementById('ledgerSubtabs');

    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üí∏ Expense Management</h3>
                <div class="flex gap-2">
                    <button onclick="downloadExpenseReport()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Download Report
                    </button>
                    <button onclick="showAddExpenseModal()" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        ‚ûï Add Expense
                    </button>
                </div>
            </div>
            
            <!-- Expense Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
                    <p class="text-sm text-gray-600">Today's Expenses</p>
                    <p class="text-2xl font-bold text-red-600" id="expensesToday">‚Çπ0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
                    <p class="text-sm text-gray-600">This Month</p>
                    <p class="text-2xl font-bold text-orange-600" id="expensesMonth">‚Çπ0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                    <p class="text-sm text-gray-600">This Year</p>
                    <p class="text-2xl font-bold text-purple-600" id="expensesYear">‚Çπ0</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                    <p class="text-sm text-gray-600">Total Expenses</p>
                    <p class="text-2xl font-bold text-gray-700" id="expensesTotal">‚Çπ0</p>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="expenseSearch" placeholder="üîç Search expenses..." 
                        onkeyup="filterExpenses()"
                        class="px-4 py-2 border rounded-lg">
                    <select id="expenseCategoryFilter" onchange="filterExpenses()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Categories</option>
                        ${expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                    <select id="expenseDateFilter" onchange="filterExpenses()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Expenses Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Category</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Description</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Payment Mode</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody"></tbody>
                </table>
            </div>
        </div>
    `;

    updateExpenseSummary();
    displayExpenses(expenses);
}

            function updateExpenseSummary() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const yearStart = new Date(today.getFullYear(), 0, 1);

                const todayExpenses = expenses.filter(e => {
                    const eDate = new Date(e.date);
                    eDate.setHours(0, 0, 0, 0);
                    return eDate.getTime() === today.getTime();
                }).reduce((sum, e) => sum + e.amount, 0);

                const monthExpenses = expenses.filter(e => new Date(e.date) >= monthStart)
                    .reduce((sum, e) => sum + e.amount, 0);

                const yearExpenses = expenses.filter(e => new Date(e.date) >= yearStart)
                    .reduce((sum, e) => sum + e.amount, 0);

                const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

                document.getElementById('expensesToday').textContent = `‚Çπ${todayExpenses.toFixed(2)}`;
                document.getElementById('expensesMonth').textContent = `‚Çπ${monthExpenses.toFixed(2)}`;
                document.getElementById('expensesYear').textContent = `‚Çπ${yearExpenses.toFixed(2)}`;
                document.getElementById('expensesTotal').textContent = `‚Çπ${totalExpenses.toFixed(2)}`;
            }

            function displayExpenses(expenseList) {
                const tbody = document.getElementById('expensesTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (expenseList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No expenses recorded</td></tr>';
                    return;
                }

                expenseList.forEach((expense, index) => {
                    const date = new Date(expense.date);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';

                    row.innerHTML = `
            <td class="px-4 py-3 text-sm">
                ${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">
                    ${expense.category}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">${expense.description}</td>
            <td class="px-4 py-3 text-right font-bold text-red-600">‚Çπ${expense.amount.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs">
                    ${expense.paymentMode || 'Cash'}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <button onclick="deleteExpense(${expense.id})" 
                    class="text-red-600 hover:text-red-800 font-medium">
                    üóëÔ∏è
                </button>
            </td>
        `;

                    tbody.appendChild(row);
                });
            }

            function filterExpenses() {
                const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
                const categoryFilter = document.getElementById('expenseCategoryFilter').value;
                const dateFilter = document.getElementById('expenseDateFilter').value;

                let filtered = expenses;

                // Category filter
                if (categoryFilter !== 'all') {
                    filtered = filtered.filter(e => e.category === categoryFilter);
                }

                // Date filter
                if (dateFilter !== 'all') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    filtered = filtered.filter(e => {
                        const eDate = new Date(e.date);
                        eDate.setHours(0, 0, 0, 0);

                        if (dateFilter === 'today') {
                            return eDate.getTime() === today.getTime();
                        } else if (dateFilter === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return eDate >= weekAgo;
                        } else if (dateFilter === 'month') {
                            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                            return eDate >= monthStart;
                        } else if (dateFilter === 'year') {
                            const yearStart = new Date(today.getFullYear(), 0, 1);
                            return eDate >= yearStart;
                        }
                        return true;
                    });
                }

                // Search filter
                if (searchTerm) {
                    filtered = filtered.filter(e =>
                        e.description.toLowerCase().includes(searchTerm) ||
                        e.category.toLowerCase().includes(searchTerm)
                    );
                }

                displayExpenses(filtered);
            }

            function showAddExpenseModal() {
                const modal = document.createElement('div');
                modal.id = 'addExpenseModal';
                modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üí∏ Add Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Category *</label>
                    <select id="expenseCategory" class="w-full px-3 py-2 border rounded-lg">
                        ${expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Description *</label>
                    <input type="text" id="expenseDescription" 
                        placeholder="Enter expense details"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="expenseAmount" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Mode</label>
                    <select id="expensePaymentMode" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="expenseDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveExpense()" 
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                        üíæ Save Expense
                    </button>
                    <button onclick="closeExpenseModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

                document.body.appendChild(modal);
            }

            function saveExpense() {
    const category = document.getElementById('expenseCategory').value;
    const description = document.getElementById('expenseDescription').value.trim();
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    const paymentMode = document.getElementById('expensePaymentMode').value;
    const date = document.getElementById('expenseDate').value;

    if (!description || !amount || amount <= 0) {
        alert('Please fill all required fields with valid values');
        return;
    }

    const expense = {
        id: Date.now(),
        category: category,
        description: description,
        amount: amount,
        paymentMode: paymentMode,
        date: new Date(date).toISOString()
    };

    expenses.unshift(expense);
    localStorage.setItem('expenses', JSON.stringify(expenses));

    // Record in ledger
    recordLedgerTransaction(transactionTypes.EXPENSE, {
        amount: amount,
        description: `${category} - ${description}`,
        category: category,
        paymentMethod: paymentMode,
        reference: `EXP${expense.id}`,
        date: expense.date
    });

    // Update cash balance
    accountBalances.cash -= amount;
    localStorage.setItem('accountBalances', JSON.stringify(accountBalances));

    closeExpenseModal();
    updateLedgerDashboard();
    showLedgerExpenses(); // Refresh display
    
    alert(`‚úÖ Expense Recorded!\n\nCategory: ${category}\nAmount: ‚Çπ${amount.toFixed(2)}\nPayment: ${paymentMode}`);
}

            function deleteExpense(id) {
                if (!confirm('Delete this expense?')) return;

                const expense = expenses.find(e => e.id === id);
                if (!expense) return;

                expenses = expenses.filter(e => e.id !== id);
                localStorage.setItem('expenses', JSON.stringify(expenses));

                // Remove from ledger
                ledgerTransactions = ledgerTransactions.filter(t => t.reference !== `EXP${id}`);
                localStorage.setItem('ledgerTransactions', JSON.stringify(ledgerTransactions));

                // Update balances
                accountBalances.cash += expense.amount; // Add back the expense amount
                localStorage.setItem('accountBalances', JSON.stringify(accountBalances));

                showLedgerExpenses();
                updateLedgerDashboard();
                alert('Expense deleted!');
            }

            function closeExpenseModal() {
                const modal = document.getElementById('addExpenseModal');
                if (modal) modal.remove();
            }

            function downloadExpenseReport() {
                if (expenses.length === 0) {
                    alert('No expenses to export!');
                    return;
                }

            // ========== METAL PURCHASE MANAGEMENT ==========

                function showLedgerPurchases() {
    const container = document.getElementById('ledgerSubtabs');

    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üõí Metal Purchase Management</h3>
                <div class="flex gap-2">
                    <button onclick="downloadPurchaseReport()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Download Report
                    </button>
                    <button onclick="showAddPurchaseModal()" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        ‚ûï Add Purchase
                    </button>
                </div>
            </div>
            
            <!-- Purchase Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                    <p class="text-sm text-gray-600">Gold Purchased</p>
                    <p class="text-2xl font-bold text-yellow-600" id="goldPurchased">0g</p>
                    <p class="text-xs text-gray-500 mt-1" id="goldPurchasedValue">‚Çπ0</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                    <p class="text-sm text-gray-600">Silver Purchased</p>
                    <p class="text-2xl font-bold text-gray-600" id="silverPurchased">0g</p>
                    <p class="text-xs text-gray-500 mt-1" id="silverPurchasedValue">‚Çπ0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                    <p class="text-sm text-gray-600">Platinum Purchased</p>
                    <p class="text-2xl font-bold text-purple-600" id="platinumPurchased">0g</p>
                    <p class="text-xs text-gray-500 mt-1" id="platinumPurchasedValue">‚Çπ0</p>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="purchaseSearch" placeholder="üîç Search purchases..." 
                        onkeyup="filterPurchases()"
                        class="px-4 py-2 border rounded-lg">
                    <select id="purchaseMetalFilter" onchange="filterPurchases()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Metals</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                        <option value="platinum">Platinum</option>
                    </select>
                    <select id="purchaseDateFilter" onchange="filterPurchases()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Purchases Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Supplier</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Metal</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Weight (g)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Rate/g</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Total Amount</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Payment</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="purchasesTableBody"></tbody>
                </table>
            </div>
        </div>
    `;

    updatePurchaseSummary();
    displayPurchases(metalPurchases);
}

                function updatePurchaseSummary() {
                    const goldData = metalPurchases.filter(p => p.metalType === 'gold');
                    const silverData = metalPurchases.filter(p => p.metalType === 'silver');
                    const platinumData = metalPurchases.filter(p => p.metalType === 'platinum');

                    const goldWeight = goldData.reduce((sum, p) => sum + p.weight, 0);
                    const goldValue = goldData.reduce((sum, p) => sum + p.totalAmount, 0);

                    const silverWeight = silverData.reduce((sum, p) => sum + p.weight, 0);
                    const silverValue = silverData.reduce((sum, p) => sum + p.totalAmount, 0);

                    const platinumWeight = platinumData.reduce((sum, p) => sum + p.weight, 0);
                    const platinumValue = platinumData.reduce((sum, p) => sum + p.totalAmount, 0);

                    document.getElementById('goldPurchased').textContent = `${goldWeight.toFixed(2)}g`;
                    document.getElementById('goldPurchasedValue').textContent = `Value: ‚Çπ${goldValue.toFixed(2)}`;

                    document.getElementById('silverPurchased').textContent = `${silverWeight.toFixed(2)}g`;
                    document.getElementById('silverPurchasedValue').textContent = `Value: ‚Çπ${silverValue.toFixed(2)}`;

                    document.getElementById('platinumPurchased').textContent = `${platinumWeight.toFixed(2)}g`;
                    document.getElementById('platinumPurchasedValue').textContent = `Value: ‚Çπ${platinumValue.toFixed(2)}`;
                }

                function displayPurchases(purchaseList) {
                    const tbody = document.getElementById('purchasesTableBody');
                    if (!tbody) return;

                    tbody.innerHTML = '';

                    if (purchaseList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No purchases recorded</td></tr>';
                        return;
                    }

                    purchaseList.forEach(purchase => {
                        const date = new Date(purchase.date);
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';

                        const metalColors = {
                            'gold': 'bg-yellow-100 text-yellow-800',
                            'silver': 'bg-gray-100 text-gray-800',
                            'platinum': 'bg-purple-100 text-purple-800'
                        };

                        row.innerHTML = `
            <td class="px-4 py-3 text-sm">
                ${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3 text-sm font-medium">${purchase.supplier}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 rounded text-xs font-semibold capitalize ${metalColors[purchase.metalType]}">
                    ${purchase.metalType}
                </span>
            </td>
            <td class="px-4 py-3 text-right font-bold">${purchase.weight.toFixed(2)}g</td>
            <td class="px-4 py-3 text-right">‚Çπ${purchase.ratePerGram.toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-bold text-purple-600">‚Çπ${purchase.totalAmount.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs ${purchase.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                    ${purchase.paymentStatus.toUpperCase()}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <button onclick="deletePurchase(${purchase.id})" 
                    class="text-red-600 hover:text-red-800 font-medium">
                    üóëÔ∏è
                </button>
            </td>
        `;

                        tbody.appendChild(row);
                    });
                }

                function filterPurchases() {
                    const searchTerm = document.getElementById('purchaseSearch').value.toLowerCase();
                    const metalFilter = document.getElementById('purchaseMetalFilter').value;
                    const dateFilter = document.getElementById('purchaseDateFilter').value;

                    let filtered = metalPurchases;

                    // Metal filter
                    if (metalFilter !== 'all') {
                        filtered = filtered.filter(p => p.metalType === metalFilter);
                    }

                    // Date filter
                    if (dateFilter !== 'all') {
                        const today = new Date();
                        filtered = filtered.filter(p => {
                            const pDate = new Date(p.date);

                            if (dateFilter === 'month') {
                                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                return pDate >= monthStart;
                            } else if (dateFilter === 'year') {
                                const yearStart = new Date(today.getFullYear(), 0, 1);
                                return pDate >= yearStart;
                            }
                            return true;
                        });
                    }

                    // Search filter
                    if (searchTerm) {
                        filtered = filtered.filter(p =>
                            p.supplier.toLowerCase().includes(searchTerm) ||
                            p.invoiceNo.toLowerCase().includes(searchTerm)
                        );
                    }

                    displayPurchases(filtered);
                }

                function showAddPurchaseModal() {
                    const modal = document.createElement('div');
                    modal.id = 'addPurchaseModal';
                    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üõí Add Metal Purchase</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Supplier Name *</label>
                    <input type="text" id="purchaseSupplier" 
                        placeholder="Enter supplier name"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Metal Type *</label>
                    <select id="purchaseMetalType" class="w-full px-3 py-2 border rounded-lg">
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                        <option value="platinum">Platinum</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Weight (grams) *</label>
                    <input type="number" step="0.01" id="purchaseWeight" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Rate per gram (‚Çπ) *</label>
                    <input type="number" step="0.01" id="purchaseRate" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Total Amount</label>
                    <input type="number" step="0.01" id="purchaseTotalAmount" 
                        readonly
                        class="w-full px-3 py-2 bg-gray-100 border rounded-lg font-bold">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Invoice No</label>
                    <input type="text" id="purchaseInvoiceNo" 
                        placeholder="INV-001"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Status</label>
                    <select id="purchasePaymentStatus" class="w-full px-3 py-2 border rounded-lg">
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="purchaseDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="savePurchase()" 
                        class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
                        üíæ Save Purchase
                    </button>
                    <button onclick="closePurchaseModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

                    document.body.appendChild(modal);

                    // Auto-calculate total amount
                    document.getElementById('purchaseWeight').addEventListener('input', calculatePurchaseTotal);
                    document.getElementById('purchaseRate').addEventListener('input', calculatePurchaseTotal);
                }

                function calculatePurchaseTotal() {
                    const weight = parseFloat(document.getElementById('purchaseWeight').value) || 0;
                    const rate = parseFloat(document.getElementById('purchaseRate').value) || 0;
                    const total = weight * rate;
                    document.getElementById('purchaseTotalAmount').value = total.toFixed(2);
                }

                function savePurchase() {
    const supplier = document.getElementById('purchaseSupplier').value.trim();
    const metalType = document.getElementById('purchaseMetalType').value;
    const weight = parseFloat(document.getElementById('purchaseWeight').value);
    const ratePerGram = parseFloat(document.getElementById('purchaseRate').value);
    const invoiceNo = document.getElementById('purchaseInvoiceNo').value.trim() || `PUR${Date.now()}`;
    const paymentStatus = document.getElementById('purchasePaymentStatus').value;
    const date = document.getElementById('purchaseDate').value;

    if (!supplier || !weight || weight <= 0 || !ratePerGram || ratePerGram <= 0) {
        alert('Please fill all required fields with valid values');
        return;
    }

    const totalAmount = weight * ratePerGram;

    const purchase = {
        id: Date.now(),
        supplier: supplier,
        metalType: metalType,
        weight: weight,
        ratePerGram: ratePerGram,
        totalAmount: totalAmount,
        invoiceNo: invoiceNo,
        paymentStatus: paymentStatus,
        date: new Date(date).toISOString()
    };

    metalPurchases.unshift(purchase);
    localStorage.setItem('metalPurchases', JSON.stringify(metalPurchases));

    // Update metal stock (ADD purchased metals)
    if (metalType === 'gold') {
        accountBalances.goldStock += weight;
    } else if (metalType === 'silver') {
        accountBalances.silverStock += weight;
    } else if (metalType === 'platinum') {
        accountBalances.platinumStock += weight;
    }

    // Update cash/payables based on payment status
    if (paymentStatus === 'paid') {
        accountBalances.cash -= totalAmount;
    } else {
        accountBalances.payables += totalAmount;
    }

    localStorage.setItem('accountBalances', JSON.stringify(accountBalances));

    // Record in ledger
    recordLedgerTransaction(transactionTypes.PURCHASE, {
        amount: totalAmount,
        description: `${metalType.toUpperCase()} Purchase - ${weight}g from ${supplier}`,
        category: 'Metal Purchase',
        paymentMethod: paymentStatus === 'paid' ? 'Cash' : 'Credit',
        reference: invoiceNo,
        supplier: supplier,
        metalType: metalType,
        weight: weight,
        date: purchase.date
    });

    closePurchaseModal();
    updateLedgerDashboard();
    showLedgerPurchases();
    
    alert(`‚úÖ Purchase Recorded!\n\nMetal: ${metalType.toUpperCase()}\nWeight: ${weight}g\nSupplier: ${supplier}\nAmount: ‚Çπ${totalAmount.toFixed(2)}\nStock Updated!`);
}

                function deletePurchase(id) {
                    if (!confirm('Delete this purchase? This will also update your metal stock.')) return;

                    const purchase = metalPurchases.find(p => p.id === id);
                    if (!purchase) return;

                    metalPurchases = metalPurchases.filter(p => p.id !== id);
                    localStorage.setItem('metalPurchases', JSON.stringify(metalPurchases));

                    // Remove from stock
                    if (purchase.metalType === 'gold') {
                        accountBalances.goldStock = Math.max(0, accountBalances.goldStock - purchase.weight);
                    } else if (purchase.metalType === 'silver') {
                        accountBalances.silverStock = Math.max(0, accountBalances.silverStock - purchase.weight);
                    } else if (purchase.metalType === 'platinum') {
                        accountBalances.platinumStock = Math.max(0, accountBalances.platinumStock - purchase.weight);
                    }

                    // Update balances
                    if (purchase.paymentStatus === 'pending') {
                        accountBalances.payables -= purchase.totalAmount;
                    } else {
                        accountBalances.cash += purchase.totalAmount;
                    }

                    localStorage.setItem('accountBalances', JSON.stringify(accountBalances));

                    // Remove from ledger
                    ledgerTransactions = ledgerTransactions.filter(t => t.reference !== purchase.invoiceNo);
                    localStorage.setItem('ledgerTransactions', JSON.stringify(ledgerTransactions));

                    showLedgerPurchases();
                    updateLedgerDashboard();
                    alert('Purchase deleted!');
                }

                function closePurchaseModal() {
                    const modal = document.getElementById('addPurchaseModal');
                    if (modal) modal.remove();
                }

                function downloadPurchaseReport() {
                    if (metalPurchases.length === 0) {
                        alert('No purchases to export!');
                        return;
                    }

                // ========== FINANCIAL REPORTS ==========

                    function showLedgerReports() {
                        const container = document.getElementById('ledgerSubtabs');

                        container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Financial Reports</h3>
            
            <!-- Report Type Selector -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="generateProfitLossReport()" 
                    class="p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl hover:shadow-lg transition">
                    <div class="text-4xl mb-2">üìà</div>
                    <div class="font-bold text-lg">Profit & Loss</div>
                    <div class="text-sm opacity-90">Income Statement</div>
                </button>
                <button onclick="generateBalanceSheet()" 
                    class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transition">
                    <div class="text-4xl mb-2">‚öñÔ∏è</div>
                    <div class="font-bold text-lg">Balance Sheet</div>
                    <div class="text-sm opacity-90">Financial Position</div>
                </button>
                <button onclick="generateCashFlowReport()" 
                    class="p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition">
                    <div class="text-4xl mb-2">üí∞</div>
                    <div class="font-bold text-lg">Cash Flow</div>
                    <div class="text-sm opacity-90">Money Movement</div>
                </button>
            </div>
            
            <!-- Report Display Area -->
            <div id="reportDisplayArea" class="mt-6"></div>
        </div>
    `;
                    }

                    function generateProfitLossReport() {
                        const reportArea = document.getElementById('reportDisplayArea');

                        // Calculate revenue (sales)
                        const totalRevenue = savedBills.reduce((sum, bill) => sum + bill.netTotal, 0);

                        // Calculate COGS (Cost of Goods Sold) - Based on metal purchases
                        const totalCOGS = metalPurchases.reduce((sum, p) => sum + p.totalAmount, 0);

                        // Calculate operating expenses
                        const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

                        // Calculate gross profit
                        const grossProfit = totalRevenue - totalCOGS;
                        const grossProfitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;

                        // Calculate net profit
                        const netProfit = grossProfit - totalExpenses;
                        const netProfitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;

                        // Expense breakdown
                        const expenseByCategory = {};
                        expenses.forEach(e => {
                            if (!expenseByCategory[e.category]) {
                                expenseByCategory[e.category] = 0;
                            }
                            expenseByCategory[e.category] += e.amount;
                        });

                        reportArea.innerHTML = `
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-200">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-bold text-gray-800">üìà Profit & Loss Statement</h4>
                <button onclick="downloadPLReport()" 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    üì• Download PDF
                </button>
            </div>
            
            <!-- Revenue Section -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Revenue</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Sales Revenue</span>
                        <span class="font-bold text-green-600">‚Çπ${totalRevenue.toFixed(2)}</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between">
                        <span class="font-bold">Total Revenue</span>
                        <span class="font-bold text-green-600 text-lg">‚Çπ${totalRevenue.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- COGS Section -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Cost of Goods Sold (COGS)</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Metal Purchases</span>
                        <span class="font-bold text-red-600">‚Çπ${totalCOGS.toFixed(2)}</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between">
                        <span class="font-bold">Total COGS</span>
                        <span class="font-bold text-red-600 text-lg">‚Çπ${totalCOGS.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Gross Profit -->
            <div class="bg-white p-4 rounded-lg mb-4 border-2 border-green-300">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-bold text-xl">Gross Profit</span>
                        <span class="text-sm text-gray-500 ml-2">(${grossProfitMargin.toFixed(2)}% margin)</span>
                    </div>
                    <span class="font-bold text-green-600 text-2xl">‚Çπ${grossProfit.toFixed(2)}</span>
                </div>
            </div>
            
            <!-- Operating Expenses -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Operating Expenses</h5>
                <div class="space-y-2">
                    ${Object.keys(expenseByCategory).map(category => `
                        <div class="flex justify-between">
                            <span class="text-gray-600">${category}</span>
                            <span class="text-red-600">‚Çπ${expenseByCategory[category].toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="border-t pt-2 flex justify-between">
                        <span class="font-bold">Total Operating Expenses</span>
                        <span class="font-bold text-red-600 text-lg">‚Çπ${totalExpenses.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Net Profit -->
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-6 rounded-lg text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-bold text-2xl">Net Profit</span>
                        <span class="text-sm opacity-90 ml-2">(${netProfitMargin.toFixed(2)}% margin)</span>
                    </div>
                    <span class="font-bold text-4xl">‚Çπ${netProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
                    }

                    function generateBalanceSheet() {
                        const reportArea = document.getElementById('reportDisplayArea');

                        // Assets
                        const cashAsset = accountBalances.cash;
                        const bankAsset = accountBalances.bank;
                        const receivables = accountBalances.receivables;

                        // Metal inventory value (at current rates)
                        const goldValue = accountBalances.goldStock * rates.gold;
                        const silverValue = accountBalances.silverStock * rates.silver;
                        const platinumValue = accountBalances.platinumStock * rates.platinum;
                        const inventoryValue = goldValue + silverValue + platinumValue;

                        const totalAssets = cashAsset + bankAsset + receivables + inventoryValue;

                        // Liabilities
                        const payables = accountBalances.payables;
                        const totalLiabilities = payables;

                        // Equity
                        const equity = totalAssets - totalLiabilities;

                        reportArea.innerHTML = `
        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-xl border-2 border-blue-200">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-bold text-gray-800">‚öñÔ∏è Balance Sheet</h4>
                <button onclick="downloadBalanceSheet()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üì• Download PDF
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Assets -->
                <div>
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h5 class="font-bold text-lg text-gray-700 mb-4 border-b pb-2">Assets</h5>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-2">Current Assets</p>
                            <div class="space-y-2 ml-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cash</span>
                                    <span class="font-semibold">‚Çπ${cashAsset.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Bank</span>
                                    <span class="font-semibold">‚Çπ${bankAsset.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Accounts Receivable</span>
                                    <span class="font-semibold">‚Çπ${receivables.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-2">Inventory</p>
                            <div class="space-y-2 ml-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Gold (${accountBalances.goldStock.toFixed(2)}g)</span>
                                    <span class="font-semibold">‚Çπ${goldValue.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Silver (${accountBalances.silverStock.toFixed(2)}g)</span>
                                    <span class="font-semibold">‚Çπ${silverValue.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Platinum (${accountBalances.platinumStock.toFixed(2)}g)</span>
                                    <span class="font-semibold">‚Çπ${platinumValue.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t-2 border-blue-300 pt-3 flex justify-between">
                            <span class="font-bold text-lg">Total Assets</span>
                            <span class="font-bold text-blue-600 text-xl">‚Çπ${totalAssets.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Liabilities & Equity -->
                <div>
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h5 class="font-bold text-lg text-gray-700 mb-4 border-b pb-2">Liabilities</h5>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-2">Current Liabilities</p>
                            <div class="space-y-2 ml-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Accounts Payable</span>
                                    <span class="font-semibold">‚Çπ${payables.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-3 mb-4 flex justify-between">
                            <span class="font-bold">Total Liabilities</span>
                            <span class="font-bold text-red-600">‚Çπ${totalLiabilities.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg">
                        <h5 class="font-bold text-lg text-gray-700 mb-4 border-b pb-2">Equity</h5>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-600">Owner's Equity</span>
                            <span class="font-semibold">‚Çπ${equity.toFixed(2)}</span>
                        </div>
                        
                        <div class="border-t-2 border-blue-300 mt-3 pt-3 flex justify-between">
                            <span class="font-bold">Total Equity</span>
                            <span class="font-bold text-green-600">‚Çπ${equity.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-4 rounded-lg mt-4 text-white">
                        <div class="flex justify-between">
                            <span class="font-bold">Total Liabilities + Equity</span>
                            <span class="font-bold text-xl">‚Çπ${(totalLiabilities + equity).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
                    }

                    function generateCashFlowReport() {
                        const reportArea = document.getElementById('reportDisplayArea');

                        // Operating Activities
                        const cashFromSales = savedBills.reduce((sum, b) => sum + b.netTotal, 0);
                        const cashForPurchases = metalPurchases.filter(p => p.paymentStatus === 'paid')
                            .reduce((sum, p) => sum + p.totalAmount, 0);
                        const cashForExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
                        const netOperatingCash = cashFromSales - cashForPurchases - cashForExpenses;

                        // Investing Activities (if any)
                        const netInvestingCash = 0;

                        // Financing Activities (if any)
                        const netFinancingCash = 0;

                        // Net change in cash
                        const netCashChange = netOperatingCash + netInvestingCash + netFinancingCash;

                        reportArea.innerHTML = `
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-200">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-bold text-gray-800">üí∞ Cash Flow Statement</h4>
                <button onclick="downloadCashFlowReport()" 
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    üì• Download PDF
                </button>
            </div>
            
            <!-- Operating Activities -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Operating Activities</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cash received from customers</span>
                        <span class="font-semibold text-green-600">‚Çπ${cashFromSales.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cash paid for metal purchases</span>
                        <span class="font-semibold text-red-600">-‚Çπ${cashForPurchases.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cash paid for operating expenses</span>
                        <span class="font-semibold text-red-600">-‚Çπ${cashForExpenses.toFixed(2)}</span>
                    </div>
                    <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                        <span class="font-bold">Net Cash from Operating Activities</span>
                        <span class="font-bold ${netOperatingCash >= 0 ? 'text-green-600' : 'text-red-600'} text-lg">
                            ‚Çπ${netOperatingCash.toFixed(2)}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Investing Activities -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Investing Activities</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">No investing activities</span>
                        <span class="font-semibold">‚Çπ0.00</span>
                    </div>
                    <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                        <span class="font-bold">Net Cash from Investing Activities</span>
                        <span class="font-bold text-lg">‚Çπ${netInvestingCash.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Financing Activities -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Financing Activities</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">No financing activities</span>
                        <span class="font-semibold">‚Çπ0.00</span>
                    </div>
                    <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                        <span class="font-bold">Net Cash from Financing Activities</span>
                        <span class="font-bold text-lg">‚Çπ${netFinancingCash.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Net Change -->
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 rounded-lg text-white">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-2xl">Net Change in Cash</span>
                    <span class="font-bold text-4xl">‚Çπ${netCashChange.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
                    }

    // ========== CUSTOMER ACCOUNTS LEDGER ==========

function showLedgerCustomerAccounts() {
    const container = document.getElementById('ledgerSubtabs');
    
    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">üë• Customer Account Ledgers</h3>
                <div class="flex gap-2">
                    <button onclick="downloadAllCustomerLedgers()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Download All
                    </button>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="customerLedgerSearch" 
                        placeholder="üîç Search by customer name or mobile..."
                        oninput="filterCustomerLedgers()"
                        class="px-4 py-2 border rounded-lg">
                    <select id="customerLedgerPeriod" onchange="filterCustomerLedgers()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Customer Accounts Grid -->
            <div id="customerAccountsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Will be populated -->
            </div>
            
            <!-- Empty State -->
            <div id="customerAccountsEmpty" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üë•</div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">No Customer Accounts</h3>
                <p class="text-gray-500">Generate sales bills to create customer accounts</p>
            </div>
        </div>
    `;
    
    displayCustomerAccounts();
}

function displayCustomerAccounts() {
    const grid = document.getElementById('customerAccountsGrid');
    const emptyState = document.getElementById('customerAccountsEmpty');
    
    if (!grid) {
        console.error('Grid element not found!');
        return;
    }
    
    // Get unique customers from bills
    const customerMap = new Map();
    
    savedBills.forEach(bill => {
        const mobile = bill.customer.mobile;
        if (!customerMap.has(mobile)) {
            customerMap.set(mobile, {
                customer: bill.customer,
                bills: [],
                totalAmount: 0,
                totalPaid: 0,
                balance: 0
            });
        }
        
        const account = customerMap.get(mobile);
        account.bills.push(bill);
        account.totalAmount += bill.netTotal;
        account.totalPaid += (bill.paidAmount || 0);
        account.balance = account.totalAmount - account.totalPaid;
    });
    
    console.log('Customer Accounts:', customerMap.size);
    
    if (customerMap.size === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }
    
    grid.classList.remove('hidden');
    emptyState.classList.add('hidden');
    grid.innerHTML = '';
    
    // Convert to array and sort by balance (highest first)
    const accounts = Array.from(customerMap.values()).sort((a, b) => b.balance - a.balance);
    
    accounts.forEach(account => {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl border-2 border-blue-200 hover:shadow-lg transition cursor-pointer';
        card.onclick = () => viewCustomerLedger(account.customer.mobile);
        
        const balanceColor = account.balance > 0 ? 'text-red-600' : 'text-green-600';
        const balanceLabel = account.balance > 0 ? 'Outstanding' : 'Paid';
        
        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-bold text-lg text-gray-800">${account.customer.name}</h4>
                    <p class="text-sm text-gray-600">üì± ${account.customer.mobile}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-xs font-bold ${account.balance > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                    ${account.bills.length} Bills
                </span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">Total Sales:</span>
                    <span class="font-bold">‚Çπ${account.totalAmount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Paid:</span>
                    <span class="font-bold text-green-600">‚Çπ${account.totalPaid.toFixed(2)}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                    <span class="font-bold">${balanceLabel}:</span>
                    <span class="font-bold ${balanceColor} text-lg">‚Çπ${Math.abs(account.balance).toFixed(2)}</span>
                </div>
            </div>
            
            <button class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
                View Full Ledger ‚Üí
            </button>
        `;
        
        grid.appendChild(card);
    });
}

function filterCustomerLedgers() {
    const searchTerm = document.getElementById('customerLedgerSearch')?.value.toLowerCase() || '';
    const period = document.getElementById('customerLedgerPeriod')?.value || 'all';
    
    // Filter bills by period
    let filteredBills = savedBills;
    
    if (period !== 'all') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        filteredBills = savedBills.filter(bill => {
            const billDate = new Date(bill.date);
            billDate.setHours(0, 0, 0, 0);
            
            if (period === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                return billDate >= monthStart;
            } else if (period === 'year') {
                const yearStart = new Date(today.getFullYear(), 0, 1);
                return billDate >= yearStart;
            }
            return true;
        });
    }
    
    // Apply search filter
    if (searchTerm) {
        filteredBills = filteredBills.filter(bill =>
            bill.customer.name.toLowerCase().includes(searchTerm) ||
            bill.customer.mobile.includes(searchTerm)
        );
    }
    
    // Temporarily replace savedBills for display
    const originalBills = savedBills;
    savedBills = filteredBills;
    displayCustomerAccounts();
    savedBills = originalBills;
}

function viewCustomerLedger(customerMobile) {
    const container = document.getElementById('ledgerSubtabs');
    
    // Get customer bills
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    
    if (customerBills.length === 0) {
        alert('No transactions found for this customer');
        return;
    }
    
    const customer = customerBills[0].customer;
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    // Get payment transactions for this customer
    const paymentTransactions = ledgerTransactions.filter(txn => 
        txn.type === transactionTypes.PAYMENT_RECEIVED && 
        txn.customerMobile === customerMobile
    );
    
    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <!-- Header with Back Button -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <button onclick="showLedgerCustomerAccounts()" 
                        class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        ‚Üê Back
                    </button>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">${customer.name}</h3>
                        <p class="text-sm text-gray-600">Customer Account Ledger</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="recordPayment('${customerMobile}')" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üí∞ Record Payment
                    </button>
                    <button onclick="downloadCustomerLedger('${customerMobile}')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        üì• Download
                    </button>
                </div>
            </div>
            
            <!-- Customer Info Card -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl border-2 border-blue-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Contact Information</p>
                        <p class="font-semibold">üì± ${customer.mobile}</p>
                        <p class="text-sm text-gray-700 mt-2">${customer.address1}</p>
                        <p class="text-sm text-gray-700">${customer.address2}</p>
                        <p class="text-sm text-gray-700">${customer.city}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Account Summary</p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm">Total Purchases: <span class="font-bold">‚Çπ${totalAmount.toFixed(2)}</span></p>
                            <p class="text-sm">Total Paid: <span class="font-bold text-green-600">‚Çπ${totalPaid.toFixed(2)}</span></p>
                            <p class="text-lg font-bold mt-2 ${balance > 0 ? 'text-red-600' : 'text-green-600'}">
                                ${balance > 0 ? 'Outstanding' : 'Advance'}: ‚Çπ${Math.abs(balance).toFixed(2)}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Period Filter -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="flex items-center gap-3">
                    <label class="font-medium text-gray-700">Period:</label>
                    <select id="customerLedgerPeriodFilter" onchange="filterCustomerLedgerPeriod('${customerMobile}')"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <div id="customDateRange" class="hidden flex gap-2">
                        <input type="date" id="startDate" class="px-3 py-2 border rounded-lg">
                        <input type="date" id="endDate" class="px-3 py-2 border rounded-lg">
                        <button onclick="applyCustomDateRange('${customerMobile}')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Apply
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Transaction History -->
            <div class="bg-white rounded-lg border">
                <div class="bg-gray-100 px-6 py-3 border-b">
                    <h4 class="font-bold text-gray-800">Transaction History</h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Particulars</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Ref No.</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Debit</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Credit</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="customerLedgerTableBody">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Display transactions
    displayCustomerLedgerTransactions(customerMobile, 'month');
}

function displayCustomerLedgerTransactions(customerMobile, period = 'month') {
    const tbody = document.getElementById('customerLedgerTableBody');
    if (!tbody) {
        console.error('Table body not found!');
        return;
    }
    
    // Get customer bills
    let customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    
    // Get payment transactions
    let paymentTransactions = ledgerTransactions.filter(txn => 
        txn.type === transactionTypes.PAYMENT_RECEIVED && 
        txn.customerMobile === customerMobile
    );
    
    console.log('Customer Bills:', customerBills.length);
    console.log('Payments:', paymentTransactions.length);
    
    // Filter by period - DEFAULT TO THIS MONTH
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (period === 'month') {
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        customerBills = customerBills.filter(bill => {
            const billDate = new Date(bill.date);
            return billDate >= monthStart;
        });
        
        paymentTransactions = paymentTransactions.filter(txn => {
            const txnDate = new Date(txn.date);
            return txnDate >= monthStart;
        });
    } else if (period === 'year') {
        const yearStart = new Date(today.getFullYear(), 0, 1);
        customerBills = customerBills.filter(bill => {
            const billDate = new Date(bill.date);
            return billDate >= yearStart;
        });
        
        paymentTransactions = paymentTransactions.filter(txn => {
            const txnDate = new Date(txn.date);
            return txnDate >= yearStart;
        });
    }
    
    // Combine and sort all transactions by date
    const allTransactions = [];
    
    customerBills.forEach(bill => {
        allTransactions.push({
            date: new Date(bill.date),
            type: 'sale',
            particulars: `Sales Bill - ${bill.items.length} items`,
            reference: bill.billNo,
            debit: bill.netTotal,
            credit: 0,
            bill: bill
        });
    });
    
    paymentTransactions.forEach(txn => {
        allTransactions.push({
            date: new Date(txn.date),
            type: 'payment',
            particulars: `Payment Received - ${txn.paymentMethod || 'Cash'}`,
            reference: txn.reference || txn.id,
            debit: 0,
            credit: txn.amount,
            transaction: txn
        });
    });
    
    // Sort by date (oldest first)
    allTransactions.sort((a, b) => a.date - b.date);
    
    // Calculate running balance
    let balance = 0;
    tbody.innerHTML = '';
    
    if (allTransactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No transactions in selected period</td></tr>';
        return;
    }
    
    allTransactions.forEach((txn, index) => {
        balance += txn.debit - txn.credit;
        
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        
        const date = txn.date;
        const formattedDate = date.toLocaleDateString('en-GB');
        const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        const balanceColor = balance > 0 ? 'text-red-600' : balance < 0 ? 'text-green-600' : 'text-gray-600';
        
        row.innerHTML = `
            <td class="px-4 py-3 text-sm">
                ${formattedDate}<br>
                <span class="text-xs text-gray-500">${formattedTime}</span>
            </td>
            <td class="px-4 py-3">
                <div class="font-medium">${txn.particulars}</div>
                ${txn.type === 'sale' && txn.bill.quotationNo ? `<div class="text-xs text-gray-500">${txn.bill.quotationNo}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs font-semibold ${txn.type === 'sale' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">
                    ${txn.reference}
                </span>
            </td>
            <td class="px-4 py-3 text-right ${txn.debit > 0 ? 'font-bold text-red-600' : 'text-gray-400'}">
                ${txn.debit > 0 ? `‚Çπ${txn.debit.toFixed(2)}` : '-'}
            </td>
            <td class="px-4 py-3 text-right ${txn.credit > 0 ? 'font-bold text-green-600' : 'text-gray-400'}">
                ${txn.credit > 0 ? `‚Çπ${txn.credit.toFixed(2)}` : '-'}
            </td>
            <td class="px-4 py-3 text-right font-bold ${balanceColor}">
                ‚Çπ${Math.abs(balance).toFixed(2)} ${balance > 0 ? 'Dr' : balance < 0 ? 'Cr' : ''}
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Add closing balance row
    const closingRow = document.createElement('tr');
    closingRow.className = 'bg-gray-100 font-bold border-t-2 border-gray-400';
    closingRow.innerHTML = `
        <td colspan="3" class="px-4 py-3 text-right">Closing Balance:</td>
        <td class="px-4 py-3 text-right">-</td>
        <td class="px-4 py-3 text-right">-</td>
        <td class="px-4 py-3 text-right ${balance > 0 ? 'text-red-600' : balance < 0 ? 'text-green-600' : 'text-gray-600'}">
            ‚Çπ${Math.abs(balance).toFixed(2)} ${balance > 0 ? 'Dr' : balance < 0 ? 'Cr' : ''}
        </td>
    `;
    tbody.appendChild(closingRow);
}

function filterCustomerLedgerPeriod(customerMobile) {
    const period = document.getElementById('customerLedgerPeriodFilter').value;
    const customRange = document.getElementById('customDateRange');
    
    if (period === 'custom') {
        customRange.classList.remove('hidden');
    } else {
        customRange.classList.add('hidden');
        displayCustomerLedgerTransactions(customerMobile, period);
    }
}

function applyCustomDateRange(customerMobile) {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    // Custom filter logic here
    displayCustomerLedgerTransactions(customerMobile, 'all');
}

function recordPayment(customerMobile) {
    const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
    if (!customer) return;
    
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    if (balance <= 0) {
        alert('No outstanding balance for this customer');
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'recordPaymentModal';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üí∞ Record Payment</h3>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <p class="font-semibold text-gray-800">${customer.name}</p>
                <p class="text-sm text-gray-600">üì± ${customer.mobile}</p>
                <p class="text-lg font-bold text-red-600 mt-2">Outstanding: ‚Çπ${balance.toFixed(2)}</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="paymentAmount" 
                        max="${balance}" value="${balance}"
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Method *</label>
                    <select id="paymentMethod" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Reference/Transaction ID</label>
                    <input type="text" id="paymentReference" 
                        placeholder="Optional"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Date</label>
                    <input type="date" id="paymentDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="paymentNotes" rows="2" 
                        placeholder="Optional notes"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="savePayment('${customerMobile}')" 
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        üíæ Save Payment
                    </button>
                    <button onclick="closePaymentModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function savePayment(customerMobile) {
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const reference = document.getElementById('paymentReference').value.trim() || `PAY${Date.now()}`;
    const date = document.getElementById('paymentDate').value;
    const notes = document.getElementById('paymentNotes').value.trim();
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid payment amount');
        return;
    }
    
    const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
    if (!customer) {
        alert('Customer not found!');
        return;
    }
    
    // Calculate outstanding balance
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    if (amount > balance) {
        if (!confirm(`Payment amount (‚Çπ${amount.toFixed(2)}) exceeds outstanding balance (‚Çπ${balance.toFixed(2)}).\n\nDo you want to record this as an advance payment?`)) {
            return;
        }
    }
    
    // Update bills with payment (allocate to oldest bills first)
    let remainingAmount = amount;
    const updatedBills = [];
    
    // Sort bills by date (oldest first)
    const sortedBills = savedBills
        .filter(bill => bill.customer.mobile === customerMobile)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    sortedBills.forEach(bill => {
        if (remainingAmount > 0) {
            const billBalance = bill.netTotal - (bill.paidAmount || 0);
            if (billBalance > 0) {
                const paymentForBill = Math.min(remainingAmount, billBalance);
                bill.paidAmount = (bill.paidAmount || 0) + paymentForBill;
                bill.paymentStatus = bill.paidAmount >= bill.netTotal ? 'paid' : 'partial';
                remainingAmount -= paymentForBill;
                updatedBills.push(bill.billNo);
            }
        }
    });
    
    localStorage.setItem('savedBills', JSON.stringify(savedBills));
    
    // Record in ledger
    recordLedgerTransaction(transactionTypes.PAYMENT_RECEIVED, {
        amount: amount,
        customerName: customer.name,
        customerMobile: customerMobile,
        description: `Payment received from ${customer.name}${notes ? ' - ' + notes : ''}`,
        category: 'Payment Received',
        paymentMethod: method,
        reference: reference,
        billsUpdated: updatedBills.join(', ')
    });
    
    // Update balances
    accountBalances.cash += amount;
    accountBalances.receivables = Math.max(0, accountBalances.receivables - amount);
    localStorage.setItem('accountBalances', JSON.stringify(accountBalances));
    
    closePaymentModal();
    updateLedgerDashboard();
    viewCustomerLedger(customerMobile); // Refresh the ledger view
    
    alert(`‚úÖ Payment recorded successfully!\n\nAmount: ‚Çπ${amount.toFixed(2)}\nMethod: ${method}\nReference: ${reference}\n\nBills Updated: ${updatedBills.join(', ') || 'None (Advance)'}\n\nCustomer account updated.`);
}

function closePaymentModal() {
    const modal = document.getElementById('recordPaymentModal');
    if (modal) modal.remove();
}

function downloadCustomerLedger(customerMobile) {
    const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
    if (!customer) return;
    
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const paymentTransactions = ledgerTransactions.filter(txn => 
        txn.type === transactionTypes.PAYMENT_RECEIVED && 
        txn.customerMobile === customerMobile
    );
    
    const wb = XLSX.utils.book_new();
    
    // Header
    const headerData = [
        ['CUSTOMER ACCOUNT LEDGER'],
        [''],
        ['Customer Name:', customer.name],
        ['Mobile:', customer.mobile],
        ['Address:', `${customer.address1}, ${customer.address2}, ${customer.city}`],
        ['Statement Date:', new Date().toLocaleDateString('en-GB')],
        ['']
    ];
    
    // Transactions
    const allTransactions = [];
    
    customerBills.forEach(bill => {
        allTransactions.push({
            Date: new Date(bill.date).toLocaleDateString('en-GB'),
            Particulars: `Sales Bill - ${bill.items.length} items`,
            Reference: bill.billNo,
            Debit: bill.netTotal.toFixed(2),
            Credit: '',
            type: 'sale',
            date: new Date(bill.date)
        });
    });
    
    paymentTransactions.forEach(txn => {
        allTransactions.push({
            Date: new Date(txn.date).toLocaleDateString('en-GB'),
            Particulars: `Payment Received - ${txn.paymentMethod || 'Cash'}`,
            Reference: txn.reference || txn.id,
            Debit: '',
            Credit: txn.amount.toFixed(2),
            type: 'payment',
            date: new Date(txn.date)
        });
    });
    
    // Sort by date
    allTransactions.sort((a, b) => a.date - b.date);
    
    // Calculate running balance
    let balance = 0;
    const txnData = allTransactions.map(txn => {
        const debit = txn.Debit ? parseFloat(txn.Debit) : 0;
        const credit = txn.Credit ? parseFloat(txn.Credit) : 0;
        balance += debit - credit;
        
        return {
            'Date': txn.Date,
            'Particulars': txn.Particulars,
            'Reference': txn.Reference,
            'Debit': txn.Debit,
            'Credit': txn.Credit,
            'Balance': `${Math.abs(balance).toFixed(2)} ${balance > 0 ? 'Dr' : balance < 0 ? 'Cr' : ''}`
        };
    });
    
    const txnHeaders = [['Date', 'Particulars', 'Reference', 'Debit', 'Credit', 'Balance']];
    const txnRows = txnData.map(obj => [obj.Date, obj.Particulars, obj.Reference, obj.Debit, obj.Credit, obj.Balance]);
    
    // Summary
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const outstanding = totalAmount - totalPaid;
    
    const summaryData = [
        [''],
        ['ACCOUNT SUMMARY'],
        ['Total Sales:', totalAmount.toFixed(2)],
        ['Total Paid:', totalPaid.toFixed(2)],
        ['Outstanding Balance:', outstanding.toFixed(2)]
    ];
    
    // Combine
    const allData = [
        ...headerData,
        ...txnHeaders,
        ...txnRows,
        ...summaryData
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(allData);
    ws['!cols'] = [
        { wch: 12 }, { wch: 35 }, { wch: 15 }, 
        { wch: 15 }, { wch: 15 }, { wch: 20 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Ledger');
    XLSX.writeFile(wb, `Ledger_${customer.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('Customer ledger downloaded successfully!');
}

function downloadAllCustomerLedgers() {
    if (savedBills.length === 0) {
        alert('No customer accounts to export!');
        return;
    }
    
    // Get unique customers
    const customerMap = new Map();
    
    savedBills.forEach(bill => {
        const mobile = bill.customer.mobile;
        if (!customerMap.has(mobile)) {
            customerMap.set(mobile, {
                customer: bill.customer,
                bills: [],
                totalAmount: 0,
                totalPaid: 0,
                balance: 0
            });
        }
        
        const account = customerMap.get(mobile);
        account.bills.push(bill);
        account.totalAmount += bill.netTotal;
        account.totalPaid += bill.paidAmount || 0;
        account.balance = account.totalAmount - account.totalPaid;
    });
    
    const wb = XLSX.utils.book_new();
    
    // Summary sheet
    const summaryData = [
        ['ALL CUSTOMER ACCOUNTS SUMMARY'],
        ['Generated:', new Date().toLocaleDateString('en-GB')],
        [''],
        ['Customer Name', 'Mobile', 'Total Sales', 'Total Paid', 'Outstanding']
    ];
    
    Array.from(customerMap.values()).forEach(account => {
        summaryData.push([
            account.customer.name,
            account.customer.mobile,
            account.totalAmount.toFixed(2),
            account.totalPaid.toFixed(2),
            account.balance.toFixed(2)
        ]);
    });
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    wsSummary['!cols'] = [
        { wch: 30 }, { wch: 15 }, { wch: 15 }, 
        { wch: 15 }, { wch: 15 }
    ];
    
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
    
    XLSX.writeFile(wb, `All_Customer_Ledgers_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('All customer ledgers downloaded successfully!');
}

                    // Download functions for reports
                    function downloadPLReport() {
                        alert('Profit & Loss Report PDF download functionality - Implement jsPDF generation here');
                    }

                    function downloadBalanceSheet() {
                        alert('Balance Sheet PDF download functionality - Implement jsPDF generation here');
                    }

                    function downloadCashFlowReport() {
                        alert('Cash Flow Report PDF download functionality - Implement jsPDF generation here');
                    }

                    const data = metalPurchases.map(p => ({
                        'Date': new Date(p.date).toLocaleDateString('en-GB'),
                        'Supplier': p.supplier,
                        'Metal Type': p.metalType.toUpperCase(),
                        'Weight (g)': p.weight.toFixed(2),
                        'Rate/g': p.ratePerGram.toFixed(2),
                        'Total Amount': p.totalAmount.toFixed(2),
                        'Invoice No': p.invoiceNo,
                        'Payment Status': p.paymentStatus.toUpperCase()
                    }));

                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Metal Purchases');
                    XLSX.writeFile(wb, `Metal_Purchases_${new Date().toISOString().split('T')[0]}.xlsx`);
                    alert('Purchase report downloaded!');
                }

                const data = expenses.map(e => ({
                    'Date': new Date(e.date).toLocaleDateString('en-GB'),
                    'Category': e.category,
                    'Description': e.description,
                    'Amount': e.amount.toFixed(2),
                    'Payment Mode': e.paymentMode || 'Cash'
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
                XLSX.writeFile(wb, `Expense_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('Expense report downloaded!');
            }

            const data = ledgerTransactions.map(txn => ({
                'Date': new Date(txn.date).toLocaleDateString('en-GB'),
                'Type': txn.type.toUpperCase(),
                'Description': txn.description || '',
                'Amount': txn.amount.toFixed(2),
                'Reference': txn.reference || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            XLSX.writeFile(wb, `Ledger_Transactions_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('Transactions exported successfully!');
        }

        // ========== CASH ENTRY FUNCTIONS ==========

function showCashEntryModal() {
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('modalOverlay').classList.add('flex');
    document.getElementById('cashEntryModal').classList.remove('hidden');
}

function closeCashEntryModal() {
    document.getElementById('cashEntryModal').classList.add('hidden');
    document.getElementById('modalOverlay').classList.add('hidden');
}

function updateCashEntryFields() {
    const type = document.getElementById('cashEntryType').value;
    const categorySelect = document.getElementById('cashEntryCategory');
    
    // Update category options based on type
    if (type === 'cash_in') {
        categorySelect.innerHTML = `
            <option value="Sales">Sales</option>
            <option value="Customer Payment">Customer Payment</option>
            <option value="Owner Investment">Owner Investment</option>
            <option value="Loan Received">Loan Received</option>
            <option value="Other Income">Other Income</option>
        `;
    } else {
        categorySelect.innerHTML = `
            <option value="Purchase">Purchase</option>
            <option value="Supplier Payment">Supplier Payment</option>
            <option value="Expense">Expense</option>
            <option value="Loan Repayment">Loan Repayment</option>
            <option value="Owner Withdrawal">Owner Withdrawal</option>
            <option value="Other Payment">Other Payment</option>
        `;
    }
}

function saveCashEntry() {
    const type = document.getElementById('cashEntryType').value;
    const amount = parseFloat(document.getElementById('cashEntryAmount').value);
    const category = document.getElementById('cashEntryCategory').value;
    const description = document.getElementById('cashEntryDescription').value.trim();
    const reference = document.getElementById('cashEntryReference').value.trim() || `CASH${Date.now()}`;
    const date = document.getElementById('cashEntryDate').value;
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (!description) {
        alert('Please enter a description');
        return;
    }
    
    // Record in ledger
    const transactionType = type === 'cash_in' ? transactionTypes.CASH_IN : transactionTypes.CASH_OUT;
    
    recordLedgerTransaction(transactionType, {
        amount: amount,
        description: `${category} - ${description}`,
        category: category,
        paymentMethod: 'Cash',
        reference: reference,
        date: new Date(date).toISOString()
    });
    
    // Update cash balance
    if (type === 'cash_in') {
        accountBalances.cash += amount;
    } else {
        accountBalances.cash -= amount;
    }
    
    localStorage.setItem('accountBalances', JSON.stringify(accountBalances));
    
    closeCashEntryModal();
    updateLedgerDashboard();
    
    alert(`‚úÖ Cash Entry Recorded!\n\nType: ${type === 'cash_in' ? 'Cash In' : 'Cash Out'}\nAmount: ‚Çπ${amount.toFixed(2)}\nCategory: ${category}\nReference: ${reference}`);
    
    // If on ledger tab, refresh display
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        showLedgerTransactions();
    }
}

function filterExpenses() {
    const searchTerm = document.getElementById('expenseSearch')?.value.toLowerCase() || '';
    const categoryFilter = document.getElementById('expenseCategoryFilter')?.value || 'all';
    const dateFilter = document.getElementById('expenseDateFilter')?.value || 'all';

    let filtered = expenses;

    // Category filter
    if (categoryFilter !== 'all') {
        filtered = filtered.filter(e => e.category === categoryFilter);
    }

    // Date filter
    if (dateFilter !== 'all') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        filtered = filtered.filter(e => {
            const eDate = new Date(e.date);
            eDate.setHours(0, 0, 0, 0);

            if (dateFilter === 'today') {
                return eDate.getTime() === today.getTime();
            } else if (dateFilter === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                return eDate >= weekAgo;
            } else if (dateFilter === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                return eDate >= monthStart;
            } else if (dateFilter === 'year') {
                const yearStart = new Date(today.getFullYear(), 0, 1);
                return eDate >= yearStart;
            }
            return true;
        });
    }

    // Search filter
    if (searchTerm) {
        filtered = filtered.filter(e =>
            e.description.toLowerCase().includes(searchTerm) ||
            e.category.toLowerCase().includes(searchTerm)
        );
    }

    displayExpenses(filtered);
}

function filterPurchases() {
    const searchTerm = document.getElementById('purchaseSearch')?.value.toLowerCase() || '';
    const metalFilter = document.getElementById('purchaseMetalFilter')?.value || 'all';
    const dateFilter = document.getElementById('purchaseDateFilter')?.value || 'all';

    let filtered = metalPurchases;

    // Metal filter
    if (metalFilter !== 'all') {
        filtered = filtered.filter(p => p.metalType === metalFilter);
    }

    // Date filter
    if (dateFilter !== 'all') {
        const today = new Date();
        filtered = filtered.filter(p => {
            const pDate = new Date(p.date);

            if (dateFilter === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                return pDate >= monthStart;
            } else if (dateFilter === 'year') {
                const yearStart = new Date(today.getFullYear(), 0, 1);
                return pDate >= yearStart;
            }
            return true;
        });
    }

    // Search filter
    if (searchTerm) {
        filtered = filtered.filter(p =>
            p.supplier.toLowerCase().includes(searchTerm) ||
            p.invoiceNo.toLowerCase().includes(searchTerm)
        );
    }

    displayPurchases(filtered);
}

function filterCustomerLedgers() {
    const searchTerm = document.getElementById('customerLedgerSearch')?.value.toLowerCase() || '';
    const period = document.getElementById('customerLedgerPeriod')?.value || 'all';
    
    // Filter bills by period
    let filteredBills = savedBills;
    
    if (period !== 'all') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        filteredBills = savedBills.filter(bill => {
            const billDate = new Date(bill.date);
            billDate.setHours(0, 0, 0, 0);
            
            if (period === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                return billDate >= monthStart;
            } else if (period === 'year') {
                const yearStart = new Date(today.getFullYear(), 0, 1);
                return billDate >= yearStart;
            }
            return true;
        });
    }
    
    // Apply search filter
    if (searchTerm) {
        filteredBills = filteredBills.filter(bill =>
            bill.customer.name.toLowerCase().includes(searchTerm) ||
            bill.customer.mobile.includes(searchTerm)
        );
    }
    
    // Temporarily replace savedBills for display
    const originalBills = savedBills;
    savedBills = filteredBills;
    displayCustomerAccounts();
    savedBills = originalBills;
}

function downloadExpenseReport() {
    if (expenses.length === 0) {
        alert('No expenses to export!');
        return;
    }

    const wb = XLSX.utils.book_new();
    
    // Header
    const headerData = [
        ['EXPENSE REPORT'],
        ['Generated:', new Date().toLocaleDateString('en-GB')],
        ['']
    ];
    
    const data = expenses.map(e => ({
        'Date': new Date(e.date).toLocaleDateString('en-GB'),
        'Category': e.category,
        'Description': e.description,
        'Amount': e.amount.toFixed(2),
        'Payment Mode': e.paymentMode || 'Cash'
    }));
    
    // Summary
    const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
    const summaryData = [
        [''],
        ['TOTAL EXPENSES:', totalExpenses.toFixed(2)]
    ];
    
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.sheet_add_aoa(ws, headerData, { origin: 'A1' });
    XLSX.utils.sheet_add_aoa(ws, summaryData, { origin: -1 });
    
    XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
    XLSX.writeFile(wb, `Expense_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('Expense report downloaded!');
}

function downloadPurchaseReport() {
    if (metalPurchases.length === 0) {
        alert('No purchases to export!');
        return;
    }

    const wb = XLSX.utils.book_new();
    
    const data = metalPurchases.map(p => ({
        'Date': new Date(p.date).toLocaleDateString('en-GB'),
        'Supplier': p.supplier,
        'Metal Type': p.metalType.toUpperCase(),
        'Weight (g)': p.weight.toFixed(2),
        'Rate/g': p.ratePerGram.toFixed(2),
        'Total Amount': p.totalAmount.toFixed(2),
        'Invoice No': p.invoiceNo,
        'Payment Status': p.paymentStatus.toUpperCase()
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Metal Purchases');
    XLSX.writeFile(wb, `Metal_Purchases_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('Purchase report downloaded!');
}

function showBankEntryModal() {
    const modal = document.createElement('div');
    modal.id = 'bankEntryModal';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üè¶ Bank Entry</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Entry Type *</label>
                    <select id="bankEntryType" class="w-full px-3 py-2 border rounded-lg">
                        <option value="deposit">Bank Deposit (Cash ‚Üí Bank)</option>
                        <option value="withdrawal">Bank Withdrawal (Bank ‚Üí Cash)</option>
                        <option value="customer_payment">Customer Payment (Bank)</option>
                        <option value="supplier_payment">Supplier Payment (Bank)</option>
                    </select>
                </div>
                
                <div id="customerSelectDiv" class="hidden">
                    <label class="block text-sm font-medium mb-1">Select Customer *</label>
                    <select id="bankEntryCustomer" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">-- Select Customer --</option>
                    </select>
                    <div id="customerBalanceInfo" class="mt-2 text-sm text-gray-600"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="bankEntryAmount" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Bank Name</label>
                    <input type="text" id="bankEntryBankName" 
                        placeholder="e.g., HDFC Bank"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Transaction Reference *</label>
                    <input type="text" id="bankEntryReference" 
                        placeholder="UTR/IMPS/NEFT/RTGS Number"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="bankEntryDescription" rows="2" 
                        placeholder="Enter transaction details"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="bankEntryDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveBankEntry()" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        üíæ Save Entry
                    </button>
                    <button onclick="closeBankEntryModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
document.body.appendChild(modal);

    // ‚úÖ FIXED: Use requestAnimationFrame for reliable DOM rendering
    requestAnimationFrame(() => {
        // Populate customer dropdown
        populateBankEntryCustomers();
        
        // Add event listener for entry type change
        const typeSelect = document.getElementById('bankEntryType');
        if (typeSelect) {
            typeSelect.addEventListener('change', function() {
                const type = this.value;
                const customerDiv = document.getElementById('customerSelectDiv');
                
                if (type === 'customer_payment') {
                    customerDiv.classList.remove('hidden');
                } else {
                    customerDiv.classList.add('hidden');
                }
            });
        }
        
        // Add event listener for customer selection
        const customerSelect = document.getElementById('bankEntryCustomer');
        if (customerSelect) {
            customerSelect.addEventListener('change', function() {
                const customerMobile = this.value;
                if (customerMobile) {
                    showCustomerBalance(customerMobile);
                }
            });
        }
    });
}


function populateBankEntryCustomers() {
    const select = document.getElementById('bankEntryCustomer');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Select Customer --</option>';
    
    // Get unique customers with outstanding balance
    const customerMap = new Map();
    
    savedBills.forEach(bill => {
        const mobile = bill.customer.mobile;
        if (!customerMap.has(mobile)) {
            customerMap.set(mobile, {
                customer: bill.customer,
                totalAmount: 0,
                totalPaid: 0
            });
        }
        
        const account = customerMap.get(mobile);
        account.totalAmount += bill.netTotal;
        account.totalPaid += bill.paidAmount || 0;
    });
    
    // Only show customers with outstanding balance
    Array.from(customerMap.values())
        .filter(account => account.totalAmount > account.totalPaid)
        .sort((a, b) => a.customer.name.localeCompare(b.customer.name))
        .forEach(account => {
            const option = document.createElement('option');
            option.value = account.customer.mobile;
            option.textContent = `${account.customer.name} - Outstanding: ‚Çπ${(account.totalAmount - account.totalPaid).toFixed(2)}`;
            select.appendChild(option);
        });
}

function showCustomerBalance(customerMobile) {
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    const infoDiv = document.getElementById('customerBalanceInfo');
    if (balance > 0) {
        infoDiv.innerHTML = `<span class="font-semibold text-red-600">Outstanding Balance: ‚Çπ${balance.toFixed(2)}</span>`;
        document.getElementById('bankEntryAmount').value = balance.toFixed(2);
    } else {
        infoDiv.innerHTML = `<span class="font-semibold text-green-600">No outstanding balance</span>`;
    }
}

function saveBankEntry() {
    const type = document.getElementById('bankEntryType').value;
    const amount = parseFloat(document.getElementById('bankEntryAmount').value);
    const bankName = document.getElementById('bankEntryBankName').value.trim();
    const reference = document.getElementById('bankEntryReference').value.trim();
    const description = document.getElementById('bankEntryDescription').value.trim();
    const date = document.getElementById('bankEntryDate').value;
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (!reference) {
        alert('Please enter transaction reference');
        return;
    }
    
    let transactionData = {
        amount: amount,
        description: description || `Bank ${type}`,
        paymentMethod: 'Bank Transfer',
        reference: reference,
        date: new Date(date).toISOString(),
        bankName: bankName
    };
    
    switch (type) {
        case 'deposit':
            // Cash to Bank
            recordLedgerTransaction(transactionTypes.BANK_DEPOSIT, transactionData);
            accountBalances.cash -= amount;
            accountBalances.bank += amount;
            break;
            
        case 'withdrawal':
            // Bank to Cash
            recordLedgerTransaction(transactionTypes.BANK_WITHDRAWAL, transactionData);
            accountBalances.bank -= amount;
            accountBalances.cash += amount;
            break;
            
        case 'customer_payment':
            // Customer payment via bank
            const customerMobile = document.getElementById('bankEntryCustomer').value;
            if (!customerMobile) {
                alert('Please select a customer');
                return;
            }
            
            const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
            if (!customer) {
                alert('Customer not found!');
                return;
            }
            
            // Update customer bills
            let remainingAmount = amount;
            const updatedBills = [];
            
            savedBills
                .filter(bill => bill.customer.mobile === customerMobile)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(bill => {
                    if (remainingAmount > 0) {
                        const billBalance = bill.netTotal - (bill.paidAmount || 0);
                        if (billBalance > 0) {
                            const paymentForBill = Math.min(remainingAmount, billBalance);
                            bill.paidAmount = (bill.paidAmount || 0) + paymentForBill;
                            bill.paymentStatus = bill.paidAmount >= bill.netTotal ? 'paid' : 'partial';
                            remainingAmount -= paymentForBill;
                            updatedBills.push(bill.billNo);
                        }
                    }
                });
            
            localStorage.setItem('savedBills', JSON.stringify(savedBills));
            
            transactionData.customerName = customer.name;
            transactionData.customerMobile = customerMobile;
            transactionData.description = `Bank payment from ${customer.name}${description ? ' - ' + description : ''}`;
            transactionData.billsUpdated = updatedBills.join(', ');
            
            recordLedgerTransaction(transactionTypes.PAYMENT_RECEIVED, transactionData);
            accountBalances.bank += amount;
            accountBalances.receivables = Math.max(0, accountBalances.receivables - amount);
            break;
            
        case 'supplier_payment':
            // Payment to supplier via bank
            recordLedgerTransaction(transactionTypes.PAYMENT_MADE, transactionData);
            accountBalances.bank -= amount;
            accountBalances.payables = Math.max(0, accountBalances.payables - amount);
            break;
    }
    
    localStorage.setItem('accountBalances', JSON.stringify(accountBalances));
    
    closeBankEntryModal();
    updateLedgerDashboard();
    
    alert(`‚úÖ Bank Entry Recorded!\n\nType: ${type.replace('_', ' ').toUpperCase()}\nAmount: ‚Çπ${amount.toFixed(2)}\nReference: ${reference}`);
    
    // Refresh ledger if visible
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        showLedgerTransactions();
    }
}

function closeBankEntryModal() {
    const modal = document.getElementById('bankEntryModal');
    if (modal) modal.remove();
}



            </script>
    </body>
    
    </html>