<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JP Jewellery Estimations - Complete</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
    
    /* Table hover effects */
    tbody tr:hover {
        background-color: #f9fafb !important;
    }
    
    /* Modal backdrop blur */
    #modalOverlay {
        backdrop-filter: blur(2px);
    }
    
    /* Print styles for ledger */
    @media print {
        .no-print {
            display: none !important;
        }
        
        body {
            background: white !important;
        }
    }
</style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen">
    <!-- Authentication Modal -->
    <div id="authModal" class="fixed inset-0 flex items-center justify-center z-50 bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900">
        <div class="bg-white p-10 rounded-lg shadow-2xl max-w-md w-full mx-4 border-2 border-gray-200">
            <div class="text-center mb-8">
                <div class="text-4xl font-bold text-gray-800 mb-2">Gaurav Softwares</div>
                <div class="text-xl text-gray-600 mb-6">JP Jewellery Estimations</div>
                <div class="h-1 w-24 bg-amber-600 mx-auto"></div>
            </div>
            <form onsubmit="event.preventDefault(); handleLogin();">
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Client / Tenant</label>
                        <select id="authTenant" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition"
                            onchange="loadTenants()">
                            <option value="">Loading clients...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                        <input type="text" id="authUsername" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" 
                            autofocus placeholder="Enter your username">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                        <input type="password" id="authPassword" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition" 
                            onkeypress="if(event.key==='Enter') {event.preventDefault(); handleLogin();}" 
                            placeholder="Enter your password">
                    </div>
                    <button type="submit" class="w-full px-4 py-3 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-bold text-lg shadow-lg transition transform hover:scale-105">
                        Sign In
                    </button>
                </div>
            </form>
            <div class="mt-6 text-center text-xs text-gray-500">
                ¬© 2025 Gaurav Softwares. All rights reserved.
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4 hidden">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
            <div class="bg-gradient-to-r from-amber-600 to-orange-600 text-white p-6">
                <div class="flex justify-between items-center flex-wrap gap-4">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">üíé JP Jewellery Estimations</h1>
                        <p class="text-amber-100" id="quotationNo">Quotation No: Q0001</p>
                    </div>
                    <div class="flex gap-3 flex-wrap items-center">
                        <div class="flex items-center gap-2 text-sm" id="userInfoSection">
                            <span class="text-amber-100" id="currentUserName">User: Guest</span>
                            <span id="userManagementBtn" class="hidden">
                                <button onclick="showUserManagement()" id="btnManageUsers" class="px-3 py-1 bg-white text-amber-600 rounded text-xs hover:bg-amber-50 hidden">üë• Manage Users</button>
                            </span>
                            <button onclick="logout()" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Logout</button>
                        </div>
                        <button onclick="showTab('billing')" id="btnBilling"
                            class="px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition">üìã
                            Billing</button>
                        <button onclick="showTab('products')" id="btnProducts"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üì¶
                            Products</button>
                        <button onclick="showTab('customers')" id="btnCustomers"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üë•
                            Customers</button>
                        <button onclick="showTab('rol')" id="btnROL"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìä ROL</button>
                        <button onclick="showTab('salesbill')" id="btnSalesBill"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üí∞Sales Bill</button>
                        <button onclick="showTab('quotations')" id="btnQuotations"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìú
                            Quotations</button>
                        <button onclick="showTab('billhistory')" id="btnBillHistory" 
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìãBillHistory</button>
                        <button onclick="showTab('ledger')" id="btnLedger"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìí Ledger</button>
                        <button onclick="showTab('pv')" id="btnPV"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üìã PV StockIn</button>
                        <button onclick="showTab('tagsplit')" id="btnTagSplit"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">‚úÇÔ∏è Tag
                            Split/Merge</button>
                        <button onclick="showTab('tagsearch')" id="btnTagSearch"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üîç Tag Search</button>
                        <button onclick="showTab('floor')" id="btnFloor"
                            class="px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition">üè¢ Floor</button>
                    </div>
                </div>
            </div>
        </div>
        

<!-- Billing Tab - REPLACE ENTIRE billingTab div -->
<div id="billingTab" class="space-y-4">
    <!-- Customer Details Card - Compact -->
    <div class="bg-white p-4 rounded-xl shadow-lg">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Customer</label>
                <input type="text" id="customerSelect" list="customerList" 
                    oninput="handleCustomerInput()" onchange="handleCustomerSelect()"
                    placeholder="Type or select customer..."
                    class="w-full px-3 py-2 text-sm border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                <datalist id="customerList">
                </datalist>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Mobile</label>
                <input type="text" id="customerMobile" readonly class="w-full px-3 py-2 text-sm bg-gray-100 border rounded-lg">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Rate Slab</label>
                <select id="rateSlab" onchange="updateRateSlabInfo()"
                    class="w-full px-3 py-2 text-sm border-2 border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500 font-semibold">
                    <option value="R">R</option>
                    <option value="R1">R1</option>
                    <option value="R2">R2</option>
                    <option value="R3">R3</option>
                    <option value="R4">R4</option>
                </select>
            </div>
            <div class="flex items-end gap-2">
                <button onclick="showNewCustomerModal()"
                    class="flex-1 px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 font-medium">‚ûï New</button>
            </div>
        </div>
        
        <!-- Customer Details Compact Display -->
        <div id="customerDetailsDisplay" class="mt-3 hidden">
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-3 rounded-lg border-l-4 border-amber-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800" id="custName"></p>
                        <p class="text-xs text-gray-600" id="custAddress"></p>
                    </div>
                    <div class="bg-amber-600 text-white px-3 py-1 rounded-lg text-center">
                        <p class="text-xs">Rate Slab</p>
                        <p class="text-lg font-bold" id="rateSlabDisplay">R</p>
                        <p class="text-xs" id="rateSlabDesc">Standard</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Grid: Scanner & Rates | Product Table -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
        <!-- LEFT COLUMN: Scanner, Rates, Manual Entry -->
        <div class="lg:col-span-1 space-y-4">
            <!-- Barcode Scanner -->
            <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg">
                <div class="flex items-center gap-2 mb-3">
                    <span class="text-2xl">üì∑</span>
                    <h3 class="font-bold text-lg">Scanner</h3>
                </div>
                <input id="barcodeInput" type="text" placeholder="Scan barcode..."
                    class="w-full px-4 py-3 border-2 border-white/30 rounded-lg focus:ring-2 focus:ring-white text-lg text-gray-900 font-semibold" autofocus>
                <p class="text-xs text-blue-100 mt-2">üîç Press Enter</p>
            </div>

            <!-- Current Rates -->
            <div class="bg-white p-4 rounded-xl shadow-lg border-2 border-amber-200">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-gray-800 text-sm">Current Rates</h3>
                    <button onclick="showRatesModal()" class="px-2 py-1 bg-amber-600 text-white text-xs rounded hover:bg-amber-700">Update</button>
                </div>
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-yellow-50 rounded">
                        <span class="text-xs font-medium">Gold</span>
                        <span class="text-sm font-bold text-yellow-600" id="goldRate">‚Çπ7500/gm</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <span class="text-xs font-medium">Silver</span>
                        <span class="text-sm font-bold text-gray-600" id="silverRate">‚Çπ156/gm</span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-purple-50 rounded">
                        <span class="text-xs font-medium">Platinum</span>
                        <span class="text-sm font-bold text-gray-800" id="platinumRate">‚Çπ3500/gm</span>
                    </div>
                </div>
            </div>

            <!-- Manual Entry Form -->
            <div class="bg-white p-3 rounded-xl shadow-lg border">
                <h3 class="font-bold text-gray-800 text-sm mb-2">Manual Entry</h3>
                <div class="space-y-2">
                    <input type="text" id="itemSku" placeholder="SKU (S=Silver Rings, A=Silver Articles, B=Bullion)" class="w-full px-2 py-1.5 text-xs border rounded" onkeypress="handleSkuShortcut(event)">
                    <input type="text" id="itemStyleCode" placeholder="Style Code" class="w-full px-2 py-1.5 text-xs border rounded">
                    <input type="text" id="itemName" placeholder="Item Name" class="w-full px-2 py-1.5 text-xs border rounded">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="itemSize" placeholder="Size" class="px-2 py-1.5 text-xs border rounded">
                        <input type="number" step="0.01" id="itemWeight" placeholder="Weight" class="px-2 py-1.5 text-xs border rounded">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" step="0.1" id="itemPurity" placeholder="Purity %" value="100" class="px-2 py-1.5 text-xs border rounded">
                        <input type="number" step="0.01" id="itemRate" placeholder="Rate/gm" class="px-2 py-1.5 text-xs border rounded">
                    </div>
                    <input type="number" step="0.01" id="itemMcRate" placeholder="MC Rate/gm" class="w-full px-2 py-1.5 text-xs border rounded">
                    
                    <div>
                        <label class="block text-xs font-medium mb-1">MC Type</label>
                        <select id="itemMcType" onchange="updateMCTypeLabel()" class="w-full px-2 py-1.5 text-xs border rounded">
                            <option value="MC/GM">MC per Gram</option>
                            <option value="PieceCost">Piece Cost</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-medium mb-1">PCS (Pieces)</label>
                        <input type="number" id="itemPcs" placeholder="1" value="1" min="1" class="w-full px-2 py-1.5 text-xs border rounded">
                    </div>
                    <input type="hidden" id="itemMetalType">
                    <input type="number" step="0.01" id="itemBoxCharges" placeholder="Box Charges"
                        class="w-full px-2 py-1.5 text-xs border rounded">
                    <input type="number" step="0.01" id="itemStoneCharges" placeholder="Stone Charges"
                        class="w-full px-2 py-1.5 text-xs border rounded">
                    <div class="bg-amber-50 border-2 border-amber-300 rounded p-2 text-center">
                        <p class="text-xs text-gray-600">Amount</p>
                        <div class="text-lg font-bold text-amber-700" id="itemAmount">‚Çπ0.00</div>
                    </div>
                    <button onclick="addItem()" class="w-full px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 font-bold">‚ûï Add</button>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Product Table (Excel-like) -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-lg border-2 border-blue-200">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-t-xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-bold">üì¶ Scanned Products</h3>
                        <span class="bg-white text-blue-600 px-3 py-1 rounded-full font-bold" id="itemCount">0 Items</span>
                    </div>
                </div>
                
                <!-- Table Container - Scrollable -->
                <div class="overflow-auto" style="max-height: calc(100vh - 380px); min-height: 600px;">
                    <!-- Empty State -->
                    <div id="emptyProductsState" class="text-center py-16">
                        <div class="text-6xl mb-4">üîç</div>
                        <h4 class="text-xl font-bold text-gray-700 mb-2">No Products Scanned</h4>
                        <p class="text-gray-500">Scan a barcode to begin</p>
                    </div>
                    
                    <!-- Products Table - Excel Style -->
                    <table id="productsTable" class="w-full hidden text-sm">
                        <thead class="bg-gray-200 sticky top-0 z-10">
                            <tr class="border-b-2 border-gray-400">
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">#</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Barcode</th>
                                <th class="px-3 py-2 text-left font-bold text-gray-700 border-r">Item Name</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">SKU</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Style</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Metal</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Size</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r bg-blue-50">Weight (g)</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700 border-r">Purity%</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-yellow-50">Rate/g</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-orange-50">MC/g</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-purple-50">Box</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-pink-50">Stone</th>
                                <th class="px-2 py-2 text-right font-bold text-gray-700 border-r bg-green-50">Amount</th>
                                <th class="px-2 py-2 text-center font-bold text-gray-700">Action</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Summary Footer -->
                <div class="border-t-2 border-gray-300 bg-gradient-to-r from-amber-50 to-orange-50 p-4 rounded-b-xl mt-4">
                    <div class="grid grid-cols-5 gap-4 text-center">
                        <div>
                            <p class="text-xs text-gray-600 mb-1">Items</p>
                            <p class="text-xl font-bold text-gray-800" id="totalItems">0</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">TOTAL WEIGHT</p>
                            <p class="text-xl font-bold text-blue-600" id="summaryTotalWeight">0.00g</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">SUBTOTAL</p>
                            <p class="text-xl font-bold text-gray-800" id="summaryTotal">‚Çπ0.00</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-600 mb-1">GST (3%)</p>
                            <p class="text-xl font-bold text-blue-600" id="summaryGst">‚Çπ0.00</p>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg px-3 py-2">
                            <p class="text-xs mb-1">NET TOTAL</p>
                            <p class="text-2xl font-bold" id="summaryNetTotal">‚Çπ0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-3 gap-4 mt-6">
        <button onclick="generateQuote()"
            class="px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl hover:shadow-xl font-bold text-lg transition-all">üìÑ
            Generate Quote</button>
        <button onclick="showCashReceiveModal()"
            class="px-6 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-xl hover:shadow-xl font-bold text-lg transition-all">üíµ
            Cash Receive</button>
        <button onclick="clearAll()"
            class="px-6 py-4 bg-gradient-to-r from-gray-600 to-gray-700 text-white rounded-xl hover:shadow-xl font-bold text-lg transition-all">üóëÔ∏è
            Clear All</button>
    </div>
</div>

<!-- Products Tab -->   
<div id="productsTab" class="space-y-6 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
            <h2 class="text-2xl font-bold text-gray-800">üì¶ Product Management</h2>
            <div class="flex gap-2 flex-wrap">
                <button onclick="downloadStockReport()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìä Stock
                    Report</button>
                <button onclick="downloadAllProducts()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                    Download All</button>
                <button onclick="downloadSampleExcel()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìã
                    Sample</button>
                <button onclick="showBulkUploadModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">üì§ Bulk
                    Upload</button>
                <button onclick="showAddProductModal()"
                    class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-bold text-sm">‚ûï Add
                    Product</button>
                <button onclick="showBulkUpdateModal()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-bold text-sm">‚öôÔ∏è Bulk Update MC</button>
            </div>
        </div>

        <!-- Barcode Scanner for Product Management -->
        <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 rounded-xl border-2 border-purple-200 mb-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-xl">üì∑</span>
                <h3 class="font-semibold text-gray-800">Quick Add by Barcode</h3>
            </div>
            <input id="productBarcodeInput" type="text" placeholder="Scan barcode to quickly add new product..."
                class="w-full px-4 py-2 border-2 border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500">
            <p class="text-xs text-gray-600 mt-1">Scan a new barcode to auto-fill product form</p>
        </div>

        <!-- Search Bar -->
        <div class="mb-4">
            <input type="text" id="productSearch"
                placeholder="üîç Search by Barcode, SKU, Style Code, or Product Name..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 text-base"
                oninput="filterProducts()">
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Barcode</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">SKU</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Style Code</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Name</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Size</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Avg Wt</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Metal</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Purity%</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">MC Rate</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold">PCS</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Box</th>
                        <th class="px-4 py-3 text-left text-sm font-semibold">Stone</th>
                        <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody"></tbody>
            </table>
        </div>
    </div>
</div>

        <!-- Customers Tab -->
        <div id="customersTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üë• Customer Management</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadAllCustomers()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì• Download All</button>
                        <button onclick="downloadSampleCustomerExcel()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìã Sample</button>
                        <button onclick="showBulkUploadCustomerModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">üì§ Bulk Upload</button>
                        <button onclick="showNewCustomerModal()" class="px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-bold text-sm">‚ûï Add Customer</button>
                    </div>
                </div>
                <div id="customersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- ROL Tab -->
        <div id="rolTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üìä Reorder Level (ROL) Management - Style Code Based</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadROLReportForStyleCode()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                            Download ROL Data</button>
                        <button onclick="downloadROLSample()"
                            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">üìã
                            Download Sample</button>
                        <button onclick="showROLUploadModal()"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">üì§ Upload
                            ROL Data</button>
                    </div>
                </div>
        
                <!-- Style Code Selection Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border-2 border-blue-200 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Style Code</label>
                            <input type="text" id="rolSelectedStyleCode" list="rolStyleCodeList" 
                                placeholder="Type or select style code to view/upload ROL data..." 
                                onchange="loadROLForStyleCode()" oninput="loadROLForStyleCode()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg">
                            <datalist id="rolStyleCodeList">
                                <!-- Will be populated dynamically -->
                            </datalist>
                        </div>
                        <div class="flex items-end">
                            <button onclick="clearROLSelection()"
                                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-medium">üîÑ
                                Clear</button>
                        </div>
                    </div>
                </div>

                <!-- ROL Counters Display (Only shown when style code is selected) -->
                <div id="rolCountersSection" class="hidden mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Wholesale Counter (Multiple Pieces) -->
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üì¶ Wholesale Counter</h3>
                                <span class="text-sm opacity-90">(Multiple Pieces - Weight in gms)</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm opacity-90 mb-1">ROL Set (gms)</p>
                                    <p class="text-3xl font-bold" id="rolWholesaleSet">0</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Available (gms)</p>
                                    <p class="text-3xl font-bold" id="rolWholesaleAvailable">0</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Required (gms)</p>
                                    <p class="text-3xl font-bold" id="rolWholesaleRequired">0</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Status</p>
                                    <p class="text-2xl font-bold" id="rolWholesaleStatus">OK</p>
                                </div>
                            </div>
                        </div>

                        <!-- Retail Counter (Single Piece) -->
                        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">üõçÔ∏è Retail Counter</h3>
                                <span class="text-sm opacity-90">(Single Piece - Number of pieces)</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-sm opacity-90 mb-1">ROL Set (pcs)</p>
                                    <p class="text-3xl font-bold" id="rolRetailSet">0</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Available (pcs)</p>
                                    <p class="text-3xl font-bold" id="rolRetailAvailable">0</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Required (pcs)</p>
                                    <p class="text-3xl font-bold" id="rolRetailRequired">0</p>
                                </div>
                                <div>
                                    <p class="text-sm opacity-90 mb-1">Status</p>
                                    <p class="text-2xl font-bold" id="rolRetailStatus">OK</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ROL Items Table (Only shown when style code is selected) -->
                <div id="rolItemsSection" class="hidden">
                    <h3 class="text-lg font-bold mb-4">ROL Items for Selected Style Code</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-semibold border">Design (Product Name)</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold border">SKU</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold border">Size</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold border bg-orange-100">ROL Wholesale (gms)</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold border bg-orange-100">Available Wholesale (gms)</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold border bg-green-100">ROL Retail (pcs)</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold border bg-green-100">Available Retail (pcs)</th>
                                    <th class="px-4 py-3 text-center text-sm font-semibold border">Status</th>
                                </tr>
                            </thead>
                            <tbody id="rolItemsTableBody">
                                <!-- Will be populated when style code is selected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty State -->
                <div id="rolEmptyState" class="text-center py-16">
                    <div class="text-6xl mb-4">üìä</div>
                    <h4 class="text-xl font-bold text-gray-700 mb-2">Select a Style Code</h4>
                    <p class="text-gray-500">Choose a style code above to view or upload ROL data</p>
                </div>
            </div>
        </div>
        <!-- Quotations History Tab -->
        <div id="quotationsTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üìú Quotation History</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadAllQuotations()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                            Export All</button>
                        <button onclick="clearOldQuotations()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">üóëÔ∏è
                            Clear Old</button>
                    </div>
                </div>
        
                <!-- Search and Filter -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border-2 border-blue-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="quotationSearch" onkeyup="filterQuotations()"
                                placeholder="üîç Search by Quote No, Customer..."
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Customer</label>
                            <select id="quotationCustomerFilter" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Customers</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Status</label>
                            <select id="quotationStatusFilter" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Quotations</option>
                                <option value="pending">Pending Bills</option>
                                <option value="billed">Already Billed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Remarks</label>
                            <select id="quotationRemarksFilter" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">All Remarks</option>
                                <option value="rate-unfixed">Rate-Unfixed</option>
                                <option value="approval">Approval</option>
                                <option value="repair and polish">Repair and Polish</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">From Date</label>
                            <input type="date" id="quotationFromDate" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">To Date</label>
                            <input type="date" id="quotationToDate" onchange="filterQuotations()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
        
                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Quotations</p>
                        <p class="text-3xl font-bold" id="quotationTotalCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Value</p>
                        <p class="text-2xl font-bold" id="quotationTotalValue">‚Çπ0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">This Month</p>
                        <p class="text-3xl font-bold" id="quotationMonthCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Today</p>
                        <p class="text-3xl font-bold" id="quotationTodayCount">0</p>
                    </div>
                </div>
        
                <!-- Quotations Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Quote No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Items</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">GST</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Net Total</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Remarks</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="quotationsTableBody"></tbody>
                    </table>
                </div>
        
                <!-- Empty State -->
                <div id="quotationsEmptyState" class="text-center py-12 hidden">
                    <div class="text-6xl mb-4">üìã</div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">No Quotations Yet</h3>
                    <p class="text-gray-500">Generate your first quotation from the Billing tab</p>
                </div>
            </div>
        </div>

        <!-- Sales Bill Tab -->
        <div id="salesbillTab" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">üí∞ Sales Bill</h2>
        
                <!-- Step 1: Select Quotation -->
                <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <h3 class="font-semibold text-blue-900 mb-3">Step 1: Select Quotation to Convert</h3>
                    <div class="flex gap-4 items-end">
                        <div class="flex-1">
                            <label class="block text-sm font-medium mb-2">Select Quotation</label>
                            <select id="selectQuotationForBill" class="w-full border rounded px-3 py-2"
                                onchange="loadQuotationForBill()">
                                <option value="">-- Select a Quotation --</option>
                            </select>
                        </div>
                        <button onclick="refreshQuotationsList()"
                            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                            üîÑ Refresh List
                        </button>
                    </div>
                </div>
        
                <!-- Quotation Details Display (Hidden by default) -->
                <div id="selectedQuotationDetails" class="hidden mb-6 p-4 bg-gray-50 border rounded">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div>
                            <span class="text-sm text-gray-600">Quotation No:</span>
                            <div class="font-semibold text-lg" id="selectedQuotNo"></div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">Customer:</span>
                            <div class="font-semibold" id="selectedQuotCustomer"></div>
                        </div>
                        <div>
                            <span class="text-sm text-gray-600">Total Amount:</span>
                            <div class="font-semibold text-green-600" id="selectedQuotAmount"></div>
                        </div>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600">Items:</span>
                        <div class="font-medium" id="selectedQuotItems"></div>
                    </div>
                </div>
        
                <!-- Current Rates Display -->
                <div id="billRatesSection" class="hidden mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
                    <h3 class="font-semibold mb-2">üìä Current Rates</h3>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>Gold: <span id="billGoldRate" class="font-semibold"></span></div>
                        <div>Silver: <span id="billSilverRate" class="font-semibold"></span></div>
                        <div>Platinum: <span id="billPlatinumRate" class="font-semibold"></span></div>
                    </div>
                </div>
        
                <!-- Step 2: Rate Slab Selection -->
                <div id="billRateSlabSection" class="hidden mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded">
                    <h3 class="font-semibold text-green-900 mb-3">Step 2: Select Rate Slab (Optional Discount)</h3>
                    <div class="flex gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium mb-2">Rate Slab</label>
                            <select id="billRateSlab" class="border rounded px-3 py-2" onchange="updateBillRateSlabInfo()">
                                <option value="R">R - Standard Rate</option>
                                <option value="R1">R1 - MC Discount ‚Çπ2/gm</option>
                                <option value="R2">R2 - MC Discount ‚Çπ5/gm</option>
                                <option value="R3">R3 - MC Discount ‚Çπ10/gm</option>
                                <option value="R4">R4 - MC Discount ‚Çπ15/gm</option>
                            </select>
                        </div>
                        <div class="flex-1 text-sm">
                            <div>Selected: <span id="billRateSlabDisplay" class="font-semibold">R</span></div>
                            <div class="text-gray-600" id="billRateSlabDesc">Standard Rate</div>
                        </div>
                    </div>
                </div>
        
                <!-- Items Table -->
                <div id="billItemsTableContainer" class="hidden mb-6">
                    <h3 class="font-semibold mb-3">üì¶ Bill Items</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse border">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="border px-4 py-2">#</th>
                                    <th class="border px-4 py-2">Item Name</th>
                                    <th class="border px-4 py-2">Weight (gm)</th>
                                    <th class="border px-4 py-2">Rate</th>
                                    <th class="border px-4 py-2">MC Rate</th>
                                    <th class="border px-4 py-2">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="billItemsTableBody"></tbody>
                        </table>
                    </div>
                </div>
        
                <!-- Bill Summary -->
                <div id="billSummarySection" class="hidden mb-6 p-4 bg-gray-100 rounded">
                    <h3 class="font-semibold mb-3">üí∞ Bill Summary</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span>Subtotal:</span>
                            <span id="billSummaryTotal" class="font-semibold">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600">
                            <span>GST (3%):</span>
                            <span id="billSummaryGst">‚Çπ0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-green-600 border-t pt-2">
                            <span>Net Total:</span>
                            <span id="billSummaryNetTotal">‚Çπ0.00</span>
                        </div>
                    </div>
                </div>
        
                <!-- Action Buttons -->
                <div id="billActionsSection" class="hidden flex gap-4">
                    <button onclick="generateSalesBill()"
                        class="flex-1 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                        üìÑ Generate Bill
                    </button>
                    <button onclick="clearBillSelection()"
                        class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600">
                        üîÑ Clear & Start New
                    </button>
                </div>
            </div>
        </div>

        <!-- Bill History Tab -->
        <div id="billHistoryTab" class="space-y-6 hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
                    <h2 class="text-2xl font-bold text-gray-800">üí∞ Sales Bill History</h2>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="downloadAllBills()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">üì•
                            Export All</button>
                        <button onclick="clearOldBills()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-sm">üóëÔ∏è
                            Clear Old</button>
                    </div>
                </div>
        
                <!-- Search and Filter -->
                <div class="bg-gradient-to-r from-green-50 to-teal-50 p-4 rounded-xl border-2 border-green-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="billSearch" onkeyup="filterBills()"
                                placeholder="üîç Search by Bill No, Customer..."
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Customer</label>
                            <select id="billCustomerFilter" onchange="filterBills()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="all">All Customers</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Date</label>
                            <select id="billDateFilter" onchange="filterBills()"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="all">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                            </select>
                        </div>
                    </div>
                </div>
        
                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Bills</p>
                        <p class="text-3xl font-bold" id="billTotalCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Total Revenue</p>
                        <p class="text-2xl font-bold" id="billTotalValue">‚Çπ0</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">This Month</p>
                        <p class="text-3xl font-bold" id="billMonthCount">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow">
                        <p class="text-sm opacity-90">Today</p>
                        <p class="text-3xl font-bold" id="billTodayCount">0</p>
                    </div>
                </div>
        
                <!-- Bills Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Bill No</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Items</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">GST</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Net Total</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="billsTableBody"></tbody>
                    </table>
                </div>
        
                <!-- Empty State -->
                <div id="billsEmptyState" class="text-center py-12 hidden">
                    <div class="text-6xl mb-4">üí∞</div>
                    <h3 class="text-xl font-bold text-gray-700 mb-2">No Bills Yet</h3>
                    <p class="text-gray-500">Generate your first sales bill from the Sales Bill tab</p>
                </div>
            </div>
        </div>

        <!-- Accounts Ledger Tab -->
<div id="ledgerTab" class="space-y-6 hidden">
    <!-- Dashboard Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Cash Balance</p>
            <p class="text-3xl font-bold" id="ledgerCashBalance">‚Çπ0</p>
            <p class="text-xs mt-1">üíµ Available Cash</p>
        </div>
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Bank Balance</p>
            <p class="text-3xl font-bold" id="ledgerBankBalance">‚Çπ0</p>
            <p class="text-xs mt-1">üè¶ Total in Banks</p>
        </div>
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Receivables</p>
            <p class="text-3xl font-bold" id="ledgerReceivables">‚Çπ0</p>
            <p class="text-xs mt-1">üì• To Collect</p>
        </div>
        <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg">
            <p class="text-sm opacity-90">Payables</p>
            <p class="text-3xl font-bold" id="ledgerPayables">‚Çπ0</p>
            <p class="text-xs mt-1">üì§ To Pay</p>
        </div>
    </div>

    <!-- Metal Stock Overview -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Metal Inventory (Weight)</h3>
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                <p class="text-sm text-gray-600">Gold Stock</p>
                <p class="text-2xl font-bold text-yellow-600" id="ledgerGoldStock">0g</p>
                <p class="text-xs text-gray-500 mt-1" id="ledgerGoldValue">Value: ‚Çπ0</p>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                <p class="text-sm text-gray-600">Silver Stock</p>
                <p class="text-2xl font-bold text-gray-600" id="ledgerSilverStock">0g</p>
                <p class="text-xs text-gray-500 mt-1" id="ledgerSilverValue">Value: ‚Çπ0</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                <p class="text-sm text-gray-600">Platinum Stock</p>
                <p class="text-2xl font-bold text-purple-600" id="ledgerPlatinumStock">0g</p>
                <p class="text-xs text-gray-500 mt-1" id="ledgerPlatinumValue">Value: ‚Çπ0</p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
<div class="grid grid-cols-2 md:grid-cols-6 gap-3 mb-6">
    <button onclick="showCashEntryModal()"
        class="px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
        üíµ Cash Entry
    </button>
    <button onclick="showBankEntryModal()"
        class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
        üè¶ Bank Entry
    </button>
    <button onclick="showLedgerCustomerAccounts()"
        class="px-4 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">
        üë• Customer Accounts
    </button>
    <button onclick="showLedgerTransactions()"
        class="px-4 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium">
        üìã All Transactions
    </button>
    <button onclick="showLedgerExpenses()"
        class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
        üí∏ Expenses
    </button>
    <button onclick="showLedgerPurchases()"
        class="px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium">
        üõí Metal Purchases
    </button>
</div>

    <!-- Subtabs Container -->
    <div id="ledgerSubtabs">
        <!-- Will be populated by subtab functions -->
    </div>
</div>

<!-- Purchase Voucher (PV) Stock In Tab -->
<div id="pvTab" class="space-y-6 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">üìã Purchase Voucher - Stock In</h2>
            <div class="flex gap-2">
                <button onclick="downloadPVSample()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">
                    üìã Download Sample
                </button>
                <button onclick="showPVUploadModal()"
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-sm">
                    üì§ Upload Stock
                </button>
                <button onclick="showPVSearchView()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-sm">
                    üîç Search PV
                </button>
            </div>
        </div>

        <!-- PV Statistics -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
            <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-4 rounded-lg shadow">
                <p class="text-sm opacity-90">Total PVs</p>
                <p class="text-3xl font-bold" id="pvTotalCount">0</p>
            </div>
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-4 rounded-lg shadow">
                <p class="text-sm opacity-90">Total Value</p>
                <p class="text-2xl font-bold" id="pvTotalValue">‚Çπ0</p>
            </div>
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-4 rounded-lg shadow">
                <p class="text-sm opacity-90">This Month</p>
                <p class="text-3xl font-bold" id="pvMonthCount">0</p>
            </div>
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white p-4 rounded-lg shadow">
                <p class="text-sm opacity-90">Total Products</p>
                <p class="text-3xl font-bold" id="pvTotalProducts">0</p>
            </div>
        </div>

        <!-- PV List Section -->
        <div id="pvListSection">
            <!-- Filter -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="pvSearch" placeholder="üîç Search PV Number, Supplier..."
                        oninput="filterPVList()" class="px-4 py-2 border rounded-lg">
                    <select id="pvDateFilter" onchange="filterPVList()" class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    <select id="pvSupplierFilter" onchange="filterPVList()" class="px-4 py-2 border rounded-lg">
                        <option value="all">All Suppliers</option>
                    </select>
                </div>
            </div>

            <!-- PV Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">PV No</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Supplier</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Products</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Total Weight</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Total Value</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pvTableBody"></tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div id="pvEmptyState" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üìã</div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">No Purchase Vouchers</h3>
                <p class="text-gray-500">Upload your first stock to create a PV</p>
            </div>
        </div>
    </div>
</div>

<!-- Tag Split/Merge Tab -->
<div id="tagsplitTab" class="space-y-6 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">‚úÇÔ∏è Tag Split & Merge Management</h2>
            <div class="flex gap-2">
                <button onclick="showSplitHistory()"
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold text-sm">
                    üìä Split History
                </button>
            </div>
        </div>

        <!-- Barcode Scanner for Tag Split -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 mb-6">
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">üì∑</span>
                <h3 class="font-bold text-xl text-gray-800">Scan Product to Split/Merge</h3>
            </div>
            <input id="tagSplitBarcodeInput" type="text" placeholder="Scan barcode here..." autofocus
                class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg font-semibold">
            <p class="text-sm text-gray-600 mt-2">Press Enter after scanning</p>
        </div>

        <!-- Current Product Display (Initially Hidden) -->
        <div id="currentTagProduct" class="hidden">
            <!-- Product Info Card -->
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-6 rounded-xl border-2 border-amber-300 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Barcode</p>
                        <p class="text-lg font-bold text-gray-800" id="currentTagBarcode"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Product Name</p>
                        <p class="text-lg font-bold" id="currentTagName"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Weight</p>
                        <p class="text-2xl font-bold text-blue-600" id="currentTagWeight"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Total Pieces</p>
                        <p class="text-2xl font-bold text-green-600" id="currentTagPcs"></p>
                    </div>
                </div>
            </div>

            <!-- Split Entry Form -->
            <div class="bg-white p-6 rounded-xl border-2 border-gray-200 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Add Split Entry</h3>
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Weight (grams) *</label>
                        <input type="number" step="0.001" id="tagSplitWeight" placeholder="0.000"
                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Pieces</label>
                        <input type="number" id="tagSplitPcs" value="1" min="1"
                            class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addTagSplitEntry()"
                            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                            ‚ûï Add Split
                        </button>
                    </div>
                </div>
            </div>

            <!-- Remaining Display -->
            <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-4 rounded-lg border-2 border-orange-300 mb-6">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <p class="text-sm text-gray-600">Remaining Pieces</p>
                        <p class="text-3xl font-bold text-orange-600" id="tagRemainingPcs">0</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Remaining Weight</p>
                        <p class="text-3xl font-bold text-orange-600" id="tagRemainingWeight">0.000g</p>
                    </div>
                </div>
            </div>

            <!-- Split Entries Table -->
            <div class="bg-white rounded-xl border mb-6">
                <div class="bg-gray-100 px-4 py-3 border-b">
                    <h4 class="font-bold text-gray-800">Split Entries (<span id="tagSplitEntriesCount">0</span>)</h4>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left">#</th>
                                <th class="px-3 py-2 text-left">New Barcode</th>
                                <th class="px-3 py-2 text-right">Weight (g)</th>
                                <th class="px-3 py-2 text-center">Pieces</th>
                                <th class="px-3 py-2 text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="tagSplitEntriesTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button onclick="completeTagSplit()"
                    class="flex-1 px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg">
                    ‚úÖ Complete Split & Generate Barcodes
                </button>
                <button onclick="cancelTagSplit()"
                    class="px-6 py-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-bold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tag Search Tab -->
<div id="tagsearchTab" class="space-y-6 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üîç Tag Search</h2>
        
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200 mb-6">
            <label class="block text-sm font-medium mb-2">Search Tag (Barcode)</label>
            <input type="text" id="tagSearchInput" placeholder="Enter barcode/tag to search..." 
                class="w-full px-4 py-3 border-2 border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg font-semibold"
                onkeypress="if(event.key==='Enter') searchTag()">
            <button onclick="searchTag()" 
                class="mt-3 w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                üîç Search Tag
            </button>
        </div>

        <div id="tagSearchResults" class="hidden">
            <div class="bg-white border-2 border-gray-300 rounded-xl p-6">
                <h3 class="text-xl font-bold mb-4">Search Results</h3>
                <div id="tagSearchResultsContent"></div>
            </div>
        </div>
    </div>
</div>


<!-- Floor Management Tab -->
<div id="floorTab" class="space-y-6 hidden">
    <div class="bg-white p-6 rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">üè¢ Floor Management</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- Create Floor -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200">
                <h3 class="text-xl font-bold mb-4">‚ûï Create Floor</h3>
                <input type="text" id="newFloorName" placeholder="Floor Name (e.g., New Shop, Order Floor)" 
                    class="w-full px-3 py-2 border rounded-lg mb-3">
                <button onclick="createFloor()" 
                    class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                    Create Floor
                </button>
            </div>

            <!-- Floor Transfer -->
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-200">
                <h3 class="text-xl font-bold mb-4">üîÑ Floor Transfer</h3>
                <div class="space-y-3">
                    <select id="transferFromFloor" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">-- From Floor --</option>
                    </select>
                    <select id="transferToFloor" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">-- To Floor --</option>
                    </select>
                    <input type="text" id="transferBarcodeInput" placeholder="Scan barcode to transfer..." 
                        class="w-full px-3 py-2 border rounded-lg" onkeypress="if(event.key==='Enter') transferProductFloor()">
                    <button onclick="transferProductFloor()" 
                        class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold">
                        Transfer Product
                    </button>
                </div>
            </div>
        </div>

        <!-- Floors List -->
        <div class="bg-white border-2 border-gray-300 rounded-xl p-6">
            <h3 class="text-xl font-bold mb-4">üìã Floors</h3>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">Floor Name</th>
                            <th class="px-4 py-2 text-left">Product Count</th>
                            <th class="px-4 py-2 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="floorsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PV Upload Modal -->
<div id="pvUploadModal" class="hidden">
    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">üì§ Upload Stock - Create Purchase Voucher</h3>
                    <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                    <p class="text-sm text-blue-700 font-mono">Barcode | SKU | StyleCode | ProductName | Size | AvgWeight | Purity |
                        MCRate | MCType | PCS | BoxCharges | StoneCharges | MetalType</p>
                    <p class="text-sm text-blue-700 mt-2"><strong>MCType:</strong> "MC/GM" or "PieceCost"</p>
                    <p class="text-sm text-blue-700"><strong>MetalType:</strong> Must be "gold", "silver", or "platinum"</p>
                </div>

                <!-- PV Number Link Section -->
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                    <h4 class="font-bold text-blue-800 mb-3">üìã Link to Existing PV (Required if PV already created)</h4>
                    <div>
                        <label class="block text-sm font-medium mb-1">PV Number (Leave blank for auto-generate)</label>
                        <input type="text" id="pvNumberLink" placeholder="e.g., PV000001" class="w-full px-3 py-2 border rounded-lg"
                            oninput="validatePVNumber(this.value)">
                        <p class="text-xs text-gray-600 mt-1">If you created a PV from Metal Purchase, enter it here. Otherwise, leave blank.</p>
                        <div id="pvValidationMessage" class="mt-2 text-sm"></div>
                    </div>
                </div>

                <!-- Supplier Information -->
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h4 class="font-bold text-gray-800 mb-3">Supplier Details</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Supplier Name *</label>
                            <input type="text" id="pvSupplierName" placeholder="Enter supplier name"
                                class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Supplier Invoice No</label>
                            <input type="text" id="pvSupplierInvoice" placeholder="Optional"
                                class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Payment Status *</label>
                            <select id="pvPaymentStatus" class="w-full px-3 py-2 border rounded-lg">
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                                <option value="partial">Partial</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">PV Date *</label>
                            <input type="date" id="pvDate" class="w-full px-3 py-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Floor *</label>
                            <select id="pvFloor" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">-- Select Floor --</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="block text-sm font-medium mb-1">Notes</label>
                        <textarea id="pvNotes" rows="2" placeholder="Optional notes about this purchase"
                            class="w-full px-3 py-2 border rounded-lg"></textarea>
                    </div>
                </div>

                <!-- File Upload -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                    <input type="file" id="pvExcelFileInput" accept=".xlsx,.xls" class="hidden"
                        onchange="handlePVExcelUpload(event)">
                    <button onclick="document.getElementById('pvExcelFileInput').click()"
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg">
                        üìÅ Choose Excel File
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Upload product list with all details</p>
                </div>

                <!-- Preview Section -->
                <div id="pvUploadPreview" class="hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 products):</h4>
                    <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-2 py-2 text-left">Barcode</th>
                                    <th class="px-2 py-2 text-left">Name</th>
                                    <th class="px-2 py-2 text-left">Metal</th>
                                    <th class="px-2 py-2 text-right">Weight</th>
                                    <th class="px-2 py-2 text-right">MC Rate</th>
                                </tr>
                            </thead>
                            <tbody id="pvPreviewTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Summary -->
                    <div class="bg-green-50 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-green-800 mb-2">Upload Summary</h4>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">Total Products:</span>
                                <span class="font-bold ml-2" id="pvUploadTotalProducts">0</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Total Weight:</span>
                                <span class="font-bold ml-2" id="pvUploadTotalWeight">0g</span>
                            </div>
                            <div>
                                <span class="text-gray-600">Estimated Value:</span>
                                <span class="font-bold ml-2" id="pvUploadTotalValue">‚Çπ0</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="confirmPVUpload()"
                            class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                            ‚úÖ Create PV & Add Stock
                        </button>
                        <button onclick="closeModals()"
                            class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PV View Details Modal -->
<div id="pvViewModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-6xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-800">Purchase Voucher Details</h3>
            <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>

        <!-- PV Header Info -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 p-5 rounded-xl border-2 border-green-200 mb-4">
            <div class="grid grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-gray-600">PV Number</p>
                    <p class="text-2xl font-bold text-green-600" id="viewPVNumber"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-600">Supplier</p>
                    <p class="text-lg font-bold" id="viewPVSupplier"></p>
                    <p class="text-sm text-gray-600" id="viewPVSupplierInvoice"></p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-600">Date</p>
                    <p class="font-bold" id="viewPVDate"></p>
                    <span class="px-3 py-1 rounded-full text-xs font-bold mt-2 inline-block" id="viewPVStatus"></span>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t" id="viewPVNotes"></div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-4 gap-4 mb-4">
            <div class="bg-blue-50 p-4 rounded-lg text-center">
                <p class="text-sm text-gray-600">Products</p>
                <p class="text-2xl font-bold text-blue-600" id="viewPVTotalProducts"></p>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg text-center">
                <p class="text-sm text-gray-600">Total Weight</p>
                <p class="text-2xl font-bold text-yellow-600" id="viewPVTotalWeight"></p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
                <p class="text-sm text-gray-600">Total Value</p>
                <p class="text-2xl font-bold text-purple-600" id="viewPVTotalValue"></p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg text-center">
                <p class="text-sm text-gray-600">MC Total</p>
                <p class="text-2xl font-bold text-green-600" id="viewPVTotalMC"></p>
            </div>
        </div>

        <!-- Products Table -->
        <div class="overflow-x-auto mb-4">
            <table class="w-full text-sm border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border px-3 py-2 text-left">#</th>
                        <th class="border px-3 py-2 text-left">Barcode</th>
                        <th class="border px-3 py-2 text-left">SKU</th>
                        <th class="border px-3 py-2 text-left">Style Code</th>
                        <th class="border px-3 py-2 text-left">Product Name</th>
                        <th class="border px-3 py-2 text-center">Size</th>
                        <th class="border px-3 py-2 text-center">Metal</th>
                        <th class="border px-3 py-2 text-right">Weight</th>
                        <th class="border px-3 py-2 text-center">Purity</th>
                        <th class="border px-3 py-2 text-right">MC Rate</th>
                    </tr>
                </thead>
                <tbody id="viewPVProductsBody"></tbody>
            </table>
        </div>

        <!-- Actions -->
        <div class="flex gap-3">
            <button onclick="downloadPVReport()"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
                üì• Download PDF
            </button>
            <button onclick="closeModals()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Close
            </button>
        </div>
    </div>
</div>

    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4"
        onclick="if(event.target === this) closeModals()"></div>
    
    <!-- Rates Modal -->
    <div id="ratesModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">Update Metal Rates</h3>
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 mb-4">
                <p class="text-sm text-yellow-800">‚ö†Ô∏è Updating rates will automatically recalculate all items in current
                    bill</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Gold Rate (per gram)</label>
                    <input type="number" id="rateGold" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Silver Rate (per gram)</label>
                    <input type="number" id="rateSilver" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Platinum Rate (per gram)</label>
                    <input type="number" id="ratePlatinum" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveRates()"
                        class="flex-1 px-4 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 font-medium">Save
                        Rates</button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk MC Rate Update Modal -->
    <div id="bulkUpdateModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Bulk Update MC Rate</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4">
                <p class="text-sm text-blue-800">Update MC Rate, Box Charges, or Stone Charges for all products with a specific Style Code</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Style Code</label>
                    <input type="text" id="bulkStyleCode" placeholder="e.g., emerald idol" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">MC Rate (per gram)</label>
                    <input type="number" step="0.01" id="bulkMcRate" placeholder="Leave empty to skip" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Box Charges</label>
                    <input type="number" step="0.01" id="bulkBoxCharges" placeholder="Leave empty to skip" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Stone Charges</label>
                    <input type="number" step="0.01" id="bulkStoneCharges" placeholder="Leave empty to skip" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveBulkUpdate()"
                        class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium">Update</button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
  <!-- Add/Edit Product Modal -->
<div id="addProductModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-2xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4" id="productModalTitle">Add New Product</h3>
        <input type="hidden" id="editProductIndex" value="">
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium mb-1">Barcode *</label>
                <input type="text" id="newBarcode" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">SKU</label>
                <input type="text" id="newSku" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Style Code</label>
                <input type="text" id="newStyleCode" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Metal Type *</label>
                <select id="newMetalType" class="w-full px-3 py-2 border rounded-lg">
                    <option value="gold">Gold</option>
                    <option value="silver">Silver</option>
                    <option value="platinum">Platinum</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium mb-1">Product Name *</label>
                <input type="text" id="newShortName" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Size</label>
                <input type="text" id="newSize" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Average Weight (gm)</label>
                <input type="number" step="0.01" id="newAvgWt" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Purity (%) *</label>
                <input type="number" step="0.1" id="newPurity" value="100" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">PCS (Pieces) *</label>
                <input type="number" id="newPcs" value="1" min="1" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">MC Type *</label>
                <select id="newMcType" onchange="toggleMCRateLabel()" class="w-full px-3 py-2 border rounded-lg">
                    <option value="MC/GM">MC per Gram (MC/GM)</option>
                    <option value="PieceCost">Piece Cost (Fixed)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1" id="mcRateLabel">MC Rate (per gram) *</label>
                <input type="number" step="0.01" id="newMcRate" class="w-full px-3 py-2 border rounded-lg" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Box Charges</label>
                <input type="number" step="0.01" id="newBoxCharges" value="0" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Stone Charges</label>
                <input type="number" step="0.01" id="newStoneCharges" value="0" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="col-span-2 flex gap-3">
                <button onclick="saveProduct()"
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">üíæ Save Product</button>
                <button onclick="closeModals()"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
            </div>
        </div>
    </div>
</div>

    <!-- Bulk Upload Products Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üì§ Bulk Upload Products from Excel</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                <p class="text-sm text-blue-700 font-mono">Barcode | SKU | StyleCode | ProductName | Size | AvgWeight |
                    Purity | MCRate | MetalType</p>
                <p class="text-sm text-blue-700 mt-2"><strong>MetalType:</strong> Must be "gold", "silver", or "platinum"
                </p>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                <input type="file" id="excelFileInput" accept=".xlsx,.xls" class="hidden"
                    onchange="handleExcelUpload(event)">
                <button onclick="document.getElementById('excelFileInput').click()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg">
                    üìÅ Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">Click "Sample" button first to download template</p>
            </div>
            <div id="uploadPreview" class="hidden">
                <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 rows):</h4>
                <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left">Barcode</th>
                                <th class="px-2 py-2 text-left">Name</th>
                                <th class="px-2 py-2 text-left">Metal</th>
                                <th class="px-2 py-2 text-left">Purity</th>
                                <th class="px-2 py-2 text-left">MC Rate</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody"></tbody>
                    </table>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmBulkUpload()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Upload <span id="uploadCount"></span> Products
                    </button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Customer Modal -->
    <div id="addCustomerModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4" id="customerModalTitle">Add New Customer</h3>
            <input type="hidden" id="editCustomerIndex" value="">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Customer Name *</label>
                    <input type="text" id="newCustName" class="w-full px-3 py-2 border rounded-lg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address Line 1</label>
                    <input type="text" id="newCustAddress1" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Address Line 2</label>
                    <input type="text" id="newCustAddress2" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">City & Pincode</label>
                    <input type="text" id="newCustCity" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Mobile Number *</label>
                    <input type="tel" id="newCustMobile" class="w-full px-3 py-2 border rounded-lg" maxlength="10" required>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveCustomer()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">üíæ Save
                        Customer</button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Upload Customers Modal -->
    <div id="bulkUploadCustomerModal"
        class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üì§ Bulk Upload Customers from Excel</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                <p class="text-sm text-blue-700 font-mono">Name | Address1 | Address2 | City | Mobile</p>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                <input type="file" id="excelCustomerFileInput" accept=".xlsx,.xls" class="hidden"
                    onchange="handleCustomerExcelUpload(event)">
                <button onclick="document.getElementById('excelCustomerFileInput').click()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg">
                    üìÅ Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">Click "Sample" button first to download template</p>
            </div>
            <div id="uploadCustomerPreview" class="hidden">
                <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 rows):</h4>
                <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left">Name</th>
                                <th class="px-2 py-2 text-left">Address</th>
                                <th class="px-2 py-2 text-left">City</th>
                                <th class="px-2 py-2 text-left">Mobile</th>
                            </tr>
                        </thead>
                        <tbody id="previewCustomerTableBody"></tbody>
                    </table>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmBulkUploadCustomer()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Upload <span id="uploadCustomerCount"></span> Customers
                    </button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>

<!-- Quotation Format Selection Modal -->
<div id="quotationFormatModal"
    class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üìÑ Generate Quotation</h3>
        
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
            <p class="text-sm text-blue-800 font-medium mb-2">üí° Payment Options:</p>
            <p class="text-xs text-blue-700">Select whether payment was received for this quotation</p>
        </div>
        
        <div class="space-y-3">
            <div class="border-2 border-gray-200 rounded-lg p-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" name="paymentOption" value="cash" id="paymentCash" class="w-5 h-5">
                    <div>
                        <div class="font-bold text-gray-800">üíµ Cash Received</div>
                        <div class="text-sm text-gray-600">Payment received immediately</div>
                    </div>
                </label>
            </div>
            
            <div class="border-2 border-gray-200 rounded-lg p-4">
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" name="paymentOption" value="credit" id="paymentCredit" checked class="w-5 h-5">
                    <div>
                        <div class="font-bold text-gray-800">üìã Credit Sale</div>
                        <div class="text-sm text-gray-600">Payment pending (will bill later)</div>
                    </div>
                </label>
            </div>
            
            <button onclick="generateQuotePDFWithPayment()"
                class="w-full px-6 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Generate Quotation
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- User Management Modal -->
<div id="userManagementModal" class="fixed inset-0 flex items-center justify-center z-50 hidden bg-black bg-opacity-50 p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-2xl font-bold text-gray-800">üë• User Management</h3>
            <button onclick="document.getElementById('userManagementModal').classList.add('hidden')" 
                class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <div class="mb-4">
            <button onclick="addNewUser()" 
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                ‚ûï Add New User
            </button>
        </div>
        
        <div id="userManagementList" class="space-y-3">
            <!-- Users will be rendered here -->
        </div>
    </div>
</div>

<!-- Stock Report Format Selection Modal -->
<div id="stockReportModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üìä Stock Report Options</h3>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
            <select id="stockReportType"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="detailed">Detailed Report (All Fields)</option>
                <option value="summary">Summary Report (Key Info Only)</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Metal Type</label>
            <select id="stockMetalFilter"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="all">All Metals</option>
                <option value="gold">Gold Only</option>
                <option value="silver">Silver Only</option>
                <option value="platinum">Platinum Only</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Style Code</label>
            <select id="stockStyleCodeFilter"
                class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="all">All Style Codes</option>
            </select>
        </div>

        <h4 class="text-sm font-semibold text-gray-700 mb-2">Choose Format:</h4>
        <div class="space-y-3">
            <button onclick="downloadStockReportPDF()"
                class="w-full px-6 py-4 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Download as PDF
            </button>
            <button onclick="downloadStockReportExcel()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìó</span> Download as Excel
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
                </div>
            </div>
        </div>

    <!-- ROL Upload Modal -->
    <div id="rolUploadModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-3xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üì§ Upload ROL Data from Excel (Style Code Based)</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <h4 class="font-bold text-blue-800 mb-2">üìã Required Excel Columns:</h4>
                <p class="text-sm text-blue-700 font-mono">StyleCode | Design (Product Name) | SKU | Size | ROL Wholesale (gms) | ROL Retail (pcs)</p>
                <p class="text-sm text-blue-700 mt-2"><strong>Note:</strong> ROL is style-code based. Single piece = Retail (pcs), Multiple pieces = Wholesale (gms)</p>
                <p class="text-sm text-blue-700 mt-1"><strong>Format:</strong> Wholesale ROL in grams (gms), Retail ROL in number of pieces (pcs)</p>
            </div>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 bg-gray-50">
                <input type="file" id="rolExcelFileInput" accept=".xlsx,.xls" class="hidden"
                    onchange="handleROLExcelUpload(event)">
                <button onclick="document.getElementById('rolExcelFileInput').click()"
                    class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-lg">
                    üìÅ Choose Excel File
                </button>
                <p class="text-sm text-gray-500 mt-2">Click "Download Sample" first to see the format</p>
            </div>
            <div id="rolUploadPreview" class="hidden">
                <h4 class="font-bold text-gray-800 mb-2">Preview (First 5 rows):</h4>
                <div class="overflow-x-auto max-h-60 border rounded-lg mb-4">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left">Style Code</th>
                                <th class="px-2 py-2 text-left">Design</th>
                                <th class="px-2 py-2 text-left">SKU</th>
                                <th class="px-2 py-2 text-center">Size</th>
                                <th class="px-2 py-2 text-center bg-orange-100">ROL Wholesale (gms)</th>
                                <th class="px-2 py-2 text-center bg-green-100">ROL Retail (pcs)</th>
                            </tr>
                        </thead>
                        <tbody id="rolPreviewTableBody"></tbody>
                    </table>
                </div>
                <div class="flex gap-3">
                    <button onclick="confirmROLUpload()"
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Upload <span id="rolUploadCount"></span> ROL Items
                    </button>
                    <button onclick="closeModals()"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Quotation Details Modal -->
    <div id="viewQuotationModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold" id="viewQuotationTitle">Quotation Details</h3>
                <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
    
            <!-- Customer Info -->
            <div class="bg-amber-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-bold" id="viewQuotCustomer"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date</p>
                        <p class="font-bold" id="viewQuotDate"></p>
                    </div>
                </div>
            </div>
    
            <!-- Items Table -->
            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-left">#</th>
                            <th class="px-2 py-2 text-left">Item</th>
                            <th class="px-2 py-2 text-left">Barcode</th>
                            <th class="px-2 py-2 text-right">Weight</th>
                            <th class="px-2 py-2 text-right">Rate</th>
                            <th class="px-2 py-2 text-right">MC</th>
                            <th class="px-2 py-2 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="viewQuotItemsBody"></tbody>
                </table>
            </div>
    
            <!-- Totals -->
            <div class="bg-gradient-to-br from-amber-100 to-orange-100 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Total:</span>
                    <span class="font-bold" id="viewQuotTotal"></span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">GST (3%):</span>
                    <span class="font-bold" id="viewQuotGST"></span>
                </div>
                <div class="flex justify-between text-lg border-t-2 border-amber-400 pt-2">
                    <span class="font-bold">Net Total:</span>
                    <span class="font-bold text-amber-700" id="viewQuotNetTotal"></span>
                </div>
            </div>
    
            <!-- Actions -->
            <!-- Actions -->
<div class="flex gap-3 mt-4">
    <button onclick="reprintQuotationPDF()"
        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">
        üìï Download PDF
    </button>
    <button onclick="closeModals()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
        Close
    </button>
</div>
        </div>
    </div>

<!-- Bill Format Selection Modal -->
<div id="billFormatModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üí∞ Generate Sales Bill</h3>
        <p class="text-gray-600 mb-4">Bill will be saved and PDF will be downloaded.</p>
        <div class="space-y-3">
            <button onclick="generateSalesBillPDF()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Generate PDF Bill
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>
 
    <!-- View Bill Details Modal -->
    <div id="viewBillModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-4xl w-full pointer-events-auto max-h-[90vh] overflow-y-auto"
            onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Bill Details - <span id="viewBillNo"></span></h3>
                <button onclick="closeModals()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
    
            <!-- Customer Info -->
            <div class="bg-green-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-2 gap-4 mb-2">
                    <div>
                        <p class="text-sm text-gray-600">Customer</p>
                        <p class="font-bold" id="viewBillCustomerName"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Date</p>
                        <p class="font-bold" id="viewBillDate"></p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600">Address</p>
                        <p class="text-sm" id="viewBillCustomerAddress"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Mobile</p>
                        <p class="text-sm" id="viewBillCustomerMobile"></p>
                    </div>
                </div>
                <div class="mt-2">
                    <p class="text-sm text-gray-600">Rate Slab: <span class="font-semibold" id="viewBillRateSlab"></span>
                    </p>
                </div>
            </div>
    
            <!-- Items Table -->
            <div class="overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-2 py-2 text-left">#</th>
                            <th class="px-2 py-2 text-left">SKU</th>
                            <th class="px-2 py-2 text-left">Style Code</th>
                            <th class="px-2 py-2 text-left">Item</th>
                            <th class="px-2 py-2 text-center">Size</th>
                            <th class="px-2 py-2 text-right">Weight</th>
                            <th class="px-2 py-2 text-center">Purity</th>
                            <th class="px-2 py-2 text-right">Rate</th>
                            <th class="px-2 py-2 text-right">MC</th>
                            <th class="px-2 py-2 text-right">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="viewBillItemsTableBody"></tbody>
                </table>
            </div>
    
            <!-- Totals -->
            <div class="bg-gradient-to-br from-green-100 to-teal-100 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span class="font-medium">Total:</span>
                    <span class="font-bold" id="viewBillTotal"></span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="font-medium">GST (3%):</span>
                    <span class="font-bold" id="viewBillGST"></span>
                </div>
                <div class="flex justify-between text-lg border-t-2 border-green-400 pt-2">
                    <span class="font-bold">Net Total:</span>
                    <span class="font-bold text-green-700" id="viewBillNetTotal"></span>
                </div>
            </div>
    
            <!-- Actions -->
            <div class="flex gap-3 mt-4">
                <button onclick="reprintBillByModalId()"
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                    üñ®Ô∏è Reprint
                </button>
                <button onclick="closeModals()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Convert Quotation to Bill Modal -->
    <div id="convertQuotModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
            onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üîÑ Convert to Sales Bill</h3>
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <p class="text-sm text-blue-800">This will create a new sales bill from this quotation.</p>
            </div>
            <div class="space-y-3">
                <button onclick="confirmConvertToBill()"
                    class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg">
                    ‚úÖ Convert to Bill
                </button>
                <button onclick="closeModals()"
                    class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Reprint Format Modal -->
<div id="reprintFormatModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto"
        onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üñ®Ô∏è Reprint Bill</h3>
        <p class="text-gray-600 mb-4">Bill will be downloaded as PDF</p>
        <input type="hidden" id="reprintBillIndex" value="">
        <div class="space-y-3">
            <button onclick="reprintBillById()"
                class="w-full px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg flex items-center justify-center gap-2">
                <span>üìï</span> Download PDF
            </button>
            <button onclick="closeModals()"
                class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Cash Entry Modal -->
<div id="cashEntryModal" class="fixed inset-0 flex items-center justify-center z-50 hidden pointer-events-none p-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full pointer-events-auto" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4">üíµ Cash Entry</h3>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Entry Type *</label>
                <select id="cashEntryType" onchange="updateCashEntryFields()" class="w-full px-3 py-2 border rounded-lg">
                    <option value="cash_in">Cash In (Received)</option>
                    <option value="cash_out">Cash Out (Paid)</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                <input type="number" step="0.01" id="cashEntryAmount" 
                    placeholder="0.00"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Category *</label>
                <select id="cashEntryCategory" class="w-full px-3 py-2 border rounded-lg">
                    <option value="Sales">Sales</option>
                    <option value="Purchase">Purchase</option>
                    <option value="Customer Payment">Customer Payment</option>
                    <option value="Supplier Payment">Supplier Payment</option>
                    <option value="Owner Investment">Owner Investment</option>
                    <option value="Loan">Loan</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Description *</label>
                <textarea id="cashEntryDescription" rows="2" 
                    placeholder="Enter details about this cash transaction"
                    class="w-full px-3 py-2 border rounded-lg"></textarea>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Reference/Receipt No</label>
                <input type="text" id="cashEntryReference" 
                    placeholder="Optional"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-1">Date</label>
                <input type="date" id="cashEntryDate" 
                    value="${new Date().toISOString().split('T')[0]}"
                    class="w-full px-3 py-2 border rounded-lg">
            </div>
            
            <div class="flex gap-3">
                <button onclick="saveCashEntry()" 
                    class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                    üíæ Save Entry
                </button>
                <button onclick="closeCashEntryModal()" 
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

    <script>
        // ========== API SERVICE LAYER ==========
        const API_BASE = 'http://localhost:3000/api';
        let currentTenant = null; // Store current tenant code
        
        // API Helper Functions
        const api = {
            // Get current tenant code
            getTenant() {
                return currentTenant || localStorage.getItem('currentTenant') || 'jpjewellery';
            },
            
            // Set current tenant
            setTenant(tenantCode) {
                currentTenant = tenantCode;
                localStorage.setItem('currentTenant', tenantCode);
            },
            
            // Generic API request
            async request(endpoint, options = {}) {
                const tenant = this.getTenant();
                const url = `${API_BASE}/${tenant}${endpoint}`;
                
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };
                
                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    }
                    
                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },
            
            // Products API
            async getProducts(search = '') {
                const params = search ? `?search=${encodeURIComponent(search)}` : '';
                return this.request(`/products${params}`);
            },
            
            async getProductByBarcode(barcode) {
                return this.request(`/products?barcode=${encodeURIComponent(barcode)}`);
            },
            
            async createProduct(product) {
                return this.request('/products', {
                    method: 'POST',
                    body: JSON.stringify(product),
                });
            },
            
            async updateProduct(id, product) {
                return this.request(`/products/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(product),
                });
            },
            
            async deleteProduct(id) {
                return this.request(`/products/${id}`, {
                    method: 'DELETE',
                });
            },
            
            // Customers API
            async getCustomers() {
                return this.request('/customers');
            },
            
            async createCustomer(customer) {
                return this.request('/customers', {
                    method: 'POST',
                    body: JSON.stringify(customer),
                });
            },
            
            async updateCustomer(id, customer) {
                return this.request(`/customers/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(customer),
                });
            },
            
            async deleteCustomer(id) {
                return this.request(`/customers/${id}`, {
                    method: 'DELETE',
                });
            },
            
            // Quotations API
            async getQuotations() {
                return this.request('/quotations');
            },
            
            async createQuotation(quotation) {
                return this.request('/quotations', {
                    method: 'POST',
                    body: JSON.stringify(quotation),
                });
            },
            
            async updateQuotation(id, quotation) {
                return this.request(`/quotations/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(quotation),
                });
            },
            
            async deleteQuotation(id) {
                return this.request(`/quotations/${id}`, {
                    method: 'DELETE',
                });
            },
            
            // Bills API
            async getBills() {
                return this.request('/bills');
            },
            
            async createBill(bill) {
                return this.request('/bills', {
                    method: 'POST',
                    body: JSON.stringify(bill),
                });
            },
            
            async updateBill(id, bill) {
                return this.request(`/bills/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(bill),
                });
            },
            
            async deleteBill(id) {
                return this.request(`/bills/${id}`, {
                    method: 'DELETE',
                });
            },
            
            // Ledger API
            async getLedgerTransactions(filters = {}) {
                const params = new URLSearchParams();
                if (filters.customerId) params.append('customerId', filters.customerId);
                if (filters.type) params.append('type', filters.type);
                if (filters.startDate) params.append('startDate', filters.startDate);
                if (filters.endDate) params.append('endDate', filters.endDate);
                const query = params.toString() ? `?${params.toString()}` : '';
                return this.request(`/ledger/transactions${query}`);
            },
            
            async createLedgerTransaction(transaction) {
                return this.request('/ledger/transactions', {
                    method: 'POST',
                    body: JSON.stringify(transaction),
                });
            },
            
            // Purchase Vouchers API
            async getPurchaseVouchers(pvNo = null) {
                const query = pvNo ? `?pvNo=${encodeURIComponent(pvNo)}` : '';
                return this.request(`/purchase-vouchers${query}`);
            },
            
            async createPurchaseVoucher(pv) {
                return this.request('/purchase-vouchers', {
                    method: 'POST',
                    body: JSON.stringify(pv),
                });
            },
            
            // ROL API
            async getROLData(barcode = null, styleCode = null) {
                const params = new URLSearchParams();
                if (barcode) params.append('barcode', barcode);
                if (styleCode) params.append('styleCode', styleCode);
                const query = params.toString() ? `?${params.toString()}` : '';
                return this.request(`/rol${query}`);
            },
            
            async createROLData(rolData) {
                return this.request('/rol', {
                    method: 'POST',
                    body: JSON.stringify(rolData),
                });
            },
            
            async updateROLData(barcode, rolData) {
                return this.request(`/rol/${encodeURIComponent(barcode)}`, {
                    method: 'PUT',
                    body: JSON.stringify(rolData),
                });
            },
            
            // Users API
            async getUsers() {
                return this.request('/users');
            },
            
            async createUser(user) {
                return this.request('/users', {
                    method: 'POST',
                    body: JSON.stringify(user),
                });
            },
            
            async updateUser(id, user) {
                return this.request(`/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(user),
                });
            },
            
            async deleteUser(id) {
                return this.request(`/users/${id}`, {
                    method: 'DELETE',
                });
            },
            
            // Rates API
            async getRates() {
                return this.request('/rates');
            },
            
            async updateRates(rates) {
                return this.request('/rates', {
                    method: 'PUT',
                    body: JSON.stringify(rates),
                });
            },
            
            // Tenants API (for login)
            async getTenants() {
                try {
                    const response = await fetch(`${API_BASE.replace('/api', '')}/api/tenants`);
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error fetching tenants:', error);
                    return [];
                }
            },
            
            async login(tenantCode, username, password) {
                try {
                    const response = await fetch(`${API_BASE.replace('/api', '')}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tenantCode, username, password }),
                    });
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Login error:', error);
                    throw error;
                }
            },
        };
        
        // Load tenants on page load
        async function loadTenants() {
            const select = document.getElementById('authTenant');
            if (!select) return;
            
            try {
                const tenants = await api.getTenants();
                select.innerHTML = '<option value="">Select Client...</option>';
                
                tenants.forEach(tenant => {
                    const option = document.createElement('option');
                    option.value = tenant.tenant_code;
                    option.textContent = tenant.tenant_name || tenant.tenant_code;
                    select.appendChild(option);
                });
                
                // Set default to JP Jewellery if available
                const jpOption = Array.from(select.options).find(opt => opt.value === 'jpjewellery');
                if (jpOption) {
                    select.value = 'jpjewellery';
                }
            } catch (error) {
                console.error('Error loading tenants:', error);
                select.innerHTML = '<option value="jpjewellery">JP Jewellery</option>';
            }
        }
        
        // ‚úÖ COMPLETE DATA INTEGRITY CHECKS
            document.addEventListener('DOMContentLoaded', function () {
                // Load tenants on page load
                loadTenants();
                // Verify all critical data structures exist
                if (!localStorage.getItem('products')) {
                    localStorage.setItem('products', JSON.stringify([]));
                }

                if (!localStorage.getItem('customers')) {
                    localStorage.setItem('customers', JSON.stringify([]));
                }

                if (!localStorage.getItem('savedBills')) {
                    localStorage.setItem('savedBills', JSON.stringify([]));
                }

                if (!localStorage.getItem('savedQuotations')) {
                    localStorage.setItem('savedQuotations', JSON.stringify([]));
                }

                if (!localStorage.getItem('soldProducts')) {
                    localStorage.setItem('soldProducts', JSON.stringify([]));
                }

                if (!localStorage.getItem('ledgerTransactions')) {
                    localStorage.setItem('ledgerTransactions', JSON.stringify([]));
                }

                if (!localStorage.getItem('accountBalances')) {
                    localStorage.setItem('accountBalances', JSON.stringify({
                        cash: 0,
                        bank: 0,
                        receivables: 0,
                        payables: 0,
                        goldStock: 0,
                        silverStock: 0,
                        platinumStock: 0
                    }));
                }

                if (!localStorage.getItem('purchaseVouchers')) {
                    localStorage.setItem('purchaseVouchers', JSON.stringify([]));
                }

                if (!localStorage.getItem('pendingPVs')) {
                    localStorage.setItem('pendingPVs', JSON.stringify([]));
                }

                if (!localStorage.getItem('expenses')) {
                    localStorage.setItem('expenses', JSON.stringify([]));
                }

                if (!localStorage.getItem('metalPurchases')) {
                    localStorage.setItem('metalPurchases', JSON.stringify([]));
                }

                console.log('‚úÖ Data integrity check completed');
                
                // Update quotation number display on page load
                if (typeof getNextQuotationNumber === 'function') {
                    const nextQuotNum = getNextQuotationNumber();
                    const quotNoEl = document.getElementById('quotationNo');
                    if (quotNoEl) {
                        quotNoEl.textContent = `Quotation No: Q${String(nextQuotNum).padStart(4, '0')}`;
                    }
                }
            });

        // ========== PERFORMANCE OPTIMIZATION ==========
        // localStorage cache to reduce reads
        const localStorageCache = {};
        const localStorageWriteQueue = {};
        let localStorageWriteTimer = null;

        // Optimized localStorage getter with cache
        function getCachedItem(key, defaultValue = null) {
            if (localStorageCache[key] !== undefined) {
                return localStorageCache[key];
            }
            try {
                const value = localStorage.getItem(key);
                const parsed = value ? JSON.parse(value) : defaultValue;
                localStorageCache[key] = parsed;
                return parsed;
            } catch (e) {
                return defaultValue;
            }
        }

        // Batched localStorage setter (debounced writes)
        function setCachedItem(key, value) {
            localStorageCache[key] = value;
            localStorageWriteQueue[key] = value;
            
            // Clear existing timer
            if (localStorageWriteTimer) {
                clearTimeout(localStorageWriteTimer);
            }
            
            // Batch writes every 100ms
            localStorageWriteTimer = setTimeout(() => {
                Object.keys(localStorageWriteQueue).forEach(k => {
                    try {
                        localStorage.setItem(k, JSON.stringify(localStorageWriteQueue[k]));
                    } catch (e) {
                        console.error('localStorage write error:', e);
                    }
                });
                localStorageWriteQueue = {};
            }, 100);
        }

        // Debounce function for input handlers
        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Throttle function for scroll/resize handlers
        function throttle(func, limit = 100) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // DOM query cache
        const domCache = {};
        function getCachedElement(id) {
            if (!domCache[id]) {
                domCache[id] = document.getElementById(id);
            }
            return domCache[id];
        }

        let items = [];
        let rates = getCachedItem('rates', {gold:7500, silver:156, platinum:3500});
        // Ensure rates are numbers, not strings
        rates.gold = parseFloat(rates.gold) || 7500;
        rates.silver = parseFloat(rates.silver) || 156;
        rates.platinum = parseFloat(rates.platinum) || 3500;
        let customers = getCachedItem('customers', []);
        let products = getCachedItem('products', []);
        let currentCustomer = null;
        // Initialize quotation counter based on saved quotations
        function getNextQuotationNumber() {
            const savedQuotations = getCachedItem('savedQuotations', []);
            return savedQuotations.length + 1;
        }
        let quotationCounter = getNextQuotationNumber();
        let bulkUploadData = [];
        let bulkUploadCustomerData = [];
        let currentRateSlab = 'R'; 
        const rateSlabDiscounts = {  
                'R': 0,
                'R1': 2,
                'R2': 5,
                'R3': 10,
                'R4': 15
            };
        // New ROL data structure: style-code based with wholesale/retail
        // Structure: { styleCode: { items: [{ design, sku, size, rolWholesale, rolRetail, availableWholesale, availableRetail }] } }
        let rolData = getCachedItem('rolData', {}); // Changed from array to object keyed by style code
        let bulkUploadROLData = [];
        let currentSelectedROLStyleCode = null;
let currentTagSplitProduct = null;
let tagSplitEntries = [];
let tagRemainingPcs = 0;
let tagRemainingWeight = 0;
let tagSplitSequenceStart = 0;
        // Track double scans for permanent highlighting
        let doubleScannedBarcodes = getCachedItem('doubleScannedBarcodes', []);
        // Floor management
        let floors = getCachedItem('floors', ['estimation floor']);

const STATIC_MODAL_IDS = [
    'pvUploadModal',
    'pvViewModal',
    'ratesModal',
    'addProductModal',
    'bulkUploadModal',
    'addCustomerModal',
    'bulkUploadCustomerModal',
    'quotationFormatModal',
    'stockReportModal',
    'rolUploadModal',
    'viewQuotationModal',
    'billFormatModal',
    'viewBillModal',
    'convertQuotModal',
    'reprintFormatModal',
    'cashEntryModal',
    'bulkUpdateModal'
];

// ========== DIALOG SYSTEM ==========
function showDialog(title, message, type = 'info', callback = null) {
    const dialog = document.createElement('div');
    dialog.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    dialog.id = 'customDialog';
    
    const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    const bgColor = type === 'error' ? 'bg-red-50 border-red-500' : type === 'success' ? 'bg-green-50 border-green-500' : type === 'warning' ? 'bg-yellow-50 border-yellow-500' : 'bg-blue-50 border-blue-500';
    const btnColor = type === 'error' ? 'bg-red-600 hover:bg-red-700' : type === 'success' ? 'bg-green-600 hover:bg-green-700' : type === 'warning' ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-blue-600 hover:bg-blue-700';
    
    dialog.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full mx-4 border-2 ${bgColor}">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-3xl">${icon}</span>
                <h3 class="text-xl font-bold text-gray-800">${title}</h3>
            </div>
            <p class="text-gray-700 mb-6">${message}</p>
            <div class="flex justify-end">
                <button onclick="closeDialog()" class="px-6 py-2 ${btnColor} text-white rounded-lg font-medium">
                    OK
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    
    if (callback) {
        setTimeout(() => {
            closeDialog();
            callback();
        }, 100);
    }
}

function showInputDialog(title, message, defaultValue = '', placeholder = '', onConfirm, onCancel = null) {
    return new Promise((resolve, reject) => {
        const dialog = document.createElement('div');
        dialog.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
        dialog.id = 'customInputDialog';
        
        dialog.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full mx-4 border-2 border-blue-500">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-3xl">üìù</span>
                    <h3 class="text-xl font-bold text-gray-800">${title}</h3>
                </div>
                <p class="text-gray-700 mb-4">${message}</p>
                <input type="text" id="customInputField" 
                    value="${defaultValue}" 
                    placeholder="${placeholder}"
                    class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mb-4"
                    autofocus>
                <div class="flex justify-end gap-2">
                    <button onclick="closeInputDialog(null)" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600">
                        Cancel
                    </button>
                    <button onclick="closeInputDialog(document.getElementById('customInputField').value)" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                        OK
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        
        const inputField = dialog.querySelector('#customInputField');
        if (inputField) {
            inputField.focus();
            inputField.select();
            inputField.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    closeInputDialog(inputField.value);
                } else if (e.key === 'Escape') {
                    closeInputDialog(null);
                }
            });
        }
        
        window.closeInputDialog = function(value) {
            const dialogEl = document.getElementById('customInputDialog');
            if (dialogEl) {
                dialogEl.remove();
            }
            delete window.closeInputDialog;
            if (value !== null && value !== undefined) {
                if (onConfirm) onConfirm(value);
                resolve(value);
            } else {
                if (onCancel) onCancel();
                reject(null);
            }
        };
    });
}

function showConfirmDialog(title, message, onConfirm, onCancel = null) {
    const dialog = document.createElement('div');
    dialog.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    dialog.id = 'customDialog';
    
    dialog.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full mx-4 border-2 border-blue-500">
            <div class="flex items-center gap-3 mb-4">
                <span class="text-3xl">‚ö†Ô∏è</span>
                <h3 class="text-xl font-bold text-gray-800">${title}</h3>
            </div>
            <p class="text-gray-700 mb-6">${message}</p>
            <div class="flex justify-end gap-3">
                <button onclick="closeDialog()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600">
                    Cancel
                </button>
                <button onclick="confirmDialog()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                    Confirm
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(dialog);
    window.currentConfirmCallback = onConfirm;
    window.currentCancelCallback = onCancel;
}

function closeDialog() {
    const dialog = document.getElementById('customDialog');
    if (dialog) {
        dialog.remove();
    }
    window.currentConfirmCallback = null;
    window.currentCancelCallback = null;
}

function confirmDialog() {
    if (window.currentConfirmCallback) {
        window.currentConfirmCallback();
    }
    closeDialog();
}

// Replace all alert() calls with showDialog
const originalAlert = window.alert;
window.alert = function(message) {
    showDialog('Information', message, 'info');
};

// Replace all confirm() calls with showConfirmDialog
const originalConfirm = window.confirm;
window.confirm = function(message) {
    let result = false;
    showConfirmDialog('Confirmation', message, () => { result = true; }, () => { result = false; });
    return result;
};

// ========== AUTHENTICATION ==========
let AUTH_USERS = getCachedItem('authUsers', {
    'admin': { password: '123456', role: 'admin', allowedTabs: ['all'] },
    'Gaurav': { password: '@GauravSolanki56789__', role: 'admin', allowedTabs: ['all'] }
});

let currentUser = null;

function saveAuthUsers() {
    setCachedItem('authUsers', AUTH_USERS);
    // Clear cache to force reload on next access
    delete localStorageCache['authUsers'];
}

function logout() {
    showConfirmDialog('Logout', 'Are you sure you want to log out?', () => {
        currentUser = null;
        delete localStorageCache['currentUser'];
        try { localStorage.removeItem('currentUser'); } catch(e) {}
        document.getElementById('authModal').classList.remove('hidden');
        document.getElementById('app').classList.add('hidden');
        const usernameInput = document.getElementById('authUsername');
        const passwordInput = document.getElementById('authPassword');
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (usernameInput) usernameInput.focus();
        updateTabVisibility();
    });
}

function updateTabVisibility() {
    if (!currentUser) {
        const userNameEl = document.getElementById('currentUserName');
        if (userNameEl) userNameEl.textContent = 'User: Guest';
        return;
    }
    
    // Update user info display
    const userNameEl = document.getElementById('currentUserName');
    const userMgmtBtn = document.getElementById('btnManageUsers');
    if (userNameEl) {
        userNameEl.textContent = `User: ${currentUser.username}`;
    }
    // Only admin and Gaurav can access user management
    if (userMgmtBtn) {
        if (currentUser.username === 'admin' || currentUser.username === 'Gaurav') {
            userMgmtBtn.classList.remove('hidden');
        } else {
            userMgmtBtn.classList.add('hidden');
        }
    }
    
    const allTabs = ['billing', 'products', 'customers', 'rol', 'quotations', 'salesbill', 'billhistory', 'ledger', 'pv', 'tagsplit', 'tagsearch', 'floor'];
    const allowedTabs = currentUser.allowedTabs || [];
    
    allTabs.forEach(tab => {
        const btnId = 'btn' + tab.charAt(0).toUpperCase() + tab.slice(1);
        const btn = document.getElementById(btnId);
        if (btn) {
            if (allowedTabs.includes('all') || allowedTabs.includes(tab)) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }
    });
}

function showUserManagement() {
    const modal = document.getElementById('userManagementModal');
    if (!modal) {
        showDialog('Error', 'User management modal not found. Please refresh the page.', 'error');
        return;
    }
    modal.classList.remove('hidden');
    renderUserManagement();
}

function renderUserManagement() {
    const userListDiv = document.getElementById('userManagementList');
    if (!userListDiv) return;
    
    userListDiv.innerHTML = '';
    
    Object.keys(AUTH_USERS).forEach(username => {
        const user = AUTH_USERS[username];
        const isProtected = username === 'admin' || username === 'Gaurav';
        
        const userCard = document.createElement('div');
        userCard.className = 'bg-white p-4 rounded-lg border-2 border-gray-200 mb-3';
        userCard.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-bold text-lg">${username}</span>
                        ${isProtected ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Protected</span>' : ''}
                        <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${user.role || 'user'}</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-2">
                        <div><strong>Role Type:</strong> ${user.role === 'admin' ? 'Admin' : (user.role || 'Employee')}</div>
                        <div><strong>Allowed Tabs:</strong> ${user.allowedTabs && user.allowedTabs.includes('all') ? 'All Tabs' : (user.allowedTabs || []).join(', ') || 'None'}</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="editUser('${username}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">‚úèÔ∏è Edit</button>
                    ${!isProtected ? `<button onclick="deleteUser('${username}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">üóëÔ∏è Delete</button>` : ''}
                </div>
            </div>
        `;
        userListDiv.appendChild(userCard);
    });
}

async function editUser(username) {
    const user = AUTH_USERS[username];
    if (!user) return;
    
    try {
        const newPassword = await showInputDialog(
            'Edit User Password',
            `Enter new password for ${username} (leave empty to keep current):`,
            '',
            'Enter password or leave empty'
        );
        
        if (newPassword) {
            user.password = newPassword;
        }
        
        const newRole = await showInputDialog(
            'Edit User Role',
            `Enter role name for ${username}:`,
            user.role || 'user',
            'Enter role name'
        );
        user.role = newRole;
        
        showConfirmDialog(
            'Set Admin Status',
            `Is ${username} an admin?`,
            () => {
                user.role = 'admin';
                proceedWithTabsSelection();
            },
            () => {
                user.role = newRole;
                proceedWithTabsSelection();
            }
        );
        
        function proceedWithTabsSelection() {
            const allTabs = ['billing', 'products', 'customers', 'rol', 'quotations', 'salesbill', 'billhistory', 'ledger', 'pv', 'tagsplit', 'tagsearch', 'floor'];
            const currentTabs = user.allowedTabs || [];
            const hasAllTabs = currentTabs.includes('all');
            
            let tabsMessage = `Select tabs for ${username}:\n\nCurrent: ${hasAllTabs ? 'All Tabs' : currentTabs.join(', ') || 'None'}\n\nEnter "all" for all tabs, or comma-separated list:\n${allTabs.join(', ')}`;
            
            showInputDialog(
                'Select Tabs',
                tabsMessage,
                hasAllTabs ? 'all' : currentTabs.join(', '),
                'all or comma-separated list'
            ).then(tabsInput => {
                if (tabsInput.trim().toLowerCase() === 'all') {
                    user.allowedTabs = ['all'];
                } else {
                    const selectedTabs = tabsInput.split(',').map(t => t.trim()).filter(t => allTabs.includes(t));
                    user.allowedTabs = selectedTabs;
                }
                
                AUTH_USERS[username] = user;
                saveAuthUsers();
                renderUserManagement();
                showDialog('Success', `User ${username} updated successfully!`, 'success');
            }).catch(() => {
                // User cancelled
            });
        }
    } catch (e) {
        // User cancelled
    }
}

function deleteUser(username) {
    if (username === 'admin' || username === 'Gaurav') {
        showDialog('Error', 'Cannot delete protected users!', 'error');
        return;
    }
    
    showConfirmDialog('Delete User', `Are you sure you want to delete user "${username}"?`, () => {
        delete AUTH_USERS[username];
        saveAuthUsers();
        renderUserManagement();
        showDialog('Success', `User ${username} deleted successfully!`, 'success');
    });
}

async function addNewUser() {
    try {
        const username = await showInputDialog('Add New User', 'Enter username:', '', 'Enter username');
        if (!username || !username.trim()) return;
        
        if (AUTH_USERS[username]) {
            showDialog('Error', 'Username already exists!', 'error');
            return;
        }
        
        const password = await showInputDialog('Add New User', 'Enter password:', '', 'Enter password');
        if (!password) return;
        
        const roleName = await showInputDialog('Add New User', 'Enter role name (e.g., Employee, Accounts, Sales, ROL):', 'Employee', 'Enter role name');
        if (!roleName) return;
        
        showConfirmDialog(
            'Set Admin Status',
            'Is this user an admin?',
            () => {
                proceedWithTabsSelection('admin');
            },
            () => {
                proceedWithTabsSelection(roleName);
            }
        );
        
        function proceedWithTabsSelection(role) {
            const allTabs = ['billing', 'products', 'customers', 'rol', 'quotations', 'salesbill', 'billhistory', 'ledger', 'pv', 'tagsplit', 'tagsearch', 'floor'];
            let tabsMessage = `Select tabs for ${username}:\n\nEnter "all" for all tabs, or comma-separated list:\n${allTabs.join(', ')}`;
            
            showInputDialog('Select Tabs', tabsMessage, 'all', 'all or comma-separated list').then(tabsInput => {
                let allowedTabs = [];
                if (tabsInput.trim().toLowerCase() === 'all') {
                    allowedTabs = ['all'];
                } else {
                    allowedTabs = tabsInput.split(',').map(t => t.trim()).filter(t => allTabs.includes(t));
                }
                
                AUTH_USERS[username] = {
                    password: password,
                    role: role,
                    allowedTabs: allowedTabs
                };
                
                saveAuthUsers();
                renderUserManagement();
                showDialog('Success', `User ${username} created successfully!`, 'success');
            }).catch(() => {
                // User cancelled
            });
        }
    } catch (e) {
        // User cancelled
    }
}

// Make handleLogin globally accessible
window.handleLogin = async function() {
    const tenantCode = document.getElementById('authTenant').value.trim();
    const username = document.getElementById('authUsername').value.trim();
    const password = document.getElementById('authPassword').value;

    if (!tenantCode) {
        showDialog('Login Failed', 'Please select a client/tenant!', 'error');
        return;
    }

    if (!username || !password) {
        showDialog('Login Failed', 'Please enter username and password!', 'error');
        return;
    }

    try {
        // Try API login first
        const loginResult = await api.login(tenantCode, username, password);
        
        if (loginResult.success) {
            // API login successful
            currentUser = {
                username: loginResult.username,
                role: loginResult.role || 'user',
                allowedTabs: loginResult.allowedTabs || ['all'],
                tenantCode: loginResult.tenantCode
            };
            api.setTenant(tenantCode);
            setCachedItem('currentUser', currentUser);
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            updateTabVisibility();
            // Load data from API
            await loadDataFromAPI();
            return;
        }
    } catch (apiError) {
        // API login failed, try local authentication as fallback
        console.log('API login failed, trying local auth:', apiError);
    }

    // Fallback to local authentication (for backward compatibility)
    AUTH_USERS = getCachedItem('authUsers', {
        'admin': { password: '123456', role: 'admin', allowedTabs: ['all'] },
        'Gaurav': { password: '@GauravSolanki56789__', role: 'admin', allowedTabs: ['all'] }
    });

    if (AUTH_USERS[username] && AUTH_USERS[username].password === password) {
        currentUser = { 
            username, 
            role: AUTH_USERS[username].role,
            allowedTabs: AUTH_USERS[username].allowedTabs || ['all'],
            tenantCode: tenantCode
        };
        api.setTenant(tenantCode);
        setCachedItem('currentUser', currentUser);
        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        updateTabVisibility();
    } else {
        showDialog('Login Failed', 'Invalid username or password!', 'error');
        document.getElementById('authPassword').value = '';
    }
};

// Load data from API after login
async function loadDataFromAPI() {
    try {
        // Load products
        const productsData = await api.getProducts();
        if (Array.isArray(productsData)) {
            products = productsData.map(p => ({
                id: p.id,
                barcode: p.barcode,
                sku: p.sku,
                styleCode: p.style_code,
                shortName: p.short_name,
                itemName: p.item_name,
                metalType: p.metal_type,
                size: p.size,
                weight: parseFloat(p.weight) || 0,
                avgWt: parseFloat(p.avg_wt) || parseFloat(p.weight) || 0,
                purity: parseFloat(p.purity) || 100,
                rate: parseFloat(p.rate) || 0,
                mcRate: parseFloat(p.mc_rate) || 0,
                mcType: p.mc_type || 'MC/GM',
                pcs: parseInt(p.pcs) || 1,
                boxCharges: parseFloat(p.box_charges) || 0,
                stoneCharges: parseFloat(p.stone_charges) || 0,
                floor: p.floor,
                isSold: p.is_sold || false
            }));
            setCachedItem('products', products);
        }
        
        // Load customers
        const customersData = await api.getCustomers();
        if (Array.isArray(customersData)) {
            customers = customersData.map(c => ({
                id: c.id,
                name: c.name,
                mobile: c.mobile,
                address1: c.address1,
                address2: c.address2,
                city: c.city,
                state: c.state || '',
                pincode: c.pincode || '',
                gstin: c.gstin || ''
            }));
            setCachedItem('customers', customers);
            updateCustomerDropdown();
        }
        
        // Load quotations
        try {
            const quotationsData = await api.getQuotations();
            if (Array.isArray(quotationsData)) {
                const loadedQuotations = quotationsData.map(q => ({
                    id: Date.now() + Math.random(), // Frontend ID
                    dbId: q.id, // Database ID
                    quotationNo: q.quotation_no,
                    date: q.date,
                    customer: {
                        id: q.customer_id,
                        name: q.customer_name,
                        mobile: q.customer_mobile
                    },
                    items: typeof q.items === 'string' ? JSON.parse(q.items) : q.items,
                    total: parseFloat(q.total) || 0,
                    gst: parseFloat(q.gst) || 0,
                    netTotal: parseFloat(q.net_total) || 0,
                    discount: parseFloat(q.discount) || 0,
                    advance: parseFloat(q.advance) || 0,
                    finalAmount: parseFloat(q.final_amount) || 0,
                    paymentStatus: q.payment_status || 'pending',
                    isBilled: false
                }));
                savedQuotations = loadedQuotations;
                setCachedItem('savedQuotations', savedQuotations);
            }
        } catch (e) {
            console.log('Quotations not available from API');
        }
        
        // Load bills
        try {
            const billsData = await api.getBills();
            if (Array.isArray(billsData)) {
                const loadedBills = billsData.map(b => ({
                    id: Date.now() + Math.random(),
                    dbId: b.id,
                    billNo: b.bill_no,
                    quotationNo: b.quotation_id ? 'Q' + b.quotation_id : '',
                    date: b.date,
                    customer: {
                        id: b.customer_id,
                        name: b.customer_name,
                        mobile: b.customer_mobile
                    },
                    items: typeof b.items === 'string' ? JSON.parse(b.items) : b.items,
                    total: parseFloat(b.total) || 0,
                    gst: parseFloat(b.gst) || 0,
                    netTotal: parseFloat(b.net_total) || 0,
                    paymentMethod: b.payment_method || 'cash'
                }));
                savedBills = loadedBills;
                setCachedItem('savedBills', savedBills);
            }
        } catch (e) {
            console.log('Bills not available from API');
        }
        
        // Load rates
        try {
            const ratesData = await api.getRates();
            if (ratesData) {
                rates = {
                    gold: parseFloat(ratesData.gold) || 7500,
                    silver: parseFloat(ratesData.silver) || 156,
                    platinum: parseFloat(ratesData.platinum) || 3500
                };
                setCachedItem('rates', rates);
                updateRatesDisplay();
            }
        } catch (e) {
            console.log('Rates not available from API, using defaults');
        }
        
        console.log('‚úÖ Data loaded from API');
    } catch (error) {
        console.error('Error loading data from API:', error);
        showDialog('Warning', 'Could not load data from database. Using local storage.', 'warning');
    }
}

// Check authentication on load
document.addEventListener('DOMContentLoaded', function() {
    // Reload AUTH_USERS from cache to get latest users
    AUTH_USERS = getCachedItem('authUsers', {
        'admin': { password: '123456', role: 'admin', allowedTabs: ['all'] },
        'Gaurav': { password: '@GauravSolanki56789__', role: 'admin', allowedTabs: ['all'] }
    });
    
    // Update quotation number on page load
    if (typeof getNextQuotationNumber === 'function') {
        const nextQuotNum = getNextQuotationNumber();
        const quotNoEl = document.getElementById('quotationNo');
        if (quotNoEl) {
            quotNoEl.textContent = `Quotation No: Q${String(nextQuotNum).padStart(4, '0')}`;
        }
    }
    
    const savedUser = getCachedItem('currentUser', null);
    if (savedUser) {
        try {
            currentUser = savedUser;
            // Reload AUTH_USERS again to ensure we have latest data
            AUTH_USERS = getCachedItem('authUsers', {
                'admin': { password: '123456', role: 'admin', allowedTabs: ['all'] },
                'Gaurav': { password: '@GauravSolanki56789__', role: 'admin', allowedTabs: ['all'] }
            });
            if (AUTH_USERS[currentUser.username] && AUTH_USERS[currentUser.username].password) {
                currentUser.allowedTabs = AUTH_USERS[currentUser.username].allowedTabs || ['all'];
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                updateTabVisibility();
                return;
            }
        } catch(e) {}
    }
    // Show auth modal if not authenticated
    document.getElementById('authModal').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
});

        // ========== ACCOUNTS LEDGER DATA STRUCTURES ==========

            // Core ledger storage
            let ledgerTransactions = getCachedItem('ledgerTransactions', []);
            let cashBook = getCachedItem('cashBook', []);
            let bankAccounts = getCachedItem('bankAccounts', []);
            let expenses = getCachedItem('expenses', []);
            let metalPurchases = getCachedItem('metalPurchases', []);
            let suppliers = getCachedItem('suppliers', []);

            // Initialize account balances properly
                let accountBalances = getCachedItem('accountBalances', {
                    cash: 0,
                    bank: 0,
                    receivables: 0,
                    payables: 0,
                    goldStock: 0,
                    silverStock: 0,
                    platinumStock: 0
                });

                // NEW: Purchase Voucher System
                let purchaseVouchers = getCachedItem('purchaseVouchers', []);
                let pvCounter = parseInt(localStorage.getItem('pvCounter') || '1');

                // Function to generate PV number
                function generatePVNumber() {
                    const pvNo = `PV${String(pvCounter).padStart(6, '0')}`;
                    pvCounter++;
                    localStorage.setItem('pvCounter', pvCounter);
                    return pvNo;
                }

            // Expense categories
            const expenseCategories = [
                'Rent',
                'Salaries',
                'Electricity',
                'Marketing',
                'Transportation',
                'Office Supplies',
                'Maintenance',
                'Insurance',
                'Professional Fees',
                'Miscellaneous'
            ];

            // Transaction types
            const transactionTypes = {
                SALE: 'sale',
                PURCHASE: 'purchase',
                EXPENSE: 'expense',
                CASH_IN: 'cash_in',
                CASH_OUT: 'cash_out',
                BANK_DEPOSIT: 'bank_deposit',
                BANK_WITHDRAWAL: 'bank_withdrawal',
                PAYMENT_RECEIVED: 'payment_received',
                PAYMENT_MADE: 'payment_made'
            };



            // Function to generate unique transaction ID
            function generateTransactionId() {
                return 'TXN' + Date.now() + Math.random().toString(36).substr(2, 9).toUpperCase();
            }

            // Function to record ledger transaction
            async function recordLedgerTransaction(type, data) {
    const transaction = {
        id: generateTransactionId(),
        type: type,
        date: data.date || new Date().toISOString(),
        amount: data.amount || 0,
        description: data.description || '',
        category: data.category || '',
        paymentMethod: data.paymentMethod || 'Cash',
        reference: data.reference || '',
        customerName: data.customerName || '',
        customerMobile: data.customerMobile || '',
        billNo: data.billNo || '',
        supplier: data.supplier || '',
        metalType: data.metalType || '',
        weight: data.weight || 0
    };

    // Find customer ID if customer name/mobile provided
    let customerId = null;
    if (data.customerMobile) {
        const customer = customers.find(c => c.mobile === data.customerMobile);
        if (customer && customer.id) {
            customerId = customer.id;
        }
    }

    // Save to API
    try {
        await api.createLedgerTransaction({
            customerId: customerId,
            transactionType: type,
            amount: transaction.amount,
            description: transaction.description,
            date: transaction.date
        });
    } catch (error) {
        console.error('Failed to save ledger transaction to API:', error);
    }

    ledgerTransactions.unshift(transaction);
    setCachedItem('ledgerTransactions', ledgerTransactions);

    // Don't auto-update balances here - let calling functions handle it
    return transaction;
}

            // Function to update account balances
            function updateAccountBalances(type, data) {
                switch (type) {
                    case transactionTypes.SALE:
                        accountBalances.cash += data.amount;
                        accountBalances.receivables += data.amount;
                        break;
                    case transactionTypes.PURCHASE:
                        accountBalances.cash -= data.amount;
                        accountBalances.payables += data.amount;
                        break;
                    case transactionTypes.EXPENSE:
                        accountBalances.cash -= data.amount;
                        break;
                    case transactionTypes.CASH_IN:
                        accountBalances.cash += data.amount;
                        break;
                    case transactionTypes.CASH_OUT:
                        accountBalances.cash -= data.amount;
                        break;
                    case transactionTypes.BANK_DEPOSIT:
                        accountBalances.cash -= data.amount;
                        accountBalances.bank += data.amount;
                        break;
                    case transactionTypes.BANK_WITHDRAWAL:
                        accountBalances.bank -= data.amount;
                        accountBalances.cash += data.amount;
                        break;
                    case transactionTypes.PAYMENT_RECEIVED:
                        accountBalances.cash += data.amount;
                        accountBalances.receivables -= data.amount;
                        break;
                    case transactionTypes.PAYMENT_MADE:
                        accountBalances.cash -= data.amount;
                        accountBalances.payables -= data.amount;
                        break;
                }

                setCachedItem('accountBalances', accountBalances);
            }


        let savedQuotations = JSON.parse(localStorage.getItem('savedQuotations') || '[]');
        let currentViewingQuotation = null;
        // New variables added for sales bill
        let billItems = [];
        let currentBillCustomer = null;
        let billCounter = parseInt(localStorage.getItem('billCounter') || '1');
        let currentBillRateSlab = 'R';
        let savedBills = JSON.parse(localStorage.getItem('savedBills') || '[]');
        let currentViewingBill = null;
        let quotationToConvert = null;

        // ========== SALES BILL - CONVERT QUOTATION TO BILL ==========

            let selectedQuotationForBill = null;
            

            function refreshQuotationsList() {
                const select = document.getElementById('selectQuotationForBill');
                select.innerHTML = '<option value="">-- Select a Quotation --</option>';

                if (savedQuotations.length === 0) {
                    // Just show empty dropdown, don't show alert
                    return;
                }

                savedQuotations.forEach((quot, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = `${quot.quotationNo} - ${quot.customer.name} - ‚Çπ${quot.netTotal.toFixed(2)}`;
                    select.appendChild(option);
                });
            }

function loadQuotationForBill() {
    const idx = document.getElementById('selectQuotationForBill').value;

    if (idx === '') {
        // Hide all sections
        document.getElementById('selectedQuotationDetails').classList.add('hidden');
        document.getElementById('billRatesSection').classList.add('hidden');
        document.getElementById('billRateSlabSection').classList.add('hidden');
        document.getElementById('billItemsTableContainer').classList.add('hidden');
        document.getElementById('billSummarySection').classList.add('hidden');
        document.getElementById('billActionsSection').classList.add('hidden');
        selectedQuotationForBill = null;
        billItems = [];
        return;
    }

    selectedQuotationForBill = savedQuotations[idx];
    
    // Check if already billed
    if (selectedQuotationForBill.isBilled) {
        const billDate = new Date(selectedQuotationForBill.billDate).toLocaleDateString('en-GB');
        alert(`‚ö†Ô∏è This quotation (${selectedQuotationForBill.quotationNo}) has already been billed!\n\nBill No: ${selectedQuotationForBill.billNo || 'Unknown'}\nBill Date: ${billDate}\n\nPlease select a different quotation.`);
        document.getElementById('selectQuotationForBill').value = '';
        
        // Clear all sections
        document.getElementById('selectedQuotationDetails').classList.add('hidden');
        document.getElementById('billRatesSection').classList.add('hidden');
        document.getElementById('billRateSlabSection').classList.add('hidden');
        document.getElementById('billItemsTableContainer').classList.add('hidden');
        document.getElementById('billSummarySection').classList.add('hidden');
        document.getElementById('billActionsSection').classList.add('hidden');
        selectedQuotationForBill = null;
        billItems = [];
        return;
    }

    // Display quotation details
    document.getElementById('selectedQuotNo').textContent = selectedQuotationForBill.quotationNo;
    document.getElementById('selectedQuotCustomer').textContent = selectedQuotationForBill.customer.name;
    document.getElementById('selectedQuotAmount').textContent = `‚Çπ${selectedQuotationForBill.netTotal.toFixed(2)}`;
    document.getElementById('selectedQuotItems').textContent =
        selectedQuotationForBill.items.map(item => `${item.name} (${item.weight.toFixed(2)}g)`).join(', ');

    document.getElementById('selectedQuotationDetails').classList.remove('hidden');

    // Show current rates
    updateBillRatesDisplay();
    document.getElementById('billRatesSection').classList.remove('hidden');

    // Show rate slab section
    document.getElementById('billRateSlab').value = selectedQuotationForBill.rateSlab || 'R';
    currentBillRateSlab = selectedQuotationForBill.rateSlab || 'R';
    updateBillRateSlabInfo();
    document.getElementById('billRateSlabSection').classList.remove('hidden');

    // Load items from quotation with current rates
billItems = selectedQuotationForBill.items.map(item => {
    const currentRate = rates[item.metalType] || rates.silver;
    const originalMCRate = item.originalMcRate || item.mcRate;
    const adjustedMCRate = getBillAdjustedMCRate(originalMCRate);
    const amount = (currentRate + adjustedMCRate) * item.weight;
    
    return {
        ...item,
        rate: currentRate,
        mcRate: adjustedMCRate,
        originalMcRate: originalMCRate,
        amount: amount,
        barcode: item.barcode || null
    };
});

    // Recalculate with current rates and rate slab
    recalculateBillItems();

    // Show items table and summary
    document.getElementById('billItemsTableContainer').classList.remove('hidden');
    document.getElementById('billSummarySection').classList.remove('hidden');
    document.getElementById('billActionsSection').classList.remove('hidden');
}

            function updateBillRatesDisplay() {
                document.getElementById('billGoldRate').textContent = `‚Çπ${rates.gold}/gm`;
                document.getElementById('billSilverRate').textContent = `‚Çπ${rates.silver}/gm`;
                document.getElementById('billPlatinumRate').textContent = `‚Çπ${rates.platinum}/gm`;
            }

            function updateBillRateSlabInfo() {
                currentBillRateSlab = document.getElementById('billRateSlab').value;

                document.getElementById('billRateSlabDisplay').textContent = currentBillRateSlab;

                const descriptions = {
                    'R': 'Standard Rate',
                    'R1': 'MC Discount ‚Çπ2/gm',
                    'R2': 'MC Discount ‚Çπ5/gm',
                    'R3': 'MC Discount ‚Çπ10/gm',
                    'R4': 'MC Discount ‚Çπ15/gm'
                };

                document.getElementById('billRateSlabDesc').textContent = descriptions[currentBillRateSlab];

                if (billItems.length > 0) {
                    recalculateBillItems();
                }
            }

            function getBillAdjustedMCRate(originalMCRate) {
                    const slab = currentBillRateSlab || 'R';
                    const discount = rateSlabDiscounts[slab] || 0;
                    const adjustedRate = Math.max(0, (originalMCRate || 0) - discount);
                    return adjustedRate;
                }

            function recalculateBillItems() {
                billItems.forEach(item => {
                    // Update with current metal rate
                    const currentRate = rates[item.metalType] || rates.silver;
                    item.rate = currentRate;

                    // Apply rate slab discount to MC
                    const originalMCRate = item.originalMcRate || item.mcRate;
                    const adjustedMCRate = getBillAdjustedMCRate(originalMCRate);

                    // Recalculate amount
                    item.amount = (item.rate + adjustedMCRate) * item.weight;
                    item.mcRate = adjustedMCRate;
                    item.originalMcRate = originalMCRate;
                });

                updateBillItemsTable();
                updateBillSummary();
            }

            function updateBillItemsTable() {
                const tbody = document.getElementById('billItemsTableBody');
                tbody.innerHTML = '';

                billItems.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
            <td class="px-4 py-3">${index + 1}</td>
            <td class="px-4 py-3 font-medium">${item.name}</td>
            <td class="px-4 py-3 text-right">${item.weight.toFixed(2)}</td>
            <td class="px-4 py-3 text-right">‚Çπ${item.rate}</td>
            <td class="px-4 py-3 text-right">‚Çπ${item.mcRate.toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-semibold">‚Çπ${item.amount.toFixed(2)}</td>
        `;
                    tbody.appendChild(row);
                });
            }

            function updateBillSummary() {
                const total = billItems.reduce((sum, item) => sum + item.amount, 0);
                const gst = total * 0.03;
                const netTotal = total + gst;

                document.getElementById('billSummaryTotal').textContent = `‚Çπ${total.toFixed(2)}`;
                document.getElementById('billSummaryGst').textContent = `‚Çπ${gst.toFixed(2)}`;
                document.getElementById('billSummaryNetTotal').textContent = `‚Çπ${netTotal.toFixed(2)}`;
            }

            function clearBillSelection() {
                if (confirm('Clear current selection and start new bill?')) {
                    document.getElementById('selectQuotationForBill').value = '';
                    loadQuotationForBill();
                }
            }

            function generateSalesBill() {
                    if (billItems.length === 0) {
                        alert('‚ö†Ô∏è Please load a quotation first');
                        return;
                    }
                    if (!selectedQuotationForBill) {
                        alert('‚ö†Ô∏è No quotation selected');
                        return;
                    }
                    // Show format selection modal
                    document.getElementById('modalOverlay').classList.remove('hidden');
                    document.getElementById('modalOverlay').classList.add('flex');
                    document.getElementById('billFormatModal').classList.remove('hidden');
                }

                // Product inventory tracking
                    let soldProducts = JSON.parse(localStorage.getItem('soldProducts') || '[]');

                    // Function to mark product as sold
                    function markProductAsSold(barcode, billNo) {
                        soldProducts.push({
                            barcode: barcode,
                            billNo: billNo,
                            soldDate: new Date().toISOString()
                        });
                        localStorage.setItem('soldProducts', JSON.stringify(soldProducts));
                    }

                    // Function to check if product is sold
                    function isProductSold(barcode) {
                        return soldProducts.find(sp => sp.barcode === barcode);
                    }

                    // Function to remove sold product from inventory
                    function removeProductFromInventory(barcode) {
                        const productIndex = products.findIndex(p => p.barcode === barcode);
                        if (productIndex >= 0) {
                            products.splice(productIndex, 1);
                            setCachedItem('products', products);
                        }
                    }

async function generateSalesBillPDF() {
    if (billItems.length === 0) {
        alert('‚ö†Ô∏è No items to bill');
        return;
    }
    if (!selectedQuotationForBill) {
        alert('‚ö†Ô∏è No quotation selected');
        return;
    }

    const total = billItems.reduce((sum, item) => sum + item.amount, 0);
    const gst = total * 0.03;
    const cgst = gst / 2;
    const sgst = gst / 2;
    const netTotal = total + gst;
    const billNo = `SCB${String(billCounter).padStart(4, '0')}`;
    const date = new Date();

  const billRecord = {
    id: Date.now(),
    billNo: billNo,
    quotationNo: selectedQuotationForBill.quotationNo,
    date: date.toISOString(),
    customer: selectedQuotationForBill.customer,
    items: JSON.parse(JSON.stringify(billItems)),
    total: total,
    gst: gst,
    netTotal: netTotal,
    rateSlab: currentBillRateSlab,
    paymentStatus: selectedQuotationForBill.paymentReceived ? 'paid' : 'unpaid',
    paidAmount: selectedQuotationForBill.paymentReceived ? netTotal : 0,
    linkedQuotation: selectedQuotationForBill.id
};

    savedBills.unshift(billRecord);
    setCachedItem('savedBills', savedBills);

    // Save bill to API
    try {
        const customerId = selectedQuotationForBill.customer && selectedQuotationForBill.customer.id 
            ? selectedQuotationForBill.customer.id 
            : null;
        const quotationId = selectedQuotationForBill.dbId || selectedQuotationForBill.id || null;
        
        const savedBill = await api.createBill({
            billNo: billNo,
            quotationId: quotationId,
            customerId: customerId,
            customerName: selectedQuotationForBill.customer.name,
            customerMobile: selectedQuotationForBill.customer.mobile,
            items: billItems.map(item => ({
                ...item,
                barcode: item.barcode || null
            })),
            total: total,
            gst: gst,
            cgst: cgst,
            sgst: sgst,
            netTotal: netTotal,
            paymentMethod: selectedQuotationForBill.paymentReceived ? 'cash' : 'credit'
        });
        // Store database ID in bill record
        if (savedBill && savedBill.id) {
            billRecord.dbId = savedBill.id;
        }
    } catch (error) {
        console.error('Failed to save bill to API:', error);
    }

    // ‚úÖ AUTOMATIC LEDGER ENTRY FOR SALE
    const ledgerEntry = await recordLedgerTransaction(transactionTypes.SALE, {
        billNo: billNo,
        customerName: selectedQuotationForBill.customer.name,
        customerMobile: selectedQuotationForBill.customer.mobile,
        amount: netTotal,
        items: billItems.length,
        description: `Sales Bill ${billNo} - ${selectedQuotationForBill.customer.name}`,
        category: 'Sales Revenue',
        paymentMethod: selectedQuotationForBill.paymentReceived ? 'Cash' : 'Credit',
        reference: billNo,
        date: date.toISOString()
    });

    // ‚úÖ Update cash/receivables based on quotation payment status
    if (selectedQuotationForBill.paymentReceived) {
        // Payment was already received during quotation
        accountBalances.cash += netTotal;
    } else {
        // Credit sale - increase receivables
        accountBalances.receivables += netTotal;
    }

    // ‚úÖ Update metal stock levels (DEDUCT sold items)
    billItems.forEach(item => {
        const weightInGrams = item.weight;
        if (item.metalType === 'gold') {
            accountBalances.goldStock = Math.max(0, accountBalances.goldStock - weightInGrams);
        } else if (item.metalType === 'silver') {
            accountBalances.silverStock = Math.max(0, accountBalances.silverStock - weightInGrams);
        } else if (item.metalType === 'platinum') {
            accountBalances.platinumStock = Math.max(0, accountBalances.platinumStock - weightInGrams);
        }
    });

    setCachedItem('accountBalances', accountBalances);

    // ‚úÖ Update ledger dashboard if visible
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        updateLedgerDashboard();
        showLedgerCustomerAccounts(); // Refresh customer accounts
    }

    //Mark products as sold and update barcodes + Deduct from ROL counters
    billItems.forEach(item => {
        if (item.barcode) {
            // Mark as sold
            if (!soldProducts.find(sp => sp.barcode === item.barcode)) {
                markProductAsSold(item.barcode, billNo);
            }
            // Remove from inventory
            removeProductFromInventory(item.barcode);
            
            // ‚úÖ DEDUCT FROM ROL COUNTERS
            if (item.styleCode && rolData[item.styleCode]) {
                const styleROLData = rolData[item.styleCode];
                const product = products.find(p => p.barcode === item.barcode);
                
                if (product) {
                    // Find matching ROL item by SKU and size
                    const rolItem = styleROLData.items.find(ri => 
                        (ri.sku && product.sku && ri.sku.toLowerCase() === product.sku.toLowerCase()) &&
                        (ri.size && product.size && ri.size.toLowerCase() === product.size.toLowerCase())
                    );
                    
                    if (rolItem) {
                        // Determine if single piece (retail) or multiple pieces (wholesale)
                        const isSinglePiece = (product.pcs || 1) === 1;
                        
                        if (isSinglePiece) {
                            // Retail: Deduct pieces
                            rolItem.availableRetail = Math.max(0, (parseFloat(rolItem.availableRetail || 0) - 1));
                        } else {
                            // Wholesale: Deduct weight in grams
                            const weightToDeduct = parseFloat(item.weight || 0);
                            rolItem.availableWholesale = Math.max(0, (parseFloat(rolItem.availableWholesale || 0) - weightToDeduct));
                        }
                    }
                }
            }
        }
    });
    
    // Save updated ROL data
    if (billItems.some(item => item.styleCode && rolData[item.styleCode])) {
        setCachedItem('rolData', rolData);
        // Refresh ROL display if visible
        if (!document.getElementById('rolTab').classList.contains('hidden') && currentSelectedROLStyleCode) {
            loadROLForStyleCode();
        }
    }
    // Update products table if visible
    if (!document.getElementById('productsTab').classList.contains('hidden')) {
        updateProductsTable();
    }

    // MARK QUOTATION AS BILLED
    const quotIndex = savedQuotations.findIndex(q => q.id === selectedQuotationForBill.id);
    if (quotIndex >= 0) {
        savedQuotations[quotIndex].isBilled = true;
        savedQuotations[quotIndex].billNo = billNo;
        savedQuotations[quotIndex].billDate = date.toISOString();
        setCachedItem('savedQuotations', savedQuotations);
    }

    // ========== PDF GENERATION (MATCHING SAMPLE) ==========
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
    const customer = selectedQuotationForBill.customer;
    const totalWeight = billItems.reduce((sum, item) => sum + item.weight, 0);
    const totalPCS = billItems.length;

    // ========== HEADER ==========
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('JP JEWELLERY', 105, 15, { align: 'center' });

    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.text('2ND FLOOR, OLD NO.34, NEW NO.21, BOTHRA EMPORIUM', 105, 20, { align: 'center' });
    doc.text('VEERAPPAN STREET, SOWCARPET', 105, 24, { align: 'center' });
    doc.text('CHENNAI 600079 | 044-43593474', 105, 28, { align: 'center' });

    doc.setFont(undefined, 'bold');
    doc.text('TAX INVOICE', 105, 35, { align: 'center' });
    doc.text('33AADFJ4897R1ZJ', 105, 39, { align: 'center' });

    // ========== BILL INFO ==========
    doc.setFontSize(8);
    doc.text('INVOICE No.:', 15, 48);
    doc.setFont(undefined, 'normal');
    doc.text(billNo, 45, 48);

    doc.setFont(undefined, 'bold');
    doc.text('BILL DATE:', 150, 48);
    doc.setFont(undefined, 'normal');
    doc.text(formattedDate, 175, 48);

    // ========== CUSTOMER INFO ==========
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    doc.text(customer.name.toUpperCase(), 15, 60);

    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    let yCustomer = 64;
    if (customer.address1) {
        doc.text(customer.address1, 15, yCustomer);
        yCustomer += 4;
    }
    if (customer.address2) {
        doc.text(customer.address2, 15, yCustomer);
        yCustomer += 4;
    }
    if (customer.city) {
        doc.text(customer.city, 15, yCustomer);
        yCustomer += 4;
    }
    doc.text(`MOB: ${customer.mobile}`, 15, yCustomer);

    // ========== ITEMS TABLE ==========
    const tableStartY = Math.max(yCustomer + 8, 85);

    const tableData = billItems.map((item, idx) => {
        return [
            idx + 1,
            item.name,
            '711311', // HSN Code
            totalPCS,
            item.weight.toFixed(3),
            item.purity.toFixed(1),
            item.rate.toFixed(2),
            item.amount.toFixed(2)
        ];
    });

    doc.autoTable({
        startY: tableStartY,
        head: [['Sl', 'ITEM', 'HSN', 'PCS', 'Weight In Gms', 'Purity', 'Rate', 'TOTAL']],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [220, 220, 220],
            textColor: 0,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: 2
        },
        bodyStyles: {
            fontSize: 7,
            cellPadding: 1.5
        },
        columnStyles: {
            0: { cellWidth: 10, halign: 'center' },
            1: { cellWidth: 60, halign: 'left' },
            2: { cellWidth: 20, halign: 'center' },
            3: { cellWidth: 15, halign: 'center' },
            4: { cellWidth: 25, halign: 'right' },
            5: { cellWidth: 20, halign: 'center' },
            6: { cellWidth: 20, halign: 'right' },
            7: { cellWidth: 25, halign: 'right' }
        },
        margin: { left: 15, right: 15 }
    });

    // ========== TOTALS SECTION ==========
    const finalY = doc.lastAutoTable.finalY + 10;

    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text(`Total PCS: ${totalPCS}`, 15, finalY);
    doc.text(`${totalWeight.toFixed(3)}`, 50, finalY);

    const rightX = 150;
    doc.text('GST Value:', rightX, finalY);
    doc.setFont(undefined, 'normal');
    doc.text(total.toFixed(2), 195, finalY, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('CGST@1.50%:', rightX, finalY + 5);
    doc.setFont(undefined, 'normal');
    doc.text(cgst.toFixed(2), 195, finalY + 5, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('SGST@1.50%:', rightX, finalY + 10);
    doc.setFont(undefined, 'normal');
    doc.text(sgst.toFixed(2), 195, finalY + 10, { align: 'right' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Total Amount:', rightX, finalY + 17);
    doc.text(netTotal.toFixed(2), 195, finalY + 17, { align: 'right' });

    // ========== FOOTER ==========
    const footerY = finalY + 25;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    doc.text('BANK NAME: HDFC BANK', 15, footerY);
    doc.text('AC NAME: JPJEWELLERY', 15, footerY + 4);
    doc.text('AC NO: 50200016402896', 15, footerY + 8);
    doc.text('IFSC CODE: HDFC0000214', 15, footerY + 12);

    doc.setFont(undefined, 'bold');
    doc.text('For JP JEWELLERY', 150, footerY + 10);

    doc.save(`Bill_${billNo}_${formattedDate.replace(/\//g, '-')}.pdf`);

    closeModals();
    alert(`‚úÖ Sales Bill Generated!\n\nBill No: ${billNo}\nQuotation: ${selectedQuotationForBill.quotationNo}\nCustomer: ${customer.name}\n\n${billItems.length} products removed from inventory.\n\nTransaction recorded in Accounts Ledger.`);

    clearBillSelection();
    billCounter++;
    localStorage.setItem('billCounter', billCounter);
}

    function incrementBillCounter() {
        billCounter++;
        localStorage.setItem('billCounter', billCounter);
    }

                        // ========== BILL HISTORY MANAGEMENT ==========
    function loadBillHistory() {
        // Populate customer filter
        const customerFilter = document.getElementById('billCustomerFilter');
        customerFilter.innerHTML = '<option value="all">All Customers</option>';

        const uniqueCustomers = [...new Set(savedBills.map(b => b.customer.name))];
        uniqueCustomers.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            customerFilter.appendChild(option);
        });

        // Update statistics
        updateBillStatistics();

        // Display bills
        displayBills(savedBills);
    }

    function reprintBillByModalId() {
    const modal = document.getElementById('viewBillModal');
    const billId = modal ? parseInt(modal.getAttribute('data-bill-id')) : null;
    if (!billId) {
        alert('Bill ID not found!');
        return;
    }
    reprintBillById(billId);
}

                                    

        // INITIAL DATA LOAD

        if (products.length === 0) {
    products = [
        { 
            id: 1, 
            barcode: '1001', 
            sku: 'RING-22K-001', 
            styleCode: '4001', 
            shortName: 'Gold Ring 22K', 
            size: '18', 
            avgWt: 4.5, 
            purity: 91.6, 
            mcRate: 250, 
            mcType: 'MC/GM', // NEW: 'MC/GM' or 'PieceCost'
            pcs: 1, // NEW: Number of pieces
            boxCharges: 0, // NEW
            stoneCharges: 0, // NEW
            metalType: 'gold',
            isSold: false // NEW: Track if sold
        },
        { 
            id: 2, 
            barcode: '1002', 
            sku: 'CHAIN-22K-002', 
            styleCode: '4002', 
            shortName: 'Gold Chain 22K', 
            size: '20', 
            avgWt: 15.3, 
            purity: 91.6, 
            mcRate: 200, 
            mcType: 'MC/GM',
            pcs: 1,
            boxCharges: 0,
            stoneCharges: 0,
            metalType: 'gold',
            isSold: false
        },
        { 
            id: 3, 
            barcode: '1003', 
            sku: 'IDOL-SF-001', 
            styleCode: '4265', 
            shortName: 'Silver Idol', 
            size: '270', 
            avgWt: 17.47, 
            purity: 100, 
            mcRate: 173.69, 
            mcType: 'MC/GM',
            pcs: 1,
            boxCharges: 0,
            stoneCharges: 0,
            metalType: 'silver',
            isSold: false
        }
    ];
    localStorage.setItem('products', JSON.stringify(products));
}

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize data structures
        updateRatesDisplay();
        updateCustomerDropdown();
        updateProductsTable();
        updateRateSlabInfo();
        updateBillCustomerDropdown();
        updateCashEntryFields();

        // Billing barcode scanner - single registration
        const barcodeInput = document.getElementById('barcodeInput');
        if (barcodeInput && !barcodeInput.dataset.listenerAdded) {
            barcodeInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleBarcodeScan(this.value.trim());
                    this.value = '';
                }
            });
            barcodeInput.dataset.listenerAdded = 'true';
            barcodeInput.focus();
        }

        // Product Management barcode scanner
        const productBarcodeInput = document.getElementById('productBarcodeInput');
        if (productBarcodeInput && !productBarcodeInput.dataset.listenerAdded) {
            productBarcodeInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleProductBarcodeScan(this.value.trim());
                    this.value = '';
                }
            });
            productBarcodeInput.dataset.listenerAdded = 'true';
        }

        // Auto-calculate item amount - single registration only
        const itemInputs = ['itemWeight', 'itemRate', 'itemMcRate', 'itemPurity', 'itemBoxCharges', 'itemStoneCharges'];
        itemInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element && !element.dataset.listenerAdded) {
                element.addEventListener('input', updateItemAmount);
                element.dataset.listenerAdded = 'true';
            }
        });

        // Tag split barcode scanner
        const tagSplitInput = document.getElementById('tagSplitBarcodeInput');
        if (tagSplitInput && !tagSplitInput.dataset.listenerAdded) {
            tagSplitInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleTagSplitBarcodeScan(this.value.trim());
                    this.value = '';
                }
            });
            tagSplitInput.dataset.listenerAdded = 'true';
        }

        // Tag split weight input
        const tagWeightInput = document.getElementById('tagSplitWeight');
        if (tagWeightInput && !tagWeightInput.dataset.listenerAdded) {
            tagWeightInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTagSplitEntry();
                }
            });
            tagWeightInput.dataset.listenerAdded = 'true';
        }

        // Initialize ledger dashboard
        updateLedgerDashboard();
        showLedgerCustomerAccounts();

        // Initialize Sales Bill Tab
        refreshQuotationsList();
    });

            function updateBillCustomerDropdown() {
                    const select = document.getElementById('billCustomerSelect');
                    if (!select) return;

                    select.innerHTML = '<option value="">-- Select Customer --</option>';
                    customers.forEach((customer, idx) => {
                        const option = document.createElement('option');
                        option.value = idx;
                        option.textContent = customer.name;
                        select.appendChild(option);
                    });
                }

        function showTab(tab) {
                // Initialize ROL when tab is shown
                if (tab === 'rol' && typeof initializeROL === 'function') {
                    initializeROL();
                }
                // Check if user has access to this tab
                if (currentUser && !currentUser.allowedTabs.includes('all') && !currentUser.allowedTabs.includes(tab)) {
                    showDialog('Access Denied', 'You do not have permission to access this tab.', 'error');
                    return;
                }
                
                // Hide all tabs
                document.getElementById('billingTab').classList.add('hidden');
                document.getElementById('productsTab').classList.add('hidden');
                document.getElementById('customersTab').classList.add('hidden');
                document.getElementById('rolTab').classList.add('hidden');
                document.getElementById('quotationsTab').classList.add('hidden');
                document.getElementById('salesbillTab').classList.add('hidden'); 
                document.getElementById('billHistoryTab').classList.add('hidden'); 
                document.getElementById('ledgerTab').classList.add('hidden'); 
                document.getElementById('pvTab').classList.add('hidden'); 
                document.getElementById('tagsplitTab').classList.add('hidden');
                document.getElementById('tagsearchTab').classList.add('hidden');
                document.getElementById('floorTab').classList.add('hidden');

                // Reset all buttons
                document.getElementById('btnBilling').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnProducts').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnCustomers').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnROL').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnQuotations').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnSalesBill').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition'; 
                document.getElementById('btnBillHistory').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnLedger').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition'; 
                document.getElementById('btnPV').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition'; 
                document.getElementById('btnTagSplit').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnTagSearch').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';
                document.getElementById('btnFloor').className = 'px-4 py-2 bg-amber-800 text-white rounded-lg hover:bg-amber-900 font-medium transition';

                if (tab === 'billing') {
                    document.getElementById('billingTab').classList.remove('hidden');
                    document.getElementById('btnBilling').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                } else if (tab === 'products') {
                    document.getElementById('productsTab').classList.remove('hidden');
                    document.getElementById('btnProducts').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateProductsTable();
                } else if (tab === 'customers') {
                    document.getElementById('customersTab').classList.remove('hidden');
                    document.getElementById('btnCustomers').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadCustomersDisplay();
                } else if (tab === 'rol') {
                    document.getElementById('rolTab').classList.remove('hidden');
                    document.getElementById('btnROL').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    initializeROL();
                    // ROL display is now loaded via loadROLForStyleCode() when style code is selected
                } else if (tab === 'quotations') {
                    document.getElementById('quotationsTab').classList.remove('hidden');
                    document.getElementById('btnQuotations').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadQuotationsHistory();
                } else if (tab === 'salesbill') { // ADD THIS BLOCK
                    document.getElementById('salesbillTab').classList.remove('hidden');
                    document.getElementById('btnSalesBill').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateBillRatesDisplay();
                    setTimeout(() => {
                        const billInput = document.getElementById('billBarcodeInput');
                        if (billInput) {
                            billInput.focus();
                        }
                    }, 100);
                } else if (tab === 'billhistory') {
                    document.getElementById('billHistoryTab').classList.remove('hidden');
                    document.getElementById('btnBillHistory').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadBillHistory();
                } else if (tab === 'ledger') {
                    document.getElementById('ledgerTab').classList.remove('hidden');
                    document.getElementById('btnLedger').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateLedgerDashboard();
                    showLedgerCustomerAccounts(); // Show customer accounts by default
                }
                else if (tab === 'pv') {
                    document.getElementById('pvTab').classList.remove('hidden');
                    document.getElementById('btnPV').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    loadPVTab();
                } else if (tab === 'tagsplit') {
                    document.getElementById('tagsplitTab').classList.remove('hidden');
                    document.getElementById('btnTagSplit').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    setTimeout(() => {
                        const splitInput = document.getElementById('tagSplitBarcodeInput');
                        if (splitInput) {
                            splitInput.focus();
                        }
                    }, 100);
                } else if (tab === 'tagsearch') {
                    document.getElementById('tagsearchTab').classList.remove('hidden');
                    document.getElementById('btnTagSearch').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    setTimeout(() => {
                        const searchInput = document.getElementById('tagSearchInput');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    }, 100);
                } else if (tab === 'floor') {
                    document.getElementById('floorTab').classList.remove('hidden');
                    document.getElementById('btnFloor').className = 'px-4 py-2 bg-white text-amber-600 rounded-lg hover:bg-amber-50 font-medium transition';
                    updateFloorsTable();
                    updateFloorDropdowns();
                }
            }

        function updateRatesDisplay() {
                document.getElementById('goldRate').textContent = `‚Çπ${parseFloat(rates.gold).toFixed(2)}/gm`;
                document.getElementById('silverRate').textContent = `‚Çπ${parseFloat(rates.silver).toFixed(2)}/gm`;
                document.getElementById('platinumRate').textContent = `‚Çπ${parseFloat(rates.platinum).toFixed(2)}/gm`;
            }

        function showRatesModal() {
            document.getElementById('rateGold').value = rates.gold;
            document.getElementById('rateSilver').value = rates.silver;
            document.getElementById('ratePlatinum').value = rates.platinum;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('ratesModal').classList.remove('hidden');
        }

        function closeModals() {
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }

            STATIC_MODAL_IDS.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.classList.add('hidden');
                }
            });
        }

        // Add event listeners for rate inputs to enable dynamic updates
            document.addEventListener('DOMContentLoaded', function () {
                const ratesModal = document.getElementById('ratesModal');
                if (ratesModal) {
                    ratesModal.addEventListener('input', function (e) {
                        if (e.target.id === 'rateGold' || e.target.id === 'rateSilver' || e.target.id === 'ratePlatinum') {
                            // Preview calculation
                            const silverInput = parseFloat(document.getElementById('rateSilver').value) || 0;
                            const discountedSilver = silverInput * 0.97;

                            // Show preview if silver rate is entered
                            if (e.target.id === 'rateSilver' && silverInput > 0) {
                                e.target.title = `Wholesale Rate (after 3% discount): ‚Çπ${discountedSilver.toFixed(2)}`;
                            }
                        }
                    });
                }
            });

        async function saveRates() {
                const goldInput = parseFloat(document.getElementById('rateGold').value) || 0;
                const silverInput = parseFloat(document.getElementById('rateSilver').value) || 0;
                const platinumInput = parseFloat(document.getElementById('ratePlatinum').value) || 0;

                // Apply 3% discount for silver (wholesale) - ensure numbers, not strings
                rates.gold = parseFloat(goldInput);
                rates.silver = parseFloat(silverInput * 0.97); // 3% discount
                rates.platinum = parseFloat(platinumInput);

                // Save to API
                try {
                    await api.updateRates({
                        gold: rates.gold,
                        silver: rates.silver,
                        platinum: rates.platinum
                    });
                } catch (error) {
                    console.error('Failed to save rates to API:', error);
                }

                setCachedItem('rates', rates);
                updateRatesDisplay();

                // Recalculate all items with new rates
                let updatedCount = 0;
                items.forEach(item => {
                    if (item.metalType) {
                        // Limit to 2 decimal places
                        const newRate = parseFloat(parseFloat(rates[item.metalType]).toFixed(2));
                        if (newRate) {
                            item.rate = newRate;
                            // Fix rate calculation: mc - 3% (if rate is 152.5, then rate would be 147.92)
                            const originalMCRate = item.originalMcRate || parseFloat(item.mcRate);
                            const adjustedMCRate = parseFloat(parseFloat(originalMCRate * 0.97).toFixed(2));
                            item.mcRate = adjustedMCRate;
                            item.amount = (parseFloat(item.rate) + parseFloat(item.mcRate)) * item.weight + (item.boxCharges || 0) + (item.stoneCharges || 0);
                            updatedCount++;
                        }
                    }
                });

                if (updatedCount > 0) {
                    updateItemsTable();
                    updateSummary();
                }

                closeModals();
                alert(`‚úÖ Rates Updated!\n\nGold: ‚Çπ${parseFloat(rates.gold).toFixed(2)}/gm\nSilver: ‚Çπ${parseFloat(rates.silver).toFixed(2)}/gm (3% wholesale discount applied)\nPlatinum: ‚Çπ${parseFloat(rates.platinum).toFixed(2)}/gm\n\n${updatedCount} items recalculated.`);
            }

        function updateCustomerDropdown() {
            const datalist = document.getElementById('customerList');
            datalist.innerHTML = '';
            customers.forEach((customer) => {
                const option = document.createElement('option');
                option.value = customer.name;
                option.setAttribute('data-customer-idx', customers.indexOf(customer));
                datalist.appendChild(option);
            });
        }

        function handleCustomerInput() {
            const input = document.getElementById('customerSelect');
            const customerName = input.value.trim();
            if (!customerName) {
                document.getElementById('customerDetailsDisplay').classList.add('hidden');
                document.getElementById('customerMobile').value = '';
                currentCustomer = null;
                return;
            }
            const customer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
            if (customer) {
                loadCustomerByObject(customer);
            }
        }

        function handleCustomerSelect() {
            const input = document.getElementById('customerSelect');
            const customerName = input.value.trim();
            const customer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
            if (customer) {
                loadCustomerByObject(customer);
            }
        }

        function loadCustomerByObject(customer) {
            currentCustomer = customer;
            document.getElementById('custName').textContent = customer.name;
            document.getElementById('custAddress').textContent = `${customer.address1}, ${customer.address2}, ${customer.city}`;
            document.getElementById('customerMobile').value = customer.mobile;
            document.getElementById('customerDetailsDisplay').classList.remove('hidden');
            updateRateSlabInfo();
            if (items.length > 0) {
                recalculateItemsWithRateSlab();
            }
        }

        function loadCustomerDetails() {
                const customerName = document.getElementById('customerSelect').value.trim();
                if (!customerName) {
                    document.getElementById('customerDetailsDisplay').classList.add('hidden');
                    document.getElementById('customerMobile').value = '';
                    currentCustomer = null;
                    return;
                }
                const customer = customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                if (customer) {
                    loadCustomerByObject(customer);
                } else {
                    document.getElementById('customerDetailsDisplay').classList.add('hidden');
                    document.getElementById('customerMobile').value = '';
                    currentCustomer = null;
                }
                document.getElementById('custName').textContent = currentCustomer.name;
                document.getElementById('custAddress').textContent = `${currentCustomer.address1}, ${currentCustomer.address2}, ${currentCustomer.city}`;
                document.getElementById('customerMobile').value = currentCustomer.mobile;
                document.getElementById('customerDetailsDisplay').classList.remove('hidden');

                // Update rate slab display
                updateRateSlabInfo();

                // Recalculate all items with new rate slab
                if (items.length > 0) {
                    recalculateAllItems();
                }
            }
            
            function updateRateSlabInfo() {
                    currentRateSlab = document.getElementById('rateSlab').value;
                    const discount = rateSlabDiscounts[currentRateSlab];

                    document.getElementById('rateSlabDisplay').textContent = currentRateSlab;

                    const descriptions = {
                        'R': 'Standard Rate',
                        'R1': 'MC Discount ‚Çπ2/gm',
                        'R2': 'MC Discount ‚Çπ5/gm',
                        'R3': 'MC Discount ‚Çπ10/gm',
                        'R4': 'MC Discount ‚Çπ15/gm'
                    };

                    document.getElementById('rateSlabDesc').textContent = descriptions[currentRateSlab];

                    // Recalculate all items if any exist
                    if (items.length > 0) {
                        recalculateAllItems();
                    }

                    // Update current item amount if form is filled
                    updateItemAmount();
                }

                function getAdjustedMCRate(originalMCRate) {
                    const discount = rateSlabDiscounts[currentRateSlab];
                    const adjustedRate = Math.max(0, originalMCRate - discount);
                    return adjustedRate;
                }

                function recalculateAllItems() {
                        items.forEach(item => {
                            // Get original MC rate (stored separately)
                            const originalMCRate = item.originalMcRate || item.mcRate;
                            const adjustedMCRate = getAdjustedMCRate(originalMCRate);

                            const boxCharges = item.boxCharges || 0;
                            const stoneCharges = item.stoneCharges || 0;

                            item.amount = (item.rate + adjustedMCRate) * item.weight + boxCharges + stoneCharges;
                            item.mcRate = adjustedMCRate;
                            item.originalMcRate = originalMCRate;
                        });
                        updateItemsTable();
                        updateSummary();
                    }

        function showNewCustomerModal() {
            document.getElementById('customerModalTitle').textContent = 'Add New Customer';
            document.getElementById('editCustomerIndex').value = '';
            document.getElementById('newCustName').value = '';
            document.getElementById('newCustAddress1').value = '';
            document.getElementById('newCustAddress2').value = '';
            document.getElementById('newCustCity').value = '';
            document.getElementById('newCustMobile').value = '';
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        function editCustomer(idx) {
            const customer = customers[idx];
            document.getElementById('customerModalTitle').textContent = 'Edit Customer';
            document.getElementById('editCustomerIndex').value = idx;
            document.getElementById('newCustName').value = customer.name;
            document.getElementById('newCustAddress1').value = customer.address1 || '';
            document.getElementById('newCustAddress2').value = customer.address2 || '';
            document.getElementById('newCustCity').value = customer.city || '';
            document.getElementById('newCustMobile').value = customer.mobile;
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addCustomerModal').classList.remove('hidden');
        }

        async function saveCustomer() {
            const customer = {
                name: document.getElementById('newCustName').value.trim(),
                address1: document.getElementById('newCustAddress1').value.trim(),
                address2: document.getElementById('newCustAddress2').value.trim(),
                city: document.getElementById('newCustCity').value.trim(),
                mobile: document.getElementById('newCustMobile').value.trim(),
                state: document.getElementById('newCustState')?.value?.trim() || '',
                pincode: document.getElementById('newCustPincode')?.value?.trim() || '',
                gstin: document.getElementById('newCustGstin')?.value?.trim() || ''
            };
            if (!customer.name || !customer.mobile) {
                showDialog('Error', 'Please fill Name and Mobile Number', 'error');
                return;
            }
            
            const editIndex = document.getElementById('editCustomerIndex').value;
            const existingCustomer = editIndex !== '' ? customers[editIndex] : null;
            
            try {
                if (editIndex !== '' && existingCustomer && existingCustomer.id) {
                    // Update existing customer via API
                    const updated = await api.updateCustomer(existingCustomer.id, customer);
                    customers[editIndex] = { ...customer, id: updated.id };
                    showDialog('Success', 'Customer updated in database!', 'success');
                } else {
                    // Create new customer via API
                    const saved = await api.createCustomer(customer);
                    customer.id = saved.id;
                    customers.push(customer);
                    showDialog('Success', 'Customer saved to database!', 'success');
                }
                setCachedItem('customers', customers);
                updateCustomerDropdown();
                loadCustomersDisplay();
                closeModals();
            } catch (error) {
                console.error('API Error:', error);
                // Fallback to localStorage
                if (editIndex !== '') {
                    customers[editIndex] = customer;
                    showDialog('Warning', 'Customer updated locally. API unavailable.', 'warning');
                } else {
                    customers.push(customer);
                    showDialog('Warning', 'Customer saved locally. API unavailable.', 'warning');
                }
                setCachedItem('customers', customers);
                updateCustomerDropdown();
                loadCustomersDisplay();
                closeModals();
            }
        }

        async function deleteCustomer(idx) {
            if (!confirm('Delete this customer?')) return;
            
            const customer = customers[idx];
            if (customer && customer.id) {
                try {
                    await api.deleteCustomer(customer.id);
                    customers.splice(idx, 1);
                    setCachedItem('customers', customers);
                    updateCustomerDropdown();
                    loadCustomersDisplay();
                    showDialog('Success', 'Customer deleted from database!', 'success');
                } catch (error) {
                    console.error('API Error:', error);
                    // Fallback to localStorage
                    customers.splice(idx, 1);
                    setCachedItem('customers', customers);
                    updateCustomerDropdown();
                    loadCustomersDisplay();
                    showDialog('Warning', 'Customer deleted locally. API unavailable.', 'warning');
                }
            } else {
                // No ID, just delete from local
                customers.splice(idx, 1);
                setCachedItem('customers', customers);
                updateCustomerDropdown();
                loadCustomersDisplay();
                showDialog('Success', 'Customer deleted!', 'success');
            }
        }

        function loadCustomersDisplay() {
            const container = document.getElementById('customersList');
            container.innerHTML = '';
            if (customers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-8">No customers yet.</p>';
                return;
            }
            customers.forEach((customer, idx) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg border hover:shadow-lg transition';
                card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-gray-800">${customer.name}</h3>
                            <div class="flex gap-2">
                                <button onclick="editCustomer(${idx})" class="text-blue-600 hover:text-blue-800 text-sm font-medium">‚úèÔ∏è</button>
                                <button onclick="deleteCustomer(${idx})" class="text-red-600 hover:text-red-800 text-sm font-medium">üóëÔ∏è</button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600">${customer.address1}</p>
                        <p class="text-sm text-gray-600">${customer.address2}</p>
                        <p class="text-sm text-gray-600">${customer.city}</p>
                        <p class="text-sm text-blue-600 font-medium mt-2">üì± ${customer.mobile}</p>
                    `;
                container.appendChild(card);
            });
        }

    // Optimized table update with requestAnimationFrame
    let tableUpdatePending = false;
    function updateProductsTable() {
        if (tableUpdatePending) return;
        tableUpdatePending = true;
        
        requestAnimationFrame(() => {
            const searchEl = getCachedElement('productSearch');
            const searchTerm = searchEl ? searchEl.value.toLowerCase().trim() : '';
            const tbody = getCachedElement('productsTableBody');
            if (!tbody) {
                tableUpdatePending = false;
                return;
            }

            // Only show products when search term is provided
            if (!searchTerm || searchTerm.length < 2) {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-16 text-gray-500"><div class="text-6xl mb-4">üîç</div><p class="text-lg font-semibold">Search for Products</p><p class="text-sm mt-2">Enter barcode, SKU, style code, or product name to search</p></td></tr>';
                tableUpdatePending = false;
                return;
            }

            let displayProducts = products.filter(p => p.isSold !== true);

            // Apply search filter - search by barcode, SKU, style code, or product name
            displayProducts = displayProducts.filter(product => {
                return (
                    (product.barcode && product.barcode.toLowerCase().includes(searchTerm)) ||
                    (product.sku && product.sku.toLowerCase().includes(searchTerm)) ||
                    (product.styleCode && product.styleCode.toLowerCase().includes(searchTerm)) ||
                    (product.shortName && product.shortName.toLowerCase().includes(searchTerm))
                );
            });

            // Use DocumentFragment for faster DOM updates
            const fragment = document.createDocumentFragment();
            
            if (displayProducts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="13" class="text-center py-8 text-gray-500">No products found matching your search.</td>';
                fragment.appendChild(row);
            } else {
                displayProducts.forEach((product) => {
                    const originalIdx = products.findIndex(p => p.id === product.id);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    const barcode = product.barcode || '-';
                    const sku = product.sku || '-';
                    const styleCode = product.styleCode || '-';
                    const shortName = product.shortName || 'Unnamed Product';
                    const size = product.size || '-';
                    const avgWt = product.avgWt || 0;
                    const metalType = product.metalType || 'gold';
                    const purity = product.purity || 100;
                    const mcRate = product.mcRate || 0;
                    const mcType = product.mcType || 'MC/GM';
                    const pcs = product.pcs || 1;
                    const boxCharges = product.boxCharges || 0;
                    const stoneCharges = product.stoneCharges || 0;
                    row.innerHTML = `
                <td class="px-4 py-3 font-mono text-sm">${barcode}</td>
                <td class="px-4 py-3 text-sm">${sku}</td>
                <td class="px-4 py-3 text-sm font-semibold text-blue-600">${styleCode}</td>
                <td class="px-4 py-3 font-medium">${shortName}</td>
                <td class="px-4 py-3 text-sm">${size}</td>
                <td class="px-4 py-3 text-sm">${avgWt.toFixed(2)}g</td>
                <td class="px-4 py-3 capitalize text-sm">${metalType}</td>
                <td class="px-4 py-3 text-sm">${purity}%</td>
                <td class="px-4 py-3 text-sm">
                    ${mcType === 'PieceCost'
                            ? `‚Çπ${mcRate.toFixed(2)} (Piece)`
                            : `‚Çπ${mcRate} /gm`}
                </td>
                <td class="px-4 py-3 text-center">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">
                        ${pcs} pcs
                    </span>
                </td>
                <td class="px-4 py-3 text-right text-sm">‚Çπ${boxCharges.toFixed(2)}</td>
                <td class="px-4 py-3 text-right text-sm">‚Çπ${stoneCharges.toFixed(2)}</td>
                <td class="px-4 py-3 text-center">
                <button onclick="editProduct(${originalIdx})" class="text-blue-600 hover:text-blue-800 font-medium mr-2" title="Edit">‚úèÔ∏è</button>
                <button onclick="deleteProduct(${originalIdx})" class="text-red-600 hover:text-red-800 font-medium" title="Delete">üóëÔ∏è</button>
            </td>
            `;
                    fragment.appendChild(row);
                });
            }
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
            tableUpdatePending = false;
        });
    }

    // Debounced search function
    const debouncedUpdateProductsTable = debounce(updateProductsTable, 300);
    const debouncedSearchAPI = debounce(async function(searchTerm) {
        if (searchTerm.length < 2) {
            const tbody = getCachedElement('productsTableBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="13" class="text-center py-16 text-gray-500"><div class="text-6xl mb-4">üîç</div><p class="text-lg font-semibold">Search for Products</p><p class="text-sm mt-2">Enter barcode, SKU, style code, or product name to search</p></td></tr>';
            }
            return;
        }
        
        try {
            const results = await api.getProducts(searchTerm);
            const tbody = getCachedElement('productsTableBody');
            if (!tbody) return;
            
            // Map API results to frontend format
            const displayProducts = results.map(p => ({
                id: p.id,
                barcode: p.barcode,
                sku: p.sku,
                styleCode: p.style_code,
                shortName: p.short_name,
                size: p.size,
                avgWt: parseFloat(p.avg_wt) || 0,
                metalType: p.metal_type,
                purity: parseFloat(p.purity) || 100,
                mcRate: parseFloat(p.mc_rate) || 0,
                mcType: p.mc_type || 'MC/GM',
                pcs: parseInt(p.pcs) || 1,
                boxCharges: parseFloat(p.box_charges) || 0,
                stoneCharges: parseFloat(p.stone_charges) || 0,
                isSold: p.is_sold || false
            }));
            
            // Render results
            const fragment = document.createDocumentFragment();
            if (displayProducts.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="13" class="text-center py-8 text-gray-500">No products found matching your search.</td>';
                fragment.appendChild(row);
            } else {
                displayProducts.forEach((product) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    const barcode = product.barcode || '-';
                    const sku = product.sku || '-';
                    const styleCode = product.styleCode || '-';
                    const shortName = product.shortName || 'Unnamed Product';
                    const size = product.size || '-';
                    const avgWt = product.avgWt || 0;
                    const metalType = product.metalType || 'gold';
                    const purity = product.purity || 100;
                    const mcRate = product.mcRate || 0;
                    const mcType = product.mcType || 'MC/GM';
                    const pcs = product.pcs || 1;
                    const boxCharges = product.boxCharges || 0;
                    const stoneCharges = product.stoneCharges || 0;
                    
                    // Find index in local products array for edit/delete
                    const localIdx = products.findIndex(p => p.id === product.id);
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 font-mono text-sm">${barcode}</td>
                        <td class="px-4 py-3 text-sm">${sku}</td>
                        <td class="px-4 py-3 text-sm font-semibold text-blue-600">${styleCode}</td>
                        <td class="px-4 py-3 font-medium">${shortName}</td>
                        <td class="px-4 py-3 text-sm">${size}</td>
                        <td class="px-4 py-3 text-sm">${avgWt.toFixed(2)}g</td>
                        <td class="px-4 py-3 capitalize text-sm">${metalType}</td>
                        <td class="px-4 py-3 text-sm">${purity}%</td>
                        <td class="px-4 py-3 text-sm">
                            ${mcType === 'PieceCost'
                                    ? `‚Çπ${mcRate.toFixed(2)} (Piece)`
                                    : `‚Çπ${mcRate} /gm`}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-bold">
                                ${pcs} pcs
                            </span>
                        </td>
                        <td class="px-4 py-3 text-right text-sm">‚Çπ${boxCharges.toFixed(2)}</td>
                        <td class="px-4 py-3 text-right text-sm">‚Çπ${stoneCharges.toFixed(2)}</td>
                        <td class="px-4 py-3 text-center">
                            ${localIdx >= 0 ? `
                                <button onclick="editProduct(${localIdx})" class="text-blue-600 hover:text-blue-800 font-medium mr-2" title="Edit">‚úèÔ∏è</button>
                                <button onclick="deleteProduct(${localIdx})" class="text-red-600 hover:text-red-800 font-medium" title="Delete">üóëÔ∏è</button>
                            ` : `
                                <button onclick="editProductFromAPI(${product.id})" class="text-blue-600 hover:text-blue-800 font-medium mr-2" title="Edit">‚úèÔ∏è</button>
                                <button onclick="deleteProductFromAPI(${product.id})" class="text-red-600 hover:text-red-800 font-medium" title="Delete">üóëÔ∏è</button>
                            `}
                        </td>
                    `;
                    fragment.appendChild(row);
                });
            }
            
            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        } catch (error) {
            console.error('Search error:', error);
            // Fallback to local search
            debouncedUpdateProductsTable();
        }
    }, 300);
    
    function filterProducts() {
        const searchEl = getCachedElement('productSearch');
        const searchTerm = searchEl ? searchEl.value.trim() : '';
        
        // Try API search first, fallback to local
        if (currentTenant && searchTerm.length >= 2) {
            debouncedSearchAPI(searchTerm);
        } else {
            debouncedUpdateProductsTable();
        }
    }

    function downloadStockReport() {
            if (products.length === 0) {
                alert('No products in inventory to generate report!');
                return;
            }

            // Populate style code filter
            const styleCodeFilter = document.getElementById('stockStyleCodeFilter');
            styleCodeFilter.innerHTML = '<option value="all">All Style Codes</option>';

            const uniqueStyleCodes = [...new Set(products.map(p => p.styleCode).filter(s => s && s.trim() !== ''))];
            uniqueStyleCodes.sort().forEach(styleCode => {
                const option = document.createElement('option');
                option.value = styleCode;
                option.textContent = styleCode;
                styleCodeFilter.appendChild(option);
            });

            // Show format selection modal
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('stockReportModal').classList.remove('hidden');
        }

        function getFilteredProducts() {
                const metalFilter = document.getElementById('stockMetalFilter').value;
                const styleCodeFilter = document.getElementById('stockStyleCodeFilter').value;

                let filtered = products;

                // Apply metal filter
                if (metalFilter !== 'all') {
                    filtered = filtered.filter(p => p.metalType === metalFilter);
                }

                // Apply style code filter
                if (styleCodeFilter !== 'all') {
                    filtered = filtered.filter(p => p.styleCode === styleCodeFilter);
                }

                return filtered;
            }

        function downloadStockReportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape'); // Landscape for better table fit

                const reportType = document.getElementById('stockReportType').value;
                const metalFilter = document.getElementById('stockMetalFilter').value;
                const filteredProducts = getFilteredProducts();

                if (filteredProducts.length === 0) {
                    alert('No products found for selected filter!');
                    return;
                }

                const date = new Date().toLocaleDateString('en-GB');

                // Header
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('STOCK INVENTORY REPORT', 148, 15, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${date}`, 148, 22, { align: 'center' });
            doc.text(`Total Items: ${filteredProducts.length}`, 148, 28, { align: 'center' });

            let yPosFilter = 34;
            if (metalFilter !== 'all') {
                doc.text(`Metal Filter: ${metalFilter.toUpperCase()}`, 148, yPosFilter, { align: 'center' });
                yPosFilter += 5;
            }

            const styleCodeFilter = document.getElementById('stockStyleCodeFilter').value;
            if (styleCodeFilter !== 'all') {
                doc.text(`Style Code: ${styleCodeFilter}`, 148, yPosFilter, { align: 'center' });
                yPosFilter += 5;
            }

                // Calculate totals
                const totalsByMetal = {};
                filteredProducts.forEach(p => {
                    if (!totalsByMetal[p.metalType]) {
                        totalsByMetal[p.metalType] = { count: 0, weight: 0 };
                    }
                    totalsByMetal[p.metalType].count++;
                    totalsByMetal[p.metalType].weight += (p.avgWt || 0);
                });

                let tableData, tableHeaders;

                if (reportType === 'detailed') {
                    tableHeaders = [['#', 'Barcode', 'SKU', 'Style Code', 'Product Name', 'Size', 'Avg Wt (gm)', 'Purity %', 'MC Rate', 'Metal Type']];
                    tableData = filteredProducts.map((p, idx) => [
                        idx + 1,
                        p.barcode,
                        p.sku || '-',
                        p.styleCode || '-',
                        p.shortName,
                        p.size || '-',
                        (p.avgWt || 0).toFixed(2),
                        p.purity.toFixed(1),
                        p.mcRate.toFixed(2),
                        p.metalType.toUpperCase()
                    ]);
                } else {
                    tableHeaders = [['#', 'Barcode', 'Product Name', 'Metal Type', 'Purity %', 'Avg Wt (gm)', 'MC Rate']];
                    tableData = filteredProducts.map((p, idx) => [
                        idx + 1,
                        p.barcode,
                        p.shortName,
                        p.metalType.toUpperCase(),
                        p.purity.toFixed(1),
                        (p.avgWt || 0).toFixed(2),
                        p.mcRate.toFixed(2)
                    ]);
                }

            const tableStartY = (metalFilter !== 'all' || styleCodeFilter !== 'all') ? 42 : 35;
            doc.autoTable({
                startY: tableStartY,
                    head: tableHeaders,
                    body: tableData,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [139, 92, 246],
                        textColor: 255,
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    bodyStyles: { fontSize: 8 },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });

                // Summary at bottom
                const finalY = doc.lastAutoTable.finalY + 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('SUMMARY BY METAL TYPE:', 20, finalY);

                let summaryY = finalY + 7;
                doc.setFontSize(9);
                Object.keys(totalsByMetal).forEach(metal => {
                    doc.setFont(undefined, 'bold');
                    doc.text(`${metal.toUpperCase()}:`, 25, summaryY);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${totalsByMetal[metal].count} items, Total Weight: ${totalsByMetal[metal].weight.toFixed(2)} gm`, 60, summaryY);
                    summaryY += 5;
                });

                doc.save(`Stock_Report_${reportType}_${date.replace(/\//g, '-')}.pdf`);
                closeModals();
                alert('Stock Report PDF downloaded successfully!');
            }

            function downloadStockReportExcel() {
                    const reportType = document.getElementById('stockReportType').value;
                    const metalFilter = document.getElementById('stockMetalFilter').value;
                    const filteredProducts = getFilteredProducts();

                    if (filteredProducts.length === 0) {
                        alert('No products found for selected filter!');
                        return;
                    }

                    const date = new Date().toLocaleDateString('en-GB');
                    const wb = XLSX.utils.book_new();

                    // Calculate totals
                    const totalsByMetal = {};
                    filteredProducts.forEach(p => {
                        if (!totalsByMetal[p.metalType]) {
                            totalsByMetal[p.metalType] = { count: 0, weight: 0 };
                        }
                        totalsByMetal[p.metalType].count++;
                        totalsByMetal[p.metalType].weight += (p.avgWt || 0);
                    });

                    // Header section
                    const styleCodeFilter = document.getElementById('stockStyleCodeFilter').value;

                const headerData = [
                    ['STOCK INVENTORY REPORT'],
                    [''],
                    ['Generated Date:', date],
                    ['Total Items:', filteredProducts.length],
                    ['Metal Filter:', metalFilter === 'all' ? 'All Metals' : metalFilter.toUpperCase()],
                    ['Style Code Filter:', styleCodeFilter === 'all' ? 'All Style Codes' : styleCodeFilter],
                    ['Report Type:', reportType === 'detailed' ? 'Detailed Report' : 'Summary Report'],
                    ['']
                ];

                    let productData;

                    if (reportType === 'detailed') {
                        productData = filteredProducts.map((p, idx) => ({
                            '#': idx + 1,
                            'Barcode': p.barcode,
                            'SKU': p.sku || '-',
                            'Style Code': p.styleCode || '-',
                            'Product Name': p.shortName,
                            'Size': p.size || '-',
                            'Avg Weight (gm)': (p.avgWt || 0).toFixed(2),
                            'Purity %': p.purity.toFixed(1),
                            'MC Rate': p.mcRate.toFixed(2),
                            'Metal Type': p.metalType.toUpperCase()
                        }));
                    } else {
                        productData = filteredProducts.map((p, idx) => ({
                            '#': idx + 1,
                            'Barcode': p.barcode,
                            'Product Name': p.shortName,
                            'Metal Type': p.metalType.toUpperCase(),
                            'Purity %': p.purity.toFixed(1),
                            'Avg Weight (gm)': (p.avgWt || 0).toFixed(2),
                            'MC Rate': p.mcRate.toFixed(2)
                        }));
                    }

                    // Convert products to array of arrays
                    const productHeaders = Object.keys(productData[0]);
                    const productRows = productData.map(obj => productHeaders.map(key => obj[key]));

                    // Summary section
                    const summaryData = [
                        [''],
                        ['SUMMARY BY METAL TYPE'],
                        ['Metal Type', 'Count', 'Total Weight (gm)']
                    ];

                    Object.keys(totalsByMetal).forEach(metal => {
                        summaryData.push([
                            metal.toUpperCase(),
                            totalsByMetal[metal].count,
                            totalsByMetal[metal].weight.toFixed(2)
                        ]);
                    });

                    // Combine all data
                    const allData = [
                        ...headerData,
                        productHeaders,
                        ...productRows,
                        ...summaryData
                    ];

                    // Create worksheet
                    const ws = XLSX.utils.aoa_to_sheet(allData);

                    // Set column widths
                    if (reportType === 'detailed') {
                        ws['!cols'] = [
                            { wch: 5 }, { wch: 15 }, { wch: 18 }, { wch: 15 }, { wch: 35 },
                            { wch: 10 }, { wch: 15 }, { wch: 10 }, { wch: 10 }, { wch: 12 }
                        ];
                    } else {
                        ws['!cols'] = [
                            { wch: 5 }, { wch: 15 }, { wch: 35 }, { wch: 12 },
                            { wch: 10 }, { wch: 15 }, { wch: 10 }
                        ];
                    }

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Stock Report');

                    // Save file
                    XLSX.writeFile(wb, `Stock_Report_${reportType}_${date.replace(/\//g, '-')}.xlsx`);

                    closeModals();
                    alert('Stock Report Excel downloaded successfully!');
                }

        function showAddProductModal() {
            document.getElementById('productModalTitle').textContent = 'Add New Product';
            document.getElementById('editProductIndex').value = '';
            document.getElementById('newBarcode').value = '';
            document.getElementById('newSku').value = '';
            document.getElementById('newStyleCode').value = '';
            document.getElementById('newShortName').value = '';
            document.getElementById('newSize').value = '';
            document.getElementById('newAvgWt').value = '';
            document.getElementById('newPurity').value = '100';
            document.getElementById('newMcRate').value = '';
            document.getElementById('newMetalType').value = 'gold';
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('addProductModal').classList.remove('hidden');
        }

function toggleMCRateLabel() {
    const mcType = document.getElementById('newMcType').value;
    const label = document.getElementById('mcRateLabel');
    if (mcType === 'PieceCost') {
        label.textContent = 'Piece Cost (Fixed Amount) *';
    } else {
        label.textContent = 'MC Rate (per gram) *';
    }
}

function editProduct(idx) {
    const product = products[idx];
    document.getElementById('productModalTitle').textContent = 'Edit Product';
    document.getElementById('editProductIndex').value = idx;
    document.getElementById('newBarcode').value = product.barcode;
    document.getElementById('newSku').value = product.sku || '';
    document.getElementById('newStyleCode').value = product.styleCode || '';
    document.getElementById('newShortName').value = product.shortName;
    document.getElementById('newSize').value = product.size || '';
    document.getElementById('newAvgWt').value = product.avgWt || '';
    document.getElementById('newPurity').value = product.purity;
    document.getElementById('newMcRate').value = product.mcRate;
    document.getElementById('newMetalType').value = product.metalType;
    
    // ‚úÖ ADD THESE 4 NEW LINES:
    document.getElementById('newMcType').value = product.mcType || 'MC/GM';
    document.getElementById('newPcs').value = product.pcs || 1;
    document.getElementById('newBoxCharges').value = product.boxCharges || 0;
    document.getElementById('newStoneCharges').value = product.stoneCharges || 0;
    toggleMCRateLabel(); // Update label
    
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('modalOverlay').classList.add('flex');
    document.getElementById('addProductModal').classList.remove('hidden');
}

async function saveProduct() {
    const product = {
        barcode: document.getElementById('newBarcode').value.trim(),
        sku: document.getElementById('newSku').value.trim(),
        styleCode: document.getElementById('newStyleCode').value.trim(),
        shortName: document.getElementById('newShortName').value.trim(),
        itemName: document.getElementById('newShortName').value.trim(), // Same as shortName for now
        size: document.getElementById('newSize').value.trim(),
        weight: parseFloat(document.getElementById('newAvgWt').value) || 0,
        avgWt: parseFloat(document.getElementById('newAvgWt').value) || 0,
        purity: parseFloat(document.getElementById('newPurity').value) || 100,
        rate: parseFloat(rates[document.getElementById('newMetalType').value] || 0),
        mcRate: parseFloat(document.getElementById('newMcRate').value) || 0,
        mcType: document.getElementById('newMcType').value,
        pcs: parseInt(document.getElementById('newPcs').value) || 1,
        boxCharges: parseFloat(document.getElementById('newBoxCharges').value) || 0,
        stoneCharges: parseFloat(document.getElementById('newStoneCharges').value) || 0,
        metalType: document.getElementById('newMetalType').value,
        floor: 'Main Floor', // Default floor
        isSold: false
    };
    
    if (!product.barcode || !product.shortName) {
        showDialog('Error', 'Please fill Barcode and Product Name', 'error');
        return;
    }
    
    const editIndex = document.getElementById('editProductIndex').value;
    const isNewProduct = editIndex === '';
    
    try {
        let savedProduct;
        
        if (editIndex !== '') {
            // Update existing product
            const existingProduct = products[editIndex];
            savedProduct = await api.updateProduct(existingProduct.id, product);
            product.id = existingProduct.id;
            products[editIndex] = { ...product, id: existingProduct.id };
            showDialog('Success', 'Product updated in database!', 'success');
        } else {
            // Create new product
            savedProduct = await api.createProduct(product);
            product.id = savedProduct.id;
            products.push(product);
            showDialog('Success', 'Product saved to database!', 'success');
            
            // ‚úÖ UPDATE ROL AVAILABLE COUNTERS when new product is added
            if (product.styleCode && rolData[product.styleCode]) {
                const styleROLData = rolData[product.styleCode];
                const rolItem = styleROLData.items.find(ri => 
                    (ri.sku && product.sku && ri.sku.toLowerCase() === product.sku.toLowerCase()) &&
                    (ri.size && product.size && ri.size.toLowerCase() === product.size.toLowerCase())
                );
                
                if (rolItem) {
                    const isSinglePiece = (product.pcs || 1) === 1;
                    
                    if (isSinglePiece) {
                        rolItem.availableRetail = (parseFloat(rolItem.availableRetail || 0) + 1);
                    } else {
                        const weightToAdd = parseFloat(product.avgWt || 0);
                        rolItem.availableWholesale = (parseFloat(rolItem.availableWholesale || 0) + weightToAdd);
                    }
                    
                    setCachedItem('rolData', rolData);
                    if (!document.getElementById('rolTab').classList.contains('hidden') && currentSelectedROLStyleCode === product.styleCode) {
                        loadROLForStyleCode();
                    }
                }
            }
        }
        
        // Update local cache
        setCachedItem('products', products);
        updateProductsTable();
        closeModals();
    } catch (error) {
        console.error('Error saving product:', error);
        showDialog('Error', 'Failed to save product: ' + error.message, 'error');
        // Fallback to localStorage if API fails
        if (editIndex !== '') {
            product.id = products[editIndex].id;
            products[editIndex] = product;
        } else {
            product.id = Date.now();
            products.push(product);
        }
        setCachedItem('products', products);
        updateProductsTable();
        closeModals();
    }
}

        // Helper functions for API-based product operations
async function editProductFromAPI(productId) {
    try {
        const results = await api.getProducts('');
        const product = results.find(p => p.id === productId);
        if (product) {
            const localIdx = products.findIndex(p => p.id === productId);
            if (localIdx >= 0) {
                editProduct(localIdx);
            } else {
                // Add to local array temporarily for editing
                const mappedProduct = {
                    id: product.id,
                    barcode: product.barcode,
                    sku: product.sku,
                    styleCode: product.style_code,
                    shortName: product.short_name,
                    size: product.size,
                    avgWt: parseFloat(product.avg_wt) || 0,
                    purity: parseFloat(product.purity) || 100,
                    mcRate: parseFloat(product.mc_rate) || 0,
                    mcType: product.mc_type || 'MC/GM',
                    pcs: parseInt(product.pcs) || 1,
                    boxCharges: parseFloat(product.box_charges) || 0,
                    stoneCharges: parseFloat(product.stone_charges) || 0,
                    metalType: product.metal_type,
                    isSold: product.is_sold || false
                };
                products.push(mappedProduct);
                editProduct(products.length - 1);
            }
        }
    } catch (error) {
        console.error('Error loading product:', error);
        showDialog('Error', 'Failed to load product for editing', 'error');
    }
}

async function deleteProductFromAPI(productId) {
    showConfirmDialog('Delete Product', 'Are you sure you want to delete this product?', async () => {
        try {
            await api.deleteProduct(productId);
            products = products.filter(p => p.id !== productId);
            setCachedItem('products', products);
            updateProductsTable();
            showDialog('Success', 'Product deleted from database!', 'success');
        } catch (error) {
            console.error('Error deleting product:', error);
            showDialog('Error', 'Failed to delete product: ' + error.message, 'error');
        }
    });
}

function deleteProduct(idx) {
            if (!confirm('Delete this product?')) return;
            products.splice(idx, 1);
            localStorage.setItem('products', JSON.stringify(products));
            updateProductsTable();
            alert('Product deleted!');
        }

        function downloadAllProducts() {
            if (products.length === 0) {
                alert('No products to download!');
                return;
            }
            const data = products.map(p => ({
                Barcode: p.barcode,
                SKU: p.sku || '',
                StyleCode: p.styleCode || '',
                ProductName: p.shortName,
                Size: p.size || '',
                AvgWeight: p.avgWt || 0,
                Purity: p.purity,
                MCRate: p.mcRate,
                MetalType: p.metalType
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Products');
            XLSX.writeFile(wb, 'All_Products_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('Products downloaded!');
        }

        function downloadSampleExcel() {
            const sampleData = [
                {
                    Barcode: '2001',
                    SKU: 'RING-22K-100',
                    StyleCode: '5001',
                    ProductName: 'Gold Ring 22K Design 1',
                    Size: '16',
                    AvgWeight: 3.5,
                    Purity: 91.6,
                    MCRate: 250,
                    MCType: 'MC/GM',
                    PCS: 1,
                    BoxCharges: 0,
                    StoneCharges: 0,
                    MetalType: 'gold'
                },
                {
                    Barcode: '2002',
                    SKU: 'BANGLE-22K-200',
                    StyleCode: '5002',
                    ProductName: 'Gold Bangle 22K',
                    Size: '2.6',
                    AvgWeight: 25.5,
                    Purity: 91.6,
                    MCRate: 200,
                    MCType: 'MC/GM',
                    PCS: 1,
                    BoxCharges: 50,
                    StoneCharges: 0,
                    MetalType: 'gold'
                },
                {
                    Barcode: '2003',
                    SKU: 'CHAIN-18K-300',
                    StyleCode: '5003',
                    ProductName: 'Gold Chain 18K',
                    Size: '18',
                    AvgWeight: 12.3,
                    Purity: 75,
                    MCRate: 1800,
                    MCType: 'PieceCost',
                    PCS: 1,
                    BoxCharges: 100,
                    StoneCharges: 200,
                    MetalType: 'gold'
                }
            ];
            const ws = XLSX.utils.json_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sample Products');
            XLSX.writeFile(wb, 'Sample_Products_Format.xlsx');
            alert('Sample downloaded!');
        }

        function showBulkUploadModal() {
            document.getElementById('uploadPreview').classList.add('hidden');
            document.getElementById('excelFileInput').value = '';
            bulkUploadData = [];
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('bulkUploadModal').classList.remove('hidden');
        }

        function showBulkUpdateModal() {
            document.getElementById('bulkStyleCode').value = '';
            document.getElementById('bulkMcRate').value = '';
            document.getElementById('bulkBoxCharges').value = '';
            document.getElementById('bulkStoneCharges').value = '';
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('bulkUpdateModal').classList.remove('hidden');
        }

        function saveBulkUpdate() {
            const styleCode = document.getElementById('bulkStyleCode').value.trim();
            const mcRate = document.getElementById('bulkMcRate').value;
            const boxCharges = document.getElementById('bulkBoxCharges').value;
            const stoneCharges = document.getElementById('bulkStoneCharges').value;

            if (!styleCode) {
                alert('Please enter a Style Code');
                return;
            }

            const matchingProducts = products.filter(p => p.styleCode && p.styleCode.toLowerCase() === styleCode.toLowerCase());
            
            if (matchingProducts.length === 0) {
                alert(`No products found with Style Code: ${styleCode}`);
                return;
            }

            let updatedCount = 0;
            matchingProducts.forEach(product => {
                let updated = false;
                
                if (mcRate && mcRate.trim() !== '') {
                    product.mcRate = parseFloat(mcRate);
                    updated = true;
                }
                
                if (boxCharges && boxCharges.trim() !== '') {
                    product.boxCharges = parseFloat(boxCharges);
                    updated = true;
                }
                
                if (stoneCharges && stoneCharges.trim() !== '') {
                    product.stoneCharges = parseFloat(stoneCharges);
                    updated = true;
                }

                if (updated) {
                    const productIndex = products.findIndex(p => p.id === product.id);
                    if (productIndex >= 0) {
                        products[productIndex] = product;
                        updatedCount++;
                    }
                }
            });

            if (updatedCount > 0) {
                localStorage.setItem('products', JSON.stringify(products));
                updateProductsTable();
                closeModals();
                alert(`‚úÖ Updated ${updatedCount} product(s) with Style Code: ${styleCode}`);
            } else {
                alert('No fields were updated. Please enter at least one value.');
            }
        }

        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    if (jsonData.length === 0) {
                        alert('Excel file is empty!');
                        return;
                    }
                    bulkUploadData = jsonData.map((row, idx) => ({
                        id: Date.now() + idx,
                        barcode: String(row.Barcode || row.barcode || '').trim(),
                        sku: String(row.SKU || row.sku || '').trim(),
                        styleCode: String(row.StyleCode || row.styleCode || '').trim(),
                        shortName: String(row.ProductName || row.productName || row.shortName || '').trim(),
                        size: String(row.Size || row.size || '').trim(),
                        avgWt: parseFloat(row.AvgWeight || row.avgWeight || row.avgWt || 0),
                        purity: parseFloat(row.Purity || row.purity || 100),
                        mcRate: parseFloat(row.MCRate || row.mcRate || 0),
                        mcType: String(row.MCType || row.mcType || 'MC/GM').trim(), // NEW
                        pcs: parseInt(row.PCS || row.pcs || 1), // NEW
                        boxCharges: parseFloat(row.BoxCharges || row.boxCharges || 0), // NEW
                        stoneCharges: parseFloat(row.StoneCharges || row.stoneCharges || 0), // NEW
                        metalType: String(row.MetalType || row.metalType || 'gold').toLowerCase().trim(),
                        isSold: false // NEW
                    }));
                    const tbody = document.getElementById('previewTableBody');
                    tbody.innerHTML = '';
                    bulkUploadData.slice(0, 5).forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                                <td class="px-2 py-2">${item.barcode}</td>
                                <td class="px-2 py-2">${item.shortName}</td>
                                <td class="px-2 py-2 capitalize">${item.metalType}</td>
                                <td class="px-2 py-2">${item.purity}%</td>
                                <td class="px-2 py-2">‚Çπ${item.mcRate}</td>
                            `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('uploadCount').textContent = bulkUploadData.length;
                    document.getElementById('uploadPreview').classList.remove('hidden');
                } catch (error) {
                    alert('Error reading Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmBulkUpload() {
            if (bulkUploadData.length === 0) return;
            const invalidItems = bulkUploadData.filter(item => !item.barcode || !item.shortName);
            if (invalidItems.length > 0) {
                alert(`Error: ${invalidItems.length} items missing Barcode or Name.`);
                return;
            }
            products.push(...bulkUploadData);
            localStorage.setItem('products', JSON.stringify(products));
            updateProductsTable();
            closeModals();
            alert(`Successfully uploaded ${bulkUploadData.length} products!`);
        }

        function downloadAllCustomers() {
            if (customers.length === 0) {
                alert('No customers to download!');
                return;
            }
            const data = customers.map(c => ({
                Name: c.name,
                Address1: c.address1 || '',
                Address2: c.address2 || '',
                City: c.city || '',
                Mobile: c.mobile
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Customers');
            XLSX.writeFile(wb, 'All_Customers_' + new Date().toISOString().split('T')[0] + '.xlsx');
            alert('Customers downloaded!');
        }

        function downloadSampleCustomerExcel() {
            const sampleData = [
                { Name: 'Rajesh Kumar', Address1: '123 Main Street', Address2: 'T Nagar', City: 'Chennai-600017', Mobile: '9876543210' },
                { Name: 'Priya Sharma', Address1: '456 MG Road', Address2: 'Anna Nagar', City: 'Chennai-600040', Mobile: '9123456789' },
                { Name: 'Vijay Reddy', Address1: '789 Gandhi Street', Address2: 'Adyar', City: 'Chennai-600020', Mobile: '9988776655' }
            ];
            const ws = XLSX.utils.json_to_sheet(sampleData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Sample Customers');
            XLSX.writeFile(wb, 'Sample_Customers_Format.xlsx');
            alert('Sample downloaded!');
        }

        function showBulkUploadCustomerModal() {
            document.getElementById('uploadCustomerPreview').classList.add('hidden');
            document.getElementById('excelCustomerFileInput').value = '';
            bulkUploadCustomerData = [];
            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('modalOverlay').classList.add('flex');
            document.getElementById('bulkUploadCustomerModal').classList.remove('hidden');
        }

        function handleCustomerExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    if (jsonData.length === 0) {
                        alert('Excel file is empty!');
                        return;
                    }
                    bulkUploadCustomerData = jsonData.map(row => ({
                        name: String(row.Name || row.name || '').trim(),
                        address1: String(row.Address1 || row.address1 || '').trim(),
                        address2: String(row.Address2 || row.address2 || '').trim(),
                        city: String(row.City || row.city || '').trim(),
                        mobile: String(row.Mobile || row.mobile || '').trim()
                    }));
                    const tbody = document.getElementById('previewCustomerTableBody');
                    tbody.innerHTML = '';
                    bulkUploadCustomerData.slice(0, 5).forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                                <td class="px-2 py-2">${item.name}</td>
                                <td class="px-2 py-2">${item.address1}, ${item.address2}</td>
                                <td class="px-2 py-2">${item.city}</td>
                                <td class="px-2 py-2">${item.mobile}</td>
                            `;
                        tbody.appendChild(row);
                    });
                    document.getElementById('uploadCustomerCount').textContent = bulkUploadCustomerData.length;
                    document.getElementById('uploadCustomerPreview').classList.remove('hidden');
                } catch (error) {
                    alert('Error reading Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function confirmBulkUploadCustomer() {
            if (bulkUploadCustomerData.length === 0) return;
            const invalidItems = bulkUploadCustomerData.filter(item => !item.name || !item.mobile);
            if (invalidItems.length > 0) {
                alert(`Error: ${invalidItems.length} customers missing Name or Mobile.`);
                return;
            }
            customers.push(...bulkUploadCustomerData);
            setCachedItem('customers', customers);
            updateCustomerDropdown();
            loadCustomersDisplay();
            closeModals();
            alert(`Successfully uploaded ${bulkUploadCustomerData.length} customers!`);
        }

    function handleBarcodeScan(barcode) {
        if (!barcode) return;
        barcode = String(barcode).trim();

        // Check if product is already sold
        const soldInfo = isProductSold(barcode);
        if (soldInfo) {
            alert(`‚ö†Ô∏è PRODUCT ALREADY SOLD!\n\nBarcode: ${barcode}\nBill No: ${soldInfo.billNo}\nSold Date: ${new Date(soldInfo.soldDate).toLocaleDateString('en-GB')}\n\nThis product cannot be added to quotation.`);

            const barcodeInput = document.getElementById('barcodeInput');
            barcodeInput.style.backgroundColor = '#f8d7da';
            barcodeInput.style.borderColor = '#dc3545';
            setTimeout(() => {
                barcodeInput.style.backgroundColor = '';
                barcodeInput.style.borderColor = '';
            }, 1000);
            return;
        }

        const product = products.find(p => String(p.barcode).trim().toLowerCase() === barcode.toLowerCase());

        if (product) {
            // Check if EXACT SAME BARCODE already exists in current bill
            const existingItemIndex = items.findIndex(item =>
                item.barcode && String(item.barcode).trim().toLowerCase() === barcode.toLowerCase()
            );

            if (existingItemIndex >= 0) {
                // Double scan detected - add to permanent highlight list
                if (!doubleScannedBarcodes.includes(barcode.toLowerCase())) {
                    doubleScannedBarcodes.push(barcode.toLowerCase());
                    localStorage.setItem('doubleScannedBarcodes', JSON.stringify(doubleScannedBarcodes));
                }
                
                // No alert - just highlight and scroll to existing item
                const tableBody = document.getElementById('productTableBody');
                if (tableBody) {
                    // Try to find by data-barcode attribute first (more reliable)
                    let existingRow = Array.from(tableBody.children).find(row => 
                        row.getAttribute('data-barcode') && 
                        row.getAttribute('data-barcode').toLowerCase() === barcode.toLowerCase()
                    );
                    
                    // Fallback to index if data-barcode not found
                    if (!existingRow && tableBody.children[existingItemIndex]) {
                        existingRow = tableBody.children[existingItemIndex];
                    }
                    
                    if (existingRow) {
                        // Permanent highlight for double-scanned items
                        existingRow.classList.add('double-scanned-permanent');
                        existingRow.style.backgroundColor = '#ffeb3b';
                        existingRow.style.transition = 'background-color 0.3s';
                        existingRow.style.boxShadow = '0 0 15px rgba(255, 235, 59, 0.8)';
                        
                        // Scroll to the row
                        existingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                document.getElementById('barcodeInput').value = '';
                document.getElementById('barcodeInput').focus();
                return;
            }
            
            // Store original floor and move product to estimation floor when scanned for quotation
            const originalFloor = product.floor || 'estimation floor';
            if (product.floor && product.floor !== 'estimation floor') {
                product.floor = 'estimation floor';
                const productIndex = products.findIndex(p => p.id === product.id);
                if (productIndex >= 0) {
                    products[productIndex] = product;
                    localStorage.setItem('products', JSON.stringify(products));
                }
            } else if (!product.floor) {
                product.floor = 'estimation floor';
                const productIndex = products.findIndex(p => p.id === product.id);
                if (productIndex >= 0) {
                    products[productIndex] = product;
                    localStorage.setItem('products', JSON.stringify(products));
                }
            }

            // Auto-populate form
            document.getElementById('itemSku').value = product.sku || '';
            document.getElementById('itemStyleCode').value = product.styleCode || '';
            document.getElementById('itemName').value = product.shortName;
            document.getElementById('itemSize').value = product.size || '';
            document.getElementById('itemWeight').value = product.avgWt || '';
            document.getElementById('itemPurity').value = product.purity;
            document.getElementById('itemMetalType').value = product.metalType;

            const metalRate = rates[product.metalType] || rates.silver;
            // Limit to 2 decimal places
            document.getElementById('itemRate').value = parseFloat(parseFloat(metalRate).toFixed(2));

            const originalMCRate = product.mcRate;
            // Fix rate calculation: mc - 3% (if rate is 152.5, then rate would be 147.92)
            const adjustedMCRate = getAdjustedMCRate(originalMCRate);
            // Limit to 2 decimal places
            document.getElementById('itemMcRate').value = parseFloat(parseFloat(adjustedMCRate).toFixed(2));
            document.getElementById('itemMcRate').setAttribute('data-original-mc', originalMCRate);
            document.getElementById('itemBoxCharges').value = '0';
            document.getElementById('itemStoneCharges').value = '0';

            updateItemAmount();

            // AUTO-ADD ITEM IMMEDIATELY
            const item = {
                barcode: barcode,
                sku: product.sku || '',
                styleCode: product.styleCode || '',
                name: product.shortName,
                size: product.size || '',
                weight: product.avgWt || 0,
                purity: product.purity,
                rate: parseFloat(parseFloat(metalRate).toFixed(2)),
                mcRate: parseFloat(parseFloat(adjustedMCRate).toFixed(2)),
                originalMcRate: originalMCRate,
                metalType: product.metalType,
                boxCharges: 0,
                stoneCharges: 0,
                originalFloor: originalFloor, // Store original floor for restoration
                id: Date.now()
            };

            if (product.mcType === 'PieceCost') {
    // For PieceCost: Amount = (Metal Rate √ó Weight) + PieceCost + Box + Stone
    item.amount = (item.rate * item.weight) + item.mcRate + (item.boxCharges || 0) + (item.stoneCharges || 0);
} else {
    // For MC/GM: Amount = (Rate + MC/GM) √ó Weight + Box + Stone
    item.amount = (item.rate + item.mcRate) * item.weight + (item.boxCharges || 0) + (item.stoneCharges || 0);
}

            items.push(item);
            updateItemsTable();
            updateSummary();
            clearItemForm();

            // Scroll to the newly added item
            setTimeout(() => {
                const tableBody = document.getElementById('productTableBody');
                if (tableBody) {
                    // Find the row by data-item-id for more reliability
                    const newRow = Array.from(tableBody.children).find(row => 
                        row.getAttribute('data-item-id') == item.id
                    ) || (tableBody.children.length > 0 ? tableBody.children[tableBody.children.length - 1] : null);
                    
                    if (newRow) {
                        newRow.style.backgroundColor = '#d4edda';
                        newRow.style.transition = 'background-color 0.3s';
                        newRow.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
                        newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Remove highlight after 2 seconds
                        setTimeout(() => {
                            newRow.style.backgroundColor = '';
                            newRow.style.boxShadow = '';
                        }, 2000);
                    }
                }
            }, 100);

            const barcodeInput = document.getElementById('barcodeInput');
            barcodeInput.style.backgroundColor = '#d4edda';
            barcodeInput.style.borderColor = '#28a745';
            setTimeout(() => {
                barcodeInput.style.backgroundColor = '';
                barcodeInput.style.borderColor = '';
                barcodeInput.focus();
            }, 300);
        } else {
            alert(`‚ö†Ô∏è Product Not Found!\n\nBarcode: ${barcode}\n\nThis product doesn't exist in your inventory.`);
            const barcodeInput = document.getElementById('barcodeInput');
            barcodeInput.style.backgroundColor = '#f8d7da';
            barcodeInput.style.borderColor = '#dc3545';
            setTimeout(() => {
                barcodeInput.style.backgroundColor = '';
                barcodeInput.style.borderColor = '';
            }, 500);
        }
    }

            function handleProductBarcodeScan(barcode) {
                    if (!barcode) return;

                    // Check if product already exists
                    const existingProduct = products.find(p => p.barcode === barcode);
                    if (existingProduct) {
                        alert(`Product already exists!\nBarcode: ${barcode}\nName: ${existingProduct.shortName}`);
                        // Optionally edit the existing product
                        if (confirm('Do you want to edit this product?')) {
                            const idx = products.findIndex(p => p.id === existingProduct.id);
                            editProduct(idx);
                        }
                        return;
                    }

                    // New barcode - open add product modal with barcode pre-filled
                    showAddProductModal();
                    document.getElementById('newBarcode').value = barcode;
                    document.getElementById('newBarcode').style.backgroundColor = '#d4edda';

                    // Success feedback
                    const scanner = document.getElementById('productBarcodeInput');
                    scanner.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        scanner.style.backgroundColor = '';
                        document.getElementById('newBarcode').style.backgroundColor = '';
                    }, 500);

                    // Focus on SKU field
                    setTimeout(() => {
                        document.getElementById('newSku').focus();
                    }, 100);
                }

    function updateItemAmount() {
        const weight = parseFloat(document.getElementById('itemWeight')?.value) || 0;
        const rate = parseFloat(document.getElementById('itemRate')?.value) || 0;
        const mcRate = parseFloat(document.getElementById('itemMcRate')?.value) || 0;
        const mcTypeEl = document.getElementById('itemMcType');
        const mcType = mcTypeEl ? mcTypeEl.value : 'MC/GM';
        const boxCharges = parseFloat(document.getElementById('itemBoxCharges')?.value) || 0;
        const stoneCharges = parseFloat(document.getElementById('itemStoneCharges')?.value) || 0;

        let total = 0;

        if (mcType === 'PieceCost') {
            // PieceCost: (Metal Rate √ó Weight) + Fixed MC + Box + Stone
            total = (rate * weight) + mcRate + boxCharges + stoneCharges;
        } else {
            // MC/GM: (Rate + MC/GM) √ó Weight + Box + Stone
            total = (rate + mcRate) * weight + boxCharges + stoneCharges;
        }

        const amountEl = document.getElementById('itemAmount');
        if (amountEl) {
            amountEl.textContent = `‚Çπ${total.toFixed(2)}`;
        }
    }

function updateMCTypeLabel() {
    const mcType = document.getElementById('itemMcType').value;
    const mcRateInput = document.getElementById('itemMcRate');
    if (mcType === 'PieceCost') {
        mcRateInput.placeholder = 'Fixed Cost';
    } else {
        mcRateInput.placeholder = 'MC Rate/gm';
    }
    updateItemAmount();
}

        // Handle SKU shortcuts (S, A, B)
        function handleSkuShortcut(event) {
            if (event.key === 'Enter') {
                const skuValue = event.target.value.trim().toUpperCase();
                if (skuValue === 'S') {
                    // Silver Rings - auto-fill all except weight and mc/gm
                    document.getElementById('itemSku').value = 'Silver Rings';
                    document.getElementById('itemName').value = 'Silver Ring';
                    document.getElementById('itemMetalType').value = 'silver';
                    document.getElementById('itemRate').value = parseFloat(rates.silver).toFixed(2);
                    document.getElementById('itemPurity').value = '100';
                    document.getElementById('itemStyleCode').value = '';
                    document.getElementById('itemSize').value = '';
                    document.getElementById('itemMcRate').value = '';
                    document.getElementById('itemWeight').value = '';
                    document.getElementById('itemWeight').focus();
                } else if (skuValue === 'A') {
                    // Silver Articles - auto-fill all except weight and mc/gm
                    document.getElementById('itemSku').value = 'Silver Articles';
                    document.getElementById('itemName').value = 'Silver Article';
                    document.getElementById('itemMetalType').value = 'silver';
                    document.getElementById('itemRate').value = parseFloat(rates.silver).toFixed(2);
                    document.getElementById('itemPurity').value = '100';
                    document.getElementById('itemStyleCode').value = '';
                    document.getElementById('itemSize').value = '';
                    document.getElementById('itemMcRate').value = '';
                    document.getElementById('itemWeight').value = '';
                    document.getElementById('itemWeight').focus();
                } else if (skuValue === 'B') {
                    // Bullion - auto-fill all except weight and mc/gm
                    document.getElementById('itemSku').value = 'Bullion';
                    document.getElementById('itemName').value = 'Bullion';
                    document.getElementById('itemMetalType').value = 'gold';
                    document.getElementById('itemRate').value = parseFloat(rates.gold).toFixed(2);
                    document.getElementById('itemPurity').value = '100';
                    document.getElementById('itemStyleCode').value = '';
                    document.getElementById('itemSize').value = '';
                    document.getElementById('itemMcRate').value = '';
                    document.getElementById('itemWeight').value = '';
                    document.getElementById('itemWeight').focus();
                }
            }
        }

        function addItem() {
                const item = {
                    sku: document.getElementById('itemSku').value,
                    styleCode: document.getElementById('itemStyleCode').value,
                    name: document.getElementById('itemName').value,
                    size: document.getElementById('itemSize').value,
                    weight: parseFloat(document.getElementById('itemWeight').value) || 0,
                    purity: parseFloat(document.getElementById('itemPurity').value) || 100,
                    rate: parseFloat(document.getElementById('itemRate').value) || 0,
                    mcRate: parseFloat(document.getElementById('itemMcRate').value) || 0,
                    boxCharges: parseFloat(document.getElementById('itemBoxCharges').value) || 0,
                    stoneCharges: parseFloat(document.getElementById('itemStoneCharges').value) || 0,
                    originalMcRate: parseFloat(document.getElementById('itemMcRate').getAttribute('data-original-mc')) || parseFloat(document.getElementById('itemMcRate').value) || 0,
                    metalType: document.getElementById('itemMetalType').value,
                    barcode: null // Manual entries don't have barcodes
                };

                if (!item.name || !item.weight) {
                    alert('Please fill item name and weight');
                    return;
                }

                // Apply 3% discount to MC rate if needed
                if (item.originalMcRate && item.originalMcRate !== item.mcRate) {
                    item.mcRate = parseFloat(item.originalMcRate * 0.97).toFixed(2);
                }

                item.amount = (parseFloat(item.rate) + parseFloat(item.mcRate)) * item.weight + item.boxCharges + item.stoneCharges;
                item.id = Date.now();

                items.push(item);
                updateItemsTable();
                updateSummary();
                clearItemForm();
            }

// ========== TABLE-BASED PRODUCT DISPLAY (Excel-like) ==========

    function updateItemsTable() {
        const table = document.getElementById('productsTable');
        const tbody = document.getElementById('productTableBody');
        const emptyState = document.getElementById('emptyProductsState');
        const itemCountSpan = document.getElementById('itemCount');
        const totalItemsSpan = document.getElementById('totalItems');

        if (!tbody) return;

        tbody.innerHTML = '';

        if (items.length === 0) {
            table.classList.add('hidden');
            emptyState.classList.remove('hidden');
            itemCountSpan.textContent = '0 Items';
            if (totalItemsSpan) totalItemsSpan.textContent = '0';
            return;
        }

        table.classList.remove('hidden');
        emptyState.classList.add('hidden');
        itemCountSpan.textContent = `${items.length} Item${items.length > 1 ? 's' : ''}`;
        if (totalItemsSpan) totalItemsSpan.textContent = items.length;

        items.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-blue-50 transition-colors';
            row.setAttribute('data-item-id', item.id);
            if (item.barcode) {
                row.setAttribute('data-barcode', item.barcode);
                // Apply permanent highlight if double-scanned
                if (doubleScannedBarcodes.includes(String(item.barcode).toLowerCase())) {
                    row.classList.add('double-scanned-permanent');
                    row.style.backgroundColor = '#ffeb3b';
                    row.style.boxShadow = '0 0 15px rgba(255, 235, 59, 0.8)';
                }
            }

            const metalColors = {
                'gold': 'bg-yellow-100 text-yellow-800',
                'silver': 'bg-gray-200 text-gray-800',
                'platinum': 'bg-purple-100 text-purple-800'
            };

            const metalColor = metalColors[item.metalType] || 'bg-blue-100 text-blue-800';
            const boxCharges = item.boxCharges || 0;
            const stoneCharges = item.stoneCharges || 0;

            row.innerHTML = `
            <td class="px-2 py-3 text-center font-bold text-gray-700 border-r bg-gray-50">${index + 1}</td>
            <td class="px-2 py-3 text-center font-mono text-xs border-r">${item.barcode || '-'}</td>
            <td class="px-3 py-3 text-left font-semibold text-gray-800 border-r">
                ${item.name}
            </td>
            <td class="px-2 py-3 text-center text-xs border-r">${item.sku || '-'}</td>
            <td class="px-2 py-3 text-center text-xs border-r">${item.styleCode || '-'}</td>
            <td class="px-2 py-3 text-center border-r">
                <span class="px-2 py-1 rounded text-xs font-bold ${metalColor}">
                    ${item.metalType.toUpperCase()}
                </span>
            </td>
            <td class="px-2 py-3 text-center text-xs border-r">${item.size || '-'}</td>
            <td class="px-2 py-3 border-r bg-blue-50">
                <input type="number" step="0.01" value="${item.weight}" 
                    onchange="editItemWeight(${item.id}, this.value)"
                    class="w-20 px-2 py-1 text-center font-bold text-gray-800 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500 bg-white">
            </td>
            <td class="px-2 py-3 text-center font-semibold border-r">${item.purity}%</td>
            <td class="px-2 py-3 text-right font-semibold border-r bg-yellow-50">
                <input type="number" step="0.01" value="${parseFloat(item.rate).toFixed(2)}" 
                    onchange="editItemRate(${item.id}, this.value)"
                    class="w-20 px-2 py-1 text-center font-bold text-gray-800 border border-yellow-300 rounded focus:ring-2 focus:ring-yellow-500 bg-white">
            </td>
            <td class="px-2 py-3 border-r bg-orange-50">
                <input type="number" step="0.01" value="${parseFloat(item.mcRate).toFixed(2)}" 
                    onchange="editItemMCRate(${item.id}, this.value)"
                    class="w-20 px-2 py-1 text-center font-bold text-gray-800 border border-orange-300 rounded focus:ring-2 focus:ring-orange-500 bg-white">
            </td>
            <td class="px-2 py-3 text-right border-r bg-purple-50">‚Çπ${boxCharges.toFixed(2)}</td>
            <td class="px-2 py-3 text-right border-r bg-pink-50">‚Çπ${stoneCharges.toFixed(2)}</td>
            <td class="px-2 py-3 text-right font-bold text-green-700 border-r bg-green-50">‚Çπ${item.amount.toFixed(2)}</td>
            <td class="px-2 py-3 text-center">
                <button onclick="removeItem(${item.id})" 
                    class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded transition-all hover:scale-110"
                    title="Delete">
                    ‚úï
                </button>
            </td>
        `;

            tbody.appendChild(row);
        });
    }

    function editItemWeight(itemId, newWeight) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            item.weight = parseFloat(newWeight) || 0;

            // Recalculate amount including box and stone charges
            const boxCharges = item.boxCharges || 0;
            const stoneCharges = item.stoneCharges || 0;
            item.amount = (item.rate + item.mcRate) * item.weight + boxCharges + stoneCharges;

            updateItemsTable();
            updateSummary();
        }

        function editItemRate(itemId, newRate) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            // Limit to 2 decimal places
            item.rate = parseFloat(parseFloat(newRate).toFixed(2)) || 0;

            // Recalculate amount including box and stone charges
            const boxCharges = item.boxCharges || 0;
            const stoneCharges = item.stoneCharges || 0;
            item.amount = (parseFloat(item.rate) + parseFloat(item.mcRate)) * item.weight + boxCharges + stoneCharges;

            updateItemsTable();
            updateSummary();
        }

        function editItemMCRate(itemId, newMCRate) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            // Fix rate calculation: mc - 3% (if rate is 152.5, then rate would be 147.92)
            const originalMCRate = parseFloat(newMCRate) || 0;
            const adjustedMCRate = originalMCRate * 0.97; // Apply 3% discount
            // Limit to 2 decimal places
            item.mcRate = parseFloat(parseFloat(adjustedMCRate).toFixed(2));
            item.originalMcRate = originalMCRate; // Store original

            // Recalculate amount including box and stone charges
            const boxCharges = item.boxCharges || 0;
            const stoneCharges = item.stoneCharges || 0;
            item.amount = (parseFloat(item.rate) + parseFloat(item.mcRate)) * item.weight + boxCharges + stoneCharges;

            updateItemsTable();
            updateSummary();
        }

                function removeItem(id) {
                    items = items.filter(item => item.id !== id);
                    updateItemsTable();
                    updateSummary();
                }

                function clearItemForm() {
                        document.getElementById('itemSku').value = '';
                        document.getElementById('itemStyleCode').value = '';
                        document.getElementById('itemName').value = '';
                        document.getElementById('itemSize').value = '';
                        document.getElementById('itemWeight').value = '';
                        document.getElementById('itemPurity').value = '100';
                        document.getElementById('itemRate').value = '';
                        document.getElementById('itemMcRate').value = '';
                        document.getElementById('itemMcRate').removeAttribute('data-original-mc');
                        document.getElementById('itemBoxCharges').value = '';
                        document.getElementById('itemStoneCharges').value = '';
                        document.getElementById('itemMetalType').value = '';
                        document.getElementById('itemAmount').textContent = '‚Çπ0.00';

                        // Return focus to barcode scanner
                        setTimeout(() => {
                            const barcodeInput = document.getElementById('barcodeInput');
                            if (barcodeInput) {
                                barcodeInput.focus();
                            }
                        }, 100);
                    }

                function updateSummary() {
                    const total = items.reduce((sum, item) => sum + item.amount, 0);
                    const gst = total * 0.03;
                    const netTotal = total + gst;
                    const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
                    document.getElementById('summaryTotal').textContent = `‚Çπ${total.toFixed(2)}`;
                    document.getElementById('summaryGst').textContent = `‚Çπ${gst.toFixed(2)}`;
                    document.getElementById('summaryNetTotal').textContent = `‚Çπ${netTotal.toFixed(2)}`;
                    document.getElementById('summaryTotalWeight').textContent = `${totalWeight.toFixed(2)}g`; 
                }
            
                function generateQuote() {
    if (items.length === 0) {
        alert('Please add items first');
        return;
    }
    if (!currentCustomer) {
        alert('Please select a customer first');
        return;
    }
    // Show format selection modal with payment option
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('modalOverlay').classList.add('flex');
    document.getElementById('quotationFormatModal').classList.remove('hidden');
}

    async function generateQuotePDFWithPayment() {
        // Verify modal elements exist
        if (!document.getElementById('paymentCash') && !document.getElementById('paymentCredit')) {
            alert('‚ö†Ô∏è Payment option modal not properly loaded. Please try again.');
            return;
        }
            const paymentOptionElement = document.querySelector('input[name="paymentOption"]:checked');

            // SAFETY CHECK
            if (!paymentOptionElement) {
                alert('‚ö†Ô∏è Please select a payment option (Cash or Credit)');
                return;
            }

            const paymentOption = paymentOptionElement.value;
    
    const isCashReceived = paymentOption === 'cash';
    
    // Calculate totals
    const total = items.reduce((sum, item) => sum + item.amount, 0);
    const gst = total * 0.03;
    const netTotal = total + gst;
    const discount = window.cashReceiveDiscount || 0;
    const advance = window.cashReceiveAdvance || 0;
    const finalAmount = netTotal - discount + advance;
    const quotationNo = `Q${String(quotationCounter).padStart(4, '0')}`;

    // SAVE QUOTATION TO HISTORY
    const quotationRecord = {
        id: Date.now(),
        quotationNo: quotationNo,
        date: new Date().toISOString(),
        customer: {
            name: currentCustomer.name,
            address1: currentCustomer.address1,
            address2: currentCustomer.address2,
            city: currentCustomer.city,
            mobile: currentCustomer.mobile
        },
        items: items.map(item => ({
    ...item,
    barcode: item.barcode || null
})),
        total: total,
        gst: gst,
        netTotal: netTotal,
        discount: discount,
        advance: advance,
        finalAmount: finalAmount,
        rateSlab: currentRateSlab,
        isBilled: false,
        paymentReceived: isCashReceived,
        paymentDate: isCashReceived ? new Date().toISOString() : null
    };

    savedQuotations.unshift(quotationRecord);
    setCachedItem('savedQuotations', savedQuotations);

    // Save quotation to API
    try {
        const customerId = currentCustomer && currentCustomer.id ? currentCustomer.id : null;
        const savedQuotation = await api.createQuotation({
            quotationNo: quotationNo,
            customerId: customerId,
            customerName: currentCustomer.name,
            customerMobile: currentCustomer.mobile,
            items: items.map(item => ({
                ...item,
                barcode: item.barcode || null
            })),
            total: total,
            gst: gst,
            netTotal: netTotal,
            discount: discount,
            advance: advance,
            finalAmount: finalAmount,
            paymentStatus: isCashReceived ? 'paid' : 'pending',
            remarks: ''
        });
        // Store database ID in quotation record
        if (savedQuotation && savedQuotation.id) {
            quotationRecord.dbId = savedQuotation.id;
        }
    } catch (error) {
        console.error('Failed to save quotation to API:', error);
    }

    // ‚≠ê IF CASH RECEIVED - RECORD IN LEDGER IMMEDIATELY
    if (isCashReceived) {
        await recordLedgerTransaction(transactionTypes.CASH_IN, {
            quotationNo: quotationNo,
            customerName: currentCustomer.name,
            customerMobile: currentCustomer.mobile,
            amount: finalAmount,
            description: `Cash received for Quotation ${quotationNo} - ${currentCustomer.name}${discount > 0 ? ` (Discount: ‚Çπ${discount.toFixed(2)})` : ''}${advance > 0 ? ` (Advance: ‚Çπ${advance.toFixed(2)})` : ''}`,
            category: 'Sales Revenue',
            paymentMethod: 'Cash',
            reference: quotationNo
        });
        
        // Update cash balance
        accountBalances.cash += finalAmount;
        setCachedItem('accountBalances', accountBalances);
    }

    // Generate PDF (same as before)
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
    const totalMC = items.reduce((sum, item) => sum + (item.weight * item.mcRate), 0);
    const totalPCS = items.length;
    const date = new Date().toLocaleDateString('en-GB');

    // Customer info
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('To:', 15, 15);

    doc.setFont(undefined, 'bold');
    doc.setFontSize(10);
    doc.text(currentCustomer.name.toUpperCase(), 15, 20);

    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    let yPos = 24;
    if (currentCustomer.address1) {
        doc.text(currentCustomer.address1, 15, yPos);
        yPos += 4;
    }
    if (currentCustomer.address2) {
        doc.text(currentCustomer.address2, 15, yPos);
        yPos += 4;
    }
    if (currentCustomer.city) {
        doc.text(currentCustomer.city, 15, yPos);
        yPos += 4;
    }
    doc.text(`Mob: ${currentCustomer.mobile}`, 15, yPos);

    // Quotation info
    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text('EST. No:', 160, 15);
    doc.setFont(undefined, 'normal');
    doc.text(quotationNo, 180, 15);

    doc.setFont(undefined, 'bold');
    doc.text('Date:', 160, 20);
    doc.setFont(undefined, 'normal');
    doc.text(date, 180, 20);
    
    // Payment status indicator
    if (isCashReceived) {
        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 128, 0);
        doc.text('PAID', 160, 25);
        doc.setTextColor(0, 0, 0);
    }

    // Items table
    const tableStartY = yPos + 8;

    const tableData = items.map((item, idx) => {
        const itemTotal = (item.rate + item.mcRate) * item.weight;

        return [
            idx + 1,
            item.sku || '-',
            item.styleCode || '-',
            item.name,
            item.size || '-',
            item.weight.toFixed(2),
            item.weight.toFixed(2),
            item.purity.toFixed(1),
            item.weight.toFixed(2),
            '1',
            item.mcRate.toFixed(2),
            item.rate.toFixed(2),
            itemTotal.toFixed(2)
        ];
    });

    doc.autoTable({
        startY: tableStartY,
        head: [[
            '#',
            'SKU',
            'STYLE CODE',
            'Short Name',
            'SIZE',
            'NET.WT',
            'AVG.WT',
            '% Pure',
            'G.WT',
            'PCS',
            'MC/gm',
            'RATE',
            'Amount'
        ]],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [211, 211, 211],
            textColor: 0,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            valign: 'middle',
            cellPadding: 1.5
        },
        bodyStyles: {
            fontSize: 7,
            cellPadding: 1,
            valign: 'middle'
        },
        columnStyles: {
            0: { cellWidth: 8, halign: 'center' },
            1: { cellWidth: 20, halign: 'left', fontSize: 6.5 },
            2: { cellWidth: 16, halign: 'center', fontSize: 6.5 },
            3: { cellWidth: 38, halign: 'left' },
            4: { cellWidth: 12, halign: 'center' },
            5: { cellWidth: 13, halign: 'right' },
            6: { cellWidth: 13, halign: 'right' },
            7: { cellWidth: 11, halign: 'center' },
            8: { cellWidth: 11, halign: 'right' },
            9: { cellWidth: 9, halign: 'center' },
            10: { cellWidth: 12, halign: 'right' },
            11: { cellWidth: 12, halign: 'right' },
            12: { cellWidth: 16, halign: 'right' }
        },
        margin: { left: 15, right: 14 }
    });

    // Grand total section
    const finalY = doc.lastAutoTable.finalY + 8;

    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.rect(15, finalY, 180, 25);
    doc.line(105, finalY, 105, finalY + 25);

    // Left side
    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text('COUNT:', 18, finalY + 6);
    doc.setFont(undefined, 'normal');
    doc.text(totalPCS.toString(), 45, finalY + 6);

    doc.setFont(undefined, 'bold');
    doc.text('Total Weight:', 18, finalY + 12);
    doc.setFont(undefined, 'normal');
    doc.text(`${totalWeight.toFixed(2)} gm`, 45, finalY + 12);

    doc.setFont(undefined, 'bold');
    doc.text('MC:', 18, finalY + 18);
    doc.setFont(undefined, 'normal');
    doc.text(totalMC.toFixed(2), 45, finalY + 18);

    // Right side
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('GRAND TOTAL', 110, finalY + 5);

    doc.setFontSize(8);
    doc.text('TOTAL:', 110, finalY + 11);
    doc.setFont(undefined, 'normal');
    doc.text(total.toFixed(2), 190, finalY + 11, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('GST:', 110, finalY + 16);
    doc.setFont(undefined, 'normal');
    doc.text(gst.toFixed(2), 190, finalY + 16, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('NET TOTAL:', 110, finalY + 21);
    doc.setFont(undefined, 'normal');
    doc.text(netTotal.toFixed(2), 190, finalY + 21, { align: 'right' });
    
    // Add discount and advance if applicable
    let yOffset = 26;
    if (discount > 0) {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(220, 53, 69);
        doc.text('DISCOUNT:', 110, finalY + yOffset);
        doc.setFont(undefined, 'normal');
        doc.text(`-${discount.toFixed(2)}`, 190, finalY + yOffset, { align: 'right' });
        doc.setTextColor(0, 0, 0);
        yOffset += 5;
    }
    
    if (advance > 0) {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 123, 255);
        doc.text('ADVANCE:', 110, finalY + yOffset);
        doc.setFont(undefined, 'normal');
        doc.text(`+${advance.toFixed(2)}`, 190, finalY + yOffset, { align: 'right' });
        doc.setTextColor(0, 0, 0);
        yOffset += 5;
    }
    
    if (discount > 0 || advance > 0) {
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 128, 0);
        doc.text('FINAL AMOUNT:', 110, finalY + yOffset);
        doc.setFont(undefined, 'bold');
        doc.text(finalAmount.toFixed(2), 190, finalY + yOffset, { align: 'right' });
        doc.setTextColor(0, 0, 0);
    }

    doc.save(`Quotation_${quotationNo}_${date.replace(/\//g, '-')}.pdf`);

    // Update quotation number for next quotation
    const nextQuotationNumber = getNextQuotationNumber();
    document.getElementById('quotationNo').textContent = `Quotation No: Q${String(nextQuotationNumber).padStart(4, '0')}`;

    closeModals();
    
    if (isCashReceived) {
        alert(`‚úÖ Quotation Generated & Cash Recorded!\n\nQuotation: ${quotationNo}\nAmount: ‚Çπ${netTotal.toFixed(2)}\n\nüíµ Cash payment recorded in Accounts Ledger`);
    } else {
        alert(`‚úÖ Quotation Generated!\n\nQuotation: ${quotationNo}\nAmount: ‚Çπ${netTotal.toFixed(2)}\n\nüìã Payment pending - Customer can pay later`);
    }

    // Update dashboard if on ledger tab
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        updateLedgerDashboard();
    }

    clearAll();
}
    
               function clearAll() {
                    if (items.length === 0 || confirm('Clear all items from bill?')) {
                        items = [];
                        updateItemsTable();
                        updateSummary();
                        clearItemForm();
                        document.getElementById('rateSlab').value = 'R';
                        currentRateSlab = 'R';
                        updateRateSlabInfo();
                        document.getElementById('barcodeInput').focus();
                    }
                }

          function viewSoldProductsReport() {
                if (soldProducts.length === 0) {
                    alert('No products have been sold yet.');
                    return;
                }

                const wb = XLSX.utils.book_new();

                const data = soldProducts.map(sp => {
                    const bill = savedBills.find(b => b.billNo === sp.billNo);
                    return {
                        'Barcode': sp.barcode,
                        'Bill No': sp.billNo,
                        'Sold Date': new Date(sp.soldDate).toLocaleDateString('en-GB'),
                        'Customer': bill ? bill.customer.name : 'N/A'
                    };
                });

                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Sold Products');
                XLSX.writeFile(wb, `Sold_Products_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert(`Sold Products Report downloaded!\nTotal: ${soldProducts.length} products`);
            }

    function showCashReceiveModal() {
        if (items.length === 0) {
            alert('Please add items first');
            return;
        }
        if (!currentCustomer) {
            alert('Please select a customer first');
            return;
        }

        const total = items.reduce((sum, item) => sum + item.amount, 0);
        const gst = total * 0.03;
        const netTotal = total + gst;

        const modal = document.createElement('div');
        modal.id = 'cashReceiveModal';
        modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
        modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üíµ Cash Receive - Quotation</h3>
            
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-5 rounded-xl border-2 border-green-200 mb-4">
                <p class="font-bold text-gray-800">${currentCustomer.name}</p>
                <p class="text-sm text-gray-600 mt-1">üì± ${currentCustomer.mobile}</p>
                <div class="mt-3 pt-3 border-t border-green-300">
                    <div class="flex justify-between mb-2">
                        <span class="text-sm">Subtotal:</span>
                        <span class="font-semibold">‚Çπ${total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-sm">GST (3%):</span>
                        <span class="font-semibold">‚Çπ${gst.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold text-green-700 border-t pt-2">
                        <span>Net Total:</span>
                        <span>‚Çπ${netTotal.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Amount Received (‚Çπ) *</label>
                    <input type="number" step="0.01" id="cashReceivedAmount" 
                        value="${netTotal.toFixed(2)}"
                        class="w-full px-3 py-2 border-2 border-green-300 rounded-lg text-lg font-bold"
                        oninput="updateCashReceiveTotals()">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Discount (‚Çπ)</label>
                    <input type="number" step="0.01" id="cashReceiveDiscount" 
                        value="0.00"
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg"
                        oninput="updateCashReceiveTotals()">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Advance Payment (‚Çπ)</label>
                    <input type="number" step="0.01" id="cashReceiveAdvance" 
                        value="0.00"
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg"
                        oninput="updateCashReceiveTotals()">
                </div>
                
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Net Total:</span>
                        <span class="font-semibold">‚Çπ${netTotal.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-sm mb-1" id="discountRow">
                        <span>Discount:</span>
                        <span class="font-semibold text-red-600" id="discountAmount">‚Çπ0.00</span>
                    </div>
                    <div class="flex justify-between text-sm mb-1" id="advanceRow">
                        <span>Advance:</span>
                        <span class="font-semibold text-blue-600" id="advanceAmount">‚Çπ0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-bold border-t border-blue-300 pt-2 mt-2">
                        <span>Amount to Receive:</span>
                        <span class="text-green-700" id="finalAmountToReceive">‚Çπ${netTotal.toFixed(2)}</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Method</label>
                    <select id="cashReceiveMethod" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Reference/Receipt No</label>
                    <input type="text" id="cashReceiveReference" 
                        placeholder="Optional"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="processCashReceive()" 
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold">
                        ‚úÖ Receive Cash & Generate Quote
                    </button>
                    <button onclick="closeCashReceiveModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

        document.body.appendChild(modal);
        
        // Initialize totals display
        updateCashReceiveTotals();
    }

    function updateCashReceiveTotals() {
        const netTotal = items.reduce((sum, item) => sum + item.amount, 0) * 1.03;
        const discount = parseFloat(document.getElementById('cashReceiveDiscount')?.value || 0);
        const advance = parseFloat(document.getElementById('cashReceiveAdvance')?.value || 0);
        
        const discountEl = document.getElementById('discountAmount');
        const advanceEl = document.getElementById('advanceAmount');
        const finalAmountEl = document.getElementById('finalAmountToReceive');
        const discountRow = document.getElementById('discountRow');
        const advanceRow = document.getElementById('advanceRow');
        
        if (discountEl) {
            discountEl.textContent = `‚Çπ${discount.toFixed(2)}`;
            if (discountRow) {
                discountRow.style.display = discount > 0 ? 'flex' : 'none';
            }
        }
        
        if (advanceEl) {
            advanceEl.textContent = `‚Çπ${advance.toFixed(2)}`;
            if (advanceRow) {
                advanceRow.style.display = advance > 0 ? 'flex' : 'none';
            }
        }
        
        if (finalAmountEl) {
            const finalAmount = netTotal - discount + advance;
            finalAmountEl.textContent = `‚Çπ${Math.max(0, finalAmount).toFixed(2)}`;
        }
        
        // Update amount received field to match final amount
        const amountReceivedEl = document.getElementById('cashReceivedAmount');
        if (amountReceivedEl) {
            const finalAmount = netTotal - discount + advance;
            amountReceivedEl.value = Math.max(0, finalAmount).toFixed(2);
        }
    }

    function closeCashReceiveModal() {
        const modal = document.getElementById('cashReceiveModal');
        if (modal) {
            modal.remove();
        }
    }

    function processCashReceive() {
        const amountReceived = parseFloat(document.getElementById('cashReceivedAmount').value);
        const method = document.getElementById('cashReceiveMethod').value;
        const reference = document.getElementById('cashReceiveReference').value.trim();
        const discount = parseFloat(document.getElementById('cashReceiveDiscount')?.value || 0);
        const advance = parseFloat(document.getElementById('cashReceiveAdvance')?.value || 0);

        if (!amountReceived || amountReceived <= 0) {
            alert('Please enter a valid amount');
            return;
        }

        // Store discount and advance in global scope for quotation generation
        window.cashReceiveDiscount = discount;
        window.cashReceiveAdvance = advance;

        // Close modal first
        closeCashReceiveModal();

        // Set payment received flag
        const paymentRadio = document.getElementById('paymentCash');
        if (paymentRadio) {
            paymentRadio.checked = true;
        }

        // Generate quotation with payment info
        generateQuotePDFWithPayment();
    }

                // ========== ROL MANAGEMENT FUNCTIONS (Style-Code Based) ==========

                    function initializeROL() {
                            // Populate style code datalist
                            const styleCodeList = document.getElementById('rolStyleCodeList');
                            if (styleCodeList) {
                                styleCodeList.innerHTML = '';
                                const uniqueStyleCodes = [...new Set(products.map(p => p.styleCode).filter(s => s && s.trim() !== ''))];
                                uniqueStyleCodes.sort().forEach(styleCode => {
                                    const option = document.createElement('option');
                                    option.value = styleCode;
                                    styleCodeList.appendChild(option);
                                });
                            }
                        }

                    function loadROLForStyleCode() {
                        const styleCodeInput = getCachedElement('rolSelectedStyleCode');
                        if (!styleCodeInput) return;
                        
                        const selectedStyleCode = styleCodeInput.value.trim();
                        if (!selectedStyleCode) {
                            clearROLSelection();
                            return;
                        }

                        currentSelectedROLStyleCode = selectedStyleCode;
                        const rolStyleData = rolData[selectedStyleCode] || { items: [] };

                        // Calculate totals for wholesale (weight in gms) and retail (pieces)
                        let totalWholesaleROL = 0;
                        let totalWholesaleAvailable = 0;
                        let totalRetailROL = 0;
                        let totalRetailAvailable = 0;

                        rolStyleData.items.forEach(item => {
                            totalWholesaleROL += parseFloat(item.rolWholesale || 0);
                            totalWholesaleAvailable += parseFloat(item.availableWholesale || 0);
                            totalRetailROL += parseFloat(item.rolRetail || 0);
                            totalRetailAvailable += parseFloat(item.availableRetail || 0);
                        });

                        const wholesaleRequired = Math.max(0, totalWholesaleROL - totalWholesaleAvailable);
                        const retailRequired = Math.max(0, totalRetailROL - totalRetailAvailable);

                        // Update counters display
                        getCachedElement('rolWholesaleSet').textContent = totalWholesaleROL.toFixed(2);
                        getCachedElement('rolWholesaleAvailable').textContent = totalWholesaleAvailable.toFixed(2);
                        getCachedElement('rolWholesaleRequired').textContent = wholesaleRequired.toFixed(2);
                        getCachedElement('rolWholesaleStatus').textContent = wholesaleRequired > 0 ? 'REORDER' : 'OK';
                        getCachedElement('rolWholesaleStatus').className = wholesaleRequired > 0 ? 'text-2xl font-bold text-yellow-300' : 'text-2xl font-bold';

                        getCachedElement('rolRetailSet').textContent = totalRetailROL;
                        getCachedElement('rolRetailAvailable').textContent = totalRetailAvailable;
                        getCachedElement('rolRetailRequired').textContent = retailRequired;
                        getCachedElement('rolRetailStatus').textContent = retailRequired > 0 ? 'REORDER' : 'OK';
                        getCachedElement('rolRetailStatus').className = retailRequired > 0 ? 'text-2xl font-bold text-yellow-300' : 'text-2xl font-bold';

                        // Show counters and items section, hide empty state
                        getCachedElement('rolCountersSection').classList.remove('hidden');
                        getCachedElement('rolItemsSection').classList.remove('hidden');
                        getCachedElement('rolEmptyState').classList.add('hidden');

                        // Update items table
                        const tbody = getCachedElement('rolItemsTableBody');
                        tbody.innerHTML = '';

                        if (rolStyleData.items.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No ROL items found for this style code. Upload ROL data to get started.</td></tr>';
                            return;
                        }

                        rolStyleData.items.forEach(item => {
                            const wholesaleRequired = Math.max(0, (parseFloat(item.rolWholesale || 0) - parseFloat(item.availableWholesale || 0)));
                            const retailRequired = Math.max(0, (parseFloat(item.rolRetail || 0) - parseFloat(item.availableRetail || 0)));
                            const needsReorder = wholesaleRequired > 0 || retailRequired > 0;

                            const row = document.createElement('tr');
                            row.className = needsReorder ? 'border-b hover:bg-red-50 bg-red-50' : 'border-b hover:bg-green-50';
                            
                            const statusBadge = needsReorder
                                ? '<span class="px-2 py-1 bg-red-600 text-white text-xs rounded-full font-bold">REORDER</span>'
                                : '<span class="px-2 py-1 bg-green-600 text-white text-xs rounded-full font-bold">OK</span>';

                            row.innerHTML = `
                                <td class="px-4 py-3 border font-medium">${item.design || '-'}</td>
                                <td class="px-4 py-3 border">${item.sku || '-'}</td>
                                <td class="px-4 py-3 border text-center">${item.size || '-'}</td>
                                <td class="px-4 py-3 border text-center bg-orange-50 font-bold">${parseFloat(item.rolWholesale || 0).toFixed(2)}</td>
                                <td class="px-4 py-3 border text-center bg-orange-50 ${wholesaleRequired > 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(item.availableWholesale || 0).toFixed(2)}</td>
                                <td class="px-4 py-3 border text-center bg-green-50 font-bold">${parseFloat(item.rolRetail || 0)}</td>
                                <td class="px-4 py-3 border text-center bg-green-50 ${retailRequired > 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(item.availableRetail || 0)}</td>
                                <td class="px-4 py-3 border text-center">${statusBadge}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    }

                    function clearROLSelection() {
                        currentSelectedROLStyleCode = null;
                        getCachedElement('rolSelectedStyleCode').value = '';
                        getCachedElement('rolCountersSection').classList.add('hidden');
                        getCachedElement('rolItemsSection').classList.add('hidden');
                        getCachedElement('rolEmptyState').classList.remove('hidden');
                    }

                    // Old updateROLDisplay removed - now using loadROLForStyleCode() for style-code based display

                    function downloadROLSample() {
                        const sampleData = [
                            { StyleCode: 'EMERALD IDOL', Design: 'Silver Ganesh Idol', SKU: 'GAN001', Size: 'Small', 'ROL Wholesale (gms)': 500, 'ROL Retail (pcs)': 20 },
                            { StyleCode: 'EMERALD IDOL', Design: 'Silver Lakshmi Idol', SKU: 'LAK001', Size: 'Medium', 'ROL Wholesale (gms)': 750, 'ROL Retail (pcs)': 15 },
                            { StyleCode: 'SOLID IDOL 2D', Design: 'Gold Krishna Idol 2D', SKU: 'KRI001', Size: 'Large', 'ROL Wholesale (gms)': 1000, 'ROL Retail (pcs)': 10 },
                            { StyleCode: 'SOLID IDOL 3D', Design: 'Silver Saraswati 3D', SKU: 'SAR001', Size: 'Small', 'ROL Wholesale (gms)': 600, 'ROL Retail (pcs)': 25 }
                        ];

                        const ws = XLSX.utils.json_to_sheet(sampleData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'ROL Sample');
                        XLSX.writeFile(wb, 'ROL_Sample_Format.xlsx');
                        showDialog('Sample Downloaded', 'ROL sample file downloaded successfully!', 'success');
                    }

                    function showROLUploadModal() {
                        document.getElementById('rolUploadPreview').classList.add('hidden');
                        document.getElementById('rolExcelFileInput').value = '';
                        bulkUploadROLData = [];
                        document.getElementById('modalOverlay').classList.remove('hidden');
                        document.getElementById('modalOverlay').classList.add('flex');
                        document.getElementById('rolUploadModal').classList.remove('hidden');
                    }

                    function handleROLExcelUpload(event) {
                            const file = event.target.files[0];
                            if (!file) return;

                            const reader = new FileReader();
                            reader.onload = function (e) {
                                try {
                                    const data = new Uint8Array(e.target.result);
                                    const workbook = XLSX.read(data, { type: 'array' });
                                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                                    if (jsonData.length === 0) {
                                        showDialog('Error', 'Excel file is empty!', 'error');
                                        return;
                                    }

                                    // Group by style code
                                    const groupedByStyleCode = {};
                                    jsonData.forEach(row => {
                                        const styleCode = String(row.StyleCode || row.styleCode || '').trim().toUpperCase();
                                        if (!styleCode) {
                                            showDialog('Error', 'Some rows are missing Style Code. Please check your file.', 'error');
                                            return;
                                        }

                                        if (!groupedByStyleCode[styleCode]) {
                                            groupedByStyleCode[styleCode] = { items: [] };
                                        }

                                        groupedByStyleCode[styleCode].items.push({
                                            design: String(row.Design || row.design || row.ProductName || row.productName || '').trim(),
                                            sku: String(row.SKU || row.sku || '').trim(),
                                            size: String(row.Size || row.size || '').trim(),
                                            rolWholesale: parseFloat(row['ROL Wholesale (gms)'] || row['ROL Wholesale'] || row.rolWholesale || 0),
                                            rolRetail: parseFloat(row['ROL Retail (pcs)'] || row['ROL Retail'] || row.rolRetail || 0),
                                            availableWholesale: 0, // Initialize as 0
                                            availableRetail: 0 // Initialize as 0
                                        });
                                    });

                                    bulkUploadROLData = groupedByStyleCode;

                                    // Preview - show first style code's items
                                    const firstStyleCode = Object.keys(groupedByStyleCode)[0];
                                    const previewItems = groupedByStyleCode[firstStyleCode]?.items || [];
                                    const tbody = getCachedElement('rolPreviewTableBody');
                                    tbody.innerHTML = '';
                                    previewItems.slice(0, 5).forEach(item => {
                                        const row = document.createElement('tr');
                                        row.className = 'border-b';
                                        row.innerHTML = `
                                            <td class="px-2 py-2">${firstStyleCode}</td>
                                            <td class="px-2 py-2">${item.design}</td>
                                            <td class="px-2 py-2">${item.sku}</td>
                                            <td class="px-2 py-2 text-center">${item.size}</td>
                                            <td class="px-2 py-2 text-center font-bold">${item.rolWholesale.toFixed(2)} gms</td>
                                            <td class="px-2 py-2 text-center font-bold">${item.rolRetail} pcs</td>
                                        `;
                                        tbody.appendChild(row);
                                    });

                                    const totalStyleCodes = Object.keys(groupedByStyleCode).length;
                                    const totalItems = jsonData.length;
                                    getCachedElement('rolUploadCount').textContent = `${totalItems} items across ${totalStyleCodes} style code(s)`;
                                    getCachedElement('rolUploadPreview').classList.remove('hidden');
                                } catch (error) {
                                    showDialog('Error', 'Error reading Excel: ' + error.message, 'error');
                                }
                            };
                            reader.readAsArrayBuffer(file);
                        }

                        function confirmROLUpload() {
                            if (!bulkUploadROLData || Object.keys(bulkUploadROLData).length === 0) {
                                showDialog('Error', 'No data to upload!', 'error');
                                return;
                            }

                            // Merge with existing ROL data (preserve available counters)
                            Object.keys(bulkUploadROLData).forEach(styleCode => {
                                const newStyleData = bulkUploadROLData[styleCode];
                                
                                if (!rolData[styleCode]) {
                                    rolData[styleCode] = { items: [] };
                                }

                                // Merge items - update ROL values but preserve available counters
                                newStyleData.items.forEach(newItem => {
                                    const existingItem = rolData[styleCode].items.find(
                                        item => item.sku === newItem.sku && item.size === newItem.size
                                    );
                                    
                                    if (existingItem) {
                                        // Update ROL values but keep available counters
                                        existingItem.design = newItem.design;
                                        existingItem.rolWholesale = newItem.rolWholesale;
                                        existingItem.rolRetail = newItem.rolRetail;
                                    } else {
                                        // Add new item
                                        rolData[styleCode].items.push(newItem);
                                    }
                                });
                            });

                            setCachedItem('rolData', rolData);
                            
                            // Reload if current style code is in uploaded data
                            if (currentSelectedROLStyleCode && bulkUploadROLData[currentSelectedROLStyleCode]) {
                                loadROLForStyleCode();
                            }
                            
                            closeModals();
                            const totalItems = Object.values(bulkUploadROLData).reduce((sum, style) => sum + style.items.length, 0);
                            showDialog('Success', `Successfully uploaded ${totalItems} ROL items across ${Object.keys(bulkUploadROLData).length} style code(s)!`, 'success');
                        }

                        function downloadROLReportForStyleCode() {
                            if (!currentSelectedROLStyleCode) {
                                showDialog('Error', 'Please select a style code first!', 'error');
                                return;
                            }

                            const styleData = rolData[currentSelectedROLStyleCode];
                            if (!styleData || !styleData.items || styleData.items.length === 0) {
                                showDialog('Error', 'No ROL data found for selected style code!', 'error');
                                return;
                            }

                            const date = new Date().toLocaleDateString('en-GB');
                            const wb = XLSX.utils.book_new();

                            // Create data
                            const tableData = styleData.items.map((item, idx) => ({
                                '#': idx + 1,
                                'Style Code': currentSelectedROLStyleCode,
                                'Design (Product Name)': item.design || '-',
                                'SKU': item.sku || '-',
                                'Size': item.size || '-',
                                'ROL Wholesale (gms)': parseFloat(item.rolWholesale || 0).toFixed(2),
                                'Available Wholesale (gms)': parseFloat(item.availableWholesale || 0).toFixed(2),
                                'Required Wholesale (gms)': Math.max(0, parseFloat(item.rolWholesale || 0) - parseFloat(item.availableWholesale || 0)).toFixed(2),
                                'ROL Retail (pcs)': parseFloat(item.rolRetail || 0),
                                'Available Retail (pcs)': parseFloat(item.availableRetail || 0),
                                'Required Retail (pcs)': Math.max(0, parseFloat(item.rolRetail || 0) - parseFloat(item.availableRetail || 0)),
                                'Status': (Math.max(0, parseFloat(item.rolWholesale || 0) - parseFloat(item.availableWholesale || 0)) > 0 || 
                                          Math.max(0, parseFloat(item.rolRetail || 0) - parseFloat(item.availableRetail || 0)) > 0) ? 'REORDER NEEDED' : 'OK'
                            }));

                            const tableHeaders = Object.keys(tableData[0]);
                            const tableRows = tableData.map(obj => tableHeaders.map(key => obj[key]));

                            // Calculate summary
                            const totalWholesaleRequired = tableData.reduce((sum, item) => sum + parseFloat(item['Required Wholesale (gms)'] || 0), 0);
                            const totalRetailRequired = tableData.reduce((sum, item) => sum + parseFloat(item['Required Retail (pcs)'] || 0), 0);
                            const itemsNeedingReorder = tableData.filter(item => item.Status === 'REORDER NEEDED').length;

                            const headerData = [
                                ['REORDER LEVEL (ROL) REPORT'],
                                ['Generated:', date],
                                ['Style Code:', currentSelectedROLStyleCode],
                                ['Total Items:', tableData.length],
                                ['Items Needing Reorder:', itemsNeedingReorder],
                                ['Total Required Wholesale (gms):', totalWholesaleRequired.toFixed(2)],
                                ['Total Required Retail (pcs):', totalRetailRequired],
                                ['']
                            ];

                            // Combine all data
                            const allData = [
                                ...headerData,
                                tableHeaders,
                                ...tableRows,
                                ...summaryData
                            ];

                            const ws = XLSX.utils.aoa_to_sheet(allData);

                            ws['!cols'] = [
                                { wch: 5 }, { wch: 20 }, { wch: 30 }, { wch: 15 }, { wch: 10 },
                                { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 }
                            ];

                            XLSX.utils.book_append_sheet(wb, ws, 'ROL Report');
                            XLSX.writeFile(wb, `ROL_Report_${currentSelectedROLStyleCode}_${date.replace(/\//g, '-')}.xlsx`);
                            showDialog('Success', 'ROL Report downloaded successfully!', 'success');
                        }

                        // ========== QUOTATION HISTORY FUNCTIONS ==========

                            function loadQuotationsHistory() {
                                // Populate customer filter
                                const customerFilter = document.getElementById('quotationCustomerFilter');
                                customerFilter.innerHTML = '<option value="all">All Customers</option>';

                                const uniqueCustomers = [...new Set(savedQuotations.map(q => q.customer.name))];
                                uniqueCustomers.forEach(name => {
                                    const option = document.createElement('option');
                                    option.value = name;
                                    option.textContent = name;
                                    customerFilter.appendChild(option);
                                });

                                // Update statistics and display
                                updateQuotationStatistics();
                                displayQuotations(savedQuotations);
                            }

                            function updateQuotationStatistics() {
                                const today = new Date();
                                today.setHours(0, 0, 0, 0);

                                const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                                const todayQuotations = savedQuotations.filter(q => {
                                    const qDate = new Date(q.date);
                                    qDate.setHours(0, 0, 0, 0);
                                    return qDate.getTime() === today.getTime();
                                });

                                const monthQuotations = savedQuotations.filter(q => {
                                    const qDate = new Date(q.date);
                                    return qDate >= thisMonth;
                                });

                                const totalValue = savedQuotations.reduce((sum, q) => sum + q.netTotal, 0);

                                document.getElementById('quotationTotalCount').textContent = savedQuotations.length;
                                document.getElementById('quotationTotalValue').textContent = `‚Çπ${totalValue.toFixed(0)}`;
                                document.getElementById('quotationMonthCount').textContent = monthQuotations.length;
                                document.getElementById('quotationTodayCount').textContent = todayQuotations.length;
                            }

                            function displayQuotations(quotations) {
                                const tbody = document.getElementById('quotationsTableBody');
                                const emptyState = document.getElementById('quotationsEmptyState');

                                tbody.innerHTML = '';

                                if (quotations.length === 0) {
                                    emptyState.classList.remove('hidden');
                                    return;
                                }

                                emptyState.classList.add('hidden');

                                quotations.forEach(quotation => {
                                    const row = document.createElement('tr');
                                    row.className = 'border-b hover:bg-gray-50';

                                    const date = new Date(quotation.date).toLocaleDateString('en-GB');
                                    const itemCount = quotation.items.length;

                                    const remarksValue = quotation.remarks || '';
                                    row.innerHTML = `
    <td class="px-4 py-3 font-mono text-sm font-bold text-blue-600">${quotation.quotationNo}</td>
    <td class="px-4 py-3 text-sm">${date}</td>
    <td class="px-4 py-3 font-medium">${quotation.customer.name}</td>
    <td class="px-4 py-3 text-center">${itemCount}</td>
    <td class="px-4 py-3 text-right">‚Çπ${quotation.total.toFixed(2)}</td>
    <td class="px-4 py-3 text-right">‚Çπ${quotation.gst.toFixed(2)}</td>
    <td class="px-4 py-3 text-right font-bold">‚Çπ${quotation.netTotal.toFixed(2)}</td>
    <td class="px-4 py-3 text-center">
        ${quotation.isBilled ?
                                            `<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-bold">BILLED</span>` :
                                            `<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-bold">PENDING</span>`
                                        }
    </td>
    <td class="px-4 py-3 text-center">
        <select onchange="updateQuotationRemarks(${quotation.id}, this.value)" 
            class="px-2 py-1 text-xs border rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="">-- Select --</option>
            <option value="rate-unfixed" ${remarksValue === 'rate-unfixed' ? 'selected' : ''}>Rate-Unfixed</option>
            <option value="approval" ${remarksValue === 'approval' ? 'selected' : ''}>Approval</option>
            <option value="repair and polish" ${remarksValue === 'repair and polish' ? 'selected' : ''}>Repair and Polish</option>
        </select>
    </td>
    <td class="px-4 py-3 text-center">
        <button onclick="viewQuotationDetails(${quotation.id})" 
            class="text-blue-600 hover:text-blue-800 font-medium mr-2" title="View">üëÅÔ∏è</button>
        <button onclick="editQuotation(${quotation.id})" 
            class="text-green-600 hover:text-green-800 font-medium mr-2" title="Edit">‚úèÔ∏è</button>
        <button onclick="deleteQuotation(${quotation.id})" 
            class="text-red-600 hover:text-red-800 font-medium" title="Delete">üóëÔ∏è</button>
    </td>
`;

                                    tbody.appendChild(row);
                                });
                            }

                            function filterQuotations() {
                                    const searchTerm = document.getElementById('quotationSearch').value.toLowerCase();
                                    const customerFilter = document.getElementById('quotationCustomerFilter').value;
                                    const statusFilter = document.getElementById('quotationStatusFilter').value;
                                    const dateFilter = document.getElementById('quotationDateFilter').value;

                                    let filtered = savedQuotations;

                                    // Search filter
                                    if (searchTerm) {
                                        filtered = filtered.filter(q =>
                                            q.quotationNo.toLowerCase().includes(searchTerm) ||
                                            q.customer.name.toLowerCase().includes(searchTerm) ||
                                            q.customer.mobile.includes(searchTerm)
                                        );
                                    }

                                    // Customer filter
                                    if (customerFilter !== 'all') {
                                        filtered = filtered.filter(q => q.customer.name === customerFilter);
                                    }

                                    // STATUS FILTER - NEW
                                    if (statusFilter === 'pending') {
                                        filtered = filtered.filter(q => !q.isBilled);
                                    } else if (statusFilter === 'billed') {
                                        filtered = filtered.filter(q => q.isBilled);
                                    }

                                    // Date filter
                                    if (dateFilter !== 'all') {
                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);

                                        filtered = filtered.filter(q => {
                                            const qDate = new Date(q.date);
                                            qDate.setHours(0, 0, 0, 0);

                                            if (dateFilter === 'today') {
                                                return qDate.getTime() === today.getTime();
                                            } else if (dateFilter === 'week') {
                                                const weekAgo = new Date(today);
                                                weekAgo.setDate(weekAgo.getDate() - 7);
                                                return qDate >= weekAgo;
                                            } else if (dateFilter === 'month') {
                                                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                                return qDate >= monthStart;
                                            }
                                            return true;
                                        });
                                    }

                                    displayQuotations(filtered);
                                }

                            function viewQuotationDetails(id) {
                                const quotation = savedQuotations.find(q => q.id === id);
                                if (!quotation) return;

                                currentViewingQuotation = quotation;

                                document.getElementById('viewQuotationTitle').textContent = `Quotation ${quotation.quotationNo}`;
                                document.getElementById('viewQuotCustomer').textContent = quotation.customer.name;
                                document.getElementById('viewQuotDate').textContent = new Date(quotation.date).toLocaleDateString('en-GB');

                                // Items
                                const tbody = document.getElementById('viewQuotItemsBody');
                                tbody.innerHTML = '';
                                quotation.items.forEach((item, idx) => {
                                    const row = document.createElement('tr');
                                    row.className = 'border-b';
                                    row.innerHTML = `
            <td class="px-2 py-2">${idx + 1}</td>
            <td class="px-2 py-2">${item.name}</td>
            <td class="px-2 py-2 font-mono text-xs">${item.barcode || '-'}</td>
            <td class="px-2 py-2 text-right">${item.weight.toFixed(2)}g</td>
            <td class="px-2 py-2 text-right">‚Çπ${item.rate}</td>
            <td class="px-2 py-2 text-right">‚Çπ${item.mcRate}</td>
            <td class="px-2 py-2 text-right font-semibold">‚Çπ${item.amount.toFixed(2)}</td>
        `;
                                    tbody.appendChild(row);
                                });

                                // Totals
                                document.getElementById('viewQuotTotal').textContent = `‚Çπ${quotation.total.toFixed(2)}`;
                                document.getElementById('viewQuotGST').textContent = `‚Çπ${quotation.gst.toFixed(2)}`;
                                document.getElementById('viewQuotNetTotal').textContent = `‚Çπ${quotation.netTotal.toFixed(2)}`;

                                // Show modal
                                document.getElementById('modalOverlay').classList.remove('hidden');
                                document.getElementById('modalOverlay').classList.add('flex');
                                document.getElementById('viewQuotationModal').classList.remove('hidden');
                            }

                            function updateQuotationRemarks(id, remarks) {
                                const quotation = savedQuotations.find(q => q.id === id);
                                if (quotation) {
                                    quotation.remarks = remarks;
                                    setCachedItem('savedQuotations', savedQuotations);
                                }
                            }

                            function editQuotation(id) {
                                const quotation = savedQuotations.find(q => q.id === id);
                                if (!quotation) return;

                                // Switch to billing tab
                                showTab('billing');

                                // Load customer - set the input field value to customer name
                                const customer = customers.find(c => c.name === quotation.customer.name);
                                if (customer) {
                                    document.getElementById('customerSelect').value = customer.name;
                                    loadCustomerByObject(customer);
                                }

                                // Load items into billing
                                items = quotation.items.map(item => ({
                                    ...item,
                                    id: Date.now() + Math.random() // New IDs for editing
                                }));

                                // Update rate slab
                                currentRateSlab = quotation.rateSlab || 'R';
                                document.getElementById('rateSlab').value = currentRateSlab;
                                updateRateSlabInfo();

                                // Recalculate with current rates
                                items.forEach(item => {
                                    if (item.metalType) {
                                        const currentRate = parseFloat(rates[item.metalType] || rates.silver);
                                        item.rate = parseFloat(currentRate.toFixed(2));
                                        const originalMCRate = item.originalMcRate || parseFloat(item.mcRate);
                                        const adjustedMCRate = getAdjustedMCRate(originalMCRate);
                                        item.mcRate = parseFloat(adjustedMCRate.toFixed(2));
                                        
                                        if (item.mcType === 'PieceCost') {
                                            item.amount = (item.rate * item.weight) + item.mcRate + (item.boxCharges || 0) + (item.stoneCharges || 0);
                                        } else {
                                            item.amount = (item.rate + item.mcRate) * item.weight + (item.boxCharges || 0) + (item.stoneCharges || 0);
                                        }
                                    }
                                });

                                updateItemsTable();
                                updateSummary();

                                // Store quotation ID for update
                                window.editingQuotationId = id;

                                alert(`Quotation ${quotation.quotationNo} loaded for editing. Make your changes and save as a new quotation or update existing.`);
                            }

                            async function deleteQuotation(id) {
                                if (!confirm('Are you sure you want to delete this quotation?')) return;

                                const quotation = savedQuotations.find(q => q.id === id);
                                if (!quotation) return;

                                // Delete from API if has database ID
                                if (quotation.dbId) {
                                    try {
                                        await api.deleteQuotation(quotation.dbId);
                                    } catch (error) {
                                        console.error('Failed to delete quotation from API:', error);
                                    }
                                }

                                // Return items to their original floors
                                quotation.items.forEach(item => {
                                    if (item.barcode && item.originalFloor) {
                                        const product = products.find(p => p.barcode === item.barcode);
                                        if (product) {
                                            product.floor = item.originalFloor;
                                            const productIndex = products.findIndex(p => p.id === product.id);
                                            if (productIndex >= 0) {
                                                products[productIndex] = product;
                                            }
                                        }
                                    }
                                });
                                
                                if (quotation.items.some(item => item.barcode && item.originalFloor)) {
                                    setCachedItem('products', products);
                                }

                                savedQuotations = savedQuotations.filter(q => q.id !== id);
                                setCachedItem('savedQuotations', savedQuotations);

                                loadQuotationsHistory();
                                showDialog('Success', 'Quotation deleted successfully! Items returned to original floors.', 'success');
                            }

                            function downloadAllQuotations() {
                                if (savedQuotations.length === 0) {
                                    alert('No quotations to export!');
                                    return;
                                }

                                const data = savedQuotations.map(q => ({
                                    'Quote No': q.quotationNo,
                                    'Date': new Date(q.date).toLocaleDateString('en-GB'),
                                    'Customer': q.customer.name,
                                    'Mobile': q.customer.mobile,
                                    'Items': q.items.length,
                                    'Total': q.total.toFixed(2),
                                    'GST': q.gst.toFixed(2),
                                    'Net Total': q.netTotal.toFixed(2)
                                }));

                                const ws = XLSX.utils.json_to_sheet(data);
                                const wb = XLSX.utils.book_new();
                                XLSX.utils.book_append_sheet(wb, ws, 'Quotations');
                                XLSX.writeFile(wb, `All_Quotations_${new Date().toISOString().split('T')[0]}.xlsx`);
                                alert('All quotations exported successfully!');
                            }

                            function clearOldQuotations() {
                                showInputDialog('Delete Old Quotations', 'Delete quotations older than how many months? (Enter number)', '', 'Enter number of months').then(months => {
                                    if (!months || isNaN(months)) return;
                                    
                                    const cutoffDate = new Date();
                                    cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(months));

                                    const before = savedQuotations.length;
                                    savedQuotations = savedQuotations.filter(q => new Date(q.date) >= cutoffDate);
                                    const after = savedQuotations.length;

                                    setCachedItem('savedQuotations', savedQuotations);
                                    loadQuotationsHistory();

                                    showDialog('Success', `Deleted ${before - after} old quotation(s)!`, 'success');
                                }).catch(() => {});
                            }

                            function reprintQuotationPDF() {
                                if (!currentViewingQuotation) return;

                                const q = currentViewingQuotation;
                                const { jsPDF } = window.jspdf;
                                const doc = new jsPDF('p', 'mm', 'a4');

                                const date = new Date(q.date).toLocaleDateString('en-GB');

                                // Customer info
                                doc.setFontSize(9);
                                doc.setFont(undefined, 'normal');
                                doc.text('To:', 15, 15);
                                doc.setFont(undefined, 'bold');
                                doc.setFontSize(10);
                                doc.text(q.customer.name.toUpperCase(), 15, 20);

                                doc.setFontSize(8);
                                doc.setFont(undefined, 'normal');
                                let yPos = 24;
                                if (q.customer.address1) {
                                    doc.text(q.customer.address1, 15, yPos);
                                    yPos += 4;
                                }
                                if (q.customer.address2) {
                                    doc.text(q.customer.address2, 15, yPos);
                                    yPos += 4;
                                }
                                if (q.customer.city) {
                                    doc.text(q.customer.city, 15, yPos);
                                    yPos += 4;
                                }
                                doc.text(`Mob: ${q.customer.mobile}`, 15, yPos);

                                // Quote info
                                doc.setFontSize(8);
                                doc.setFont(undefined, 'bold');
                                doc.text('EST. No:', 160, 15);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.quotationNo, 180, 15);
                                doc.setFont(undefined, 'bold');
                                doc.text('Date:', 160, 20);
                                doc.setFont(undefined, 'normal');
                                doc.text(date, 180, 20);

                                // Items table
                                const tableStartY = yPos + 8;
                                const tableData = q.items.map((item, idx) => {
    // CORRECT CALCULATION: (Rate + MC) √ó Weight
    const itemTotal = (item.rate + item.mcRate) * item.weight;
    
    return [
        idx + 1,
        item.sku || '-',
        item.styleCode || '-',
        item.name,
        item.size || '-',
        item.weight.toFixed(2),
        item.weight.toFixed(2),
        item.purity.toFixed(0),
        item.weight.toFixed(2),
        '1',
        item.mcRate.toFixed(2),
        item.rate.toFixed(0),
        itemTotal.toFixed(2)
    ];
});

                                doc.autoTable({
                                    startY: tableStartY,
                                    head: [['#', 'SKU', 'STYLE CODE', 'Short Name', 'SIZE', 'NET.WT', 'AVG.WT', '% Pure', 'G.WT', 'PCS', 'MC/gm', 'RATE', 'Amount']],
                                    body: tableData,
                                    theme: 'grid',
                                    headStyles: { fillColor: [211, 211, 211], textColor: 0, fontSize: 7, fontStyle: 'bold', halign: 'center', cellPadding: 1.5 },
                                    bodyStyles: { fontSize: 7, cellPadding: 1 },
                                    columnStyles: {
                                        0: { cellWidth: 8, halign: 'center' },
                                        1: { cellWidth: 20, halign: 'left', fontSize: 6.5 },
                                        2: { cellWidth: 16, halign: 'center', fontSize: 6.5 },
                                        3: { cellWidth: 38, halign: 'left' },
                                        4: { cellWidth: 12, halign: 'center' },
                                        5: { cellWidth: 13, halign: 'right' },
                                        6: { cellWidth: 13, halign: 'right' },
                                        7: { cellWidth: 11, halign: 'center' },
                                        8: { cellWidth: 11, halign: 'right' },
                                        9: { cellWidth: 9, halign: 'center' },
                                        10: { cellWidth: 12, halign: 'right' },
                                        11: { cellWidth: 12, halign: 'right' },
                                        12: { cellWidth: 16, halign: 'right' }
                                    },
                                    margin: { left: 15, right: 14 }
                                });

                                // Totals section
                                const finalY = doc.lastAutoTable.finalY + 8;
                                const totalWeight = q.items.reduce((sum, item) => sum + item.weight, 0);
                                const totalMC = q.items.reduce((sum, item) => sum + (item.weight * item.mcRate), 0);

                                doc.setDrawColor(0);
                                doc.setLineWidth(0.5);
                                doc.rect(15, finalY, 180, 25);
                                doc.line(105, finalY, 105, finalY + 25);

                                doc.setFontSize(8);
                                doc.setFont(undefined, 'bold');
                                doc.text('COUNT:', 18, finalY + 6);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.items.length.toString(), 45, finalY + 6);
                                doc.setFont(undefined, 'bold');
                                doc.text('Total Weight:', 18, finalY + 12);
                                doc.setFont(undefined, 'normal');
                                doc.text(`${totalWeight.toFixed(2)} gm`, 45, finalY + 12);
                                doc.setFont(undefined, 'bold');
                                doc.text('MC:', 18, finalY + 18);
                                doc.setFont(undefined, 'normal');
                                doc.text(totalMC.toFixed(2), 45, finalY + 18);

                                doc.setFontSize(9);
                                doc.setFont(undefined, 'bold');
                                doc.text('GRAND TOTAL', 110, finalY + 5);
                                doc.setFontSize(8);
                                doc.text('TOTAL:', 110, finalY + 11);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.total.toFixed(2), 190, finalY + 11, { align: 'right' });
                                doc.setFont(undefined, 'bold');
                                doc.text('GST:', 110, finalY + 16);
                                doc.setFont(undefined, 'normal');
                                doc.text(q.gst.toFixed(2), 190, finalY + 16, { align: 'right' });
                                doc.setFont(undefined, 'bold');
                                doc.text('NET TOTAL:', 110, finalY + 21);
                                doc.text(q.netTotal.toFixed(2), 190, finalY + 21, { align: 'right' });

                                doc.save(`Quotation_${q.quotationNo}_REPRINT.pdf`);
                                alert('Quotation PDF downloaded!');
                            }

                            // ========== BILL HISTORY FUNCTIONS ==========
                            function filterBills() {
                                    const searchTerm = document.getElementById('billSearch').value.toLowerCase();
                                    const customerFilter = document.getElementById('billCustomerFilter').value;
                                    const dateFilter = document.getElementById('billDateFilter').value;

                                    let filtered = savedBills;

                                    // Search filter
                                    if (searchTerm) {
                                        filtered = filtered.filter(b =>
                                            b.billNo.toLowerCase().includes(searchTerm) ||
                                            b.customer.name.toLowerCase().includes(searchTerm) ||
                                            b.customer.mobile.includes(searchTerm)
                                        );
                                    }

                                    // Customer filter
                                    if (customerFilter !== 'all') {
                                        filtered = filtered.filter(b => b.customer.name === customerFilter);
                                    }

                                    // Date filter
                                    if (dateFilter !== 'all') {
                                        const today = new Date();
                                        today.setHours(0, 0, 0, 0);

                                        filtered = filtered.filter(b => {
                                            const bDate = new Date(b.date);
                                            bDate.setHours(0, 0, 0, 0);

                                            if (dateFilter === 'today') {
                                                return bDate.getTime() === today.getTime();
                                            } else if (dateFilter === 'week') {
                                                const weekAgo = new Date(today);
                                                weekAgo.setDate(weekAgo.getDate() - 7);
                                                return bDate >= weekAgo;
                                            } else if (dateFilter === 'month') {
                                                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                                return bDate >= monthStart;
                                            }
                                            return true;
                                        });
                                    }

                                    displayBills(filtered);
                                }

    function displayBills(bills) {
            const tbody = document.getElementById('billsTableBody');
            const emptyState = document.getElementById('billsEmptyState');

            if (!tbody) {
                console.error('Bills table body not found!');
                return;
            }

            tbody.innerHTML = '';

            if (bills.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');

            bills.forEach((bill) => {
                // FIX: Store bill ID for reliable lookup
                const billId = bill.id;

                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const date = new Date(bill.date);
                const formattedDate = date.toLocaleDateString('en-GB');
                const formattedTime = date.toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                row.innerHTML = `
    <td class="px-4 py-3 font-semibold text-green-600">${bill.billNo}</td>
    <td class="px-4 py-3">
        <div>${formattedDate}</div>
        <div class="text-xs text-gray-500">${formattedTime}</div>
    </td>
    <td class="px-4 py-3">
        <div class="font-medium">${bill.customer.name}</div>
        <div class="text-xs text-gray-500">${bill.customer.mobile}</div>
    </td>
    <td class="px-4 py-3 text-center">
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">
            ${bill.items.length} items
        </span>
    </td>
    <td class="px-4 py-3 text-right">‚Çπ${bill.total.toFixed(2)}</td>
    <td class="px-4 py-3 text-right">‚Çπ${bill.gst.toFixed(2)}</td>
    <td class="px-4 py-3 text-right font-bold">‚Çπ${bill.netTotal.toFixed(2)}</td>
    <td class="px-4 py-3 text-center">
        <span class="px-3 py-1 rounded-full text-xs font-bold ${bill.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
            ${(bill.paymentStatus || 'unpaid').toUpperCase()}
        </span>
    </td>
    <td class="px-4 py-3 text-center">
        <div class="flex gap-2 justify-center">
            <button onclick="viewBillById(${bill.id})" 
                class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                üëÅÔ∏è View
            </button>
            <button onclick="reprintBillById(${bill.id})" 
                class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">
                üñ®Ô∏è Reprint
            </button>
            <button onclick="deleteBillById(${bill.id})" 
                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">
                üóëÔ∏è Delete
            </button>
        </div>
    </td>
`;

                tbody.appendChild(row);
            });
        }

    // View bill by ID instead of index
        // View bill by ID instead of index
            function viewBillById(billId) {
                const bill = savedBills.find(b => b.id === billId);
                if (!bill) {
                    alert('Bill not found!');
                    return;
                }

                // Populate bill details modal directly
                document.getElementById('viewBillNo').textContent = bill.billNo;

                const date = new Date(bill.date);
                document.getElementById('viewBillDate').textContent = date.toLocaleDateString('en-GB');

                document.getElementById('viewBillCustomerName').textContent = bill.customer.name;
                const address = [
                    bill.customer.address1 || '',
                    bill.customer.address2 || '',
                    bill.customer.city || ''
                ].filter(x => x).join(', ');
                document.getElementById('viewBillCustomerAddress').textContent = address || 'N/A';
                document.getElementById('viewBillCustomerMobile').textContent = bill.customer.mobile;
                document.getElementById('viewBillRateSlab').textContent = bill.rateSlab || 'R';

                // Populate items table
                const tbody = document.getElementById('viewBillItemsTableBody');
                tbody.innerHTML = '';

                bill.items.forEach((item, idx) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b';
                    row.innerHTML = `
            <td class="px-4 py-2">${idx + 1}</td>
            <td class="px-4 py-2">${item.sku || '-'}</td>
            <td class="px-4 py-2">${item.styleCode || '-'}</td>
            <td class="px-4 py-2 font-medium">${item.name}</td>
            <td class="px-4 py-2 text-center">${item.size || '-'}</td>
            <td class="px-4 py-2 text-right">${item.weight.toFixed(2)}</td>
            <td class="px-4 py-2 text-center">${item.purity.toFixed(0)}%</td>
            <td class="px-4 py-2 text-right">‚Çπ${item.rate}</td>
            <td class="px-4 py-2 text-right">‚Çπ${item.mcRate.toFixed(2)}</td>
            <td class="px-4 py-2 text-right font-semibold">‚Çπ${item.amount.toFixed(2)}</td>
        `;
                    tbody.appendChild(row);
                });

                // Summary
                document.getElementById('viewBillTotal').textContent = `‚Çπ${bill.total.toFixed(2)}`;
                document.getElementById('viewBillGST').textContent = `‚Çπ${bill.gst.toFixed(2)}`;
                document.getElementById('viewBillNetTotal').textContent = `‚Çπ${bill.netTotal.toFixed(2)}`;

                // Store current bill ID for reprint
                document.getElementById('viewBillModal').setAttribute('data-bill-id', bill.id);

                // Show modal
                document.getElementById('modalOverlay').classList.remove('hidden');
                document.getElementById('modalOverlay').classList.add('flex');
                document.getElementById('viewBillModal').classList.remove('hidden');
            }

        // Delete bill by ID
        function deleteBillById(billId) {
            if (!confirm('Are you sure you want to delete this sales bill? This action cannot be undone.')) return;
            
            const billIndex = savedBills.findIndex(b => b.id === billId);
            if (billIndex === -1) {
                alert('Bill not found!');
                return;
            }
            
            savedBills.splice(billIndex, 1);
            setCachedItem('savedBills', savedBills);
            
            // Refresh bills display
            displayBills(savedBills);
            alert('Sales bill deleted successfully!');
        }

        // Reprint bill by ID
        function reprintBillById(billId) {
    const bill = savedBills.find(b => b.id === billId);
    if (!bill) {
        alert('Bill not found!');
        return;
    }
    
    // Generate PDF using same logic as sales bill
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const date = new Date(bill.date);
    const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit' });
    const customer = bill.customer;
    const totalWeight = bill.items.reduce((sum, item) => sum + item.weight, 0);
    const totalPCS = bill.items.length;

    // Header
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('JP JEWELLERY', 105, 15, { align: 'center' });

    doc.setFontSize(8);
    doc.setFont(undefined, 'normal');
    doc.text('2ND FLOOR, OLD NO.34, NEW NO.21, BOTHRA EMPORIUM', 105, 20, { align: 'center' });
    doc.text('VEERAPPAN STREET, SOWCARPET', 105, 24, { align: 'center' });
    doc.text('CHENNAI 600079 | 044-43593474', 105, 28, { align: 'center' });

    doc.setFont(undefined, 'bold');
    doc.text('TAX INVOICE', 105, 35, { align: 'center' });
    doc.text('33AADFJ4897R1ZJ', 105, 39, { align: 'center' });

    // Bill Info
    doc.setFontSize(8);
    doc.text('INVOICE No.:', 15, 48);
    doc.setFont(undefined, 'normal');
    doc.text(bill.billNo, 45, 48);

    doc.setFont(undefined, 'bold');
    doc.text('BILL DATE:', 150, 48);
    doc.setFont(undefined, 'normal');
    doc.text(formattedDate, 175, 48);

    // Customer Info
    doc.setFont(undefined, 'bold');
    doc.setFontSize(9);
    doc.text(customer.name.toUpperCase(), 15, 60);

    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    let yCustomer = 64;
    if (customer.address1) {
        doc.text(customer.address1, 15, yCustomer);
        yCustomer += 4;
    }
    if (customer.address2) {
        doc.text(customer.address2, 15, yCustomer);
        yCustomer += 4;
    }
    if (customer.city) {
        doc.text(customer.city, 15, yCustomer);
        yCustomer += 4;
    }
    doc.text(`MOB: ${customer.mobile}`, 15, yCustomer);

    // Items Table
    const tableStartY = Math.max(yCustomer + 8, 85);

    const tableData = bill.items.map((item, idx) => [
        idx + 1,
        item.name,
        '711311',
        totalPCS,
        item.weight.toFixed(3),
        item.purity.toFixed(1),
        item.rate.toFixed(2),
        item.amount.toFixed(2)
    ]);

    doc.autoTable({
        startY: tableStartY,
        head: [['Sl', 'ITEM', 'HSN', 'PCS', 'Weight In Gms', 'Purity', 'Rate', 'TOTAL']],
        body: tableData,
        theme: 'grid',
        headStyles: {
            fillColor: [220, 220, 220],
            textColor: 0,
            fontSize: 7,
            fontStyle: 'bold',
            halign: 'center',
            cellPadding: 2
        },
        bodyStyles: {
            fontSize: 7,
            cellPadding: 1.5
        },
        columnStyles: {
            0: { cellWidth: 10, halign: 'center' },
            1: { cellWidth: 60, halign: 'left' },
            2: { cellWidth: 20, halign: 'center' },
            3: { cellWidth: 15, halign: 'center' },
            4: { cellWidth: 25, halign: 'right' },
            5: { cellWidth: 20, halign: 'center' },
            6: { cellWidth: 20, halign: 'right' },
            7: { cellWidth: 25, halign: 'right' }
        },
        margin: { left: 15, right: 15 }
    });

    // Totals
    const finalY = doc.lastAutoTable.finalY + 10;
    const cgst = bill.gst / 2;
    const sgst = bill.gst / 2;

    doc.setFontSize(8);
    doc.setFont(undefined, 'bold');
    doc.text(`Total PCS: ${totalPCS}`, 15, finalY);
    doc.text(`${totalWeight.toFixed(3)}`, 50, finalY);

    const rightX = 150;
    doc.text('GST Value:', rightX, finalY);
    doc.setFont(undefined, 'normal');
    doc.text(bill.total.toFixed(2), 195, finalY, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('CGST@1.50%:', rightX, finalY + 5);
    doc.setFont(undefined, 'normal');
    doc.text(cgst.toFixed(2), 195, finalY + 5, { align: 'right' });

    doc.setFont(undefined, 'bold');
    doc.text('SGST@1.50%:', rightX, finalY + 10);
    doc.setFont(undefined, 'normal');
    doc.text(sgst.toFixed(2), 195, finalY + 10, { align: 'right' });

    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Total Amount:', rightX, finalY + 17);
    doc.text(bill.netTotal.toFixed(2), 195, finalY + 17, { align: 'right' });

    // Footer
    const footerY = finalY + 25;
    doc.setFontSize(7);
    doc.setFont(undefined, 'normal');
    doc.text('BANK NAME: HDFC BANK', 15, footerY);
    doc.text('AC NAME: JPJEWELLERY', 15, footerY + 4);
    doc.text('AC NO: 50200016402896', 15, footerY + 8);
    doc.text('IFSC CODE: HDFC0000214', 15, footerY + 12);

    doc.setFont(undefined, 'bold');
    doc.text('For JP JEWELLERY', 150, footerY + 10);

    doc.save(`Bill_${bill.billNo}_REPRINT_${formattedDate.replace(/\//g, '-')}.pdf`);
    alert('‚úÖ Bill reprinted successfully!');
}

   function updateBillStatistics() {
       const today = new Date();
       today.setHours(0, 0, 0, 0);

       const thisMonth = new Date(today.getFullYear(), today.getMonth(), 1);

       const todayBills = savedBills.filter(b => {
           const bDate = new Date(b.date);
           bDate.setHours(0, 0, 0, 0);
           return bDate.getTime() === today.getTime();
       });

       const monthBills = savedBills.filter(b => {
           const bDate = new Date(b.date);
           return bDate >= thisMonth;
       });

       const totalValue = savedBills.reduce((sum, b) => sum + b.netTotal, 0);

       document.getElementById('billTotalCount').textContent = savedBills.length;
       document.getElementById('billTotalValue').textContent = `‚Çπ${totalValue.toFixed(0)}`;
       document.getElementById('billMonthCount').textContent = monthBills.length;
       document.getElementById('billTodayCount').textContent = todayBills.length;
   }

   function downloadAllBills() {
       if (savedBills.length === 0) {
           alert('No bills to export!');
           return;
       }

       const data = savedBills.map(b => ({
           'Bill No': b.billNo,
           'Date': new Date(b.date).toLocaleDateString('en-GB'),
           'Customer': b.customer.name,
           'Mobile': b.customer.mobile,
           'Items': b.items.length,
           'Total': b.total.toFixed(2),
           'GST': b.gst.toFixed(2),
           'Net Total': b.netTotal.toFixed(2),
           'Quotation': b.quotationNo
       }));

       const ws = XLSX.utils.json_to_sheet(data);
       const wb = XLSX.utils.book_new();
       XLSX.utils.book_append_sheet(wb, ws, 'Bills');
       XLSX.writeFile(wb, `All_Bills_${new Date().toISOString().split('T')[0]}.xlsx`);
       alert('All bills exported successfully!');
   }

   function clearOldBills() {
       showInputDialog('Delete Old Bills', 'Delete bills older than how many months? (Enter number)', '', 'Enter number of months').then(months => {
           if (!months || isNaN(months)) return;

           const cutoffDate = new Date();
           cutoffDate.setMonth(cutoffDate.getMonth() - parseInt(months));

           const before = savedBills.length;
           savedBills = savedBills.filter(b => new Date(b.date) >= cutoffDate);
           const after = savedBills.length;

           setCachedItem('savedBills', savedBills);
           loadBillHistory();

           showDialog('Success', `Deleted ${before - after} old bill(s)!`, 'success');
       }).catch(() => {});
   }

    // ========== LEDGER DISPLAY FUNCTIONS ==========
    function updateLedgerDashboard() {
            // Update balances with proper null checks
            const cashBalance = accountBalances.cash || 0;
            const bankBalance = accountBalances.bank || 0;
            const receivables = accountBalances.receivables || 0;
            const payables = accountBalances.payables || 0;

            const cashEl = document.getElementById('ledgerCashBalance');
            const bankEl = document.getElementById('ledgerBankBalance');
            const receivablesEl = document.getElementById('ledgerReceivables');
            const payablesEl = document.getElementById('ledgerPayables');

            // SAFETY CHECKS
            if (cashEl) cashEl.textContent = `‚Çπ${cashBalance.toFixed(2)}`;
            if (bankEl) bankEl.textContent = `‚Çπ${bankBalance.toFixed(2)}`;
            if (receivablesEl) receivablesEl.textContent = `‚Çπ${receivables.toFixed(2)}`;
            if (payablesEl) payablesEl.textContent = `‚Çπ${payables.toFixed(2)}`;

            // Update metal stocks with values
            const goldStock = accountBalances.goldStock || 0;
            const silverStock = accountBalances.silverStock || 0;
            const platinumStock = accountBalances.platinumStock || 0;

            const goldValue = goldStock * (rates.gold || 0);
            const silverValue = silverStock * (rates.silver || 0);
            const platinumValue = platinumStock * (rates.platinum || 0);

            const goldStockEl = document.getElementById('ledgerGoldStock');
            const goldValueEl = document.getElementById('ledgerGoldValue');
            const silverStockEl = document.getElementById('ledgerSilverStock');
            const silverValueEl = document.getElementById('ledgerSilverValue');
            const platinumStockEl = document.getElementById('ledgerPlatinumStock');
            const platinumValueEl = document.getElementById('ledgerPlatinumValue');

            // SAFETY CHECKS
            if (goldStockEl) goldStockEl.textContent = `${goldStock.toFixed(2)}g`;
            if (goldValueEl) goldValueEl.textContent = `Value: ‚Çπ${goldValue.toFixed(2)}`;
            if (silverStockEl) silverStockEl.textContent = `${silverStock.toFixed(2)}g`;
            if (silverValueEl) silverValueEl.textContent = `Value: ‚Çπ${silverValue.toFixed(2)}`;
            if (platinumStockEl) platinumStockEl.textContent = `${platinumStock.toFixed(2)}g`;
            if (platinumValueEl) platinumValueEl.textContent = `Value: ‚Çπ${platinumValue.toFixed(2)}`;
        }

        function showLedgerTransactions() {
            const container = document.getElementById('ledgerSubtabs');

            container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üìã All Transactions</h3>
                <div class="flex gap-2">
                    <button onclick="exportLedgerTransactions()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Export
                    </button>
                    <button onclick="showAddManualTransactionModal()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ‚ûï Add Manual Entry
                    </button>
                </div>
            </div>
            
            <!-- Filter -->
            <div class="mb-4 flex gap-3">
                <input type="text" id="ledgerTxnSearch" placeholder="üîç Search transactions..." 
                    onkeyup="filterLedgerTransactions()"
                    class="flex-1 px-4 py-2 border rounded-lg">
                <select id="ledgerTxnTypeFilter" onchange="filterLedgerTransactions()"
                    class="px-4 py-2 border rounded-lg">
                    <option value="all">All Types</option>
                    <option value="sale">Sales</option>
                    <option value="purchase">Purchases</option>
                    <option value="expense">Expenses</option>
                    <option value="cash_in">Cash In</option>
                    <option value="cash_out">Cash Out</option>
                </select>
            </div>
            
            <!-- Transactions Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Type</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Description</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Reference</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerTxnTableBody"></tbody>
                </table>
            </div>
        </div>
    `;

            displayLedgerTransactions(ledgerTransactions);
        }

        function displayLedgerTransactions(transactions) {
            const tbody = document.getElementById('ledgerTxnTableBody');
            // SAFETY CHECK
            if (!tbody) {
                console.error('Ledger transaction table body not found!');
                return;
            }

            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No transactions yet</td></tr>';
                return;
            }

            transactions.forEach(txn => {
                const date = new Date(txn.date);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';

                const typeColors = {
                    'sale': 'bg-green-100 text-green-800',
                    'purchase': 'bg-purple-100 text-purple-800',
                    'expense': 'bg-red-100 text-red-800',
                    'cash_in': 'bg-blue-100 text-blue-800',
                    'cash_out': 'bg-orange-100 text-orange-800'
                };

                row.innerHTML = `
            <td class="px-4 py-3 text-sm">${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 rounded text-xs font-semibold ${typeColors[txn.type] || 'bg-gray-100 text-gray-800'}">
                    ${txn.type.toUpperCase().replace('_', ' ')}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">${txn.description || '-'}</td>
            <td class="px-4 py-3 text-right font-bold ${txn.amount >= 0 ? 'text-green-600' : 'text-red-600'}">
                ‚Çπ${Math.abs(txn.amount).toFixed(2)}
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">${txn.reference || '-'}</td>
        `;

                tbody.appendChild(row);
            });
        }

 function filterLedgerTransactions() {
        const searchTerm = document.getElementById('ledgerTxnSearch')?.value.toLowerCase() || '';
        const typeFilter = document.getElementById('ledgerTxnTypeFilter')?.value || 'all';

        let filtered = ledgerTransactions;

        if (typeFilter !== 'all') {
            filtered = filtered.filter(txn => txn.type === typeFilter);
        }

        if (searchTerm) {
            filtered = filtered.filter(txn =>
                (txn.description && txn.description.toLowerCase().includes(searchTerm)) ||
                (txn.reference && txn.reference.toLowerCase().includes(searchTerm)) ||
                (txn.customerName && txn.customerName.toLowerCase().includes(searchTerm)) ||
                (txn.category && txn.category.toLowerCase().includes(searchTerm))
            );
        }

        displayLedgerTransactions(filtered);
    }

        function exportLedgerTransactions() {
                if (ledgerTransactions.length === 0) {
                    alert('No transactions to export!');
                    return;
                }

                const wb = XLSX.utils.book_new();

                const data = ledgerTransactions.map(txn => ({
                    'Date': new Date(txn.date).toLocaleDateString('en-GB'),
                    'Type': txn.type.toUpperCase(),
                    'Description': txn.description || '',
                    'Amount': txn.amount.toFixed(2),
                    'Reference': txn.reference || ''
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
                XLSX.writeFile(wb, `Ledger_Transactions_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('Transactions exported successfully!');
            }

            function showAddManualTransactionModal() {
    const modal = document.createElement('div');
    modal.id = 'addManualTransactionModal';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">‚ûï Add Manual Transaction</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Transaction Type *</label>
                    <select id="manualTxnType" class="w-full px-3 py-2 border rounded-lg">
                        <option value="sale">Sale</option>
                        <option value="purchase">Purchase</option>
                        <option value="expense">Expense</option>
                        <option value="cash_in">Cash In</option>
                        <option value="cash_out">Cash Out</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="manualTxnAmount" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Description *</label>
                    <textarea id="manualTxnDescription" rows="2" 
                        placeholder="Enter transaction details"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Reference No</label>
                    <input type="text" id="manualTxnReference" 
                        placeholder="Optional"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="manualTxnDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveManualTransaction()" 
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        üíæ Save
                    </button>
                    <button onclick="closeManualTransactionModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function saveManualTransaction() {
    const type = document.getElementById('manualTxnType').value;
    const amount = parseFloat(document.getElementById('manualTxnAmount').value);
    const description = document.getElementById('manualTxnDescription').value.trim();
    const reference = document.getElementById('manualTxnReference').value.trim() || `MAN${Date.now()}`;
    const date = document.getElementById('manualTxnDate').value;
    
    if (!amount || amount <= 0 || !description) {
        alert('Please fill all required fields');
        return;
    }
    
    recordLedgerTransaction(type, {
        amount: amount,
        description: description,
        reference: reference,
        date: new Date(date).toISOString()
    });
    
    closeManualTransactionModal();
    updateLedgerDashboard();
    showLedgerTransactions();
    
    alert(`‚úÖ Transaction recorded!\n\nType: ${type}\nAmount: ‚Çπ${amount.toFixed(2)}`);
}

function closeManualTransactionModal() {
    const modal = document.getElementById('addManualTransactionModal');
    if (modal) modal.remove();
}

        // ========== EXPENSE MANAGEMENT ==========

            function showLedgerExpenses() {
    const container = document.getElementById('ledgerSubtabs');

    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üí∏ Expense Management</h3>
                <div class="flex gap-2">
                    <button onclick="downloadExpenseReport()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Download Report
                    </button>
                    <button onclick="showAddExpenseModal()" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        ‚ûï Add Expense
                    </button>
                </div>
            </div>
            
            <!-- Expense Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 p-4 rounded-lg border-2 border-red-200">
                    <p class="text-sm text-gray-600">Today's Expenses</p>
                    <p class="text-2xl font-bold text-red-600" id="expensesToday">‚Çπ0</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-200">
                    <p class="text-sm text-gray-600">This Month</p>
                    <p class="text-2xl font-bold text-orange-600" id="expensesMonth">‚Çπ0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-200">
                    <p class="text-sm text-gray-600">This Year</p>
                    <p class="text-2xl font-bold text-purple-600" id="expensesYear">‚Çπ0</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                    <p class="text-sm text-gray-600">Total Expenses</p>
                    <p class="text-2xl font-bold text-gray-700" id="expensesTotal">‚Çπ0</p>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="expenseSearch" placeholder="üîç Search expenses..." 
                        onkeyup="filterExpenses()"
                        class="px-4 py-2 border rounded-lg">
                    <select id="expenseCategoryFilter" onchange="filterExpenses()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Categories</option>
                        ${expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                    <select id="expenseDateFilter" onchange="filterExpenses()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Expenses Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Category</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Description</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Payment Mode</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody"></tbody>
                </table>
            </div>
        </div>
    `;

    updateExpenseSummary();
    displayExpenses(expenses);
}

            function updateExpenseSummary() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const yearStart = new Date(today.getFullYear(), 0, 1);

                const todayExpenses = expenses.filter(e => {
                    const eDate = new Date(e.date);
                    eDate.setHours(0, 0, 0, 0);
                    return eDate.getTime() === today.getTime();
                }).reduce((sum, e) => sum + e.amount, 0);

                const monthExpenses = expenses.filter(e => new Date(e.date) >= monthStart)
                    .reduce((sum, e) => sum + e.amount, 0);

                const yearExpenses = expenses.filter(e => new Date(e.date) >= yearStart)
                    .reduce((sum, e) => sum + e.amount, 0);

                const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

                document.getElementById('expensesToday').textContent = `‚Çπ${todayExpenses.toFixed(2)}`;
                document.getElementById('expensesMonth').textContent = `‚Çπ${monthExpenses.toFixed(2)}`;
                document.getElementById('expensesYear').textContent = `‚Çπ${yearExpenses.toFixed(2)}`;
                document.getElementById('expensesTotal').textContent = `‚Çπ${totalExpenses.toFixed(2)}`;
            }

            function displayExpenses(expenseList) {
                const tbody = document.getElementById('expensesTableBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (expenseList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No expenses recorded</td></tr>';
                    return;
                }

                expenseList.forEach((expense, index) => {
                    const date = new Date(expense.date);
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';

                    row.innerHTML = `
            <td class="px-4 py-3 text-sm">
                ${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">
                    ${expense.category}
                </span>
            </td>
            <td class="px-4 py-3 text-sm">${expense.description}</td>
            <td class="px-4 py-3 text-right font-bold text-red-600">‚Çπ${expense.amount.toFixed(2)}</td>
            <td class="px-4 py-3 text-sm">
                <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs">
                    ${expense.paymentMode || 'Cash'}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <button onclick="deleteExpense(${expense.id})" 
                    class="text-red-600 hover:text-red-800 font-medium">
                    üóëÔ∏è
                </button>
            </td>
        `;

                    tbody.appendChild(row);
                });
            }

            function filterExpenses() {
                const searchTerm = document.getElementById('expenseSearch').value.toLowerCase();
                const categoryFilter = document.getElementById('expenseCategoryFilter').value;
                const dateFilter = document.getElementById('expenseDateFilter').value;

                let filtered = expenses;

                // Category filter
                if (categoryFilter !== 'all') {
                    filtered = filtered.filter(e => e.category === categoryFilter);
                }

                // Date filter
                if (dateFilter !== 'all') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    filtered = filtered.filter(e => {
                        const eDate = new Date(e.date);
                        eDate.setHours(0, 0, 0, 0);

                        if (dateFilter === 'today') {
                            return eDate.getTime() === today.getTime();
                        } else if (dateFilter === 'week') {
                            const weekAgo = new Date(today);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            return eDate >= weekAgo;
                        } else if (dateFilter === 'month') {
                            const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                            return eDate >= monthStart;
                        } else if (dateFilter === 'year') {
                            const yearStart = new Date(today.getFullYear(), 0, 1);
                            return eDate >= yearStart;
                        }
                        return true;
                    });
                }

                // Search filter
                if (searchTerm) {
                    filtered = filtered.filter(e =>
                        e.description.toLowerCase().includes(searchTerm) ||
                        e.category.toLowerCase().includes(searchTerm)
                    );
                }

                displayExpenses(filtered);
            }

            function showAddExpenseModal() {
                const modal = document.createElement('div');
                modal.id = 'addExpenseModal';
                modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üí∏ Add Expense</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Category *</label>
                    <select id="expenseCategory" class="w-full px-3 py-2 border rounded-lg">
                        ${expenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Description *</label>
                    <input type="text" id="expenseDescription" 
                        placeholder="Enter expense details"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="expenseAmount" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Mode</label>
                    <select id="expensePaymentMode" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="expenseDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="saveExpense()" 
                        class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">
                        üíæ Save Expense
                    </button>
                    <button onclick="closeExpenseModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

                document.body.appendChild(modal);
            }

            function saveExpense() {
    const category = document.getElementById('expenseCategory').value;
    const description = document.getElementById('expenseDescription').value.trim();
    const amount = parseFloat(document.getElementById('expenseAmount').value);
    const paymentMode = document.getElementById('expensePaymentMode').value;
    const date = document.getElementById('expenseDate').value;

    if (!description || !amount || amount <= 0) {
        alert('Please fill all required fields with valid values');
        return;
    }

    const expense = {
        id: Date.now(),
        category: category,
        description: description,
        amount: amount,
        paymentMode: paymentMode,
        date: new Date(date).toISOString()
    };

    expenses.unshift(expense);
    setCachedItem('expenses', expenses);

    // Record in ledger
    recordLedgerTransaction(transactionTypes.EXPENSE, {
        amount: amount,
        description: `${category} - ${description}`,
        category: category,
        paymentMethod: paymentMode,
        reference: `EXP${expense.id}`,
        date: expense.date
    });

    // Update cash balance
    accountBalances.cash -= amount;
    setCachedItem('accountBalances', accountBalances);

    closeExpenseModal();
    updateLedgerDashboard();
    showLedgerExpenses(); // Refresh display
    
    alert(`‚úÖ Expense Recorded!\n\nCategory: ${category}\nAmount: ‚Çπ${amount.toFixed(2)}\nPayment: ${paymentMode}`);
}

            function deleteExpense(id) {
                if (!confirm('Delete this expense?')) return;

                const expense = expenses.find(e => e.id === id);
                if (!expense) return;

                expenses = expenses.filter(e => e.id !== id);
                setCachedItem('expenses', expenses);

                // Remove from ledger
                ledgerTransactions = ledgerTransactions.filter(t => t.reference !== `EXP${id}`);
                setCachedItem('ledgerTransactions', ledgerTransactions);

                // Update balances
                accountBalances.cash += expense.amount; // Add back the expense amount
                setCachedItem('accountBalances', accountBalances);

                showLedgerExpenses();
                updateLedgerDashboard();
                alert('Expense deleted!');
            }

            function closeExpenseModal() {
                const modal = document.getElementById('addExpenseModal');
                if (modal) modal.remove();
            }

            function downloadExpenseReport() {
                if (expenses.length === 0) {
                    alert('No expenses to export!');
                    return;
                }

                const wb = XLSX.utils.book_new();

                // Header
                const headerData = [
                    ['EXPENSE REPORT'],
                    ['Generated:', new Date().toLocaleDateString('en-GB')],
                    ['']
                ];

                const data = expenses.map(e => ({
                    'Date': new Date(e.date).toLocaleDateString('en-GB'),
                    'Category': e.category,
                    'Description': e.description,
                    'Amount': e.amount.toFixed(2),
                    'Payment Mode': e.paymentMode || 'Cash'
                }));

                // Summary
                const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
                const summaryData = [
                    [''],
                    ['TOTAL EXPENSES:', totalExpenses.toFixed(2)]
                ];

                const ws = XLSX.utils.json_to_sheet(data);
                XLSX.utils.sheet_add_aoa(ws, headerData, { origin: 'A1' });
                XLSX.utils.sheet_add_aoa(ws, summaryData, { origin: -1 });

                XLSX.utils.book_append_sheet(wb, ws, 'Expenses');
                XLSX.writeFile(wb, `Expense_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                alert('Expense report downloaded!');
            }

            // ========== METAL PURCHASE MANAGEMENT ==========

                function showLedgerPurchases() {
    const container = document.getElementById('ledgerSubtabs');

    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">üõí Metal Purchase Management</h3>
                <div class="flex gap-2">
                    <button onclick="downloadPurchaseReport()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Download Report
                    </button>
                    <button onclick="showAddMetalPurchaseForPV()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üìã New Metal Purchase (Generate PV)
                    </button>
                    <button onclick="showAddPurchaseModal()" 
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        ‚ûï Quick Add Purchase
                    </button>
                    <button onclick="showTab('pv')"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">üìã View All PVs</button>
                </div>
            </div>
            
            <!-- Purchase Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-300">
                    <p class="text-sm text-gray-600">Gold Purchased</p>
                    <p class="text-2xl font-bold text-yellow-600" id="goldPurchased">0g</p>
                    <p class="text-xs text-gray-500 mt-1" id="goldPurchasedValue">‚Çπ0</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-300">
                    <p class="text-sm text-gray-600">Silver Purchased</p>
                    <p class="text-2xl font-bold text-gray-600" id="silverPurchased">0g</p>
                    <p class="text-xs text-gray-500 mt-1" id="silverPurchasedValue">‚Çπ0</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border-2 border-purple-300">
                    <p class="text-sm text-gray-600">Platinum Purchased</p>
                    <p class="text-2xl font-bold text-purple-600" id="platinumPurchased">0g</p>
                    <p class="text-xs text-gray-500 mt-1" id="platinumPurchasedValue">‚Çπ0</p>
                </div>
            </div>
            
            <!-- Filter Section -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <input type="text" id="purchaseSearch" placeholder="üîç Search purchases..." 
                        onkeyup="filterPurchases()"
                        class="px-4 py-2 border rounded-lg">
                    <select id="purchaseMetalFilter" onchange="filterPurchases()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Metals</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                        <option value="platinum">Platinum</option>
                    </select>
                    <select id="purchaseDateFilter" onchange="filterPurchases()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Purchases Table -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Supplier</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold">Metal</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Weight (g)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Rate/g</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Subtotal</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">GST (3%)</th>
                            <th class="px-4 py-3 text-right text-sm font-semibold">Total</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Payment</th>
                            <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="purchasesTableBody"></tbody>
                </table>
            </div>
        </div>
    `;

    updatePurchaseSummary();
    displayPurchases(metalPurchases);
}

                function updatePurchaseSummary() {
                    const goldData = metalPurchases.filter(p => p.metalType === 'gold');
                    const silverData = metalPurchases.filter(p => p.metalType === 'silver');
                    const platinumData = metalPurchases.filter(p => p.metalType === 'platinum');

                    const goldWeight = goldData.reduce((sum, p) => sum + p.weight, 0);
                    const goldValue = goldData.reduce((sum, p) => sum + p.totalAmount, 0);

                    const silverWeight = silverData.reduce((sum, p) => sum + p.weight, 0);
                    const silverValue = silverData.reduce((sum, p) => sum + p.totalAmount, 0);

                    const platinumWeight = platinumData.reduce((sum, p) => sum + p.weight, 0);
                    const platinumValue = platinumData.reduce((sum, p) => sum + p.totalAmount, 0);

                    document.getElementById('goldPurchased').textContent = `${goldWeight.toFixed(2)}g`;
                    document.getElementById('goldPurchasedValue').textContent = `Value: ‚Çπ${goldValue.toFixed(2)}`;

                    document.getElementById('silverPurchased').textContent = `${silverWeight.toFixed(2)}g`;
                    document.getElementById('silverPurchasedValue').textContent = `Value: ‚Çπ${silverValue.toFixed(2)}`;

                    document.getElementById('platinumPurchased').textContent = `${platinumWeight.toFixed(2)}g`;
                    document.getElementById('platinumPurchasedValue').textContent = `Value: ‚Çπ${platinumValue.toFixed(2)}`;
                }

                function displayPurchases(purchaseList) {
                    const tbody = document.getElementById('purchasesTableBody');
                    if (!tbody) {
                        console.error('Purchases table body not found!');
                        return;
                    }

                    tbody.innerHTML = '';

                    if (purchaseList.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-500">No purchases recorded</td></tr>';
                        return;
                    }

                    purchaseList.forEach(purchase => {
                        const date = new Date(purchase.date);
                        const row = document.createElement('tr');
                        row.className = 'border-b hover:bg-gray-50';

                        const metalColors = {
                            'gold': 'bg-yellow-100 text-yellow-800',
                            'silver': 'bg-gray-100 text-gray-800',
                            'platinum': 'bg-purple-100 text-purple-800'
                        };

                        row.innerHTML = `
            <td class="px-4 py-3 text-sm">
                ${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3 text-sm font-medium">${purchase.supplier}</td>
            <td class="px-4 py-3">
                <span class="px-2 py-1 rounded text-xs font-semibold capitalize ${metalColors[purchase.metalType]}">
                    ${purchase.metalType}
                </span>
            </td>
            <td class="px-4 py-3 text-right font-bold">${purchase.weight.toFixed(2)}g</td>
            <td class="px-4 py-3 text-right">‚Çπ${purchase.ratePerGram.toFixed(2)}</td>
            <td class="px-4 py-3 text-right">‚Çπ${(purchase.subtotal || purchase.totalAmount).toFixed(2)}</td>
            <td class="px-4 py-3 text-right text-green-600">‚Çπ${(purchase.gst || 0).toFixed(2)}</td>
            <td class="px-4 py-3 text-right font-bold text-purple-600">‚Çπ${purchase.totalAmount.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs ${purchase.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                    ${purchase.paymentStatus.toUpperCase()}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <button onclick="deletePurchase(${purchase.id})" 
                    class="text-red-600 hover:text-red-800 font-medium">
                    üóëÔ∏è
                </button>
            </td>
        `;

                        tbody.appendChild(row);
                    });
                }

                function filterPurchases() {
                    const searchTerm = document.getElementById('purchaseSearch').value.toLowerCase();
                    const metalFilter = document.getElementById('purchaseMetalFilter').value;
                    const dateFilter = document.getElementById('purchaseDateFilter').value;

                    let filtered = metalPurchases;

                    // Metal filter
                    if (metalFilter !== 'all') {
                        filtered = filtered.filter(p => p.metalType === metalFilter);
                    }

                    // Date filter
                    if (dateFilter !== 'all') {
                        const today = new Date();
                        filtered = filtered.filter(p => {
                            const pDate = new Date(p.date);

                            if (dateFilter === 'month') {
                                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                return pDate >= monthStart;
                            } else if (dateFilter === 'year') {
                                const yearStart = new Date(today.getFullYear(), 0, 1);
                                return pDate >= yearStart;
                            }
                            return true;
                        });
                    }

                    // Search filter
                    if (searchTerm) {
                        filtered = filtered.filter(p =>
                            p.supplier.toLowerCase().includes(searchTerm) ||
                            p.invoiceNo.toLowerCase().includes(searchTerm)
                        );
                    }

                    displayPurchases(filtered);
                }

                function showAddPurchaseModal() {
                    const modal = document.createElement('div');
                    modal.id = 'addPurchaseModal';
                    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
                    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üõí Add Metal Purchase</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Supplier Name *</label>
                    <input type="text" id="purchaseSupplier" 
                        placeholder="Enter supplier name"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Metal Type *</label>
                    <select id="purchaseMetalType" class="w-full px-3 py-2 border rounded-lg">
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                        <option value="platinum">Platinum</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Weight (grams) *</label>
                    <input type="number" step="0.01" id="purchaseWeight" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Rate per gram (‚Çπ) *</label>
                    <input type="number" step="0.01" id="purchaseRate" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Total Amount</label>
                    <input type="number" step="0.01" id="purchaseTotalAmount" 
                        readonly
                        class="w-full px-3 py-2 bg-gray-100 border rounded-lg font-bold">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Invoice No</label>
                    <input type="text" id="purchaseInvoiceNo" 
                        placeholder="INV-001"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Status</label>
                    <select id="purchasePaymentStatus" class="w-full px-3 py-2 border rounded-lg">
                        <option value="paid">Paid</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="purchaseDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex gap-3">
                    <button onclick="savePurchase()" 
                        class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-medium">
                        üíæ Save Purchase
                    </button>
                    <button onclick="closePurchaseModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

                    document.body.appendChild(modal);

                    // Auto-calculate total amount
                    document.getElementById('purchaseWeight').addEventListener('input', calculatePurchaseTotal);
                    document.getElementById('purchaseRate').addEventListener('input', calculatePurchaseTotal);
                }

                function calculatePurchaseTotal() {
                    const weight = parseFloat(document.getElementById('purchaseWeight').value) || 0;
                    const rate = parseFloat(document.getElementById('purchaseRate').value) || 0;
                    const total = weight * rate;
                    document.getElementById('purchaseTotalAmount').value = total.toFixed(2);
                }

                function savePurchase() {
    const supplier = document.getElementById('purchaseSupplier').value.trim();
    const metalType = document.getElementById('purchaseMetalType').value;
    const weight = parseFloat(document.getElementById('purchaseWeight').value);
    const ratePerGram = parseFloat(document.getElementById('purchaseRate').value);
    const invoiceNo = document.getElementById('purchaseInvoiceNo').value.trim() || `PUR${Date.now()}`;
    const paymentStatus = document.getElementById('purchasePaymentStatus').value;
    const date = document.getElementById('purchaseDate').value;

    if (!supplier || !weight || weight <= 0 || !ratePerGram || ratePerGram <= 0) {
        alert('Please fill all required fields with valid values');
        return;
    }

    const subtotal = weight * ratePerGram;
    const gst = subtotal * 0.03; // 3% GST
    const totalAmount = subtotal + gst;

    const purchase = {
        id: Date.now(),
        supplier: supplier,
        metalType: metalType,
        weight: weight,
        ratePerGram: ratePerGram,
        subtotal: subtotal,
        gst: gst,
        totalAmount: totalAmount,
        invoiceNo: invoiceNo,
        paymentStatus: paymentStatus,
        date: new Date(date).toISOString()
    };

    metalPurchases.unshift(purchase);
    localStorage.setItem('metalPurchases', JSON.stringify(metalPurchases));

    // Update metal stock (ADD purchased metals)
    if (metalType === 'gold') {
        accountBalances.goldStock += weight;
    } else if (metalType === 'silver') {
        accountBalances.silverStock += weight;
    } else if (metalType === 'platinum') {
        accountBalances.platinumStock += weight;
    }

    // Update cash/payables based on payment status
    if (paymentStatus === 'paid') {
        accountBalances.cash -= totalAmount;
    } else {
        accountBalances.payables += totalAmount;
    }

    setCachedItem('accountBalances', accountBalances);

    // Record in ledger
    recordLedgerTransaction(transactionTypes.PURCHASE, {
        amount: totalAmount,
        description: `${metalType.toUpperCase()} Purchase - ${weight}g from ${supplier}`,
        category: 'Metal Purchase',
        paymentMethod: paymentStatus === 'paid' ? 'Cash' : 'Credit',
        reference: invoiceNo,
        supplier: supplier,
        metalType: metalType,
        weight: weight,
        date: purchase.date
    });

    closePurchaseModal();
    updateLedgerDashboard();
    showLedgerPurchases();
    
    alert(`‚úÖ Purchase Recorded!\n\nMetal: ${metalType.toUpperCase()}\nWeight: ${weight}g\nSupplier: ${supplier}\nAmount: ‚Çπ${totalAmount.toFixed(2)}\nStock Updated!`);
}

                function deletePurchase(id) {
                    if (!confirm('Delete this purchase? This will also update your metal stock.')) return;

                    const purchase = metalPurchases.find(p => p.id === id);
                    if (!purchase) return;

                    metalPurchases = metalPurchases.filter(p => p.id !== id);
                    localStorage.setItem('metalPurchases', JSON.stringify(metalPurchases));

                    // Remove from stock
                    if (purchase.metalType === 'gold') {
                        accountBalances.goldStock = Math.max(0, accountBalances.goldStock - purchase.weight);
                    } else if (purchase.metalType === 'silver') {
                        accountBalances.silverStock = Math.max(0, accountBalances.silverStock - purchase.weight);
                    } else if (purchase.metalType === 'platinum') {
                        accountBalances.platinumStock = Math.max(0, accountBalances.platinumStock - purchase.weight);
                    }

                    // Update balances
                    if (purchase.paymentStatus === 'pending') {
                        accountBalances.payables -= purchase.totalAmount;
                    } else {
                        accountBalances.cash += purchase.totalAmount;
                    }

                    setCachedItem('accountBalances', accountBalances);

                    // Remove from ledger
                    ledgerTransactions = ledgerTransactions.filter(t => t.reference !== purchase.invoiceNo);
                    setCachedItem('ledgerTransactions', ledgerTransactions);

                    showLedgerPurchases();
                    updateLedgerDashboard();
                    alert('Purchase deleted!');
                }

                function closePurchaseModal() {
                    const modal = document.getElementById('addPurchaseModal');
                    if (modal) modal.remove();
                }

                // ========== FINANCIAL REPORTS ==========

                    function showLedgerReports() {
                        const container = document.getElementById('ledgerSubtabs');

                        container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Financial Reports</h3>
            
            <!-- Report Type Selector -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="generateProfitLossReport()" 
                    class="p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl hover:shadow-lg transition">
                    <div class="text-4xl mb-2">üìà</div>
                    <div class="font-bold text-lg">Profit & Loss</div>
                    <div class="text-sm opacity-90">Income Statement</div>
                </button>
                <button onclick="generateBalanceSheet()" 
                    class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transition">
                    <div class="text-4xl mb-2">‚öñÔ∏è</div>
                    <div class="font-bold text-lg">Balance Sheet</div>
                    <div class="text-sm opacity-90">Financial Position</div>
                </button>
                <button onclick="generateCashFlowReport()" 
                    class="p-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition">
                    <div class="text-4xl mb-2">üí∞</div>
                    <div class="font-bold text-lg">Cash Flow</div>
                    <div class="text-sm opacity-90">Money Movement</div>
                </button>
            </div>
            
            <!-- Report Display Area -->
            <div id="reportDisplayArea" class="mt-6"></div>
        </div>
    `;
                    }

                    function generateProfitLossReport() {
                        const reportArea = document.getElementById('reportDisplayArea');

                        // Calculate revenue (sales)
                        const totalRevenue = savedBills.reduce((sum, bill) => sum + bill.netTotal, 0);

                        // Calculate COGS (Cost of Goods Sold) - Based on metal purchases
                        const totalCOGS = metalPurchases.reduce((sum, p) => sum + p.totalAmount, 0);

                        // Calculate operating expenses
                        const totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);

                        // Calculate gross profit
                        const grossProfit = totalRevenue - totalCOGS;
                        const grossProfitMargin = totalRevenue > 0 ? (grossProfit / totalRevenue * 100) : 0;

                        // Calculate net profit
                        const netProfit = grossProfit - totalExpenses;
                        const netProfitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;

                        // Expense breakdown
                        const expenseByCategory = {};
                        expenses.forEach(e => {
                            if (!expenseByCategory[e.category]) {
                                expenseByCategory[e.category] = 0;
                            }
                            expenseByCategory[e.category] += e.amount;
                        });

                        reportArea.innerHTML = `
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-200">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-bold text-gray-800">üìà Profit & Loss Statement</h4>
                <button onclick="downloadPLReport()" 
                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    üì• Download PDF
                </button>
            </div>
            
            <!-- Revenue Section -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Revenue</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Sales Revenue</span>
                        <span class="font-bold text-green-600">‚Çπ${totalRevenue.toFixed(2)}</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between">
                        <span class="font-bold">Total Revenue</span>
                        <span class="font-bold text-green-600 text-lg">‚Çπ${totalRevenue.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- COGS Section -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Cost of Goods Sold (COGS)</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Metal Purchases</span>
                        <span class="font-bold text-red-600">‚Çπ${totalCOGS.toFixed(2)}</span>
                    </div>
                    <div class="border-t pt-2 flex justify-between">
                        <span class="font-bold">Total COGS</span>
                        <span class="font-bold text-red-600 text-lg">‚Çπ${totalCOGS.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Gross Profit -->
            <div class="bg-white p-4 rounded-lg mb-4 border-2 border-green-300">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-bold text-xl">Gross Profit</span>
                        <span class="text-sm text-gray-500 ml-2">(${grossProfitMargin.toFixed(2)}% margin)</span>
                    </div>
                    <span class="font-bold text-green-600 text-2xl">‚Çπ${grossProfit.toFixed(2)}</span>
                </div>
            </div>
            
            <!-- Operating Expenses -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Operating Expenses</h5>
                <div class="space-y-2">
                    ${Object.keys(expenseByCategory).map(category => `
                        <div class="flex justify-between">
                            <span class="text-gray-600">${category}</span>
                            <span class="text-red-600">‚Çπ${expenseByCategory[category].toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <div class="border-t pt-2 flex justify-between">
                        <span class="font-bold">Total Operating Expenses</span>
                        <span class="font-bold text-red-600 text-lg">‚Çπ${totalExpenses.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Net Profit -->
            <div class="bg-gradient-to-r from-green-600 to-emerald-600 p-6 rounded-lg text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-bold text-2xl">Net Profit</span>
                        <span class="text-sm opacity-90 ml-2">(${netProfitMargin.toFixed(2)}% margin)</span>
                    </div>
                    <span class="font-bold text-4xl">‚Çπ${netProfit.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
                    }

                    function generateBalanceSheet() {
                        const reportArea = document.getElementById('reportDisplayArea');

                        // Assets
                        const cashAsset = accountBalances.cash;
                        const bankAsset = accountBalances.bank;
                        const receivables = accountBalances.receivables;

                        // Metal inventory value (at current rates)
                        const goldValue = accountBalances.goldStock * rates.gold;
                        const silverValue = accountBalances.silverStock * rates.silver;
                        const platinumValue = accountBalances.platinumStock * rates.platinum;
                        const inventoryValue = goldValue + silverValue + platinumValue;

                        const totalAssets = cashAsset + bankAsset + receivables + inventoryValue;

                        // Liabilities
                        const payables = accountBalances.payables;
                        const totalLiabilities = payables;

                        // Equity
                        const equity = totalAssets - totalLiabilities;

                        reportArea.innerHTML = `
        <div class="bg-gradient-to-br from-blue-50 to-cyan-50 p-6 rounded-xl border-2 border-blue-200">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-bold text-gray-800">‚öñÔ∏è Balance Sheet</h4>
                <button onclick="downloadBalanceSheet()" 
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    üì• Download PDF
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Assets -->
                <div>
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h5 class="font-bold text-lg text-gray-700 mb-4 border-b pb-2">Assets</h5>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-2">Current Assets</p>
                            <div class="space-y-2 ml-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Cash</span>
                                    <span class="font-semibold">‚Çπ${cashAsset.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Bank</span>
                                    <span class="font-semibold">‚Çπ${bankAsset.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Accounts Receivable</span>
                                    <span class="font-semibold">‚Çπ${receivables.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-2">Inventory</p>
                            <div class="space-y-2 ml-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Gold (${accountBalances.goldStock.toFixed(2)}g)</span>
                                    <span class="font-semibold">‚Çπ${goldValue.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Silver (${accountBalances.silverStock.toFixed(2)}g)</span>
                                    <span class="font-semibold">‚Çπ${silverValue.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Platinum (${accountBalances.platinumStock.toFixed(2)}g)</span>
                                    <span class="font-semibold">‚Çπ${platinumValue.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t-2 border-blue-300 pt-3 flex justify-between">
                            <span class="font-bold text-lg">Total Assets</span>
                            <span class="font-bold text-blue-600 text-xl">‚Çπ${totalAssets.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Liabilities & Equity -->
                <div>
                    <div class="bg-white p-4 rounded-lg mb-4">
                        <h5 class="font-bold text-lg text-gray-700 mb-4 border-b pb-2">Liabilities</h5>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-2">Current Liabilities</p>
                            <div class="space-y-2 ml-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Accounts Payable</span>
                                    <span class="font-semibold">‚Çπ${payables.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-3 mb-4 flex justify-between">
                            <span class="font-bold">Total Liabilities</span>
                            <span class="font-bold text-red-600">‚Çπ${totalLiabilities.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg">
                        <h5 class="font-bold text-lg text-gray-700 mb-4 border-b pb-2">Equity</h5>
                        
                        <div class="flex justify-between">
                            <span class="text-gray-600">Owner's Equity</span>
                            <span class="font-semibold">‚Çπ${equity.toFixed(2)}</span>
                        </div>
                        
                        <div class="border-t-2 border-blue-300 mt-3 pt-3 flex justify-between">
                            <span class="font-bold">Total Equity</span>
                            <span class="font-bold text-green-600">‚Çπ${equity.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 p-4 rounded-lg mt-4 text-white">
                        <div class="flex justify-between">
                            <span class="font-bold">Total Liabilities + Equity</span>
                            <span class="font-bold text-xl">‚Çπ${(totalLiabilities + equity).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
                    }

                    function generateCashFlowReport() {
                        const reportArea = document.getElementById('reportDisplayArea');

                        // Operating Activities
                        const cashFromSales = savedBills.reduce((sum, b) => sum + b.netTotal, 0);
                        const cashForPurchases = metalPurchases.filter(p => p.paymentStatus === 'paid')
                            .reduce((sum, p) => sum + p.totalAmount, 0);
                        const cashForExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
                        const netOperatingCash = cashFromSales - cashForPurchases - cashForExpenses;

                        // Investing Activities (if any)
                        const netInvestingCash = 0;

                        // Financing Activities (if any)
                        const netFinancingCash = 0;

                        // Net change in cash
                        const netCashChange = netOperatingCash + netInvestingCash + netFinancingCash;

                        reportArea.innerHTML = `
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 p-6 rounded-xl border-2 border-purple-200">
            <div class="flex justify-between items-center mb-6">
                <h4 class="text-2xl font-bold text-gray-800">üí∞ Cash Flow Statement</h4>
                <button onclick="downloadCashFlowReport()" 
                    class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    üì• Download PDF
                </button>
            </div>
            
            <!-- Operating Activities -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Operating Activities</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cash received from customers</span>
                        <span class="font-semibold text-green-600">‚Çπ${cashFromSales.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cash paid for metal purchases</span>
                        <span class="font-semibold text-red-600">-‚Çπ${cashForPurchases.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Cash paid for operating expenses</span>
                        <span class="font-semibold text-red-600">-‚Çπ${cashForExpenses.toFixed(2)}</span>
                    </div>
                    <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                        <span class="font-bold">Net Cash from Operating Activities</span>
                        <span class="font-bold ${netOperatingCash >= 0 ? 'text-green-600' : 'text-red-600'} text-lg">
                            ‚Çπ${netOperatingCash.toFixed(2)}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Investing Activities -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Investing Activities</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">No investing activities</span>
                        <span class="font-semibold">‚Çπ0.00</span>
                    </div>
                    <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                        <span class="font-bold">Net Cash from Investing Activities</span>
                        <span class="font-bold text-lg">‚Çπ${netInvestingCash.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Financing Activities -->
            <div class="bg-white p-4 rounded-lg mb-4">
                <h5 class="font-bold text-lg text-gray-700 mb-3">Financing Activities</h5>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600">No financing activities</span>
                        <span class="font-semibold">‚Çπ0.00</span>
                    </div>
                    <div class="border-t-2 border-purple-300 pt-2 flex justify-between">
                        <span class="font-bold">Net Cash from Financing Activities</span>
                        <span class="font-bold text-lg">‚Çπ${netFinancingCash.toFixed(2)}</span>
                    </div>
                </div>
            </div>
            
            <!-- Net Change -->
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 p-6 rounded-lg text-white">
                <div class="flex justify-between items-center">
                    <span class="font-bold text-2xl">Net Change in Cash</span>
                    <span class="font-bold text-4xl">‚Çπ${netCashChange.toFixed(2)}</span>
                </div>
            </div>
        </div>
    `;
                    }

    // ========== CUSTOMER ACCOUNTS LEDGER ==========
    function showLedgerCustomerAccounts() {
    const container = document.getElementById('ledgerSubtabs');
    if (!container) {
        console.error('ledgerSubtabs container not found!');
        return;
    }

    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">üë• Customer Accounts</h3>
                <div class="flex gap-2">
                    <button onclick="downloadAllCustomerLedgers()" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üì• Export All
                    </button>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="text" id="customerLedgerSearch" 
                        placeholder="üîç Search by name or mobile..." 
                        onkeyup="filterCustomerLedgers()"
                        class="px-4 py-2 border rounded-lg">
                    <select id="customerLedgerPeriod" onchange="filterCustomerLedgers()"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
            </div>
            
            <!-- Customer Accounts Grid -->
            <div id="customerAccountsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Will be populated -->
            </div>
            
            <!-- Empty State -->
            <div id="customerAccountsEmpty" class="text-center py-12 hidden">
                <div class="text-6xl mb-4">üë•</div>
                <h3 class="text-xl font-bold text-gray-700 mb-2">No Customer Accounts</h3>
                <p class="text-gray-500">Generate sales bills to create customer accounts</p>
            </div>
        </div>
    `;

        // Display accounts after DOM is ready
        setTimeout(() => {
            displayCustomerAccounts();
        }, 50);
    }

                    // FIXED VERSION - Replace entire function
                    function displayCustomerAccounts() {
    const grid = document.getElementById('customerAccountsGrid');
    const emptyState = document.getElementById('customerAccountsEmpty');

    if (!grid || !emptyState) {
        console.error('Customer accounts UI elements not found!');
        return;
    }

    // Get unique customers from bills
    const customerMap = new Map();

    savedBills.forEach(bill => {
        const mobile = bill.customer.mobile;
        if (!customerMap.has(mobile)) {
            customerMap.set(mobile, {
                customer: bill.customer,
                bills: [],
                totalAmount: 0,
                totalPaid: 0,
                balance: 0
            });
        }

        const account = customerMap.get(mobile);
        account.bills.push(bill);
        account.totalAmount += bill.netTotal;
        account.totalPaid += (bill.paidAmount || 0);
        account.balance = account.totalAmount - account.totalPaid;
    });

    if (customerMap.size === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
    }

    grid.classList.remove('hidden');
    emptyState.classList.add('hidden');
    grid.innerHTML = '';

    // Convert to array and sort by balance (highest first)
    const accounts = Array.from(customerMap.values()).sort((a, b) => b.balance - a.balance);

    accounts.forEach(account => {
        const card = document.createElement('div');
        card.className = 'bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl border-2 border-blue-200 hover:shadow-lg transition cursor-pointer';
        card.onclick = () => viewCustomerLedger(account.customer.mobile);

        const balanceColor = account.balance > 0 ? 'text-red-600' : 'text-green-600';
        const balanceLabel = account.balance > 0 ? 'Outstanding' : 'Paid';

        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h4 class="font-bold text-lg text-gray-800">${account.customer.name}</h4>
                    <p class="text-sm text-gray-600">üì± ${account.customer.mobile}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-xs font-bold ${account.balance > 0 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                    ${account.bills.length} Bills
                </span>
            </div>
            
            <div class="space-y-2 text-sm mb-3">
                <div class="flex justify-between">
                    <span class="text-gray-600">Total Sales:</span>
                    <span class="font-bold">‚Çπ${account.totalAmount.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Paid:</span>
                    <span class="font-bold text-green-600">‚Çπ${account.totalPaid.toFixed(2)}</span>
                </div>
                <div class="flex justify-between border-t pt-2">
                    <span class="font-bold">${balanceLabel}:</span>
                    <span class="font-bold ${balanceColor} text-lg">‚Çπ${Math.abs(account.balance).toFixed(2)}</span>
                </div>
            </div>
            
            <button class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm">
                View Full Ledger ‚Üí
            </button>
        `;

        grid.appendChild(card);
    });
}

function filterCustomerLedgers() {
    const searchTerm = document.getElementById('customerLedgerSearch')?.value.toLowerCase() || '';
    const period = document.getElementById('customerLedgerPeriod')?.value || 'all';
    
    // Filter bills by period
    let filteredBills = savedBills;
    
    if (period !== 'all') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        filteredBills = savedBills.filter(bill => {
            const billDate = new Date(bill.date);
            billDate.setHours(0, 0, 0, 0);
            
            if (period === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                return billDate >= monthStart;
            } else if (period === 'year') {
                const yearStart = new Date(today.getFullYear(), 0, 1);
                return billDate >= yearStart;
            }
            return true;
        });
    }
    
    // Apply search filter
    if (searchTerm) {
        filteredBills = filteredBills.filter(bill =>
            bill.customer.name.toLowerCase().includes(searchTerm) ||
            bill.customer.mobile.includes(searchTerm)
        );
    }
    
    // Temporarily replace savedBills for display
    const originalBills = savedBills;
    savedBills = filteredBills;
    displayCustomerAccounts();
    savedBills = originalBills;
}

function viewCustomerLedger(customerMobile) {
    const container = document.getElementById('ledgerSubtabs');
    
    // Get customer bills
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    
    if (customerBills.length === 0) {
        alert('No transactions found for this customer');
        return;
    }
    
    const customer = customerBills[0].customer;
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    // Get payment transactions for this customer
    const paymentTransactions = ledgerTransactions.filter(txn => 
        txn.type === transactionTypes.PAYMENT_RECEIVED && 
        txn.customerMobile === customerMobile
    );
    
    container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <!-- Header with Back Button -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <button onclick="showLedgerCustomerAccounts()" 
                        class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        ‚Üê Back
                    </button>
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">${customer.name}</h3>
                        <p class="text-sm text-gray-600">Customer Account Ledger</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="recordPayment('${customerMobile}')" 
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        üí∞ Record Payment
                    </button>
                    <button onclick="showCustomerLedgerDownloadOptions('${customerMobile}')" 
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        üì• Download
                    </button>
                </div>
            </div>
            
            <!-- Customer Info Card -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-5 rounded-xl border-2 border-blue-200 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Contact Information</p>
                        <p class="font-semibold">üì± ${customer.mobile}</p>
                        <p class="text-sm text-gray-700 mt-2">${customer.address1}</p>
                        <p class="text-sm text-gray-700">${customer.address2}</p>
                        <p class="text-sm text-gray-700">${customer.city}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Account Summary</p>
                        <div class="mt-2 space-y-1">
                            <p class="text-sm">Total Purchases: <span class="font-bold">‚Çπ${totalAmount.toFixed(2)}</span></p>
                            <p class="text-sm">Total Paid: <span class="font-bold text-green-600">‚Çπ${totalPaid.toFixed(2)}</span></p>
                            <p class="text-lg font-bold mt-2 ${balance > 0 ? 'text-red-600' : 'text-green-600'}">
                                ${balance > 0 ? 'Outstanding' : 'Advance'}: ‚Çπ${Math.abs(balance).toFixed(2)}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Period Filter -->
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <div class="flex items-center gap-3">
                    <label class="font-medium text-gray-700">Period:</label>
                    <select id="customerLedgerPeriodFilter" onchange="filterCustomerLedgerPeriod('${customerMobile}')"
                        class="px-4 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month" selected>This Month</option>
                        <option value="year">This Year</option>
                        <option value="custom">Custom Range</option>
                    </select>
                    <div id="customDateRange" class="hidden flex gap-2">
                        <input type="date" id="startDate" class="px-3 py-2 border rounded-lg">
                        <input type="date" id="endDate" class="px-3 py-2 border rounded-lg">
                        <button onclick="applyCustomDateRange('${customerMobile}')" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Apply
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Transaction History -->
            <div class="bg-white rounded-lg border">
                <div class="bg-gray-100 px-6 py-3 border-b">
                    <h4 class="font-bold text-gray-800">Transaction History</h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Particulars</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Ref No.</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Debit</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Credit</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold">Balance</th>
                            </tr>
                        </thead>
                        <tbody id="customerLedgerTableBody">
                            <!-- Will be populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    // Display transactions
    displayCustomerLedgerTransactions(customerMobile, 'month');
}

function displayCustomerLedgerTransactions(customerMobile, period = 'month') {
    const tbody = document.getElementById('customerLedgerTableBody');
    if (!tbody) {
        console.error('Table body not found!');
        return;
    }
    
    // Get customer bills
    let customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    
    // Get payment transactions
    let paymentTransactions = ledgerTransactions.filter(txn => 
        txn.type === transactionTypes.PAYMENT_RECEIVED && 
        txn.customerMobile === customerMobile
    );
    
    console.log('Customer Bills:', customerBills.length);
    console.log('Payments:', paymentTransactions.length);
    
    // Filter by period - DEFAULT TO THIS MONTH
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (period === 'month') {
        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
        customerBills = customerBills.filter(bill => {
            const billDate = new Date(bill.date);
            return billDate >= monthStart;
        });
        
        paymentTransactions = paymentTransactions.filter(txn => {
            const txnDate = new Date(txn.date);
            return txnDate >= monthStart;
        });
    } else if (period === 'year') {
        const yearStart = new Date(today.getFullYear(), 0, 1);
        customerBills = customerBills.filter(bill => {
            const billDate = new Date(bill.date);
            return billDate >= yearStart;
        });
        
        paymentTransactions = paymentTransactions.filter(txn => {
            const txnDate = new Date(txn.date);
            return txnDate >= yearStart;
        });
    }
    
    // Combine and sort all transactions by date
    const allTransactions = [];
    
    customerBills.forEach(bill => {
        allTransactions.push({
            date: new Date(bill.date),
            type: 'sale',
            particulars: `Sales Bill - ${bill.items.length} items`,
            reference: bill.billNo,
            debit: bill.netTotal,
            credit: 0,
            bill: bill
        });
    });
    
    paymentTransactions.forEach(txn => {
        allTransactions.push({
            date: new Date(txn.date),
            type: 'payment',
            particulars: `Payment Received - ${txn.paymentMethod || 'Cash'}`,
            reference: txn.reference || txn.id,
            debit: 0,
            credit: txn.amount,
            transaction: txn
        });
    });
    
    // Sort by date (oldest first)
    allTransactions.sort((a, b) => a.date - b.date);
    
    // Calculate running balance
    let balance = 0;
    // Re-fetch tbody in case DOM was updated
    const tbodyRefresh = document.getElementById('customerLedgerTableBody');
    if (!tbodyRefresh) {
        console.error('‚ùå Ledger table body not found! Refreshing view...');
        setTimeout(() => viewCustomerLedger(customerMobile), 100);
        return;
    }
    tbody.innerHTML = '';
    
    if (allTransactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No transactions in selected period</td></tr>';
        return;
    }
    
    allTransactions.forEach((txn, index) => {
        balance += txn.debit - txn.credit;
        
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        
        const date = txn.date;
        const formattedDate = date.toLocaleDateString('en-GB');
        const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        
        const balanceColor = balance > 0 ? 'text-red-600' : balance < 0 ? 'text-green-600' : 'text-gray-600';
        
        row.innerHTML = `
            <td class="px-4 py-3 text-sm">
                ${formattedDate}<br>
                <span class="text-xs text-gray-500">${formattedTime}</span>
            </td>
            <td class="px-4 py-3">
                <div class="font-medium">${txn.particulars}</div>
                ${txn.type === 'sale' && txn.bill.quotationNo ? `<div class="text-xs text-gray-500">${txn.bill.quotationNo}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-center">
                <span class="px-2 py-1 rounded text-xs font-semibold ${txn.type === 'sale' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">
                    ${txn.reference}
                </span>
            </td>
            <td class="px-4 py-3 text-right ${txn.debit > 0 ? 'font-bold text-red-600' : 'text-gray-400'}">
                ${txn.debit > 0 ? `‚Çπ${txn.debit.toFixed(2)}` : '-'}
            </td>
            <td class="px-4 py-3 text-right ${txn.credit > 0 ? 'font-bold text-green-600' : 'text-gray-400'}">
                ${txn.credit > 0 ? `‚Çπ${txn.credit.toFixed(2)}` : '-'}
            </td>
            <td class="px-4 py-3 text-right font-bold ${balanceColor}">
                ‚Çπ${Math.abs(balance).toFixed(2)} ${balance > 0 ? 'Dr' : balance < 0 ? 'Cr' : ''}
            </td>
        `;
        
        tbody.appendChild(row);
    });
    
    // Add closing balance row
    const closingRow = document.createElement('tr');
    closingRow.className = 'bg-gray-100 font-bold border-t-2 border-gray-400';
    closingRow.innerHTML = `
        <td colspan="3" class="px-4 py-3 text-right">Closing Balance:</td>
        <td class="px-4 py-3 text-right">-</td>
        <td class="px-4 py-3 text-right">-</td>
        <td class="px-4 py-3 text-right ${balance > 0 ? 'text-red-600' : balance < 0 ? 'text-green-600' : 'text-gray-600'}">
            ‚Çπ${Math.abs(balance).toFixed(2)} ${balance > 0 ? 'Dr' : balance < 0 ? 'Cr' : ''}
        </td>
    `;
    tbody.appendChild(closingRow);
}

function filterCustomerLedgerPeriod(customerMobile) {
    const period = document.getElementById('customerLedgerPeriodFilter').value;
    const customRange = document.getElementById('customDateRange');
    
    if (period === 'custom') {
        customRange.classList.remove('hidden');
    } else {
        customRange.classList.add('hidden');
        displayCustomerLedgerTransactions(customerMobile, period);
    }
}

function applyCustomDateRange(customerMobile) {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }
    
    // Custom filter logic here
    displayCustomerLedgerTransactions(customerMobile, 'all');
}

function recordPayment(customerMobile) {
    const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
    if (!customer) return;
    
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    if (balance <= 0) {
        alert('No outstanding balance for this customer');
        return;
    }
    
    const modal = document.createElement('div');
    modal.id = 'recordPaymentModal';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üí∞ Record Payment</h3>
            
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <p class="font-semibold text-gray-800">${customer.name}</p>
                <p class="text-sm text-gray-600">üì± ${customer.mobile}</p>
                <p class="text-lg font-bold text-red-600 mt-2">Outstanding: ‚Çπ${balance.toFixed(2)}</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="paymentAmount" 
                        max="${balance}" value="${balance}"
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Method *</label>
                    <select id="paymentMethod" class="w-full px-3 py-2 border rounded-lg">
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Reference/Transaction ID</label>
                    <input type="text" id="paymentReference" 
                        placeholder="Optional"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Payment Date</label>
                    <input type="date" id="paymentDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="paymentNotes" rows="2" 
                        placeholder="Optional notes"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="savePayment('${customerMobile}')" 
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        üíæ Save Payment
                    </button>
                    <button onclick="closePaymentModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function savePayment(customerMobile) {
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const method = document.getElementById('paymentMethod').value;
    const reference = document.getElementById('paymentReference').value.trim() || `PAY${Date.now()}`;
    const date = document.getElementById('paymentDate').value;
    const notes = document.getElementById('paymentNotes').value.trim();
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid payment amount');
        return;
    }
    
    const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
    if (!customer) {
        alert('Customer not found!');
        return;
    }
    
    // Calculate outstanding balance
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    if (amount > balance) {
        if (!confirm(`Payment amount (‚Çπ${amount.toFixed(2)}) exceeds outstanding balance (‚Çπ${balance.toFixed(2)}).\n\nDo you want to record this as an advance payment?`)) {
            return;
        }
    }
    
    // Update bills with payment (allocate to oldest bills first)
    let remainingAmount = amount;
    const updatedBills = [];
    
    // Sort bills by date (oldest first)
    const sortedBills = savedBills
        .filter(bill => bill.customer.mobile === customerMobile)
        .sort((a, b) => new Date(a.date) - new Date(b.date));
    
    sortedBills.forEach(bill => {
        if (remainingAmount > 0) {
            const billBalance = bill.netTotal - (bill.paidAmount || 0);
            if (billBalance > 0) {
                const paymentForBill = Math.min(remainingAmount, billBalance);
                bill.paidAmount = (bill.paidAmount || 0) + paymentForBill;
                bill.paymentStatus = bill.paidAmount >= bill.netTotal ? 'paid' : 'partial';
                remainingAmount -= paymentForBill;
                updatedBills.push(bill.billNo);
            }
        }
    });
    
    setCachedItem('savedBills', savedBills);
    
    // Record in ledger
    recordLedgerTransaction(transactionTypes.PAYMENT_RECEIVED, {
        amount: amount,
        customerName: customer.name,
        customerMobile: customerMobile,
        description: `Payment received from ${customer.name}${notes ? ' - ' + notes : ''}`,
        category: 'Payment Received',
        paymentMethod: method,
        reference: reference,
        billsUpdated: updatedBills.join(', ')
    });
    
    // Update balances
    accountBalances.cash += amount;
    accountBalances.receivables = Math.max(0, accountBalances.receivables - amount);
    setCachedItem('accountBalances', accountBalances);
    
    closePaymentModal();
    updateLedgerDashboard();
    viewCustomerLedger(customerMobile); // Refresh the ledger view
    
    alert(`‚úÖ Payment recorded successfully!\n\nAmount: ‚Çπ${amount.toFixed(2)}\nMethod: ${method}\nReference: ${reference}\n\nBills Updated: ${updatedBills.join(', ') || 'None (Advance)'}\n\nCustomer account updated.`);
}

function closePaymentModal() {
    const modal = document.getElementById('recordPaymentModal');
    if (modal) modal.remove();
}

                    // ========== PURCHASE VOUCHER (PV) FUNCTIONS ==========

                    let bulkUploadPVData = [];
                    let currentPVView = null;

                    function updatePVStatistics() {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);

                        const totalPVs = purchaseVouchers.length;
                        const totalValue = purchaseVouchers.reduce((sum, pv) => sum + pv.totalValue, 0);
                        const monthPVs = purchaseVouchers.filter(pv => new Date(pv.date) >= monthStart).length;
                        const totalProducts = purchaseVouchers.reduce((sum, pv) => sum + pv.products.length, 0);

                        document.getElementById('pvTotalCount').textContent = totalPVs;
                        document.getElementById('pvTotalValue').textContent = `‚Çπ${totalValue.toFixed(2)}`;
                        document.getElementById('pvMonthCount').textContent = monthPVs;
                        document.getElementById('pvTotalProducts').textContent = totalProducts;
                    }

                    function populatePVSupplierFilter() {
                        const select = document.getElementById('pvSupplierFilter');
                        if (!select) return;

                        select.innerHTML = '<option value="all">All Suppliers</option>';

                        const uniqueSuppliers = [...new Set(purchaseVouchers.map(pv => pv.supplierName))];
                        uniqueSuppliers.sort().forEach(supplier => {
                            const option = document.createElement('option');
                            option.value = supplier;
                            option.textContent = supplier;
                            select.appendChild(option);
                        });
                    }

                    function displayPVList(pvList) {
                        const tbody = document.getElementById('pvTableBody');
                        const emptyState = document.getElementById('pvEmptyState');

                        if (!tbody) return;

                        tbody.innerHTML = '';

                        if (pvList.length === 0) {
                            emptyState.classList.remove('hidden');
                            return;
                        }

                        emptyState.classList.add('hidden');

                        // Sort by date (newest first)
                        pvList.sort((a, b) => new Date(b.date) - new Date(a.date));

                        pvList.forEach(pv => {
                            const row = document.createElement('tr');
                            row.className = 'border-b hover:bg-gray-50';

                            const date = new Date(pv.date);
                            const statusColors = {
                                'paid': 'bg-green-100 text-green-800',
                                'pending': 'bg-red-100 text-red-800',
                                'partial': 'bg-yellow-100 text-yellow-800'
                            };

                            row.innerHTML = `
            <td class="px-4 py-3 font-mono font-bold text-green-600">${pv.pvNo}</td>
            <td class="px-4 py-3 text-sm">
                ${date.toLocaleDateString('en-GB')}<br>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</span>
            </td>
            <td class="px-4 py-3">
                <div class="font-medium">${pv.supplierName}</div>
                ${pv.supplierInvoice ? `<div class="text-xs text-gray-500">${pv.supplierInvoice}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-center">
                <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-bold">
                    ${pv.products.length}
                </span>
            </td>
            <td class="px-4 py-3 text-right font-bold">${pv.totalWeight.toFixed(2)}g</td>
            <td class="px-4 py-3 text-right font-bold text-green-600">‚Çπ${pv.totalValue.toFixed(2)}</td>
            <td class="px-4 py-3 text-center">
                <span class="px-3 py-1 rounded-full text-xs font-bold ${statusColors[pv.paymentStatus]}">
                    ${pv.paymentStatus.toUpperCase()}
                </span>
            </td>
            <td class="px-4 py-3 text-center">
                <button onclick="viewPVDetails('${pv.pvNo}')" 
                    class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 text-sm">
                    üëÅÔ∏è View
                </button>
            </td>
        `;

                            tbody.appendChild(row);
                        });
                    }

                    function filterPVList() {
                        const searchTerm = document.getElementById('pvSearch')?.value.toLowerCase() || '';
                        const dateFilter = document.getElementById('pvDateFilter')?.value || 'all';
                        const supplierFilter = document.getElementById('pvSupplierFilter')?.value || 'all';

                        let filtered = purchaseVouchers;

                        // Search filter
                        if (searchTerm) {
                            filtered = filtered.filter(pv =>
                                pv.pvNo.toLowerCase().includes(searchTerm) ||
                                pv.supplierName.toLowerCase().includes(searchTerm) ||
                                (pv.supplierInvoice && pv.supplierInvoice.toLowerCase().includes(searchTerm))
                            );
                        }

                        // Date filter
                        if (dateFilter !== 'all') {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);

                            filtered = filtered.filter(pv => {
                                const pvDate = new Date(pv.date);
                                pvDate.setHours(0, 0, 0, 0);

                                if (dateFilter === 'today') {
                                    return pvDate.getTime() === today.getTime();
                                } else if (dateFilter === 'week') {
                                    const weekAgo = new Date(today);
                                    weekAgo.setDate(weekAgo.getDate() - 7);
                                    return pvDate >= weekAgo;
                                } else if (dateFilter === 'month') {
                                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                                    return pvDate >= monthStart;
                                } else if (dateFilter === 'year') {
                                    const yearStart = new Date(today.getFullYear(), 0, 1);
                                    return pvDate >= yearStart;
                                }
                                return true;
                            });
                        }

                        // Supplier filter
                        if (supplierFilter !== 'all') {
                            filtered = filtered.filter(pv => pv.supplierName === supplierFilter);
                        }

                        displayPVList(filtered);
                    }

                    function showPVUploadModal() {
    const modal = document.getElementById('pvUploadModal');
    if (!modal) {
        console.error('PV Upload Modal not found!');
        return;
    }
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Initialize date field with today's date
    const today = new Date().toISOString().split('T')[0];
    const dateField = document.getElementById('pvDate');
    if (dateField) dateField.value = today;
    
    // Populate floor dropdown
    const pvFloorSelect = document.getElementById('pvFloor');
    if (pvFloorSelect) {
        pvFloorSelect.innerHTML = '<option value="">-- Select Floor --</option>';
        floors.forEach(floor => {
            const option = document.createElement('option');
            option.value = floor;
            option.textContent = floor;
            pvFloorSelect.appendChild(option);
        });
    }
    
    // Reset form fields
    const pvNumberLink = document.getElementById('pvNumberLink');
    const pvSupplierName = document.getElementById('pvSupplierName');
    const pvSupplierInvoice = document.getElementById('pvSupplierInvoice');
    const pvPaymentStatus = document.getElementById('pvPaymentStatus');
    const pvNotes = document.getElementById('pvNotes');
    const pvValidationMessage = document.getElementById('pvValidationMessage');
    const pvExcelFileInput = document.getElementById('pvExcelFileInput');
    
    if (pvNumberLink) pvNumberLink.value = '';
    if (pvSupplierName) pvSupplierName.value = '';
    if (pvSupplierInvoice) pvSupplierInvoice.value = '';
    if (pvPaymentStatus) pvPaymentStatus.value = 'paid';
    if (pvNotes) pvNotes.value = '';
    if (pvFloorSelect) pvFloorSelect.value = '';
    if (pvValidationMessage) {
    pvValidationMessage.innerHTML = '';
    pvValidationMessage.className = ''; // Clear any previous styling
    }
    if (pvExcelFileInput) pvExcelFileInput.value = '';
    
    // Hide preview
    const preview = document.getElementById('pvUploadPreview');
    if (preview) preview.classList.add('hidden');
    
    bulkUploadPVData = [];
}

                    function handlePVExcelUpload(event) {
                        const file = event.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = function (e) {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, { type: 'array' });
                                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                                if (jsonData.length === 0) {
                                    alert('Excel file is empty!');
                                    return;
                                }

                                bulkUploadPVData = jsonData.map((row, idx) => ({
                                    id: Date.now() + idx,
                                    barcode: String(row.Barcode || row.barcode || '').trim(),
                                    sku: String(row.SKU || row.sku || '').trim(),
                                    styleCode: String(row.StyleCode || row.styleCode || '').trim(),
                                    shortName: String(row.ProductName || row.productName || row.shortName || '').trim(),
                                    size: String(row.Size || row.size || '').trim(),
                                    avgWt: parseFloat(row.AvgWeight || row.avgWeight || row.avgWt || 0),
                                    purity: parseFloat(row.Purity || row.purity || 100),
                                    mcRate: parseFloat(row.MCRate || row.mcRate || 0),
                                    mcType: String(row.MCType || row.mcType || 'MC/GM').trim(),
                                    pcs: parseInt(row.PCS || row.pcs || 1),
                                    boxCharges: parseFloat(row.BoxCharges || row.boxCharges || 0),
                                    stoneCharges: parseFloat(row.StoneCharges || row.stoneCharges || 0),
                                    metalType: String(row.MetalType || row.metalType || 'gold').toLowerCase().trim(),
                                    isSold: false
                                }));

                                // Preview
                                const tbody = document.getElementById('pvPreviewTableBody');
                                tbody.innerHTML = '';
                                bulkUploadPVData.slice(0, 5).forEach(item => {
                                    const row = document.createElement('tr');
                                    row.className = 'border-b';
                                    row.innerHTML = `
                    <td class="px-2 py-2">${item.barcode}</td>
                    <td class="px-2 py-2">${item.shortName}</td>
                    <td class="px-2 py-2 capitalize">${item.metalType}</td>
                    <td class="px-2 py-2 text-right">${item.avgWt.toFixed(2)}g</td>
                    <td class="px-2 py-2 text-right">‚Çπ${item.mcRate.toFixed(2)}</td>
                `;
                                    tbody.appendChild(row);
                                });

                                // Calculate summary
                                const totalProducts = bulkUploadPVData.length;
                                const totalWeight = bulkUploadPVData.reduce((sum, item) => sum + item.avgWt, 0);

                                // Estimate value based on current rates and MC
                                let totalValue = 0;
                                bulkUploadPVData.forEach(item => {
                                    const metalRate = rates[item.metalType] || 0;
                                    totalValue += (metalRate + item.mcRate) * item.avgWt;
                                });

                                document.getElementById('pvUploadTotalProducts').textContent = totalProducts;
                                document.getElementById('pvUploadTotalWeight').textContent = totalWeight.toFixed(2) + 'g';
                                document.getElementById('pvUploadTotalValue').textContent = '‚Çπ' + totalValue.toFixed(2);

                                document.getElementById('pvUploadPreview').classList.remove('hidden');
                            } catch (error) {
                                alert('Error reading Excel: ' + error.message);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    }

    function confirmPVUpload() {
        if (bulkUploadPVData.length === 0) return;

        // Validate that barcodes don't exist
        const invalidItems = bulkUploadPVData.filter(item => !item.barcode || !item.shortName);
        if (invalidItems.length > 0) {
            alert(`Error: ${invalidItems.length} items missing Barcode or Name.`);
            return;
        }

        let pvNo = document.getElementById('pvNumberLink').value.trim();

        if (pvNo) {
            // Validate PV exists in pending list
            const pendingPVs = JSON.parse(localStorage.getItem('pendingPVs') || '[]');
            const existingPendingPV = pendingPVs.find(p => p.pvNo === pvNo);

            if (existingPendingPV) {
                // Valid pending PV found - link to it
                console.log('Linking to existing pending PV:', pvNo);
            } else {
                // Check if already completed
                const completedPV = purchaseVouchers.find(p => p.pvNo === pvNo);
                if (completedPV) {
                    alert(`‚ö†Ô∏è PV ${pvNo} already exists and is completed!\n\nPlease use a different PV number or leave blank to auto-generate.`);
                    return;
                } else {
                    // PV doesn't exist anywhere - create new pending entry
                    const newPendingPV = {
                        id: Date.now(),
                        pvNo: pvNo,
                        date: new Date(document.getElementById('pvDate').value).toISOString(),
                        supplierName: document.getElementById('pvSupplierName').value.trim(),
                        supplierInvoice: document.getElementById('pvSupplierInvoice').value.trim(),
                        paymentStatus: document.getElementById('pvPaymentStatus').value,
                        notes: document.getElementById('pvNotes').value.trim(),
                        expectedWeight: bulkUploadPVData.reduce((sum, item) => sum + item.avgWt, 0),
                        expectedPieces: bulkUploadPVData.length,
                        actualWeight: 0,
                        actualPieces: 0,
                        status: 'pending'
                    };

                    pendingPVs.unshift(newPendingPV);
                    localStorage.setItem('pendingPVs', JSON.stringify(pendingPVs));
                }
            }
        } else {
            // Auto-generate new PV number
            pvNo = generatePVNumber();
        }
        const supplierName = document.getElementById('pvSupplierName').value.trim();
        const supplierInvoice = document.getElementById('pvSupplierInvoice').value.trim();
        const paymentStatus = document.getElementById('pvPaymentStatus').value;
        const pvDate = document.getElementById('pvDate').value;
        const pvNotes = document.getElementById('pvNotes').value.trim();

        if (!supplierName) {
            alert('Please enter supplier name');
            return;
        }

        // ‚úÖ Calculate totals
        let totalWeight = 0;
        let totalValue = 0;
        let totalMC = 0;

        bulkUploadPVData.forEach(item => {
            totalWeight += item.avgWt;
            const metalRate = rates[item.metalType] || 0;
            const itemValue = (metalRate * item.avgWt) + (item.mcRate * item.avgWt);
            totalValue += itemValue;
            totalMC += (item.mcRate * item.avgWt);
        });

        // ‚úÖ Get selected floor
        const selectedFloor = document.getElementById('pvFloor').value;
        if (!selectedFloor) {
            alert('Please select a floor for the products');
            return;
        }
        
        // ‚úÖ Assign floor to all products
        bulkUploadPVData.forEach(product => {
            product.floor = selectedFloor;
        });
        
        // ‚úÖ Add products to inventory
        products.push(...bulkUploadPVData);
        setCachedItem('products', products);
        
        // ‚úÖ UPDATE ROL AVAILABLE COUNTERS when products are added
        bulkUploadPVData.forEach(product => {
            if (product.styleCode && rolData[product.styleCode]) {
                const styleROLData = rolData[product.styleCode];
                // Find matching ROL item by SKU and size
                const rolItem = styleROLData.items.find(ri => 
                    (ri.sku && product.sku && ri.sku.toLowerCase() === product.sku.toLowerCase()) &&
                    (ri.size && product.size && ri.size.toLowerCase() === product.size.toLowerCase())
                );
                
                if (rolItem) {
                    // Determine if single piece (retail) or multiple pieces (wholesale)
                    const isSinglePiece = (product.pcs || 1) === 1;
                    
                    if (isSinglePiece) {
                        // Retail: Add pieces
                        rolItem.availableRetail = (parseFloat(rolItem.availableRetail || 0) + 1);
                    } else {
                        // Wholesale: Add weight in grams
                        const weightToAdd = parseFloat(product.avgWt || 0);
                        rolItem.availableWholesale = (parseFloat(rolItem.availableWholesale || 0) + weightToAdd);
                    }
                }
            }
        });
        
        // Save updated ROL data if any products matched
        if (bulkUploadPVData.some(p => p.styleCode && rolData[p.styleCode])) {
            setCachedItem('rolData', rolData);
            // Refresh ROL display if visible
            if (!document.getElementById('rolTab').classList.contains('hidden') && currentSelectedROLStyleCode) {
                loadROLForStyleCode();
            }
        }

        // ‚úÖ Create PV record
        const pvRecord = {
            id: Date.now(),
            pvNo: pvNo,
            date: new Date(pvDate).toISOString(),
            supplierName: supplierName,
            supplierInvoice: supplierInvoice,
            paymentStatus: paymentStatus,
            notes: pvNotes,
            totalProducts: bulkUploadPVData.length,
            totalWeight: totalWeight,
            totalValue: totalValue,
            totalMC: totalMC,
            products: bulkUploadPVData
        };

        purchaseVouchers.unshift(pvRecord);
        setCachedItem('purchaseVouchers', purchaseVouchers); 

        // ‚úÖ Update metal stocks
        bulkUploadPVData.forEach(item => {
            if (item.metalType === 'gold') {
                accountBalances.goldStock += item.avgWt;
            } else if (item.metalType === 'silver') {
                accountBalances.silverStock += item.avgWt;
            } else if (item.metalType === 'platinum') {
                accountBalances.platinumStock += item.avgWt;
            }
        });

        setCachedItem('accountBalances', accountBalances);

        // ‚úÖ Record in ledger
        recordLedgerTransaction(transactionTypes.PURCHASE, {
            amount: totalValue,
            description: `PV ${pvNo} - ${supplierName} (${bulkUploadPVData.length} products, ${totalWeight.toFixed(2)}g)`,
            category: 'Metal Purchase',
            paymentMethod: paymentStatus === 'paid' ? 'Cash' : 'Credit',
            reference: pvNo,
            supplier: supplierName,
            weight: totalWeight,
            date: pvRecord.date
        });

        // ‚úÖ Update cash/payables
        if (paymentStatus === 'paid') {
            accountBalances.cash -= totalValue;
        } else {
            accountBalances.payables += totalValue;
        }

        setCachedItem('accountBalances', accountBalances);

        closeModals();
        alert(`‚úÖ PV Created Successfully!\n\nPV Number: ${pvNo}\nProducts Added: ${bulkUploadPVData.length}\nTotal Weight: ${totalWeight.toFixed(2)}g\nTotal Value: ‚Çπ${totalValue.toFixed(2)}\n\nStock updated in inventory.`);

        // Refresh displays
        updateProductsTable();
        loadPVTab();
        updateLedgerDashboard();

        bulkUploadPVData = [];
    }

function loadPVTab() {
    purchaseVouchers = JSON.parse(localStorage.getItem('purchaseVouchers') || '[]');
    updatePVStatistics();
    
    // Load both completed and pending PVs
    const completedPVs = purchaseVouchers || [];
    const pendingPVs = JSON.parse(localStorage.getItem('pendingPVs') || '[]');
    
    displayPVList(completedPVs);
    displayPendingPVs(pendingPVs);
    populatePVSupplierFilter();
}

    function displayPendingPVs(pendingList) {
        // Remove existing pending section if present
        const existingSection = document.querySelector('.pending-pvs-section');
        if (existingSection) {
            existingSection.remove();
        }

        if (pendingList.length === 0) return;

        const pvSection = document.querySelector('#pvListSection');
        if (!pvSection) return;

        const pendingSection = document.createElement('div');
        pendingSection.className = 'bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-6 pending-pvs-section';
    pendingSection.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-bold text-orange-800">‚ö†Ô∏è Pending PVs (Awaiting Stock Upload)</h4>
            <span class="px-3 py-1 bg-orange-200 text-orange-800 rounded-full font-bold">
                ${pendingList.length} Pending
            </span>
        </div>
        
        <div class="space-y-3">
            ${pendingList.map(pv => `
                <div class="bg-white p-4 rounded-lg border border-orange-300 flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-800">${pv.pvNo}</p>
                        <p class="text-sm text-gray-600">${pv.supplierName} | ${new Date(pv.date).toLocaleDateString('en-GB')}</p>
                        <p class="text-xs text-gray-500">Expected: ${pv.expectedWeight}g, ${pv.expectedPieces} pcs</p>
                    </div>
                    <div class="text-right">
                        <button onclick="uploadStockForPendingPV('${pv.pvNo}')" 
                            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 font-medium text-sm">
                            üì§ Upload Stock
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    pvSection.insertBefore(pendingSection, pvSection.firstChild);
}

function uploadStockForPendingPV(pvNo) {
    const pendingPVs = JSON.parse(localStorage.getItem('pendingPVs') || '[]');
    const pv = pendingPVs.find(p => p.pvNo === pvNo);
    
    if (!pv) {
        alert('Pending PV not found!');
        return;
    }
    
    // Pre-fill supplier details in upload modal
    showPVUploadModal();
    
    setTimeout(() => {
        document.getElementById('pvSupplierName').value = pv.supplierName;
        document.getElementById('pvSupplierInvoice').value = pv.supplierInvoice || '';
        document.getElementById('pvPaymentStatus').value = pv.paymentStatus;
        document.getElementById('pvDate').value = new Date(pv.date).toISOString().split('T')[0];
        document.getElementById('pvNotes').value = `Completing pending PV: ${pvNo}\nExpected: ${pv.expectedWeight}g, ${pv.expectedPieces} pcs`;
    }, 100);
}

                    function viewPVDetails(pvNo) {
                        const pv = purchaseVouchers.find(p => p.pvNo === pvNo);
                        if (!pv) {
                            alert('PV not found!');
                            return;
                        }

                        currentPVView = pv;

                        // Populate modal
                        document.getElementById('viewPVNumber').textContent = pv.pvNo;
                        document.getElementById('viewPVSupplier').textContent = pv.supplierName;
                        document.getElementById('viewPVSupplierInvoice').textContent = pv.supplierInvoice ? `Invoice: ${pv.supplierInvoice}` : '';
                        document.getElementById('viewPVDate').textContent = new Date(pv.date).toLocaleDateString('en-GB');

                        const statusColors = {
                            'paid': 'bg-green-100 text-green-800',
                            'pending': 'bg-red-100 text-red-800',
                            'partial': 'bg-yellow-100 text-yellow-800'
                        };

                        const statusEl = document.getElementById('viewPVStatus');
                        statusEl.textContent = pv.paymentStatus.toUpperCase();
                        statusEl.className = `px-3 py-1 rounded-full text-xs font-bold mt-2 inline-block ${statusColors[pv.paymentStatus]}`;

                        document.getElementById('viewPVNotes').innerHTML = pv.notes ? `<p class="text-sm text-gray-700"><strong>Notes:</strong> ${pv.notes}</p>` : '';

                        // Summary
                        document.getElementById('viewPVTotalProducts').textContent = pv.totalProducts;
                        document.getElementById('viewPVTotalWeight').textContent = pv.totalWeight.toFixed(2) + 'g';
                        document.getElementById('viewPVTotalValue').textContent = '‚Çπ' + pv.totalValue.toFixed(2);
                        document.getElementById('viewPVTotalMC').textContent = '‚Çπ' + pv.totalMC.toFixed(2);

                        // Products table
                        const tbody = document.getElementById('viewPVProductsBody');
                        tbody.innerHTML = '';

                        pv.products.forEach((product, idx) => {
                            const row = document.createElement('tr');
                            row.className = 'border-b hover:bg-gray-50';

                            const metalColors = {
                                'gold': 'bg-yellow-100 text-yellow-800',
                                'silver': 'bg-gray-100 text-gray-800',
                                'platinum': 'bg-purple-100 text-purple-800'
                            };

                            row.innerHTML = `
            <td class="border px-3 py-2 text-center">${idx + 1}</td>
            <td class="border px-3 py-2 font-mono text-xs">${product.barcode}</td>
            <td class="border px-3 py-2 text-xs">${product.sku || '-'}</td>
            <td class="border px-3 py-2 text-xs">${product.styleCode || '-'}</td>
            <td class="border px-3 py-2 font-medium">${product.shortName}</td>
            <td class="border px-3 py-2 text-center text-xs">${product.size || '-'}</td>
            <td class="border px-3 py-2 text-center">
                <span class="px-2 py-1 rounded text-xs font-bold capitalize ${metalColors[product.metalType]}">
                    ${product.metalType}
                </span>
            </td>
            <td class="border px-3 py-2 text-right font-bold">${product.avgWt.toFixed(2)}g</td>
            <td class="border px-3 py-2 text-center">${product.purity.toFixed(1)}%</td>
            <td class="border px-3 py-2 text-right">‚Çπ${product.mcRate.toFixed(2)}</td>
        `;

                            tbody.appendChild(row);
                        });

                        // Show modal
                        document.getElementById('modalOverlay').classList.remove('hidden');
                        document.getElementById('modalOverlay').classList.add('flex');
                        document.getElementById('pvViewModal').classList.remove('hidden');
                    }

                    function validatePVNumber(pvNo) {
    const msgDiv = document.getElementById('pvValidationMessage');
    if (!msgDiv) return;
    
    if (!pvNo.trim()) {
        msgDiv.innerHTML = '';
        return;
    }
    
    // Check if PV exists
    const pendingPVs = JSON.parse(localStorage.getItem('pendingPVs') || '[]');
    const completedPVs = JSON.parse(localStorage.getItem('purchaseVouchers') || '[]');
    
    const isPending = pendingPVs.find(p => p.pvNo === pvNo);
    const isCompleted = completedPVs.find(p => p.pvNo === pvNo);
    
    if (isPending) {
        msgDiv.innerHTML = `
            <div class="bg-green-50 border border-green-300 rounded p-2">
                <span class="text-green-700 font-medium">‚úÖ PV Found!</span>
                <p class="text-xs text-green-600 mt-1">Supplier: ${isPending.supplierName}</p>
                <p class="text-xs text-green-600">Expected: ${isPending.expectedWeight}g, ${isPending.expectedPieces} pcs</p>
                <p class="text-xs text-green-600">Remaining: ${(isPending.expectedWeight - isPending.actualWeight).toFixed(2)}g</p>
            </div>
        `;
    } else if (isCompleted) {
        msgDiv.innerHTML = `
            <div class="bg-yellow-50 border border-yellow-300 rounded p-2">
                <span class="text-yellow-700 font-medium">‚ö†Ô∏è PV Already Completed</span>
                <p class="text-xs text-yellow-600 mt-1">This PV has already been processed</p>
            </div>
        `;
    } else {
        msgDiv.innerHTML = `
            <div class="bg-red-50 border border-red-300 rounded p-2">
                <span class="text-red-700 font-medium">‚ùå PV Not Found</span>
                <p class="text-xs text-red-600 mt-1">This PV number doesn't exist in pending list</p>
            </div>
        `;
    }
}

                    function showPVSearchView() {
                        showInputDialog('Search PV', 'Enter PV Number (e.g., PV000001):', '', 'PV000001').then(pvNo => {
                            if (!pvNo) return;

                            const pv = purchaseVouchers.find(p => p.pvNo.toLowerCase() === pvNo.toLowerCase().trim());

                            if (pv) {
                                viewPVDetails(pv.pvNo);
                            } else {
                                showDialog('PV Not Found', `PV not found: ${pvNo}\n\nPlease check the PV number and try again.`, 'error');
                            }
                        }).catch(() => {});
                    }

                    function downloadPVSample() {
                            const sampleData = [
                                {
                                    Barcode: 'PV2001',
                                    SKU: 'RING-22K-PV01',
                                    StyleCode: '6001',
                                    ProductName: 'Gold Ring 22K - PV Sample',
                                    Size: '18',
                                    AvgWeight: 4.2,
                                    Purity: 91.6,
                                    MCRate: 250,
                                    MCType: 'MC/GM',
                                    PCS: 1,
                                    BoxCharges: 0,
                                    StoneCharges: 0,
                                    MetalType: 'gold'
                                },
                                {
                                    Barcode: 'PV2002',
                                    SKU: 'CHAIN-22K-PV02',
                                    StyleCode: '6002',
                                    ProductName: 'Gold Chain 22K - PV Sample',
                                    Size: '20',
                                    AvgWeight: 12.5,
                                    Purity: 91.6,
                                    MCRate: 200,
                                    MCType: 'MC/GM',
                                    PCS: 1,
                                    BoxCharges: 0,
                                    StoneCharges: 0,
                                    MetalType: 'gold'
                                },
                                {
                                    Barcode: 'PV2003',
                                    SKU: 'IDOL-SF-PV03',
                                    StyleCode: '6003',
                                    ProductName: 'Silver Idol - PV Sample',
                                    Size: '4inch',
                                    AvgWeight: 35.8,
                                    Purity: 100,
                                    MCRate: 150,
                                    MCType: 'MC/GM',
                                    PCS: 1,
                                    BoxCharges: 0,
                                    StoneCharges: 0,
                                    MetalType: 'silver'
                                }
                            ];

                        const ws = XLSX.utils.json_to_sheet(sampleData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'PV Sample');
                        XLSX.writeFile(wb, 'PV_Stock_Upload_Sample.xlsx');
                        alert('PV Sample template downloaded!');
                    }

                    function downloadPVReport() {
                        if (!currentPVView) return;

                        const pv = currentPVView;
                        const { jsPDF } = window.jspdf;
                        const doc = new jsPDF();

                        // Header
                        doc.setFontSize(18);
                        doc.setFont(undefined, 'bold');
                        doc.text('PURCHASE VOUCHER', 105, 15, { align: 'center' });

                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(pv.pvNo, 105, 25, { align: 'center' });

                        // Details
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Date: ${new Date(pv.date).toLocaleDateString('en-GB')}`, 15, 35);
                        doc.text(`Supplier: ${pv.supplierName}`, 15, 42);
                        if (pv.supplierInvoice) {
                            doc.text(`Supplier Invoice: ${pv.supplierInvoice}`, 15, 49);
                        }
                        doc.text(`Payment Status: ${pv.paymentStatus.toUpperCase()}`, 15, 56);

                        // Products table
                        const tableData = pv.products.map((p, idx) => [
                            idx + 1,
                            p.barcode,
                            p.shortName,
                            p.metalType.toUpperCase(),
                            p.avgWt.toFixed(2) + 'g',
                            p.purity.toFixed(1) + '%',
                            '‚Çπ' + p.mcRate.toFixed(2)
                        ]);

                        doc.autoTable({
                            startY: 65,
                            head: [['#', 'Barcode', 'Product', 'Metal', 'Weight', 'Purity', 'MC Rate']],
                            body: tableData,
                            theme: 'grid',
                            headStyles: { fillColor: [34, 197, 94] },
                            styles: { fontSize: 8 }
                        });

                        // Summary
                        const finalY = doc.lastAutoTable.finalY + 10;
                        doc.setFont(undefined, 'bold');
                        doc.text(`Total Products: ${pv.totalProducts}`, 15, finalY);
                        doc.text(`Total Weight: ${pv.totalWeight.toFixed(2)}g`, 15, finalY + 7);
                        doc.text(`Total Value: ‚Çπ${pv.totalValue.toFixed(2)}`, 15, finalY + 14);

                        doc.save(`PV_${pv.pvNo}_${new Date().toISOString().split('T')[0]}.pdf`);
                        alert('PV Report downloaded!');
                    }

function showCustomerLedgerDownloadOptions(customerMobile) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.id = 'ledgerDownloadModal';
    
    const currentYear = new Date().getFullYear();
    let yearOptions = '';
    for (let y = currentYear; y >= 2020; y--) {
        yearOptions += `<option value="${y}">Year ${y}</option>`;
    }
    
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Download Customer Ledger</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Select Period</label>
                    <select id="ledgerPeriodSelect" class="w-full px-3 py-2 border rounded-lg">
                        <option value="all">All Time</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                        <option value="2024">Year 2024</option>
                        ${yearOptions}
                    </select>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeLedgerDownloadModal()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                    <button onclick="downloadCustomerLedgerWithFilter('${customerMobile}')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Download
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeLedgerDownloadModal() {
    const modal = document.getElementById('ledgerDownloadModal');
    if (modal) modal.remove();
}

function downloadCustomerLedgerWithFilter(customerMobile) {
    const period = document.getElementById('ledgerPeriodSelect').value;
    downloadCustomerLedger(customerMobile, period);
    closeLedgerDownloadModal();
}

function downloadCustomerLedger(customerMobile, period = 'all') {
    const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
    if (!customer) {
        showDialog('Error', 'Customer not found!', 'error');
        return;
    }
    
    let customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    let paymentTransactions = ledgerTransactions.filter(txn => 
        txn.type === transactionTypes.PAYMENT_RECEIVED && 
        txn.customerMobile === customerMobile
    );
    
    // Apply date filter
    const now = new Date();
    let startDate = null;
    
    if (period === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    } else if (period === 'year') {
        startDate = new Date(now.getFullYear(), 0, 1);
    } else if (period && period !== 'all') {
        startDate = new Date(parseInt(period), 0, 1);
        const endDate = new Date(parseInt(period), 11, 31, 23, 59, 59);
        customerBills = customerBills.filter(bill => {
            const billDate = new Date(bill.date);
            return billDate >= startDate && billDate <= endDate;
        });
        paymentTransactions = paymentTransactions.filter(txn => {
            const txnDate = new Date(txn.date);
            return txnDate >= startDate && txnDate <= endDate;
        });
    }
    
    if (startDate && period !== 'all' && !period.match(/^\d{4}$/)) {
        customerBills = customerBills.filter(bill => new Date(bill.date) >= startDate);
        paymentTransactions = paymentTransactions.filter(txn => new Date(txn.date) >= startDate);
    }
    
    const wb = XLSX.utils.book_new();
    
    // Header
    const headerData = [
        ['CUSTOMER ACCOUNT LEDGER'],
        [''],
        ['Customer Name:', customer.name],
        ['Mobile:', customer.mobile],
        ['Address:', `${customer.address1}, ${customer.address2}, ${customer.city}`],
        ['Statement Date:', new Date().toLocaleDateString('en-GB')],
        ['']
    ];
    
    // Transactions
    const allTransactions = [];
    
    customerBills.forEach(bill => {
        allTransactions.push({
            Date: new Date(bill.date).toLocaleDateString('en-GB'),
            Particulars: `Sales Bill - ${bill.items.length} items`,
            Reference: bill.billNo,
            Debit: bill.netTotal.toFixed(2),
            Credit: '',
            type: 'sale',
            date: new Date(bill.date)
        });
    });
    
    paymentTransactions.forEach(txn => {
        allTransactions.push({
            Date: new Date(txn.date).toLocaleDateString('en-GB'),
            Particulars: `Payment Received - ${txn.paymentMethod || 'Cash'}`,
            Reference: txn.reference || txn.id,
            Debit: '',
            Credit: txn.amount.toFixed(2),
            type: 'payment',
            date: new Date(txn.date)
        });
    });
    
    // Sort by date
    allTransactions.sort((a, b) => a.date - b.date);
    
    // Calculate running balance
    let balance = 0;
    const txnData = allTransactions.map(txn => {
        const debit = txn.Debit ? parseFloat(txn.Debit) : 0;
        const credit = txn.Credit ? parseFloat(txn.Credit) : 0;
        balance += debit - credit;
        
        return {
            'Date': txn.Date,
            'Particulars': txn.Particulars,
            'Reference': txn.Reference,
            'Debit': txn.Debit,
            'Credit': txn.Credit,
            'Balance': `${Math.abs(balance).toFixed(2)} ${balance > 0 ? 'Dr' : balance < 0 ? 'Cr' : ''}`
        };
    });
    
    const txnHeaders = [['Date', 'Particulars', 'Reference', 'Debit', 'Credit', 'Balance']];
    const txnRows = txnData.map(obj => [obj.Date, obj.Particulars, obj.Reference, obj.Debit, obj.Credit, obj.Balance]);
    
    // Summary
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const outstanding = totalAmount - totalPaid;
    
    const summaryData = [
        [''],
        ['ACCOUNT SUMMARY'],
        ['Total Sales:', totalAmount.toFixed(2)],
        ['Total Paid:', totalPaid.toFixed(2)],
        ['Outstanding Balance:', outstanding.toFixed(2)]
    ];
    
    // Combine
    const allData = [
        ...headerData,
        ...txnHeaders,
        ...txnRows,
        ...summaryData
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(allData);
    ws['!cols'] = [
        { wch: 12 }, { wch: 35 }, { wch: 15 }, 
        { wch: 15 }, { wch: 15 }, { wch: 20 }
    ];
    
    XLSX.utils.book_append_sheet(wb, ws, 'Ledger');
    XLSX.writeFile(wb, `Ledger_${customer.name}_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('Customer ledger downloaded successfully!');
}

function downloadAllCustomerLedgers() {
    if (savedBills.length === 0) {
        alert('No customer accounts to export!');
        return;
    }
    
    // Get unique customers
    const customerMap = new Map();
    
    savedBills.forEach(bill => {
        const mobile = bill.customer.mobile;
        if (!customerMap.has(mobile)) {
            customerMap.set(mobile, {
                customer: bill.customer,
                bills: [],
                totalAmount: 0,
                totalPaid: 0,
                balance: 0
            });
        }
        
        const account = customerMap.get(mobile);
        account.bills.push(bill);
        account.totalAmount += bill.netTotal;
        account.totalPaid += bill.paidAmount || 0;
        account.balance = account.totalAmount - account.totalPaid;
    });
    
    const wb = XLSX.utils.book_new();
    
    // Summary sheet
    const summaryData = [
        ['ALL CUSTOMER ACCOUNTS SUMMARY'],
        ['Generated:', new Date().toLocaleDateString('en-GB')],
        [''],
        ['Customer Name', 'Mobile', 'Total Sales', 'Total Paid', 'Outstanding']
    ];
    
    Array.from(customerMap.values()).forEach(account => {
        summaryData.push([
            account.customer.name,
            account.customer.mobile,
            account.totalAmount.toFixed(2),
            account.totalPaid.toFixed(2),
            account.balance.toFixed(2)
        ]);
    });
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    wsSummary['!cols'] = [
        { wch: 30 }, { wch: 15 }, { wch: 15 }, 
        { wch: 15 }, { wch: 15 }
    ];
    
    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
    
    XLSX.writeFile(wb, `All_Customer_Ledgers_${new Date().toISOString().split('T')[0]}.xlsx`);
    alert('All customer ledgers downloaded successfully!');
}

    // Download functions for reports
    function downloadPLReport() {
        alert('Profit & Loss Report PDF download functionality - Implement jsPDF generation here');
    }

    function downloadBalanceSheet() {
        alert('Balance Sheet PDF download functionality - Implement jsPDF generation here');
    }

    function downloadCashFlowReport() {
        alert('Cash Flow Report PDF download functionality - Implement jsPDF generation here');
    }

     function downloadPurchaseReport() {
            if (metalPurchases.length === 0) {
                alert('No purchases to export!');
                return;
            }

            const wb = XLSX.utils.book_new();
            const data = metalPurchases.map(p => ({
                'Date': new Date(p.date).toLocaleDateString('en-GB'),
                'Supplier': p.supplier,
                'Metal Type': p.metalType.toUpperCase(),
                'Weight (g)': p.weight.toFixed(2),
                'Rate/g': p.ratePerGram.toFixed(2),
                'Subtotal': p.subtotal.toFixed(2),
                'GST (3%)': p.gst.toFixed(2),
                'Total Amount': p.totalAmount.toFixed(2),
                'Invoice No': p.invoiceNo,
                'Payment Status': p.paymentStatus.toUpperCase()
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Metal Purchases');
            XLSX.writeFile(wb, `Metal_Purchases_${new Date().toISOString().split('T')[0]}.xlsx`);
            alert('Purchase report downloaded!');
        }

    // ========== TAG SPLIT/MERGE TAB - STANDALONE IMPLEMENTATION ==========

    function handleTagSplitBarcodeScan(barcode) {
        if (!barcode) return;

        // Check if product is sold
        const soldInfo = isProductSold(barcode);
        if (soldInfo) {
            alert(`‚ö†Ô∏è PRODUCT ALREADY SOLD!\n\nBarcode: ${barcode}\nBill No: ${soldInfo.billNo}\nSold Date: ${new Date(soldInfo.soldDate).toLocaleDateString('en-GB')}\n\nCannot split sold product.`);
            return;
        }

        // Find product
        const product = products.find(p => String(p.barcode).trim().toLowerCase() === barcode.toLowerCase());

        if (!product) {
            alert(`‚ö†Ô∏è Product Not Found!\n\nBarcode: ${barcode}\n\nThis product doesn't exist in inventory.`);
            return;
        }

        if (product.pcs <= 1) {
            alert(`‚ö†Ô∏è Cannot Split!\n\nThis product has only ${product.pcs} piece.\n\nSplitting requires at least 2 pieces.`);
            return;
        }

        // Load product for splitting
        loadTagSplitProduct(product);
    }

    function loadTagSplitProduct(product) {
        currentTagSplitProduct = JSON.parse(JSON.stringify(product)); // Deep copy
        tagSplitEntries = [];
        tagRemainingPcs = product.pcs;
        tagRemainingWeight = product.avgWt;
        tagSplitSequenceStart = products.filter(p => p.splitFrom === product.barcode).length;

        // Show product info
        document.getElementById('currentTagBarcode').textContent = product.barcode;
        document.getElementById('currentTagName').textContent = product.shortName;
        document.getElementById('currentTagWeight').textContent = product.avgWt.toFixed(3) + 'g';
        document.getElementById('currentTagPcs').textContent = product.pcs;

        updateTagRemainingDisplay();
        updateTagSplitEntriesTable();

        // Show product section
        document.getElementById('currentTagProduct').classList.remove('hidden');

        // Focus on weight input
        setTimeout(() => {
            document.getElementById('tagSplitWeight').focus();
        }, 100);
    }

    function updateTagRemainingDisplay() {
        tagRemainingPcs = Math.max(0, tagRemainingPcs);
        tagRemainingWeight = Math.max(0, Number(tagRemainingWeight.toFixed(3)));

        const remainingPcsEl = document.getElementById('tagRemainingPcs');
        if (remainingPcsEl) {
            remainingPcsEl.textContent = tagRemainingPcs;
        }

        const remainingWeightEl = document.getElementById('tagRemainingWeight');
        if (remainingWeightEl) {
            remainingWeightEl.textContent = tagRemainingWeight.toFixed(3) + 'g';
        }
    }

    function generateTagSplitBarcode(originalBarcode, index) {
        // Get the highest numeric barcode from all products
        let highestBarcode = 0;
        products.forEach(p => {
            if (p.barcode) {
                // Try to extract numeric part from barcode
                const numericMatch = String(p.barcode).match(/^(\d+)$/);
                if (numericMatch) {
                    const num = parseInt(numericMatch[1], 10);
                    if (num > highestBarcode) {
                        highestBarcode = num;
                    }
                }
            }
        });
        
        // Start from 1 if no numeric barcodes found, otherwise use next number
        const startNumber = highestBarcode > 0 ? highestBarcode + 1 : 1;
        const sequenceNumber = startNumber + index;
        
        // Format as 8-digit number: 00000001, 00000002, etc.
        return String(sequenceNumber).padStart(8, '0');
    }

    function addTagSplitEntry() {
        if (!currentTagSplitProduct) {
            alert('‚ö†Ô∏è Scan a product before adding split entries.');
            return;
        }

        const weightInput = document.getElementById('tagSplitWeight');
        const pcsInput = document.getElementById('tagSplitPcs');

        let weight = parseFloat(weightInput.value);
        const pcs = parseInt(pcsInput.value, 10) || 1;

        if (!weight || weight <= 0) {
            alert('‚ö†Ô∏è Please enter a valid weight');
            return;
        }

        weight = Number(weight.toFixed(3));

        if (pcs > tagRemainingPcs) {
            alert(`‚ö†Ô∏è Cannot add ${pcs} pieces!\n\nOnly ${tagRemainingPcs} pieces remaining.`);
            return;
        }

        const weightDifference = weight - tagRemainingWeight;
        if (weightDifference > 0.001) { // 0.001g tolerance
            alert(`‚ö†Ô∏è Weight exceeds remaining!\n\nEntered: ${weight.toFixed(3)}g\nRemaining: ${tagRemainingWeight.toFixed(3)}g\nExcess: ${weightDifference.toFixed(3)}g`);
            return;
        }

        // Add entry
        const entry = {
            id: Date.now() + Math.random(),
            newBarcode: generateTagSplitBarcode(currentTagSplitProduct.barcode, tagSplitEntries.length),
            weight: weight,
            pcs: pcs
        };

        tagSplitEntries.push(entry);

        // Update remaining
        tagRemainingPcs -= pcs;
        tagRemainingWeight -= weight;

        updateTagRemainingDisplay();
        updateTagSplitEntriesTable();

        // Clear inputs
        weightInput.value = '';
        pcsInput.value = '1';
        weightInput.focus();
    }

    function updateTagSplitEntriesTable() {
        const tbody = document.getElementById('tagSplitEntriesTableBody');
        const count = document.getElementById('tagSplitEntriesCount');

        tbody.innerHTML = '';
        count.textContent = tagSplitEntries.length;

        if (tagSplitEntries.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No split entries yet</td></tr>';
            return;
        }

        tagSplitEntries.forEach((entry, idx) => {
            const row = document.createElement('tr');
            row.className = 'border-b hover:bg-gray-50';

            row.innerHTML = `
            <td class="px-3 py-2">${idx + 1}</td>
            <td class="px-3 py-2 font-mono text-xs font-bold text-blue-600">${entry.newBarcode}</td>
            <td class="px-3 py-2 text-right font-bold">${entry.weight.toFixed(3)}g</td>
            <td class="px-3 py-2 text-center">${entry.pcs}</td>
            <td class="px-3 py-2 text-center">
                <button onclick="removeTagSplitEntry(${idx})" 
                    class="text-red-600 hover:text-red-800 font-bold">
                    ‚úï
                </button>
            </td>
        `;

            tbody.appendChild(row);
        });
    }

    function removeTagSplitEntry(index) {
        const entry = tagSplitEntries[index];

        if (!entry) return;

        // Restore remaining
        tagRemainingPcs += entry.pcs;
        tagRemainingWeight += entry.weight;

        // Remove entry
        tagSplitEntries.splice(index, 1);

        updateTagRemainingDisplay();
        updateTagSplitEntriesTable();
    }

    function completeTagSplit() {
        if (!currentTagSplitProduct) {
            alert('‚ö†Ô∏è Scan a product before completing a tag split.');
            return;
        }

        if (tagSplitEntries.length === 0) {
            alert('‚ö†Ô∏è No split entries added!\n\nPlease add at least one split piece.');
            return;
        }

        if (tagRemainingPcs > 0 || Math.abs(tagRemainingWeight) > 0.001) {
            const confirm = window.confirm(
                `‚ö†Ô∏è Incomplete Split!\n\n` +
                `Remaining Pieces: ${tagRemainingPcs}\n` +
                `Remaining Weight: ${tagRemainingWeight.toFixed(3)}g\n\n` +
                `Do you want to:\n` +
                `‚Ä¢ YES - Keep remaining as original product\n` +
                `‚Ä¢ NO - Cancel and continue splitting`
            );

            if (!confirm) {
                return;
            }
        }

        const originalBarcode = currentTagSplitProduct.barcode;

        // Find original product index
        const originalIndex = products.findIndex(p => p.barcode === originalBarcode);
        if (originalIndex === -1) {
            alert('‚ùå Error: Original product not found in inventory!');
            return;
        }

        // Create new split products
        const timestamp = Date.now();
        const baseProduct = { ...currentTagSplitProduct };
        const newProducts = tagSplitEntries.map((entry, idx) => ({
            ...baseProduct,
            id: timestamp + idx + Math.random(),
            barcode: entry.newBarcode,
            avgWt: entry.weight,
            pcs: entry.pcs,
            splitFrom: originalBarcode,
            splitDate: new Date().toISOString(),
            isSold: false
        }));

        // Handle remaining
        if (tagRemainingPcs > 0 && Math.abs(tagRemainingWeight) > 0.001) {
            // Update original product with remaining
            products[originalIndex].avgWt = tagRemainingWeight;
            products[originalIndex].pcs = tagRemainingPcs;
        } else {
            // Remove original product (completely split)
            products.splice(originalIndex, 1);
        }

        // Add new products
        products.push(...newProducts);

        // Save to localStorage
        localStorage.setItem('products', JSON.stringify(products));

        // Update display if on products tab
        if (!document.getElementById('productsTab').classList.contains('hidden')) {
            updateProductsTable();
        }

        // Show success message
        const message =
            `‚úÖ Tag Split Completed!\n\n` +
            `Original Barcode: ${originalBarcode}\n` +
            `Split into: ${tagSplitEntries.length} new items\n\n` +
            `New Barcodes:\n${newProducts.map(p => `‚Ä¢ ${p.barcode} (${p.avgWt.toFixed(3)}g, ${p.pcs}pcs)`).join('\n')}\n\n` +
            (tagRemainingPcs > 0 ? `Remaining: ${tagRemainingWeight.toFixed(3)}g, ${tagRemainingPcs}pcs kept in original barcode ${originalBarcode}` : `Original product ${originalBarcode} fully split and removed`);

        alert(message);

        // Ask to print barcodes
        if (confirm('Do you want to print barcodes for the new split items?')) {
            printTagSplitBarcodes(newProducts);
        }

        // Reset
        cancelTagSplit();
    }

    function printTagSplitBarcodes(splitProducts) {
        const printWindow = window.open('', '_blank');

        if (!printWindow) {
            alert('‚ùå Pop-up blocked! Please allow pop-ups for this site.');
            return;
        }

        const barcodesHTML = splitProducts.map(product => `
        <div style="page-break-inside: avoid; margin-bottom: 20px; border: 2px solid #333; padding: 15px; width: 280px; background: white;">
            <div style="text-align: center; margin-bottom: 8px; font-family: 'Libre Barcode 128', cursive; font-size: 48px; letter-spacing: 3px;">
                ${product.barcode}
            </div>
            <div style="text-align: center; font-family: monospace; font-size: 14px; margin-bottom: 8px; font-weight: bold; border-top: 1px solid #ccc; padding-top: 5px;">
                ${product.barcode}
            </div>
            <div style="font-size: 10px; border-top: 2px solid #333; padding-top: 8px; line-height: 1.4;">
                <div style="font-weight: bold; margin-bottom: 3px;">${product.shortName}</div>
                <div>SKU: ${product.sku || '-'} | Style: ${product.styleCode || '-'}</div>
                <div style="display: flex; justify-content: space-between; margin-top: 3px;">
                    <span><strong>Weight:</strong> ${product.avgWt.toFixed(3)}g</span>
                    <span><strong>Pcs:</strong> ${product.pcs}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span><strong>Metal:</strong> ${product.metalType.toUpperCase()}</span>
                    <span><strong>Purity:</strong> ${product.purity}%</span>
                </div>
                <div style="margin-top: 3px; font-size: 8px; color: #666;">
                    Split from: ${product.splitFrom} | ${new Date(product.splitDate).toLocaleDateString('en-GB')}
                </div>
            </div>
        </div>
    `).join('');

        printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Split Tag Barcodes - Print</title>
            <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap" rel="stylesheet">
            <style>
                body { 
                    font-family: Arial, sans-serif; 
                    padding: 20px; 
                    background: #f5f5f5;
                }
                @media print {
                    body { 
                        padding: 0; 
                        background: white;
                    }
                    .no-print { display: none; }
                }
            </style>
        </head>
        <body>
            <h2 style="text-align: center; color: #333;" class="no-print">Split Product Barcodes</h2>
            <button onclick="window.print()" class="no-print" 
                style="margin: 15px auto; display: block; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">
                üñ®Ô∏è Print Barcodes
            </button>
            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                ${barcodesHTML}
            </div>
        </body>
        </html>
    `);

        printWindow.document.close();
    }

    function cancelTagSplit() {
        currentTagSplitProduct = null;
        tagSplitEntries = [];
        tagRemainingPcs = 0;
        tagRemainingWeight = 0;
        tagSplitSequenceStart = 0;

        const currentProductSection = document.getElementById('currentTagProduct');
        if (currentProductSection) currentProductSection.classList.add('hidden');

        const weightInput = document.getElementById('tagSplitWeight');
        const pcsInput = document.getElementById('tagSplitPcs');
        const barcodeInput = document.getElementById('tagSplitBarcodeInput');

        if (weightInput) weightInput.value = '';
        if (pcsInput) pcsInput.value = '1';
        if (barcodeInput) barcodeInput.focus();

        updateTagSplitEntriesTable();
        updateTagRemainingDisplay();
    }

    function showSplitHistory() {
        const splitProducts = products.filter(p => p.splitFrom);

        if (splitProducts.length === 0) {
            alert('üìä No Split History\n\nNo products have been split yet.');
            return;
        }

        // Group by original barcode
        const splitGroups = {};
        splitProducts.forEach(p => {
            if (!splitGroups[p.splitFrom]) {
                splitGroups[p.splitFrom] = [];
            }
            splitGroups[p.splitFrom].push(p);
        });

        let historyHTML = 'üìä SPLIT HISTORY\n\n';

        Object.keys(splitGroups).forEach(originalBarcode => {
            const splits = splitGroups[originalBarcode];
            const splitDate = new Date(splits[0].splitDate).toLocaleDateString('en-GB');

            historyHTML += `Original: ${originalBarcode} (Split on ${splitDate})\n`;
            historyHTML += `Split into ${splits.length} items:\n`;

            splits.forEach(s => {
                historyHTML += `  ‚Ä¢ ${s.barcode} - ${s.avgWt.toFixed(3)}g, ${s.pcs}pcs\n`;
            });

            historyHTML += '\n';
        });

        alert(historyHTML);
    }
                    

// ========== CASH ENTRY FUNCTIONS - FIXED ==========

function showCashEntryModal() {
    document.getElementById('modalOverlay').classList.remove('hidden');
    document.getElementById('modalOverlay').classList.add('flex');
    document.getElementById('cashEntryModal').classList.remove('hidden');
}

function updateCashEntryFields() {
    const type = document.getElementById('cashEntryType').value;
    const categorySelect = document.getElementById('cashEntryCategory');
    
    // Update category options based on type
    if (type === 'cash_in') {
        categorySelect.innerHTML = `
            <option value="Sales">Sales</option>
            <option value="Customer Payment">Customer Payment</option>
            <option value="Owner Investment">Owner Investment</option>
            <option value="Loan Received">Loan Received</option>
            <option value="Other Income">Other Income</option>
        `;
    } else {
        categorySelect.innerHTML = `
            <option value="Purchase">Purchase</option>
            <option value="Supplier Payment">Supplier Payment</option>
            <option value="Expense">Expense</option>
            <option value="Loan Repayment">Loan Repayment</option>
            <option value="Owner Withdrawal">Owner Withdrawal</option>
            <option value="Other Payment">Other Payment</option>
        `;
    }
}

function closeCashEntryModal() {
    document.getElementById('cashEntryModal').classList.add('hidden');
    document.getElementById('modalOverlay').classList.add('hidden');
}

function saveCashEntry() {
    const type = document.getElementById('cashEntryType').value;
    const amount = parseFloat(document.getElementById('cashEntryAmount').value);
    const category = document.getElementById('cashEntryCategory').value;
    const description = document.getElementById('cashEntryDescription').value.trim();
    const reference = document.getElementById('cashEntryReference').value.trim() || `CASH${Date.now()}`;
    const date = document.getElementById('cashEntryDate').value;
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (!description) {
        alert('Please enter a description');
        return;
    }
    
    // Record in ledger
    const transactionType = type === 'cash_in' ? transactionTypes.CASH_IN : transactionTypes.CASH_OUT;
    
    recordLedgerTransaction(transactionType, {
        amount: amount,
        description: `${category} - ${description}`,
        category: category,
        paymentMethod: 'Cash',
        reference: reference,
        date: new Date(date).toISOString()
    });
    
    // Update cash balance
    if (type === 'cash_in') {
        accountBalances.cash += amount;
    } else {
        accountBalances.cash -= amount;
    }
    
    setCachedItem('accountBalances', accountBalances);
    
    closeCashEntryModal();
    updateLedgerDashboard();
    
    alert(`‚úÖ Cash Entry Recorded!\n\nType: ${type === 'cash_in' ? 'Cash In' : 'Cash Out'}\nAmount: ‚Çπ${amount.toFixed(2)}\nCategory: ${category}\nReference: ${reference}`);
    
    // If on ledger tab, refresh display
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        showLedgerTransactions();
    }
}

// ========== BANK ENTRY FUNCTIONS - FIXED ==========

function showBankEntryModal() {
    const modal = document.createElement('div');
    modal.id = 'bankEntryModal';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üè¶ Bank Entry</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Entry Type *</label>
                    <select id="bankEntryType" onchange="updateBankEntryType()" class="w-full px-3 py-2 border rounded-lg">
                        <option value="deposit">Bank Deposit (Cash ‚Üí Bank)</option>
                        <option value="withdrawal">Bank Withdrawal (Bank ‚Üí Cash)</option>
                        <option value="customer_payment">Customer Payment (Bank)</option>
                        <option value="supplier_payment">Supplier Payment (Bank)</option>
                    </select>
                </div>
                
                <div id="customerSelectDiv" class="hidden">
                    <label class="block text-sm font-medium mb-1">Select Customer *</label>
                    <select id="bankEntryCustomer" onchange="showCustomerBalance(this.value)" class="w-full px-3 py-2 border rounded-lg">
                        <option value="">-- Select Customer --</option>
                    </select>
                    <div id="customerBalanceInfo" class="mt-2 text-sm text-gray-600"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Amount (‚Çπ) *</label>
                    <input type="number" step="0.01" id="bankEntryAmount" 
                        placeholder="0.00"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Bank Name</label>
                    <input type="text" id="bankEntryBankName" 
                        placeholder="e.g., HDFC Bank"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Transaction Reference *</label>
                    <input type="text" id="bankEntryReference" 
                        placeholder="UTR/IMPS/NEFT/RTGS Number"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Description</label>
                    <textarea id="bankEntryDescription" rows="2" 
                        placeholder="Enter transaction details"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Date</label>
                    <input type="date" id="bankEntryDate" 
                        value="${new Date().toISOString().split('T')[0]}"
                        class="w-full px-3 py-2 border rounded-lg">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveBankEntry()" 
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">
                        üíæ Save Entry
                    </button>
                    <button onclick="closeBankEntryModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    populateBankEntryCustomers();
}


    function showAddMetalPurchaseForPV() {
    const modal = document.createElement('div');
    modal.id = 'addMetalPurchaseModal';
    modal.className = 'fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-2xl w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4">üìã Metal Purchase Entry (PV Step 1)</h3>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                <p class="text-sm text-blue-800 font-medium">
                    Step 1: Enter purchase details. A PV number will be auto-generated after saving.
                </p>
            </div>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Supplier Name *</label>
                        <input type="text" id="pvSupplierNameEntry" 
                            placeholder="e.g., Emerald Jewel Industry"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Supplier Invoice No</label>
                        <input type="text" id="pvSupplierInvoiceEntry" 
                            placeholder="Optional"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Total Weight (grams) *</label>
                        <input type="number" step="0.01" id="pvTotalWeightEntry" 
                            placeholder="0.00"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Total Pieces *</label>
                        <input type="number" id="pvTotalPiecesEntry" 
                            placeholder="0"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Payment Status *</label>
                        <select id="pvPaymentStatusEntry" class="w-full px-3 py-2 border rounded-lg">
                            <option value="paid">Paid</option>
                            <option value="pending">Pending</option>
                            <option value="partial">Partial</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Purchase Date *</label>
                        <input type="date" id="pvDateEntry" 
                            value="${new Date().toISOString().split('T')[0]}"
                            class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">Notes/Remarks</label>
                    <textarea id="pvNotesEntry" rows="2" 
                        placeholder="Any additional notes about this purchase"
                        class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveMetalPurchaseEntry()" 
                        class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">
                        ‚úÖ Generate PV & Continue to Stock Upload
                    </button>
                    <button onclick="closeMetalPurchaseModal()" 
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);

// Show overlay
const overlay = document.getElementById('modalOverlay');
if (overlay) {
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
}
}

function saveMetalPurchaseEntry() {
    const supplierName = document.getElementById('pvSupplierNameEntry').value.trim();
    const supplierInvoice = document.getElementById('pvSupplierInvoiceEntry').value.trim();
    const totalWeight = parseFloat(document.getElementById('pvTotalWeightEntry').value);
    const totalPieces = parseInt(document.getElementById('pvTotalPiecesEntry').value);
    const paymentStatus = document.getElementById('pvPaymentStatusEntry').value;
    const pvDate = document.getElementById('pvDateEntry').value;
    const notes = document.getElementById('pvNotesEntry').value.trim();
    
    if (!supplierName || !totalWeight || !totalPieces) {
        alert('‚ö†Ô∏è Please fill all required fields');
        return;
    }
    
    // ‚úÖ GENERATE PV NUMBER AUTOMATICALLY
    const pvNo = generatePVNumber();
    
    // Create pending PV record
    const pendingPV = {
        id: Date.now(),
        pvNo: pvNo,
        date: new Date(pvDate).toISOString(),
        supplierName: supplierName,
        supplierInvoice: supplierInvoice,
        paymentStatus: paymentStatus,
        notes: notes,
        expectedWeight: totalWeight,
        expectedPieces: totalPieces,
        actualWeight: 0,
        actualPieces: 0,
        products: [],
        status: 'pending', // pending, completed, partial
        totalValue: 0,
        totalMC: 0
    };
    
    // Save to pending PVs
    if (!localStorage.getItem('pendingPVs')) {
        localStorage.setItem('pendingPVs', JSON.stringify([]));
    }
    let pendingPVs = JSON.parse(localStorage.getItem('pendingPVs'));
    pendingPVs.unshift(pendingPV);
    localStorage.setItem('pendingPVs', JSON.stringify(pendingPVs));
    
    closeMetalPurchaseModal();
    
    alert(`‚úÖ PV Generated Successfully!\n\nPV Number: ${pvNo}\nSupplier: ${supplierName}\nExpected: ${totalWeight}g, ${totalPieces} pieces\n\nNow upload the stock Excel file in PV Stock In tab.`);
    
    // Redirect to PV tab
    showTab('pv');
}

function closeMetalPurchaseModal() {
    const modal = document.getElementById('addMetalPurchaseModal');
    if (modal) modal.remove();
}

function closeBankEntryModal() {
    const modal = document.getElementById('bankEntryModal');
    if (modal) modal.remove();
}

function updateBankEntryType() {
    const type = document.getElementById('bankEntryType').value;
    const customerDiv = document.getElementById('customerSelectDiv');

    if (type === 'customer_payment') {
        customerDiv.classList.remove('hidden');
    } else {
        customerDiv.classList.add('hidden');
    }
}

function populateBankEntryCustomers() {
    const select = document.getElementById('bankEntryCustomer');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Select Customer --</option>';
    
    // Get unique customers with outstanding balance
    const customerMap = new Map();
    
    savedBills.forEach(bill => {
        const mobile = bill.customer.mobile;
        if (!customerMap.has(mobile)) {
            customerMap.set(mobile, {
                customer: bill.customer,
                totalAmount: 0,
                totalPaid: 0
            });
        }
        
        const account = customerMap.get(mobile);
        account.totalAmount += bill.netTotal;
        account.totalPaid += bill.paidAmount || 0;
    });
    
    // Only show customers with outstanding balance
    Array.from(customerMap.values())
        .filter(account => account.totalAmount > account.totalPaid)
        .sort((a, b) => a.customer.name.localeCompare(b.customer.name))
        .forEach(account => {
            const option = document.createElement('option');
            option.value = account.customer.mobile;
            option.textContent = `${account.customer.name} - Outstanding: ‚Çπ${(account.totalAmount - account.totalPaid).toFixed(2)}`;
            select.appendChild(option);
        });
}

function showCustomerBalance(customerMobile) {
    const customerBills = savedBills.filter(bill => bill.customer.mobile === customerMobile);
    const totalAmount = customerBills.reduce((sum, bill) => sum + bill.netTotal, 0);
    const totalPaid = customerBills.reduce((sum, bill) => sum + (bill.paidAmount || 0), 0);
    const balance = totalAmount - totalPaid;
    
    const infoDiv = document.getElementById('customerBalanceInfo');
    if (balance > 0) {
        infoDiv.innerHTML = `<span class="font-semibold text-red-600">Outstanding Balance: ‚Çπ${balance.toFixed(2)}</span>`;
        document.getElementById('bankEntryAmount').value = balance.toFixed(2);
    } else {
        infoDiv.innerHTML = `<span class="font-semibold text-green-600">No outstanding balance</span>`;
    }
}

function saveBankEntry() {
    const type = document.getElementById('bankEntryType').value;
    const amount = parseFloat(document.getElementById('bankEntryAmount').value);
    const bankName = document.getElementById('bankEntryBankName').value.trim();
    const reference = document.getElementById('bankEntryReference').value.trim();
    const description = document.getElementById('bankEntryDescription').value.trim();
    const date = document.getElementById('bankEntryDate').value;
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (!reference) {
        alert('Please enter transaction reference');
        return;
    }
    
    let transactionData = {
        amount: amount,
        description: description || `Bank ${type}`,
        paymentMethod: 'Bank Transfer',
        reference: reference,
        date: new Date(date).toISOString(),
        bankName: bankName
    };
    
    switch (type) {
        case 'deposit':
            recordLedgerTransaction(transactionTypes.BANK_DEPOSIT, transactionData);
            accountBalances.cash -= amount;
            accountBalances.bank += amount;
            break;
            
        case 'withdrawal':
            recordLedgerTransaction(transactionTypes.BANK_WITHDRAWAL, transactionData);
            accountBalances.bank -= amount;
            accountBalances.cash += amount;
            break;
            
        case 'customer_payment':
            const customerMobile = document.getElementById('bankEntryCustomer').value;
            if (!customerMobile) {
                alert('Please select a customer');
                return;
            }
            
            const customer = savedBills.find(b => b.customer.mobile === customerMobile)?.customer;
            if (!customer) {
                alert('Customer not found!');
                return;
            }
            
            let remainingAmount = amount;
            const updatedBills = [];
            
            savedBills
                .filter(bill => bill.customer.mobile === customerMobile)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .forEach(bill => {
                    if (remainingAmount > 0) {
                        const billBalance = bill.netTotal - (bill.paidAmount || 0);
                        if (billBalance > 0) {
                            const paymentForBill = Math.min(remainingAmount, billBalance);
                            bill.paidAmount = (bill.paidAmount || 0) + paymentForBill;
                            bill.paymentStatus = bill.paidAmount >= bill.netTotal ? 'paid' : 'partial';
                            remainingAmount -= paymentForBill;
                            updatedBills.push(bill.billNo);
                        }
                    }
                });
            
            setCachedItem('savedBills', savedBills);
            
            transactionData.customerName = customer.name;
            transactionData.customerMobile = customerMobile;
            transactionData.description = `Bank payment from ${customer.name}${description ? ' - ' + description : ''}`;
            transactionData.billsUpdated = updatedBills.join(', ');
            
            recordLedgerTransaction(transactionTypes.PAYMENT_RECEIVED, transactionData);
            accountBalances.bank += amount;
            accountBalances.receivables = Math.max(0, accountBalances.receivables - amount);
            break;
            
        case 'supplier_payment':
            recordLedgerTransaction(transactionTypes.PAYMENT_MADE, transactionData);
            accountBalances.bank -= amount;
            accountBalances.payables = Math.max(0, accountBalances.payables - amount);
            break;
    }
    
    setCachedItem('accountBalances', accountBalances);
    
    closeBankEntryModal();
    updateLedgerDashboard();
    
    alert(`‚úÖ Bank Entry Recorded!\n\nType: ${type.replace('_', ' ').toUpperCase()}\nAmount: ‚Çπ${amount.toFixed(2)}\nReference: ${reference}`);
    
    if (!document.getElementById('ledgerTab').classList.contains('hidden')) {
        showLedgerTransactions();
    }
}

// ========== TAG SEARCH FUNCTION ==========
function searchTag() {
    const tagInput = document.getElementById('tagSearchInput');
    const tag = tagInput.value.trim().toLowerCase();
    const resultsDiv = document.getElementById('tagSearchResults');
    const resultsContent = document.getElementById('tagSearchResultsContent');
    
    if (!tag) {
        alert('Please enter a tag/barcode to search');
        return;
    }
    
    // Search in quotations
    const foundInQuotations = [];
    savedQuotations.forEach(quotation => {
        const foundItem = quotation.items.find(item => 
            item.barcode && item.barcode.toLowerCase() === tag
        );
        if (foundItem) {
            foundInQuotations.push({
                quotationNo: quotation.quotationNo,
                quotationId: quotation.id,
                date: quotation.date,
                customer: quotation.customer.name,
                isBilled: quotation.isBilled
            });
        }
    });
    
    // Search in products
    const product = products.find(p => p.barcode && p.barcode.toLowerCase() === tag);
    
    // Display results
    let html = '';
    if (foundInQuotations.length > 0) {
        html += '<div class="mb-4"><h4 class="font-bold text-green-600 mb-2">‚úÖ Found in Quotations:</h4>';
        foundInQuotations.forEach(result => {
            html += `<div class="bg-green-50 p-3 rounded-lg mb-2 border-l-4 border-green-500">
                <p class="font-bold">Quotation: ${result.quotationNo}</p>
                <p class="text-sm">Customer: ${result.customer}</p>
                <p class="text-sm">Date: ${new Date(result.date).toLocaleDateString('en-GB')}</p>
                <p class="text-sm">Status: ${result.isBilled ? '<span class="text-green-600 font-bold">BILLED</span>' : '<span class="text-orange-600 font-bold">PENDING</span>'}</p>
            </div>`;
        });
        html += '</div>';
    } else {
        html += '<div class="mb-4"><p class="text-red-600 font-bold">‚ùå Tag not found in any quotation</p></div>';
    }
    
    if (product) {
        html += `<div class="bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500">
            <h4 class="font-bold text-blue-600 mb-2">üì¶ Product Information:</h4>
            <p><strong>Name:</strong> ${product.shortName}</p>
            <p><strong>SKU:</strong> ${product.sku || 'N/A'}</p>
            <p><strong>Floor:</strong> ${product.floor || 'Not assigned'}</p>
            <p><strong>Weight:</strong> ${product.avgWt || 'N/A'} gm</p>
        </div>`;
    } else {
        html += '<div class="bg-gray-50 p-3 rounded-lg"><p class="text-gray-600">Product not found in inventory</p></div>';
    }
    
    resultsContent.innerHTML = html;
    resultsDiv.classList.remove('hidden');
    tagInput.value = '';
}

// ========== APPROVAL FUNCTIONS ==========

// ========== FLOOR MANAGEMENT FUNCTIONS ==========
function createFloor() {
    const floorName = document.getElementById('newFloorName').value.trim();
    
    if (!floorName) {
        alert('Please enter a floor name');
        return;
    }
    
    if (floors.includes(floorName)) {
        alert('Floor already exists!');
        return;
    }
    
    floors.push(floorName);
    localStorage.setItem('floors', JSON.stringify(floors));
    
    document.getElementById('newFloorName').value = '';
    updateFloorsTable();
    updateFloorDropdowns();
    alert(`‚úÖ Floor "${floorName}" created successfully!`);
}

function deleteFloor(floorName) {
    if (floorName === 'estimation floor') {
        alert('Cannot delete estimation floor!');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete floor "${floorName}"? Products in this floor will be moved to "estimation floor".`)) {
        return;
    }
    
    // Move all products from this floor to estimation floor
    products.forEach(product => {
        if (product.floor === floorName) {
            product.floor = 'estimation floor';
        }
    });
    localStorage.setItem('products', JSON.stringify(products));
    
    // Remove floor
    floors = floors.filter(f => f !== floorName);
    localStorage.setItem('floors', JSON.stringify(floors));
    
    updateFloorsTable();
    updateFloorDropdowns();
    alert(`‚úÖ Floor "${floorName}" deleted. Products moved to estimation floor.`);
}

function transferProductFloor() {
    const barcodeInput = document.getElementById('transferBarcodeInput').value.trim();
    const fromFloor = document.getElementById('transferFromFloor').value;
    const toFloor = document.getElementById('transferToFloor').value;
    
    if (!barcodeInput || !fromFloor || !toFloor) {
        alert('Please fill all fields');
        return;
    }
    
    if (fromFloor === toFloor) {
        alert('Source and destination floors cannot be the same!');
        return;
    }
    
    // Support multiple barcodes separated by comma, newline, or space
    const barcodes = barcodeInput.split(/[,\n\s]+/).map(b => b.trim()).filter(b => b);
    
    if (barcodes.length === 0) {
        alert('Please enter at least one barcode');
        return;
    }
    
    let successCount = 0;
    let errorMessages = [];
    
    barcodes.forEach(barcode => {
        const product = products.find(p => p.barcode && p.barcode.toLowerCase() === barcode.toLowerCase());
        if (!product) {
            errorMessages.push(`Barcode ${barcode}: Product not found!`);
            return;
        }
        
        if (product.floor !== fromFloor) {
            errorMessages.push(`Barcode ${barcode}: Product is not in "${fromFloor}". Current floor: ${product.floor || 'Not assigned'}`);
            return;
        }
        
        product.floor = toFloor;
        const productIndex = products.findIndex(p => p.id === product.id);
        if (productIndex >= 0) {
            products[productIndex] = product;
            successCount++;
        }
    });
    
    if (successCount > 0) {
        localStorage.setItem('products', JSON.stringify(products));
        updateFloorsTable();
    }
    
    document.getElementById('transferBarcodeInput').value = '';
    
    if (errorMessages.length > 0) {
        alert(`‚úÖ ${successCount} product(s) transferred successfully!\n\nErrors:\n${errorMessages.join('\n')}`);
    } else {
        alert(`‚úÖ ${successCount} product(s) transferred from "${fromFloor}" to "${toFloor}"`);
    }
}

function updateFloorsTable() {
    const tbody = document.getElementById('floorsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    floors.forEach(floorName => {
        const productCount = products.filter(p => p.floor === floorName).length;
        const row = document.createElement('tr');
        row.className = 'border-b hover:bg-gray-50';
        
        const deleteButton = floorName === 'estimation floor' 
            ? '<span class="text-gray-400">Cannot delete</span>'
            : `<button onclick="deleteFloor('${floorName}')" class="text-red-600 hover:text-red-800 font-medium">üóëÔ∏è Delete</button>`;
        
        row.innerHTML = `
            <td class="px-4 py-2 font-bold">${floorName}</td>
            <td class="px-4 py-2 text-center">${productCount}</td>
            <td class="px-4 py-2">${deleteButton}</td>
        `;
        tbody.appendChild(row);
    });
}

function updateFloorDropdowns() {
    // Update transfer dropdowns
    const fromSelect = document.getElementById('transferFromFloor');
    const toSelect = document.getElementById('transferToFloor');
    
    if (fromSelect) {
        fromSelect.innerHTML = '<option value="">-- From Floor --</option>';
        floors.forEach(floor => {
            const option = document.createElement('option');
            option.value = floor;
            option.textContent = floor;
            fromSelect.appendChild(option);
        });
    }
    
    if (toSelect) {
        toSelect.innerHTML = '<option value="">-- To Floor --</option>';
        floors.forEach(floor => {
            const option = document.createElement('option');
            option.value = floor;
            option.textContent = floor;
            toSelect.appendChild(option);
        });
    }
}

// ========== GLOBAL ERROR HANDLER  ==========
window.addEventListener('error', function(e) {
    console.error('Global Error:', e.error);
    // Silently handle errors in production
});
            </script>
    </body>
    
    </html>  